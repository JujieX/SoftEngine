const uc=function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function a(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerpolicy&&(r.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?r.credentials="include":e.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(e){if(e.ep)return;e.ep=!0;const r=a(e);fetch(e.href,r)}};uc();var Nt;(function(n){n[n.Disjoint=0]="Disjoint",n[n.Contains=1]="Contains",n[n.Intersects=2]="Intersects"})(Nt||(Nt={}));var je;(function(n){n[n.Back=0]="Back",n[n.Front=1]="Front",n[n.Intersecting=2]="Intersecting"})(je||(je={}));var L=function(){function n(){}return n.clamp=function(a,t,e){return Math.max(t,Math.min(e,a))},n.equals=function(a,t){return Math.abs(a-t)<=n.zeroTolerance},n.isPowerOf2=function(a){return(a&a-1)===0},n.radianToDegree=function(a){return a*n.radToDegreeFactor},n.degreeToRadian=function(a){return a*n.degreeToRadFactor},n}();L.zeroTolerance=1e-6;L.radToDegreeFactor=180/Math.PI;L.degreeToRadFactor=Math.PI/180;var x=function(){n.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z},n.subtract=function(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z},n.multiply=function(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z},n.divide=function(t,e,r){r.x=t.x/e.x,r.y=t.y/e.y,r.z=t.z/e.z},n.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},n.cross=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=e.x,u=e.y,h=e.z;r.x=o*h-c*u,r.y=c*l-i*h,r.z=i*u-o*l},n.distance=function(t,e){var r=e.x-t.x,i=e.y-t.y,o=e.z-t.z;return Math.sqrt(r*r+i*i+o*o)},n.distanceSquared=function(t,e){var r=e.x-t.x,i=e.y-t.y,o=e.z-t.z;return r*r+i*i+o*o},n.equals=function(t,e){return L.equals(t.x,e.x)&&L.equals(t.y,e.y)&&L.equals(t.z,e.z)},n.lerp=function(t,e,r,i){var o=t.x,c=t.y,l=t.z;i.x=o+(e.x-o)*r,i.y=c+(e.y-c)*r,i.z=l+(e.z-l)*r},n.max=function(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y),r.z=Math.max(t.z,e.z)},n.min=function(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y),r.z=Math.min(t.z,e.z)},n.negate=function(t,e){e.x=-t.x,e.y=-t.y,e.z=-t.z},n.normalize=function(t,e){var r=t.x,i=t.y,o=t.z,c=Math.sqrt(r*r+i*i+o*o);c>0&&(c=1/c,e.x=r*c,e.y=i*c,e.z=o*c)},n.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e},n.transformNormal=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=e.elements;r.x=i*l[0]+o*l[4]+c*l[8],r.y=i*l[1]+o*l[5]+c*l[9],r.z=i*l[2]+o*l[6]+c*l[10]},n.transformToVec3=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=e.elements;r.x=i*l[0]+o*l[4]+c*l[8]+l[12],r.y=i*l[1]+o*l[5]+c*l[9]+l[13],r.z=i*l[2]+o*l[6]+c*l[10]+l[14]},n.transformToVec4=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=e.elements;r.x=i*l[0]+o*l[4]+c*l[8]+l[12],r.y=i*l[1]+o*l[5]+c*l[9]+l[13],r.z=i*l[2]+o*l[6]+c*l[10]+l[14],r.w=i*l[3]+o*l[7]+c*l[11]+l[15]},n.transformCoordinate=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=e.elements,u=i*l[3]+o*l[7]+c*l[11]+l[15];u=1/u,r.x=(i*l[0]+o*l[4]+c*l[8]+l[12])*u,r.y=(i*l[1]+o*l[5]+c*l[9]+l[13])*u,r.z=(i*l[2]+o*l[6]+c*l[10]+l[14])*u},n.transformByQuat=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=e.x,u=e.y,h=e.z,d=e.w,f=d*i+u*c-h*o,_=d*o+h*i-l*c,v=d*c+l*o-u*i,p=-l*i-u*o-h*c;r.x=f*d-p*l-_*h+v*u,r.y=_*d-p*u-v*l+f*h,r.z=v*d-p*h-f*u+_*l};function n(a,t,e){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),this.x=void 0,this.y=void 0,this.z=void 0,this.x=a,this.y=t,this.z=e}var s=n.prototype;return s.setValue=function(t,e,r){return this.x=t,this.y=e,this.z=r,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},s.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},s.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},s.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},s.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},s.length=function(){var t=this.x,e=this.y,r=this.z;return Math.sqrt(t*t+e*e+r*r)},s.lengthSquared=function(){var t=this.x,e=this.y,r=this.z;return t*t+e*e+r*r},s.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z},s.clone=function(){return new n(this.x,this.y,this.z)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t},s.transformNormal=function(t){return n.transformNormal(this,t,this),this},s.transformToVec3=function(t){return n.transformToVec3(this,t,this),this},s.transformCoordinate=function(t){return n.transformCoordinate(this,t,this),this},s.transformByQuat=function(t){return n.transformByQuat(this,t,this),this},n}();x._zero=new x(0,0,0);x._one=new x(1,1,1);new x;var or=function(){n.fromCenterAndExtent=function(t,e,r){x.subtract(t,e,r.min),x.add(t,e,r.max)},n.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=e.min,i=e.max;r.x=r.y=r.z=Number.MAX_VALUE,i.x=i.y=i.z=-Number.MAX_VALUE;for(var o=0,c=t.length;o<c;++o){var l=t[o];x.min(r,l,r),x.max(i,l,i)}},n.fromSphere=function(t,e){var r=t.center,i=t.radius,o=e.min,c=e.max;o.x=r.x-i,o.y=r.y-i,o.z=r.z-i,c.x=r.x+i,c.y=r.y+i,c.z=r.z+i},n.transform=function(t,e,r){var i=n._tempVec30,o=n._tempVec31;t.getCenter(i),t.getExtent(o),x.transformCoordinate(i,e,i);var c=o.x,l=o.y,u=o.z,h=e.elements;o.x=Math.abs(c*h[0])+Math.abs(l*h[4])+Math.abs(u*h[8]),o.y=Math.abs(c*h[1])+Math.abs(l*h[5])+Math.abs(u*h[9]),o.z=Math.abs(c*h[2])+Math.abs(l*h[6])+Math.abs(u*h[10]),x.subtract(i,o,r.min),x.add(i,o,r.max)},n.merge=function(t,e,r){return x.min(t.min,e.min,r.min),x.max(t.max,e.max,r.max),r};function n(a,t){a===void 0&&(a=null),t===void 0&&(t=null),this.min=new x,this.max=new x,a&&a.cloneTo(this.min),t&&t.cloneTo(this.max)}var s=n.prototype;return s.clone=function(){return new n(this.min,this.max)},s.cloneTo=function(t){return this.min.cloneTo(t.min),this.max.cloneTo(t.max),t},s.getCenter=function(t){return x.add(this.min,this.max,t),x.scale(t,.5,t),t},s.getExtent=function(t){return x.subtract(this.max,this.min,t),x.scale(t,.5,t),t},s.getCorners=function(t){t===void 0&&(t=[]);var e=this.min,r=this.max,i=e.x,o=e.y,c=e.z,l=r.x,u=r.y,h=r.z,d=t.length;if(d<8)for(var f=0,_=8-d;f<_;++f)t[d+f]=new x;return t[0].setValue(i,u,h),t[1].setValue(l,u,h),t[2].setValue(l,o,h),t[3].setValue(i,o,h),t[4].setValue(i,u,c),t[5].setValue(l,u,c),t[6].setValue(l,o,c),t[7].setValue(i,o,c),t},s.transform=function(t){return n.transform(this,t,this),this},n}();or._tempVec30=new x;or._tempVec31=new x;var pr=function(){function n(){}return n.distancePlaneAndPoint=function(a,t){return x.dot(a.normal,t)+a.distance},n.intersectsPlaneAndPoint=function(a,t){var e=n.distancePlaneAndPoint(a,t);return e>0?je.Front:e<0?je.Back:je.Intersecting},n.intersectsPlaneAndBox=function(a,t){var e=t.min,r=t.max,i=a.normal,o=n._tempVec30,c=n._tempVec31;return i.x>=0?(o.x=r.x,c.x=e.x):(o.x=e.x,c.x=r.x),i.y>=0?(o.y=r.y,c.y=e.y):(o.y=e.y,c.y=r.y),i.z>=0?(o.z=r.z,c.z=e.z):(o.z=e.z,c.z=r.z),n.distancePlaneAndPoint(a,o)<0?je.Back:n.distancePlaneAndPoint(a,c)>0?je.Front:je.Intersecting},n.intersectsPlaneAndSphere=function(a,t){var e=t.center,r=t.radius,i=n.distancePlaneAndPoint(a,e);return i>r?je.Front:i<-r?je.Back:je.Intersecting},n.intersectsRayAndPlane=function(a,t){var e=t.normal,r=L.zeroTolerance,i=x.dot(e,a.direction);if(Math.abs(i)<r)return-1;var o=x.dot(e,a.origin),c=(-t.distance-o)/i;if(c<0){if(c<-r)return-1;c=0}return c},n.intersectsRayAndBox=function(a,t){var e=L.zeroTolerance,r=a.origin,i=a.direction,o=t.min,c=t.max,l=i.x,u=i.y,h=i.z,d=r.x,f=r.y,_=r.z,v=0,p=Number.MAX_VALUE;if(Math.abs(l)<e){if(d<o.x||d>c.x)return-1}else{var g=1/l,m=(o.x-d)*g,y=(c.x-d)*g;if(m>y){var w=m;m=y,y=w}if(v=Math.max(m,v),p=Math.min(y,p),v>p)return-1}if(Math.abs(u)<e){if(f<o.y||f>c.y)return-1}else{var P=1/u,A=(o.y-f)*P,b=(c.y-f)*P;if(A>b){var M=A;A=b,b=M}if(v=Math.max(A,v),p=Math.min(b,p),v>p)return-1}if(Math.abs(h)<e){if(_<o.z||_>c.z)return-1}else{var S=1/h,T=(o.z-_)*S,z=(c.z-_)*S;if(T>z){var R=T;T=z,z=R}if(v=Math.max(T,v),p=Math.min(z,p),v>p)return-1}return v},n.intersectsRayAndSphere=function(a,t){var e=a.origin,r=a.direction,i=t.center,o=t.radius,c=n._tempVec30;x.subtract(e,i,c);var l=x.dot(c,r),u=x.dot(c,c)-o*o;if(l>0&&u>0)return-1;var h=l*l-u;if(h<0)return-1;var d=-l-Math.sqrt(h);return d<0&&(d=0),d},n.intersectsBoxAndBox=function(a,t){return a.min.x>t.max.x||t.min.x>a.max.x||a.min.y>t.max.y||t.min.y>a.max.y?!1:!(a.min.z>t.max.z||t.min.z>a.max.z)},n.intersectsSphereAndSphere=function(a,t){var e=a.radius+t.radius;return x.distanceSquared(a.center,t.center)<e*e},n.intersectsSphereAndBox=function(a,t){var e=a.center,r=t.max,i=t.min,o=n._tempVec30;o.setValue(Math.max(i.x,Math.min(e.x,r.x)),Math.max(i.y,Math.min(e.y,r.y)),Math.max(i.z,Math.min(e.z,r.z)));var c=x.distanceSquared(e,o);return c<=a.radius*a.radius},n.intersectsFrustumAndBox=function(a,t){for(var e=t.min,r=t.max,i=n._tempVec30,o=0;o<6;++o){var c=a.getPlane(o),l=c.normal;if(i.x=l.x>=0?e.x:r.x,i.y=l.y>=0?e.y:r.y,i.z=l.z>=0?e.z:r.z,x.dot(c.normal,i)>-c.distance)return!1}return!0},n.frustumContainsBox=function(a,t){for(var e=t.min,r=t.max,i=n._tempVec30,o=n._tempVec31,c=Nt.Contains,l=0;l<6;++l){var u=a.getPlane(l),h=u.normal;if(h.x>=0?(i.x=r.x,o.x=e.x):(i.x=e.x,o.x=r.x),h.y>=0?(i.y=r.y,o.y=e.y):(i.y=e.y,o.y=r.y),h.z>=0?(i.z=r.z,o.z=e.z):(i.z=e.z,o.z=r.z),n.intersectsPlaneAndPoint(u,o)===je.Front)return Nt.Disjoint;n.intersectsPlaneAndPoint(u,i)===je.Front&&(c=Nt.Intersects)}return c},n.frustumContainsSphere=function(a,t){for(var e=Nt.Contains,r=0;r<6;++r){var i=a.getPlane(r),o=n.intersectsPlaneAndSphere(i,t);if(o===je.Front)return Nt.Disjoint;if(o===je.Intersecting){e=Nt.Intersects;break}}return e},n}();pr._tempVec30=new x;pr._tempVec31=new x;var Tr=function(){n.normalize=function(t,e){var r=t.normal,i=1/r.length(),o=e.normal;o.x=r.x*i,o.y=r.y*i,o.z=r.z*i,e.distance=t.distance*i},n.fromPoints=function(t,e,r,i){var o=t.x,c=t.y,l=t.z,u=e.x-o,h=e.y-c,d=e.z-l,f=r.x-o,_=r.y-c,v=r.z-l,p=h*v-d*_,g=d*f-u*v,m=u*_-h*f,y=1/Math.sqrt(p*p+g*g+m*m),w=p*y,P=g*y,A=m*y,b=i.normal;b.x=w,b.y=P,b.z=A,i.distance=-(w*o+P*c+A*l)};function n(a,t){a===void 0&&(a=null),t===void 0&&(t=0),this.normal=new x,this.distance=0,a&&a.cloneTo(this.normal),this.distance=t}var s=n.prototype;return s.normalize=function(){return n.normalize(this,this),this},s.clone=function(){var t=new n;return this.cloneTo(t),t},s.cloneTo=function(t){return this.normal.cloneTo(t.normal),t.distance=this.distance,t},n}(),hc=function(){function n(a){a===void 0&&(a=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.top=void 0,this.bottom=void 0,this.near=new Tr,this.far=new Tr,this.left=new Tr,this.right=new Tr,this.top=new Tr,this.bottom=new Tr,a&&this.calculateFromMatrix(a)}var s=n.prototype;return s.clone=function(){var t=new n;return this.cloneTo(t),t},s.cloneTo=function(t){return this.near.cloneTo(t.near),this.far.cloneTo(t.far),this.left.cloneTo(t.left),this.right.cloneTo(t.right),this.top.cloneTo(t.top),this.bottom.cloneTo(t.bottom),t},s.getPlane=function(t){switch(t){case 0:return this.near;case 1:return this.far;case 2:return this.left;case 3:return this.right;case 4:return this.top;case 5:return this.bottom;default:return null}},s.calculateFromMatrix=function(t){var e=t.elements,r=e[0],i=e[1],o=e[2],c=e[3],l=e[4],u=e[5],h=e[6],d=e[7],f=e[8],_=e[9],v=e[10],p=e[11],g=e[12],m=e[13],y=e[14],w=e[15],P=this.near.normal;P.x=-c-o,P.y=-d-h,P.z=-p-v,this.near.distance=-w-y,this.near.normalize();var A=this.far.normal;A.x=o-c,A.y=h-d,A.z=v-p,this.far.distance=y-w,this.far.normalize();var b=this.left.normal;b.x=-c-r,b.y=-d-l,b.z=-p-f,this.left.distance=-w-g,this.left.normalize();var M=this.right.normal;M.x=r-c,M.y=l-d,M.z=f-p,this.right.distance=g-w,this.right.normalize();var S=this.top.normal;S.x=i-c,S.y=u-d,S.z=_-p,this.top.distance=m-w,this.top.normalize();var T=this.bottom.normal;T.x=-c-i,T.y=-d-u,T.z=-p-_,this.bottom.distance=-w-m,this.bottom.normalize()},s.intersectsBox=function(t){return pr.intersectsFrustumAndBox(this,t)},s.intersectsSphere=function(t){return pr.frustumContainsSphere(this,t)!==Nt.Disjoint},n}(),Or=function(){n.add=function(t,e,r){var i=t.elements,o=e.elements,c=r.elements;c[0]=i[0]+o[0],c[1]=i[1]+o[1],c[2]=i[2]+o[2],c[3]=i[3]+o[3],c[4]=i[4]+o[4],c[5]=i[5]+o[5],c[6]=i[6]+o[6],c[7]=i[7]+o[7],c[8]=i[8]+o[8]},n.subtract=function(t,e,r){var i=t.elements,o=e.elements,c=r.elements;c[0]=i[0]-o[0],c[1]=i[1]-o[1],c[2]=i[2]-o[2],c[3]=i[3]-o[3],c[4]=i[4]-o[4],c[5]=i[5]-o[5],c[6]=i[6]-o[6],c[7]=i[7]-o[7],c[8]=i[8]-o[8]},n.multiply=function(t,e,r){var i=t.elements,o=e.elements,c=r.elements,l=i[0],u=i[1],h=i[2],d=i[3],f=i[4],_=i[5],v=i[6],p=i[7],g=i[8],m=o[0],y=o[1],w=o[2],P=o[3],A=o[4],b=o[5],M=o[6],S=o[7],T=o[8];c[0]=l*m+d*y+v*w,c[1]=u*m+f*y+p*w,c[2]=h*m+_*y+g*w,c[3]=l*P+d*A+v*b,c[4]=u*P+f*A+p*b,c[5]=h*P+_*A+g*b,c[6]=l*M+d*S+v*T,c[7]=u*M+f*S+p*T,c[8]=h*M+_*S+g*T},n.equals=function(t,e){var r=t.elements,i=e.elements;return L.equals(r[0],i[0])&&L.equals(r[1],i[1])&&L.equals(r[2],i[2])&&L.equals(r[3],i[3])&&L.equals(r[4],i[4])&&L.equals(r[5],i[5])&&L.equals(r[6],i[6])&&L.equals(r[7],i[7])&&L.equals(r[8],i[8])},n.lerp=function(t,e,r,i){var o=t.elements,c=e.elements,l=i.elements,u=1-r;l[0]=o[0]*u+c[0]*r,l[1]=o[1]*u+c[1]*r,l[2]=o[2]*u+c[2]*r,l[3]=o[3]*u+c[3]*r,l[4]=o[4]*u+c[4]*r,l[5]=o[5]*u+c[5]*r,l[6]=o[6]*u+c[6]*r,l[7]=o[7]*u+c[7]*r,l[8]=o[8]*u+c[8]*r},n.rotationQuaternion=function(t,e){var r=e.elements,i=t.x,o=t.y,c=t.z,l=t.w,u=i+i,h=o+o,d=c+c,f=i*u,_=o*u,v=o*h,p=c*u,g=c*h,m=c*d,y=l*u,w=l*h,P=l*d;r[0]=1-v-m,r[3]=_-P,r[6]=p+w,r[1]=_+P,r[4]=1-f-m,r[7]=g-y,r[2]=p-w,r[5]=g+y,r[8]=1-f-v},n.scaling=function(t,e){var r=e.elements;r[0]=t.x,r[1]=0,r[2]=0,r[3]=0,r[4]=t.y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},n.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=t.x,r[7]=t.y,r[8]=1},n.invert=function(t,e){var r=t.elements,i=e.elements,o=r[0],c=r[1],l=r[2],u=r[3],h=r[4],d=r[5],f=r[6],_=r[7],v=r[8],p=v*h-d*_,g=-v*u+d*f,m=_*u-h*f,y=o*p+c*g+l*m;!y||(y=1/y,i[0]=p*y,i[1]=(-v*c+l*_)*y,i[2]=(d*c-l*h)*y,i[3]=g*y,i[4]=(v*o-l*f)*y,i[5]=(-d*o+l*u)*y,i[6]=m*y,i[7]=(-_*o+c*f)*y,i[8]=(h*o-c*u)*y)},n.normalMatrix=function(t,e){var r=t.elements,i=e.elements,o=r[0],c=r[1],l=r[2],u=r[3],h=r[4],d=r[5],f=r[6],_=r[7],v=r[8],p=r[9],g=r[10],m=r[11],y=r[12],w=r[13],P=r[14],A=r[15],b=o*d-c*h,M=o*f-l*h,S=o*_-u*h,T=c*f-l*d,z=c*_-u*d,R=l*_-u*f,E=v*w-p*y,N=v*P-g*y,D=v*A-m*y,V=p*P-g*w,U=p*A-m*w,G=g*A-m*P,O=b*G-M*U+S*V+T*D-z*N+R*E;if(!O)return null;O=1/O,i[0]=(d*G-f*U+_*V)*O,i[1]=(f*D-h*G-_*N)*O,i[2]=(h*U-d*D+_*E)*O,i[3]=(l*U-c*G-u*V)*O,i[4]=(o*G-l*D+u*N)*O,i[5]=(c*D-o*U-u*E)*O,i[6]=(w*R-P*z+A*T)*O,i[7]=(P*S-y*R-A*M)*O,i[8]=(y*z-w*S+A*b)*O},n.rotate=function(t,e,r){var i=t.elements,o=r.elements,c=Math.sin(e),l=Math.cos(e),u=i[0],h=i[1],d=i[2],f=i[3],_=i[4],v=i[5],p=i[6],g=i[7],m=i[8];o[0]=l*u+c*f,o[1]=l*h+c*_,o[2]=l*d+c*v,o[3]=l*f-c*u,o[4]=l*_-c*h,o[5]=l*v-c*d,o[6]=p,o[7]=g,o[8]=m},n.scale=function(t,e,r){var i=e.x,o=e.y,c=t.elements,l=r.elements;l[0]=i*c[0],l[1]=i*c[1],l[2]=i*c[2],l[3]=o*c[3],l[4]=o*c[4],l[5]=o*c[5],l[6]=c[6],l[7]=c[7],l[8]=c[8]},n.translate=function(t,e,r){var i=e.x,o=e.y,c=t.elements,l=r.elements,u=c[0],h=c[1],d=c[2],f=c[3],_=c[4],v=c[5],p=c[6],g=c[7],m=c[8];l[0]=u,l[1]=h,l[2]=d,l[3]=f,l[4]=_,l[5]=v,l[6]=i*u+o*f+p,l[7]=i*h+o*_+g,l[8]=i*d+o*v+m},n.transpose=function(t,e){var r=t.elements,i=e.elements;if(e===t){var o=r[1],c=r[2],l=r[5];i[1]=r[3],i[2]=r[6],i[3]=o,i[5]=r[7],i[6]=c,i[7]=l}else i[0]=r[0],i[1]=r[3],i[2]=r[6],i[3]=r[1],i[4]=r[4],i[5]=r[7],i[6]=r[2],i[7]=r[5],i[8]=r[8]};function n(a,t,e,r,i,o,c,l,u){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),i===void 0&&(i=1),o===void 0&&(o=0),c===void 0&&(c=0),l===void 0&&(l=0),u===void 0&&(u=1),this.elements=new Float32Array(9);var h=this.elements;h[0]=a,h[1]=t,h[2]=e,h[3]=r,h[4]=i,h[5]=o,h[6]=c,h[7]=l,h[8]=u}var s=n.prototype;return s.setValue=function(t,e,r,i,o,c,l,u,h){var d=this.elements;return d[0]=t,d[1]=e,d[2]=r,d[3]=i,d[4]=o,d[5]=c,d[6]=l,d[7]=u,d[8]=h,this},s.setValueByArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,i=0;i<12;i++)r[i]=t[i+e];return this},s.setValueByMatrix=function(t){var e=t.elements,r=this.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],this},s.toArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},s.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);return e},s.cloneTo=function(t){var e=this.elements,r=t.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],t},s.add=function(t){return n.add(this,t,this),this},s.subtract=function(t){return n.subtract(this,t,this),this},s.multiply=function(t){return n.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],i=t[2],o=t[3],c=t[4],l=t[5],u=t[6],h=t[7],d=t[8],f=d*c-l*h,_=-d*o+l*u,v=h*o-c*u;return e*f+r*_+i*v},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},s.invert=function(){return n.invert(this,this),this},s.rotate=function(t){return n.rotate(this,t,this),this},s.scale=function(t){return n.scale(this,t,this),this},s.translate=function(t){return n.translate(this,t,this),this},s.transpose=function(){return n.transpose(this,this),this},n}(),he=function(){n.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z,r.w=t.w+e.w},n.multiply=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=t.w,u=e.x,h=e.y,d=e.z,f=e.w;r.x=i*f+l*u+o*d-c*h,r.y=o*f+l*h+c*u-i*d,r.z=c*f+l*d+i*h-o*u,r.w=l*f-i*u-o*h-c*d},n.conjugate=function(t,e){e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w},n.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},n.equals=function(t,e){return L.equals(t.x,e.x)&&L.equals(t.y,e.y)&&L.equals(t.z,e.z)&&L.equals(t.w,e.w)},n.rotationAxisAngle=function(t,e,r){var i=n._tempVector3;x.normalize(t,i),e*=.5;var o=Math.sin(e);r.x=i.x*o,r.y=i.y*o,r.z=i.z*o,r.w=Math.cos(e)},n.rotationEuler=function(t,e,r,i){n.rotationYawPitchRoll(e,t,r,i)},n.rotationYawPitchRoll=function(t,e,r,i){var o=r*.5,c=e*.5,l=t*.5,u=Math.sin(o),h=Math.cos(o),d=Math.sin(c),f=Math.cos(c),_=Math.sin(l),v=Math.cos(l),p=v*f,g=_*d;i.x=v*d*h+_*f*u,i.y=_*f*h-v*d*u,i.z=p*u-g*h,i.w=p*h+g*u},n.rotationMatrix3x3=function(t,e){var r=t.elements,i=r[0],o=r[1],c=r[2],l=r[3],u=r[4],h=r[5],d=r[6],f=r[7],_=r[8],v=i+u+_,p,g;v>0?(p=Math.sqrt(v+1),e.w=p*.5,p=.5/p,e.x=(h-f)*p,e.y=(d-c)*p,e.z=(o-l)*p):i>=u&&i>=_?(p=Math.sqrt(1+i-u-_),g=.5/p,e.x=.5*p,e.y=(o+l)*g,e.z=(c+d)*g,e.w=(h-f)*g):u>_?(p=Math.sqrt(1+u-i-_),g=.5/p,e.x=(l+o)*g,e.y=.5*p,e.z=(f+h)*g,e.w=(d-c)*g):(p=Math.sqrt(1+_-i-u),g=.5/p,e.x=(c+d)*g,e.y=(h+f)*g,e.z=.5*p,e.w=(o-l)*g)},n.invert=function(t,e){var r=t.x,i=t.y,o=t.z,c=t.w,l=r*r+i*i+o*o+c*c;if(l>L.zeroTolerance){var u=1/l;e.x=-r*u,e.y=-i*u,e.z=-o*u,e.w=c*u}},n.lerp=function(t,e,r,i){var o=1-r;n.dot(t,e)>=0?(i.x=t.x*o+e.x*r,i.y=t.y*o+e.y*r,i.z=t.z*o+e.z*r,i.w=t.w*o+e.w*r):(i.x=t.x*o-e.x*r,i.y=t.y*o-e.y*r,i.z=t.z*o-e.z*r,i.w=t.w*o-e.w*r),i.normalize()},n.slerp=function(t,e,r,i){var o=t.x,c=t.y,l=t.z,u=t.w,h=e.x,d=e.y,f=e.z,_=e.w,v,p,g=o*h+c*d+l*f+u*_;if(g<0&&(g=-g,h=-h,d=-d,f=-f,_=-_),1-g>L.zeroTolerance){var m=Math.acos(g),y=Math.sin(m);v=Math.sin((1-r)*m)/y,p=Math.sin(r*m)/y}else v=1-r,p=r;i.x=v*o+p*h,i.y=v*c+p*d,i.z=v*l+p*f,i.w=v*u+p*_},n.normalize=function(t,e){var r=t.x,i=t.y,o=t.z,c=t.w,l=Math.sqrt(r*r+i*i+o*o+c*c);l>L.zeroTolerance&&(l=1/l,e.x=r*l,e.y=i*l,e.z=o*l,e.w=c*l)},n.rotationX=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e.x=r,e.y=0,e.z=0,e.w=i},n.rotationY=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e.x=0,e.y=r,e.z=0,e.w=i},n.rotationZ=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e.x=0,e.y=0,e.z=r,e.w=i},n.rotateX=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=t.w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r.x=i*h+l*u,r.y=o*h+c*u,r.z=c*h-o*u,r.w=l*h-i*u},n.rotateY=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=t.w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r.x=i*h-c*u,r.y=o*h+l*u,r.z=c*h+i*u,r.w=l*h-o*u},n.rotateZ=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=t.w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r.x=i*h+o*u,r.y=o*h-i*u,r.z=c*h+l*u,r.w=l*h-c*u},n.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e,r.w=t.w*e};function n(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=1),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=a,this.y=t,this.z=e,this.w=r}var s=n.prototype;return s.setValue=function(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},s.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},s.getAxisAngle=function(t){var e=this.x,r=this.y,i=this.z,o=e*e+r*r+i*i;if(o<L.zeroTolerance)return t.x=1,t.y=0,t.z=0,0;var c=1/o;return t.x=this.x*c,t.y=this.y*c,t.z=this.z*c,Math.acos(this.w)*2},s.identity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},s.length=function(){var t=this.x,e=this.y,r=this.z,i=this.w;return Math.sqrt(t*t+e*e+r*r+i*i)},s.lengthSquared=function(){var t=this.x,e=this.y,r=this.z,i=this.w;return t*t+e*e+r*r+i*i},s.normalize=function(){return n.normalize(this,this),this},s.toEuler=function(t){this.toYawPitchRoll(t);var e=t.x;return t.x=t.y,t.y=e,t},s.toYawPitchRoll=function(t){var e=this.x,r=this.y,i=this.z,o=this.w,c=e*e,l=r*r,u=i*i,h=e*r,d=i*o,f=i*e,_=r*o,v=r*i,p=e*o;return t.y=Math.asin(2*(p-v)),Math.cos(t.y)>L.zeroTolerance?(t.z=Math.atan2(2*(h+d),1-2*(u+c)),t.x=Math.atan2(2*(f+_),1-2*(l+c))):(t.z=Math.atan2(-2*(h-d),1-2*(l+u)),t.x=0),t},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w},s.clone=function(){return new n(this.x,this.y,this.z,this.w)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w,t},s.rotateX=function(t){return n.rotateX(this,t,this),this},s.rotateY=function(t){return n.rotateY(this,t,this),this},s.rotateZ=function(t){return n.rotateZ(this,t,this),this},s.rotationAxisAngle=function(t,e){return n.rotationAxisAngle(t,e,this),this},s.multiply=function(t){return n.multiply(this,t,this),this},s.invert=function(){return n.invert(this,this),this},s.dot=function(t){return n.dot(this,t)},s.lerp=function(t,e){return n.lerp(this,t,e,this),this},s.rotateAxisAngle=function(t,e){return n._tempQuat1.rotationAxisAngle(t,e),this.multiply(n._tempQuat1),this},n}();he._tempVector3=new x;he._tempQuat1=new he;var j=function(){n.multiply=function(t,e,r){var i=t.elements,o=e.elements,c=r.elements,l=i[0],u=i[1],h=i[2],d=i[3],f=i[4],_=i[5],v=i[6],p=i[7],g=i[8],m=i[9],y=i[10],w=i[11],P=i[12],A=i[13],b=i[14],M=i[15],S=o[0],T=o[1],z=o[2],R=o[3],E=o[4],N=o[5],D=o[6],V=o[7],U=o[8],G=o[9],O=o[10],K=o[11],ee=o[12],re=o[13],Z=o[14],se=o[15];c[0]=l*S+f*T+g*z+P*R,c[1]=u*S+_*T+m*z+A*R,c[2]=h*S+v*T+y*z+b*R,c[3]=d*S+p*T+w*z+M*R,c[4]=l*E+f*N+g*D+P*V,c[5]=u*E+_*N+m*D+A*V,c[6]=h*E+v*N+y*D+b*V,c[7]=d*E+p*N+w*D+M*V,c[8]=l*U+f*G+g*O+P*K,c[9]=u*U+_*G+m*O+A*K,c[10]=h*U+v*G+y*O+b*K,c[11]=d*U+p*G+w*O+M*K,c[12]=l*ee+f*re+g*Z+P*se,c[13]=u*ee+_*re+m*Z+A*se,c[14]=h*ee+v*re+y*Z+b*se,c[15]=d*ee+p*re+w*Z+M*se},n.equals=function(t,e){var r=t.elements,i=e.elements;return L.equals(r[0],i[0])&&L.equals(r[1],i[1])&&L.equals(r[2],i[2])&&L.equals(r[3],i[3])&&L.equals(r[4],i[4])&&L.equals(r[5],i[5])&&L.equals(r[6],i[6])&&L.equals(r[7],i[7])&&L.equals(r[8],i[8])&&L.equals(r[9],i[9])&&L.equals(r[10],i[10])&&L.equals(r[11],i[11])&&L.equals(r[12],i[12])&&L.equals(r[13],i[13])&&L.equals(r[14],i[14])&&L.equals(r[15],i[15])},n.lerp=function(t,e,r,i){var o=t.elements,c=e.elements,l=i.elements,u=1-r;l[0]=o[0]*u+c[0]*r,l[1]=o[1]*u+c[1]*r,l[2]=o[2]*u+c[2]*r,l[3]=o[3]*u+c[3]*r,l[4]=o[4]*u+c[4]*r,l[5]=o[5]*u+c[5]*r,l[6]=o[6]*u+c[6]*r,l[7]=o[7]*u+c[7]*r,l[8]=o[8]*u+c[8]*r,l[9]=o[9]*u+c[9]*r,l[10]=o[10]*u+c[10]*r,l[11]=o[11]*u+c[11]*r,l[12]=o[12]*u+c[12]*r,l[13]=o[13]*u+c[13]*r,l[14]=o[14]*u+c[14]*r,l[15]=o[15]*u+c[15]*r},n.rotationQuaternion=function(t,e){var r=e.elements,i=t.x,o=t.y,c=t.z,l=t.w,u=i+i,h=o+o,d=c+c,f=i*u,_=o*u,v=o*h,p=c*u,g=c*h,m=c*d,y=l*u,w=l*h,P=l*d;r[0]=1-v-m,r[1]=_+P,r[2]=p-w,r[3]=0,r[4]=_-P,r[5]=1-f-m,r[6]=g+y,r[7]=0,r[8]=p+w,r[9]=g-y,r[10]=1-f-v,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.rotationAxisAngle=function(t,e,r){var i=r.elements,o=t.x,c=t.y,l=t.z,u=Math.sqrt(o*o+c*c+l*l),h,d,f;Math.abs(u)<L.zeroTolerance||(u=1/u,o*=u,c*=u,l*=u,h=Math.sin(e),d=Math.cos(e),f=1-d,i[0]=o*o*f+d,i[1]=c*o*f+l*h,i[2]=l*o*f-c*h,i[3]=0,i[4]=o*c*f-l*h,i[5]=c*c*f+d,i[6]=l*c*f+o*h,i[7]=0,i[8]=o*l*f+c*h,i[9]=c*l*f-o*h,i[10]=l*l*f+d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1)},n.rotationTranslation=function(t,e,r){n.rotationQuaternion(t,r);var i=r.elements;i[12]=e.x,i[13]=e.y,i[14]=e.z},n.affineTransformation=function(t,e,r,i){var o=i.elements,c=e.x,l=e.y,u=e.z,h=e.w,d=c+c,f=l+l,_=u+u,v=c*d,p=c*f,g=c*_,m=l*f,y=l*_,w=u*_,P=h*d,A=h*f,b=h*_,M=t.x,S=t.y,T=t.z;o[0]=(1-(m+w))*M,o[1]=(p+b)*M,o[2]=(g-A)*M,o[3]=0,o[4]=(p-b)*S,o[5]=(1-(v+w))*S,o[6]=(y+P)*S,o[7]=0,o[8]=(g+A)*T,o[9]=(y-P)*T,o[10]=(1-(v+m))*T,o[11]=0,o[12]=r.x,o[13]=r.y,o[14]=r.z,o[15]=1},n.scaling=function(t,e){var r=e.elements;r[0]=t.x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t.y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t.z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1},n.invert=function(t,e){var r=t.elements,i=e.elements,o=r[0],c=r[1],l=r[2],u=r[3],h=r[4],d=r[5],f=r[6],_=r[7],v=r[8],p=r[9],g=r[10],m=r[11],y=r[12],w=r[13],P=r[14],A=r[15],b=o*d-c*h,M=o*f-l*h,S=o*_-u*h,T=c*f-l*d,z=c*_-u*d,R=l*_-u*f,E=v*w-p*y,N=v*P-g*y,D=v*A-m*y,V=p*P-g*w,U=p*A-m*w,G=g*A-m*P,O=b*G-M*U+S*V+T*D-z*N+R*E;if(!O)return null;O=1/O,i[0]=(d*G-f*U+_*V)*O,i[1]=(l*U-c*G-u*V)*O,i[2]=(w*R-P*z+A*T)*O,i[3]=(g*z-p*R-m*T)*O,i[4]=(f*D-h*G-_*N)*O,i[5]=(o*G-l*D+u*N)*O,i[6]=(P*S-y*R-A*M)*O,i[7]=(v*R-g*S+m*M)*O,i[8]=(h*U-d*D+_*E)*O,i[9]=(c*D-o*U-u*E)*O,i[10]=(y*z-w*S+A*b)*O,i[11]=(p*S-v*z-m*b)*O,i[12]=(d*N-h*V-f*E)*O,i[13]=(o*V-c*N+l*E)*O,i[14]=(w*M-y*T-P*b)*O,i[15]=(v*T-p*M+g*b)*O},n.lookAt=function(t,e,r,i){var o=i.elements,c=n._tempVec30,l=n._tempVec31,u=n._tempVec32;x.subtract(t,e,u),u.normalize(),x.cross(r,u,c),c.normalize(),x.cross(u,c,l),o[0]=c.x,o[1]=l.x,o[2]=u.x,o[3]=0,o[4]=c.y,o[5]=l.y,o[6]=u.y,o[7]=0,o[8]=c.z,o[9]=l.z,o[10]=u.z,o[11]=0,o[12]=-x.dot(c,t),o[13]=-x.dot(l,t),o[14]=-x.dot(u,t),o[15]=1},n.ortho=function(t,e,r,i,o,c,l){var u=l.elements,h=1/(t-e),d=1/(r-i),f=1/(o-c);u[0]=-2*h,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*d,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*f,u[11]=0,u[12]=(t+e)*h,u[13]=(i+r)*d,u[14]=(c+o)*f,u[15]=1},n.perspective=function(t,e,r,i,o){var c=o.elements,l=1/Math.tan(t/2),u=1/(r-i);c[0]=l/e,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=l,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=(i+r)*u,c[11]=-1,c[12]=0,c[13]=0,c[14]=2*i*r*u,c[15]=0},n.rotateAxisAngle=function(t,e,r,i){var o=e.x,c=e.y,l=e.z,u=Math.sqrt(o*o+c*c+l*l);if(!(Math.abs(u)<L.zeroTolerance)){var h=t.elements,d=i.elements,f,_,v;u=1/u,o*=u,c*=u,l*=u,f=Math.sin(r),_=Math.cos(r),v=1-_;var p=h[0],g=h[1],m=h[2],y=h[3],w=h[4],P=h[5],A=h[6],b=h[7],M=h[8],S=h[9],T=h[10],z=h[11],R=o*o*v+_,E=c*o*v+l*f,N=l*o*v-c*f,D=o*c*v-l*f,V=c*c*v+_,U=l*c*v+o*f,G=o*l*v+c*f,O=c*l*v-o*f,K=l*l*v+_;d[0]=p*R+w*E+M*N,d[1]=g*R+P*E+S*N,d[2]=m*R+A*E+T*N,d[3]=y*R+b*E+z*N,d[4]=p*D+w*V+M*U,d[5]=g*D+P*V+S*U,d[6]=m*D+A*V+T*U,d[7]=y*D+b*V+z*U,d[8]=p*G+w*O+M*K,d[9]=g*G+P*O+S*K,d[10]=m*G+A*O+T*K,d[11]=y*G+b*O+z*K,t!==i&&(d[12]=h[12],d[13]=h[13],d[14]=h[14],d[15]=h[15])}},n.scale=function(t,e,r){var i=t.elements,o=r.elements,c=e.x,l=e.y,u=e.z;o[0]=i[0]*c,o[1]=i[1]*c,o[2]=i[2]*c,o[3]=i[3]*c,o[4]=i[4]*l,o[5]=i[5]*l,o[6]=i[6]*l,o[7]=i[7]*l,o[8]=i[8]*u,o[9]=i[9]*u,o[10]=i[10]*u,o[11]=i[11]*u,o[12]=i[12],o[13]=i[13],o[14]=i[14],o[15]=i[15]},n.translate=function(t,e,r){var i=t.elements,o=r.elements,c=e.x,l=e.y,u=e.z;if(t===r)o[12]=i[0]*c+i[4]*l+i[8]*u+i[12],o[13]=i[1]*c+i[5]*l+i[9]*u+i[13],o[14]=i[2]*c+i[6]*l+i[10]*u+i[14],o[15]=i[3]*c+i[7]*l+i[11]*u+i[15];else{var h=i[0],d=i[1],f=i[2],_=i[3],v=i[4],p=i[5],g=i[6],m=i[7],y=i[8],w=i[9],P=i[10],A=i[11];o[0]=h,o[1]=d,o[2]=f,o[3]=_,o[4]=v,o[5]=p,o[6]=g,o[7]=m,o[8]=y,o[9]=w,o[10]=P,o[11]=A,o[12]=h*c+v*l+y*u+i[12],o[13]=d*c+p*l+w*u+i[13],o[14]=f*c+g*l+P*u+i[14],o[15]=_*c+m*l+A*u+i[15]}},n.transpose=function(t,e){var r=t.elements,i=e.elements;if(e===t){var o=r[1],c=r[2],l=r[3],u=r[6],h=r[7],d=r[11];i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=o,i[6]=r[9],i[7]=r[13],i[8]=c,i[9]=u,i[11]=r[14],i[12]=l,i[13]=h,i[14]=d}else i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15]};function n(a,t,e,r,i,o,c,l,u,h,d,f,_,v,p,g){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),i===void 0&&(i=0),o===void 0&&(o=1),c===void 0&&(c=0),l===void 0&&(l=0),u===void 0&&(u=0),h===void 0&&(h=0),d===void 0&&(d=1),f===void 0&&(f=0),_===void 0&&(_=0),v===void 0&&(v=0),p===void 0&&(p=0),g===void 0&&(g=1),this.elements=new Float32Array(16);var m=this.elements;m[0]=a,m[1]=t,m[2]=e,m[3]=r,m[4]=i,m[5]=o,m[6]=c,m[7]=l,m[8]=u,m[9]=h,m[10]=d,m[11]=f,m[12]=_,m[13]=v,m[14]=p,m[15]=g}var s=n.prototype;return s.setValue=function(t,e,r,i,o,c,l,u,h,d,f,_,v,p,g,m){var y=this.elements;return y[0]=t,y[1]=e,y[2]=r,y[3]=i,y[4]=o,y[5]=c,y[6]=l,y[7]=u,y[8]=h,y[9]=d,y[10]=f,y[11]=_,y[12]=v,y[13]=p,y[14]=g,y[15]=m,this},s.setValueByArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,i=0;i<16;i++)r[i]=t[i+e];return this},s.toArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},s.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]);return e},s.cloneTo=function(t){var e=this.elements,r=t.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],t},s.multiply=function(t){return n.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],i=t[2],o=t[3],c=t[4],l=t[5],u=t[6],h=t[7],d=t[8],f=t[9],_=t[10],v=t[11],p=t[12],g=t[13],m=t[14],y=t[15],w=e*l-r*c,P=e*u-i*c,A=e*h-o*c,b=r*u-i*l,M=r*h-o*l,S=i*h-o*u,T=d*g-f*p,z=d*m-_*p,R=d*y-v*p,E=f*m-_*g,N=f*y-v*g,D=_*y-v*m;return w*D-P*N+A*E+b*R-M*z+S*T},s.decompose=function(t,e,r){var i=n._tempMat30,o=this.elements,c=i.elements,l=o[0],u=o[1],h=o[2],d=o[3],f=o[4],_=o[5],v=o[6],p=o[7],g=o[8],m=o[9],y=o[10],w=o[11];t.x=o[12],t.y=o[13],t.z=o[14];var P=Math.sign(l*u*h*d)<0?-1:1,A=Math.sign(f*_*v*p)<0?-1:1,b=Math.sign(g*m*y*w)<0?-1:1,M=P*Math.sqrt(l*l+u*u+h*h),S=A*Math.sqrt(f*f+_*_+v*v),T=b*Math.sqrt(g*g+m*m+y*y);if(r.x=M,r.y=S,r.z=T,Math.abs(M)<L.zeroTolerance||Math.abs(S)<L.zeroTolerance||Math.abs(T)<L.zeroTolerance)return e.identity(),!1;var z=1/M,R=1/S,E=1/T;return c[0]=l*z,c[1]=u*z,c[2]=h*z,c[3]=f*R,c[4]=_*R,c[5]=v*R,c[6]=g*E,c[7]=m*E,c[8]=y*E,he.rotationMatrix3x3(i,e),!0},s.getRotation=function(t){var e=this.elements,r=e[0]+e[5]+e[10];if(r>L.zeroTolerance){var i=Math.sqrt(r+1)*2;t.w=.25*i,t.x=(e[6]-e[9])/i,t.y=(e[8]-e[2])/i,t.z=(e[1]-e[4])/i}else if(e[0]>e[5]&&e[0]>e[10]){var o=Math.sqrt(1+e[0]-e[5]-e[10])*2;t.w=(e[6]-e[9])/o,t.x=.25*o,t.y=(e[1]+e[4])/o,t.z=(e[8]+e[2])/o}else if(e[5]>e[10]){var c=Math.sqrt(1+e[5]-e[0]-e[10])*2;t.w=(e[8]-e[2])/c,t.x=(e[1]+e[4])/c,t.y=.25*c,t.z=(e[6]+e[9])/c}else{var l=Math.sqrt(1+e[10]-e[0]-e[5])*2;t.w=(e[1]-e[4])/l,t.x=(e[8]+e[2])/l,t.y=(e[6]+e[9])/l,t.z=.25*l}return t},s.getScaling=function(t){var e=this.elements,r=e[0],i=e[1],o=e[2],c=e[4],l=e[5],u=e[6],h=e[8],d=e[9],f=e[10];return t.x=Math.sqrt(r*r+i*i+o*o),t.y=Math.sqrt(c*c+l*l+u*u),t.z=Math.sqrt(h*h+d*d+f*f),t},s.getTranslation=function(t){var e=this.elements;return t.x=e[12],t.y=e[13],t.z=e[14],t},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},s.invert=function(){return n.invert(this,this),this},s.rotateAxisAngle=function(t,e){return n.rotateAxisAngle(this,t,e,this),this},s.scale=function(t){return n.scale(this,t,this),this},s.translate=function(t){return n.translate(this,t,this),this},s.transpose=function(){return n.transpose(this,this),this},n}();j._tempVec30=new x;j._tempVec31=new x;j._tempVec32=new x;j._tempMat30=new Or;j._identity=new j(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var dc=function(){function n(a,t){a===void 0&&(a=null),t===void 0&&(t=null),this.origin=new x,this.direction=new x,a&&a.cloneTo(this.origin),t&&t.cloneTo(this.direction)}var s=n.prototype;return s.intersectPlane=function(t){return pr.intersectsRayAndPlane(this,t)},s.intersectSphere=function(t){return pr.intersectsRayAndSphere(this,t)},s.intersectBox=function(t){return pr.intersectsRayAndBox(this,t)},s.getPoint=function(t,e){return x.scale(this.direction,t,e),e.add(this.origin)},n}(),k=function(){n.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y},n.subtract=function(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y},n.multiply=function(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y},n.divide=function(t,e,r){r.x=t.x/e.x,r.y=t.y/e.y},n.dot=function(t,e){return t.x*e.x+t.y*e.y},n.distance=function(t,e){var r=e.x-t.x,i=e.y-t.y;return Math.sqrt(r*r+i*i)},n.distanceSquared=function(t,e){var r=e.x-t.x,i=e.y-t.y;return r*r+i*i},n.equals=function(t,e){return L.equals(t.x,e.x)&&L.equals(t.y,e.y)},n.lerp=function(t,e,r,i){var o=t.x,c=t.y;i.x=o+(e.x-o)*r,i.y=c+(e.y-c)*r},n.max=function(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y)},n.min=function(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y)},n.negate=function(t,e){e.x=-t.x,e.y=-t.y},n.normalize=function(t,e){var r=t.x,i=t.y,o=Math.sqrt(r*r+i*i);o>L.zeroTolerance&&(o=1/o,e.x=r*o,e.y=i*o)},n.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e};function n(a,t){a===void 0&&(a=0),t===void 0&&(t=0),this.x=void 0,this.y=void 0,this.x=a,this.y=t}var s=n.prototype;return s.setValue=function(t,e){return this.x=t,this.y=e,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this},s.add=function(t){return this.x+=t.x,this.y+=t.y,this},s.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},s.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},s.divide=function(t){return this.x/=t.x,this.y/=t.y,this},s.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},s.lengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},s.negate=function(){return this.x=-this.x,this.y=-this.y,this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this.x*=t,this.y*=t,this},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y},s.clone=function(){return new n(this.x,this.y)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t},n}();k._zero=new k(0,0);k._one=new k(1,1);var ve=function(){n.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z,r.w=t.w+e.w},n.subtract=function(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z,r.w=t.w-e.w},n.multiply=function(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z,r.w=t.w*e.w},n.divide=function(t,e,r){r.x=t.x/e.x,r.y=t.y/e.y,r.z=t.z/e.z,r.w=t.w/e.w},n.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},n.distance=function(t,e){var r=e.x-t.x,i=e.y-t.y,o=e.z-t.z,c=e.w-t.w;return Math.sqrt(r*r+i*i+o*o+c*c)},n.distanceSquared=function(t,e){var r=e.x-t.x,i=e.y-t.y,o=e.z-t.z,c=e.w-t.w;return r*r+i*i+o*o+c*c},n.equals=function(t,e){return L.equals(t.x,e.x)&&L.equals(t.y,e.y)&&L.equals(t.z,e.z)&&L.equals(t.w,e.w)},n.lerp=function(t,e,r,i){var o=t.x,c=t.y,l=t.z,u=t.w;i.x=o+(e.x-o)*r,i.y=c+(e.y-c)*r,i.z=l+(e.z-l)*r,i.w=u+(e.w-u)*r},n.max=function(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y),r.z=Math.max(t.z,e.z),r.w=Math.max(t.w,e.w)},n.min=function(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y),r.z=Math.min(t.z,e.z),r.w=Math.min(t.w,e.w)},n.negate=function(t,e){e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w},n.normalize=function(t,e){var r=t.x,i=t.y,o=t.z,c=t.w,l=Math.sqrt(r*r+i*i+o*o+c*c);l>L.zeroTolerance&&(l=1/l,e.x=r*l,e.y=i*l,e.z=o*l,e.w=c*l)},n.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e,r.w=t.w*e},n.transform=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=t.w,u=e.elements;r.x=i*u[0]+o*u[4]+c*u[8]+l*u[12],r.y=i*u[1]+o*u[5]+c*u[9]+l*u[13],r.z=i*u[2]+o*u[6]+c*u[10]+l*u[14],r.w=i*u[3]+o*u[7]+c*u[11]+l*u[15]},n.transformByQuat=function(t,e,r){var i=t.x,o=t.y,c=t.z,l=t.w,u=e.x,h=e.y,d=e.z,f=e.w,_=f*i+h*c-d*o,v=f*o+d*i-u*c,p=f*c+u*o-h*i,g=-u*i-h*o-d*c;r.x=_*f-g*u-v*d+p*h,r.y=v*f-g*h-p*u+_*d,r.z=p*f-g*d-_*h+v*u,r.w=l};function n(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=a,this.y=t,this.z=e,this.w=r}var s=n.prototype;return s.setValue=function(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},s.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},s.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},s.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},s.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},s.length=function(){var t=this.x,e=this.y,r=this.z,i=this.w;return Math.sqrt(t*t+e*e+r*r+i*i)},s.lengthSquared=function(){var t=this.x,e=this.y,r=this.z,i=this.w;return t*t+e*e+r*r+i*i},s.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w},s.clone=function(){var t=new n(this.x,this.y,this.z,this.w);return t},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w,t},n}();ve._zero=new ve(0,0,0,0);ve._one=new ve(1,1,1,1);var Q=function(){n.gammaToLinearSpace=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},n.linearToGammaSpace=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},n.equals=function(t,e){return L.equals(t.r,e.r)&&L.equals(t.g,e.g)&&L.equals(t.b,e.b)&&L.equals(t.a,e.a)},n.add=function(t,e,r){return r.r=t.r+e.r,r.g=t.g+e.g,r.b=t.b+e.b,r.a=t.a+e.a,r},n.scale=function(t,e,r){return r.r=t.r*e,r.g=t.g*e,r.b=t.b*e,r.a=t.a*e,r};function n(a,t,e,r){a===void 0&&(a=1),t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=a,this.g=t,this.b=e,this.a=r}var s=n.prototype;return s.setValue=function(t,e,r,i){return this.r=t,this.g=e,this.b=r,this.a=i,this},s.add=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},s.scale=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},s.clone=function(){var t=new n(this.r,this.g,this.b,this.a);return t},s.cloneTo=function(t){return t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t},s.toLinear=function(t){return t.r=n.gammaToLinearSpace(this.r),t.g=n.gammaToLinearSpace(this.g),t.b=n.gammaToLinearSpace(this.b),t},s.toGamma=function(t){return t.r=n.linearToGammaSpace(this.r),t.g=n.linearToGammaSpace(this.g),t.b=n.linearToGammaSpace(this.b),t},n}(),tn=function(){function n(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=a,this.y=t,this.width=e,this.height=r}var s=n.prototype;return s.setValue=function(t,e,r,i){return this.x=t,this.y=e,this.width=r,this.height=i,this},s.clone=function(){return new n(this.x,this.y,this.width,this.height)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t},n}(),fc=function(){function n(){this.coefficients=new Float32Array(27)}var s=n.prototype;return s.addLight=function(t,e,r){e.scale(r);var i=this.coefficients,o=t.x,c=t.y,l=t.z,u=e.r,h=e.g,d=e.b,f=.282095,_=-.488603*c,v=.488603*l,p=-.488603*o,g=1.092548*(o*c),m=-1.092548*(c*l),y=.315392*(3*l*l-1),w=-1.092548*(o*l),P=.546274*(o*o-c*c);i[0]+=u*f,i[1]+=h*f,i[2]+=d*f,i[3]+=u*_,i[4]+=h*_,i[5]+=d*_,i[6]+=u*v,i[7]+=h*v,i[8]+=d*v,i[9]+=u*p,i[10]+=h*p,i[11]+=d*p,i[12]+=u*g,i[13]+=h*g,i[14]+=d*g,i[15]+=u*m,i[16]+=h*m,i[17]+=d*m,i[18]+=u*y,i[19]+=h*y,i[20]+=d*y,i[21]+=u*w,i[22]+=h*w,i[23]+=d*w,i[24]+=u*P,i[25]+=h*P,i[26]+=d*P},s.evaluate=function(t,e){var r=this.coefficients,i=t.x,o=t.y,c=t.z,l=.886227,u=-1.023327*o,h=1.023327*c,d=-1.023327*i,f=.858086*o*i,_=-.858086*o*c,v=.247708*(3*c*c-1),p=-.858086*c*i,g=.429042*(i*i-o*o),m=r[0]*l,y=r[1]*l,w=r[2]*l;return m+=r[3]*u+r[6]*h+r[9]*d,y+=r[4]*u+r[7]*h+r[10]*d,w+=r[5]*u+r[8]*h+r[11]*d,m+=r[12]*f+r[15]*_+r[18]*v+r[21]*p+r[24]*g,y+=r[13]*f+r[16]*_+r[19]*v+r[22]*p+r[25]*g,w+=r[14]*f+r[17]*_+r[20]*v+r[23]*p+r[26]*g,e.setValue(m,y,w,1),e},s.scale=function(t){var e=this.coefficients;e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e[12]*=t,e[13]*=t,e[14]*=t,e[15]*=t,e[16]*=t,e[17]*=t,e[18]*=t,e[19]*=t,e[20]*=t,e[21]*=t,e[22]*=t,e[23]*=t,e[24]*=t,e[25]*=t,e[26]*=t},s.setValueByArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;r[0]=t[e],r[1]=t[1+e],r[2]=t[2+e],r[3]=t[3+e],r[4]=t[4+e],r[5]=t[5+e],r[6]=t[6+e],r[7]=t[7+e],r[8]=t[8+e],r[9]=t[9+e],r[10]=t[10+e],r[11]=t[11+e],r[12]=t[12+e],r[13]=t[13+e],r[14]=t[14+e],r[15]=t[15+e],r[16]=t[16+e],r[17]=t[17+e],r[18]=t[18+e],r[19]=t[19+e],r[20]=t[20+e],r[21]=t[21+e],r[22]=t[22+e],r[23]=t[23+e],r[24]=t[24+e],r[25]=t[25+e],r[26]=t[26+e]},s.toArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;t[0+e]=r[0],t[1+e]=r[1],t[2+e]=r[2],t[3+e]=r[3],t[4+e]=r[4],t[5+e]=r[5],t[6+e]=r[6],t[7+e]=r[7],t[8+e]=r[8],t[9+e]=r[9],t[10+e]=r[10],t[11+e]=r[11],t[12+e]=r[12],t[13+e]=r[13],t[14+e]=r[14],t[15+e]=r[15],t[16+e]=r[16],t[17+e]=r[17],t[18+e]=r[18],t[19+e]=r[19],t[20+e]=r[20],t[21+e]=r[21],t[22+e]=r[22],t[23+e]=r[23],t[24+e]=r[24],t[25+e]=r[25],t[26+e]=r[26]},s.clone=function(){var t=new n;return this.cloneTo(t),t},s.cloneTo=function(t){return this.toArray(t.coefficients),t},n}();function Sn(n,s){var a=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);s&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),a.push.apply(a,t)}return a}function An(n){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?Sn(Object(a),!0).forEach(function(t){_c(n,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):Sn(Object(a)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(a,t))})}return n}function Mn(n,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function W(n,s,a){return s&&Mn(n.prototype,s),a&&Mn(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}function _c(n,s,a){return s in n?Object.defineProperty(n,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[s]=a,n}function ii(){return ii=Object.assign||function(n){for(var s=1;s<arguments.length;s++){var a=arguments[s];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(n[t]=a[t])}return n},ii.apply(this,arguments)}function X(n,s){n.prototype=Object.create(s.prototype),n.prototype.constructor=n,ni(n,s)}function rn(n){return rn=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},rn(n)}function ni(n,s){return ni=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},ni(n,s)}function vc(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ti(n,s,a){return vc()?Ti=Reflect.construct:Ti=function(e,r,i){var o=[null];o.push.apply(o,r);var c=Function.bind.apply(e,o),l=new c;return i&&ni(l,i.prototype),l},Ti.apply(null,arguments)}function pc(n){return Function.toString.call(n).indexOf("[native code]")!==-1}function nn(n){var s=typeof Map=="function"?new Map:void 0;return nn=function(t){if(t===null||!pc(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(typeof s!="undefined"){if(s.has(t))return s.get(t);s.set(t,e)}function e(){return Ti(t,arguments,rn(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),ni(e,t)},nn(n)}function B(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function gc(n,s){if(!!n){if(typeof n=="string")return Cn(n,s);var a=Object.prototype.toString.call(n).slice(8,-1);if(a==="Object"&&n.constructor&&(a=n.constructor.name),a==="Map"||a==="Set")return Array.from(n);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Cn(n,s)}}function Cn(n,s){(s==null||s>n.length)&&(s=n.length);for(var a=0,t=new Array(s);a<s;a++)t[a]=n[a];return t}function mc(n,s){var a=typeof Symbol!="undefined"&&n[Symbol.iterator]||n["@@iterator"];if(a)return(a=a.call(n)).next.bind(a);if(Array.isArray(n)||(a=gc(n))||s&&n&&typeof n.length=="number"){a&&(n=a);var t=0;return function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function I(n,s,a,t){!a||Object.defineProperty(n,s,{enumerable:a.enumerable,configurable:a.configurable,writable:a.writable,value:a.initializer?a.initializer.call(t):void 0})}function F(n,s,a,t,e){var r={};return Object.keys(t).forEach(function(i){r[i]=t[i]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=a.slice().reverse().reduce(function(i,o){return o(n,s,i)||i},r),e&&r.initializer!==void 0&&(r.value=r.initializer?r.initializer.call(e):void 0,r.initializer=void 0),r.initializer===void 0&&(Object.defineProperty(n,s,r),r=null),r}function yc(n,s){var a=n.indexOf(s);if(a<0)return!1;var t=n.length-1;if(a!==t){var e=n[t];n[a]=e}return n.length--,!0}function ai(n){return Object.keys(n).map(function(s){return n[s]})}var Lr;(function(n){n[n.Success=0]="Success",n[n.Pending=1]="Pending",n[n.Failed=2]="Failed"})(Lr||(Lr={}));var tt=function(n){X(a,n),a.all=function(e){return new a(function(r,i,o){if(!Array.isArray(e))return r([e]);var c=0,l=e.length,u=new Array(l);e.forEach(function(h,d){Promise.resolve(h).then(function(f){u[d]=f,c+=1,o(c/l),c==l&&r(u)}).catch(function(f){return i(f)})})})};var s=a.prototype;s.onProgress=function(e){return this._listeners.add(e),this},s.cancel=function(){return this._status!==Lr.Pending?this:(this._reject("Promise Canceled"),this)};function a(t){var e,r,i=function(c){if(!(c<=e._progress)){e._progress=c;for(var l=mc(e._listeners),u;!(u=l()).done;){var h=u.value;h(c)}}};return e=n.call(this,function(o,c){r=function(u){Promise.resolve().then(function(){e._status=Lr.Failed,c(u)})},t(function(l){Promise.resolve().then(function(){i(1),e._status=Lr.Success,o(l)})},r,function(l){Promise.resolve().then(function(){i(l)})})})||this,e._status=void 0,e._progress=void 0,e._reject=void 0,e._listeners=void 0,e._reject=r,e._listeners=new Set,e._progress=0,e._status=Lr.Pending,e}return W(a,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),a}(nn(Promise)),Gi=function(){n._addLoader=function(t,e,r){this._loaders[t]=e;for(var i=0,o=r.length;i<o;i++)this._extTypeMapping[r[i]]=t},n._getTypeByUrl=function(t){var e=t.split("?")[0];return this._extTypeMapping[e.substring(e.lastIndexOf(".")+1)]};function n(a){this.engine=a,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}var s=n.prototype;return s.load=function(t){var e=this;if(!Array.isArray(t))return this._loadSingleItem(t);var r=t.map(function(i){return e._loadSingleItem(i)});return tt.all(r)},s.cancelNotLoaded=function(t){var e=this;if(!t)ai(this._loadingPromises).forEach(function(i){i.cancel()});else if(typeof t=="string"){var r;(r=this._loadingPromises[t])===null||r===void 0||r.cancel()}else t.forEach(function(i){var o;(o=e._loadingPromises[i])===null||o===void 0||o.cancel()})},s.gc=function(){this._gc(!1)},s.getAssetPath=function(t){return this._assetPool[t]},s._addAsset=function(t,e){this._assetPool[e.instanceId]=t,this._assetUrlPool[t]=e},s._deleteAsset=function(t){var e=t.instanceId,r=this._assetPool[e];r&&(delete this._assetPool[e],delete this._assetUrlPool[r])},s._addRefObject=function(t,e){this._refObjectPool[t]=e},s._deleteRefObject=function(t){delete this._refObjectPool[t]},s._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._refObjectPool=null,this._loadingPromises=null},s._assignDefaultOptions=function(t){var e,r,i,o,c;if(t.type=(e=t.type)!=null?e:n._getTypeByUrl(t.url),t.type===void 0)throw"asset type should be specified: "+t.url;return t.retryCount=(r=t.retryCount)!=null?r:this.retryCount,t.timeout=(i=t.timeout)!=null?i:this.timeout,t.retryInterval=(o=t.retryInterval)!=null?o:this.retryInterval,t.url=(c=t.url)!=null?c:t.urls.join(","),t},s._loadSingleItem=function(t){var e=this,r=this._assignDefaultOptions(typeof t=="string"?{url:t}:t),i=r.url;if(this._assetUrlPool[i])return new tt(function(l){l(e._assetUrlPool[i])});if(this._loadingPromises[i])return this._loadingPromises[r.url];var o=n._loaders[r.type],c=o.load(r,this);return this._loadingPromises[i]=c,c.then(function(l){o.useCache&&e._addAsset(i,l),delete e._loadingPromises[i]}).catch(function(l){Promise.reject(l),delete e._loadingPromises[i]}),c},s._gc=function(t){for(var e=ai(this._refObjectPool),r=0,i=e.length;r<i;r++)(!e[r].isGCIgnored||t)&&e[r].destroy()},n}();Gi._loaders={};Gi._extTypeMapping={};function jt(n,s,a){return a===void 0&&(a=!0),function(t){var e=new t(a);Gi._addLoader(n,e,s)}}var Tn=function(){function n(a,t,e,r){t===void 0&&(t=null),e===void 0&&(e={}),r===void 0&&(r=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=new Date().getTime(),this._target=t,this.data=e,this._currentTarget=null,this._bubbles=r,this._propagationStopped=!1,this._type=a}var s=n.prototype;return s.stopPropagation=function(){this._propagationStopped=!0},W(n,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(t){this._target=t}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(t){this._currentTarget=t}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),n}(),Gt;(function(n){n[n.Ignore=0]="Ignore",n[n.Assignment=1]="Assignment",n[n.Shallow=2]="Shallow",n[n.Deep=3]="Deep"})(Gt||(Gt={}));function q(n,s){yt.registerCloneMode(n,s,Gt.Ignore)}function Tt(n,s){yt.registerCloneMode(n,s,Gt.Assignment)}function xc(n,s){yt.registerCloneMode(n,s,Gt.Shallow)}function ye(n,s){yt.registerCloneMode(n,s,Gt.Deep)}var yt=function(){function n(){}return n.registerCloneMode=function(a,t,e){var r=n._subCloneModeMap.get(a.constructor);r||(r=Object.create(null),n._subCloneModeMap.set(a.constructor,r)),r[t]=e},n.getCloneMode=function(a){var t=n._cloneModeMap.get(a);if(!t){t=Object.create(null),n._cloneModeMap.set(a,t);for(var e=n._objectType,r=n._subCloneModeMap;a!==e;){var i=r.get(a);i&&ii(t,i),a=Object.getPrototypeOf(a)}}return t},n.deepCloneObject=function(a,t){var e=a.constructor;switch(e){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:t.set(a);break;case Array:for(var r=0,i=a.length;r<i;r++)n._deepCloneObjectItem(a,t,r);break;default:var o=a;if(o.clone&&o.cloneTo)o.cloneTo(t);else for(var c=Object.keys(a),l=0,u=c.length;l<u;l++)n._deepCloneObjectItem(a,t,c[l])}},n._deepCloneObjectItem=function(a,t,e){var r=a[e];if(r instanceof Object){var i=r.constructor;switch(i){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var o=r,c=t[e];c==null?t[e]=o.slice():c.set(o);break;case Array:var l=r,u=t[e];u==null?t[e]=new Array(l.length):u.length=l.length,n.deepCloneObject(l,u);break;default:if(r.clone&&r.cloneTo){var h=r,d=t[e];d?h.cloneTo(d):t[e]=h.clone()}else{var f=t[e];f==null&&(t[e]=f=new r.constructor),n.deepCloneObject(r,f);break}}}else t[e]=r},n}();yt._subCloneModeMap=new Map;yt._cloneModeMap=new Map;yt._objectType=Object.getPrototypeOf(Object);var Qi,Rn,Ss=(Qi=function(){function n(){I(this,"_evts",Rn,this),this._evtCount=0}var s=n.prototype;return s.hasEvent=function(t){return this._evts[t]!=null},s.eventNames=function(){return this._evtCount===0?[]:Object.keys(this._evts)},s.listenerCount=function(t){var e=this._evts[t];return e?e.fn?1:e.length:0},s.dispatch=function(t,e){if(!this._evts[t])return!1;var r=this._evts[t];if(r.fn)r.once&&this.removeEventListener(t,r.fn),r.fn(e);else for(var i=r.length,o=0;o<i;o++)r[o].once&&this.removeEventListener(t,r[o].fn),r[o].fn(e);return!0},s.on=function(t,e){return this.addEventListener(t,e)},s.once=function(t,e){return this.addEventListener(t,e,!0)},s.addEventListener=function(t,e,r){var i={fn:e,once:r},o=this._evts;return o[t]?o[t].fn?o[t]=[o[t],i]:o[t].push(i):(o[t]=i,this._evtCount++),this},s.off=function(t,e){if(!this._evts[t])return this;if(!e)return this._clearEvent(t),this;var r=this._evts[t];if(r.fn&&r.fn===e)this._clearEvent(t);else{var i=r.indexOf(e);if(i>-1){var o=r[r.length-1];r[i]=o,r.length--,r.length===1&&(this._evts[t]=r[0])}}return this},s.removeEventListener=function(t,e){return this.off(t,e)},s.removeAllEventListeners=function(t){t?this._evts[t]&&this._clearEvent(t):(this._evts=Object.create(null),this._evtCount=0)},s.trigger=function(t){this.dispatch(t.type,t.data)},s._clearEvent=function(t){--this._evtCount===0?this._evts=Object.create(null):delete this._evts[t]},n}(),Rn=F(Qi.prototype,"_evts",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),Qi),qt=function(s){},wc=console.log.bind(console),bc=console.info.bind(console),Pc=console.warn.bind(console),Sc=console.error.bind(console),ht={debug:qt,info:qt,warn:qt,error:qt,isEnabled:!1,enable:function(){this.debug=wc,this.info=bc,this.warn=Pc,this.error=Sc,this.isEnabled=!0},disable:function(){this.debug=qt,this.info=qt,this.warn=qt,this.error=qt,this.isEnabled=!1}},Ac=function(){function n(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var a=this._clock.now();this._startTime=a,this._lastTickTime=a}var s=n.prototype;return s.reset=function(){this._lastTickTime=this._clock.now()},s.tick=function(){var t=this.nowTime;this._deltaTime=(t-this._lastTickTime)*this._timeScale,this._lastTickTime=t},W(n,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(t){this._timeScale=t}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),n}(),Ai,zn,En,Yi,sr=(Ai=(Yi=function(){function n(a){I(this,"instanceId",zn,this),I(this,"_engine",En,this),this._destroyed=!1,this._engine=a}var s=n.prototype;return s.destroy=function(){var t;this._destroyed||((t=this._engine.resourceManager)===null||t===void 0||t._deleteAsset(this),this._destroyed=!0)},W(n,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),n}(),Yi._instanceIdCounter=0,Yi),zn=F(Ai.prototype,"instanceId",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++sr._instanceIdCounter}}),En=F(Ai.prototype,"_engine",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ai),we;(function(n){n[n.FLOAT=5126]="FLOAT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT=5124]="INT",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.FLOAT_ARRAY=35677]="FLOAT_ARRAY",n[n.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",n[n.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",n[n.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",n[n.INT_ARRAY=100003]="INT_ARRAY",n[n.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",n[n.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",n[n.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",n[n.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",n[n.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",n[n.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",n[n.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",n[n.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n[n.SAMPLER_CUBE=35680]="SAMPLER_CUBE",n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT"})(we||(we={}));var Ve;(function(n){n.shaderVertexID="shaderVertexID",n.standardDerivatives="OES_standard_derivatives",n.shaderTextureLod="EXT_shader_texture_lod",n.elementIndexUint="OES_element_index_uint",n.depthTexture="WEBGL_depth_texture",n.drawBuffers="WEBGL_draw_buffers",n.vertexArrayObject="OES_vertex_array_object",n.instancedArrays="ANGLE_instanced_arrays",n.multipleSample="multipleSampleOnlySupportedInWebGL2",n.textureFloat="OES_texture_float",n.textureFloatLinear="OES_texture_float_linear",n.textureHalfFloat="OES_texture_half_float",n.textureHalfFloatLinear="OES_texture_half_float_linear",n.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",n.colorBufferFloat="EXT_color_buffer_float",n.colorBufferHalfFloat="EXT_color_buffer_half_float",n.textureFilterAnisotropic="EXT_texture_filter_anisotropic",n.blendMinMax="EXT_blend_minmax",n.astc="WEBGL_compressed_texture_astc",n.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",n.etc="WEBGL_compressed_texture_etc",n.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",n.etc1="WEBGL_compressed_texture_etc1",n.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",n.pvrtc="WEBGL_compressed_texture_pvrtc",n.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",n.s3tc="WEBGL_compressed_texture_s3tc",n.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc"})(Ve||(Ve={}));var It=function(){function n(a){a===void 0&&(a=0),this._elements=void 0,this.length=0,this._elements=new Array(a)}var s=n.prototype;return s.add=function(t){this.length===this._elements.length?this._elements.push(t):this._elements[this.length]=t,this.length++},s.delete=function(t){var e=this._elements.indexOf(t);this.deleteByIndex(e)},s.get=function(t){if(t>=this.length)throw"Index is out of range.";return this._elements[t]},s.deleteByIndex=function(t){var e=this._elements,r=null,i=this.length-1;return t!==i&&(r=e[i],e[t]=r),this.length--,r},s.garbageCollection=function(){this._elements.length=this.length},n}(),rt=function(){function n(){this._mask=[],this._length=0}n.unionCollection=function(t,e,r){var i=r._mask,o,c,l,u;t._length<e._length?(o=t._length,c=e._length,l=t._mask,u=e._mask):(o=e._length,c=t._length,l=e._mask,u=t._mask);var h=0;for(i.length<c&&(i.length=c);h<o;h++)i[h]=l[h]|u[h];for(;h<c;h++)i[h]=u[h];r._length=c};var s=n.prototype;return s.enable=function(t){var e=t._index,r=e+1,i=this._mask,o=this._length;if(o<r){for(i.length<r&&(i.length=r);o<e;o++)i[o]=0;i[e]=t._value,this._length=r}else i[e]|=t._value},s.disable=function(t){var e=t._index,r=this._mask,i=this._length-1;if(!(e>i)){var o=r[e]&~t._value;e==i&&o===0?this._length--:r[e]=o}},s.unionCollection=function(t){var e=t._mask,r=t._length,i=this._mask,o=this._length;if(o<r){i.length<r&&(i.length=r);for(var c=0;c<o;c++)i[c]|=e[c];for(;c<r;c++)i[c]=e[c];this._length=r}else for(var l=0;l<r;l++)i[l]|=e[l]},s.complementaryCollection=function(t){for(var e=t._mask,r=this._mask,i=this._length-1,o=Math.min(t._length-1,i);o>=0;o--){var c=r[o]&~e[o];o==i&&c===0?(i--,this._length--):r[o]=c}},s.intersectionCollection=function(t){for(var e=t._mask,r=this._mask,i=this._length-1;i>=0;i--){var o=r[i]&e[i];o==0&&i==this._length-1?this._length--:r[i]=o}},s.isEnable=function(t){var e=t._index;return e>=this._length?!1:(this._mask[e]&t._value)!==0},s.clear=function(){this._length=0},n}(),fn=function(){function n(){this._onStartScripts=new It,this._onUpdateScripts=new It,this._onLateUpdateScripts=new It,this._destroyComponents=[],this._onUpdateAnimations=new It,this._renderers=new It,this._onUpdateRenderers=new It,this._componentsContainerPool=[],this._colliders=new It}var s=n.prototype;return s.addRenderer=function(t){t._rendererIndex=this._renderers.length,this._renderers.add(t)},s.removeRenderer=function(t){var e=this._renderers.deleteByIndex(t._rendererIndex);e&&(e._rendererIndex=t._rendererIndex),t._rendererIndex=-1},s.addOnStartScript=function(t){t._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(t)},s.removeOnStartScript=function(t){var e=this._onStartScripts.deleteByIndex(t._onStartIndex);e&&(e._onStartIndex=t._onStartIndex),t._onStartIndex=-1},s.addCollider=function(t){t._index=this._colliders.length,this._colliders.add(t)},s.removeCollider=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1},s.addOnUpdateScript=function(t){t._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(t)},s.removeOnUpdateScript=function(t){var e=this._onUpdateScripts.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnLateUpdateScript=function(t){t._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(t)},s.removeOnLateUpdateScript=function(t){var e=this._onLateUpdateScripts.deleteByIndex(t._onLateUpdateIndex);e&&(e._onLateUpdateIndex=t._onLateUpdateIndex),t._onLateUpdateIndex=-1},s.addOnUpdateAnimations=function(t){t._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(t)},s.removeOnUpdateAnimations=function(t){var e=this._onUpdateAnimations.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnUpdateRenderers=function(t){t._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(t)},s.removeOnUpdateRenderers=function(t){var e=this._onUpdateRenderers.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addDestroyComponent=function(t){this._destroyComponents.push(t)},s.callScriptOnStart=function(){var t=this._onStartScripts;if(t.length>0){for(var e=t._elements,r=0;r<t.length;r++){var i=e[r];i._started=!0,i._onStartIndex=-1,i.onStart()}t.length=0}},s.callScriptOnUpdate=function(t){for(var e=this._onUpdateScripts._elements,r=this._onUpdateScripts.length-1;r>=0;--r){var i=e[r];i._started&&i.onUpdate(t)}},s.callScriptOnLateUpdate=function(t){for(var e=this._onLateUpdateScripts._elements,r=this._onLateUpdateScripts.length-1;r>=0;--r){var i=e[r];i._started&&i.onLateUpdate(t)}},s.callAnimationUpdate=function(t){for(var e=this._onUpdateAnimations._elements,r=this._onUpdateAnimations.length-1;r>=0;--r)e[r].update(t)},s.callRendererOnUpdate=function(t){for(var e=this._onUpdateRenderers._elements,r=this._onUpdateRenderers.length-1;r>=0;--r)e[r].update(t)},s.callRender=function(t){for(var e=t._camera,r=this._renderers._elements,i=this._renderers.length-1;i>=0;--i){var o=r[i];if(!!(e.cullingMask&o._entity.layer)&&!(e.enableFrustumCulling&&(o.isCulled=!e._frustum.intersectsBox(o.bounds),o.isCulled))){var c=e.entity.transform,l=c.worldPosition,u=o.bounds.getCenter(n._tempVector0);if(e.isOrthographic){var h=c.getWorldForward(n._tempVector1);x.subtract(u,l,u),o._distanceForSort=x.dot(u,h)}else o._distanceForSort=x.distanceSquared(u,l);o._updateShaderData(t),o._render(e),rt.unionCollection(e._globalShaderMacro,o.shaderData._macroCollection,o._globalShaderMacro)}}},s.callComponentDestroy=function(){var t=this._destroyComponents,e=t.length;if(e>0){for(var r=e-1;r>=0;--r)t[r].onDestroy();t.length=0}},s.callCameraOnBeginRender=function(t){for(var e=t.entity._components,r=e.length-1;r>=0;--r){var i=e[r];i.onBeginRender&&i.onBeginRender(t)}},s.callCameraOnEndRender=function(t){for(var e=t.entity._components,r=e.length-1;r>=0;--r){var i=e[r];i.onEndRender&&i.onEndRender(t)}},s.callColliderOnUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onUpdate()},s.callColliderOnLateUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onLateUpdate()},s.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},s.putActiveChangedTempList=function(t){t.length=0,this._componentsContainerPool.push(t)},n}();fn._tempVector0=new x;fn._tempVector1=new x;var Mc=function(){function n(){}return n.cloneComponent=function(a,t){for(var e=yt.getCloneMode(a.constructor),r=Object.keys(a),i=0,o=r.length;i<o;i++){var c=r[i],l=e[c];switch(l){case void 0:case Gt.Assignment:t[c]=a[c];break;case Gt.Shallow:var u=a[c];if(u instanceof Object){var h=t[c];h==null&&(h=t[c]=u.constructor()),ii(h,u)}else t[c]=u;break;case Gt.Deep:var d=a[c];if(d instanceof Object){var f=t[c];f==null&&(f=t[c]=d.constructor()),yt.deepCloneObject(d,f)}else t[c]=d;break}}a._cloneTo&&a._cloneTo(t)},n}(),oi=function(){n.register=function(a,t){this._addDependency(a,t,this._dependenciesMap),this._addDependency(t,a,this._invDependenciesMap)},n._addCheck=function(a,t){var e=n._dependenciesMap.get(t);if(e){for(var r=0,i=e.length;r<i;r++)if(!a.getComponent(e[r]))throw"you should add "+e[r]+" before adding "+t}},n._removeCheck=function(a,t){var e=n._invDependenciesMap.get(t);if(e){for(var r=0,i=e.length;r<i;r++)if(a.getComponent(e[r]))throw"you should remove "+e[r]+" before adding "+t}},n._addDependency=function(a,t,e){var r=e.get(a);r||(r=[],e.set(a,r)),r.indexOf(t)===-1&&r.push(t)};function n(){}return n}();oi._dependenciesMap=new Map;oi._invDependenciesMap=new Map;function Cc(){for(var n=arguments.length,s=new Array(n),a=0;a<n;a++)s[a]=arguments[a];return function(t){s.forEach(function(e){return oi.register(t,e)})}}var ot;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything",n[n.Nothing=0]="Nothing"})(ot||(ot={}));var Rr,Bn,Dn,On,Ln,dt=(Rr=function(n){X(s,n);function s(t){var e;return e=n.call(this,t.engine)||this,I(e,"_entity",Bn,B(e)),I(e,"_destroyed",Dn,B(e)),I(e,"_enabled",On,B(e)),I(e,"_awoken",Ln,B(e)),e._entity=t,e}var a=s.prototype;return a.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&(this._enabled&&this._onDisable(),this._onInActive()),this._destroyed=!0,this._onDestroy())},a._onAwake=function(){},a._onEnable=function(){},a._onDisable=function(){},a._onDestroy=function(){},a._onActive=function(){},a._onInActive=function(){},a._setActive=function(e){e?(this._awoken||(this._awoken=!0,this._onAwake()),this._entity._isActiveInHierarchy&&(this._onActive(),this._enabled&&this._onEnable())):(this._enabled&&this._onDisable(),this._onInActive())},W(s,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),s}(sr),Bn=F(Rr.prototype,"_entity",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Dn=F(Rr.prototype,"_destroyed",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),On=F(Rr.prototype,"_enabled",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ln=F(Rr.prototype,"_awoken",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rr),Tc=function(){function n(a){a===void 0&&(a=[]),this._flags=a,this.flag=!0,this._flags.push(this)}var s=n.prototype;return s.destroy=function(){var t=this._flags;yc(t,this),this._flags=null},n}(),ui=function(){function n(){this._updateFlags=[]}var s=n.prototype;return s.register=function(){return new Tc(this._updateFlags)},s.distribute=function(){for(var t=this._updateFlags,e=t.length-1;e>=0;e--)t[e].flag=!0},n}(),We,In,Fn,Nn,Un,Vn,Gn,kn,Hn,Wn,jn,Xn,Kn,qn,ft,Rt=(We=(ft=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,I(t,"_position",In,B(t)),I(t,"_rotation",Fn,B(t)),I(t,"_rotationQuaternion",Nn,B(t)),I(t,"_scale",Un,B(t)),I(t,"_worldPosition",Vn,B(t)),I(t,"_worldRotation",Gn,B(t)),I(t,"_worldRotationQuaternion",kn,B(t)),I(t,"_lossyWorldScale",Hn,B(t)),I(t,"_localMatrix",Wn,B(t)),I(t,"_worldMatrix",jn,B(t)),I(t,"_updateFlagManager",Xn,B(t)),I(t,"_isParentDirty",Kn,B(t)),I(t,"_parentTransformCache",qn,B(t)),t._dirtyFlag=$.WmWpWeWqWs,t}var a=s.prototype;return a.setPosition=function(e,r,i){this._position.setValue(e,r,i),this.position=this._position},a.setRotation=function(e,r,i){this._rotation.setValue(e,r,i),this.rotation=this._rotation},a.setRotationQuaternion=function(e,r,i,o){this._rotationQuaternion.setValue(e,r,i,o),this.rotationQuaternion=this._rotationQuaternion},a.setScale=function(e,r,i){this._scale.setValue(e,r,i),this.scale=this._scale},a.setWorldPosition=function(e,r,i){this._worldPosition.setValue(e,r,i),this.worldPosition=this._worldPosition},a.setWorldRotation=function(e,r,i){this._worldRotation.setValue(e,r,i),this.worldRotation=this._worldRotation},a.setWorldRotationQuaternion=function(e,r,i,o){this._worldRotationQuaternion.setValue(e,r,i,o),this.worldRotationQuaternion=this._worldRotationQuaternion},a.getWorldForward=function(e){var r=this.worldMatrix.elements;return e.setValue(-r[8],-r[9],-r[10]),e.normalize()},a.getWorldRight=function(e){var r=this.worldMatrix.elements;return e.setValue(r[0],r[1],r[2]),e.normalize()},a.getWorldUp=function(e){var r=this.worldMatrix.elements;return e.setValue(r[4],r[5],r[6]),e.normalize()},a.translate=function(e,r,i,o){if(typeof e=="number"){var c=s._tempVec3;c.setValue(e,r,i),this._translate(c,o)}else this._translate(e,r)},a.rotate=function(e,r,i,o){typeof e=="number"?this._rotateXYZ(e,r,i,o):this._rotateXYZ(e.x,e.y,e.z,r)},a.rotateByAxis=function(e,r,i){i===void 0&&(i=!0);var o=r*L.degreeToRadFactor;he.rotationAxisAngle(e,o,s._tempQuat0),this._rotateByQuat(s._tempQuat0,i)},a.lookAt=function(e,r){var i,o=this.worldPosition,c=L.zeroTolerance;if(!(Math.abs(o.x-e.x)<c&&Math.abs(o.y-e.y)<c&&Math.abs(o.z-e.z)<c)){var l=s._tempMat43,u=this._worldRotationQuaternion;r=(i=r)!=null?i:s._tempVec3.setValue(0,1,0),j.lookAt(o,e,r,l),l.getRotation(u).invert(),this.worldRotationQuaternion=u}},a.registerWorldChangeFlag=function(){return this._updateFlagManager.register()},a._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},a._isFrontFaceInvert=function(){var e=this.lossyWorldScale,r=e.x<0;return e.y<0&&(r=!r),e.z<0&&(r=!r),r},a._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags($.WmWp)){this._worldAssociatedChange($.WmWp);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionFlag()}}},a._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags($.WmWeWq)){this._worldAssociatedChange($.WmWeWq);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndRotationFlag()}}},a._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags($.WmWpWeWq)){this._worldAssociatedChange($.WmWpWeWq);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndRotationFlag()}}},a._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags($.WmWs)){this._worldAssociatedChange($.WmWs);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndScaleFlag()}}},a._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags($.WmWpWs)){this._worldAssociatedChange($.WmWpWs);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndScaleFlag()}}},a._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags($.WmWpWeWqWs)){this._worldAssociatedChange($.WmWpWeWqWs);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateAllWorldFlag()}}},a._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,r=this._entity.parent;r;){var i=r.transform;if(i){e=i;break}else r=r.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},a._getScaleMatrix=function(){var e=s._tempQuat0,r=s._tempMat30,i=s._tempMat31,o=s._tempMat32;return i.setValueByMatrix(this.worldMatrix),he.invert(this.worldRotationQuaternion,e),Or.rotationQuaternion(e,r),Or.multiply(r,i,o),o},a._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},a._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.distribute()},a._rotateByQuat=function(e,r){r?(he.multiply(this.rotationQuaternion,e,this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion):(he.multiply(this.worldRotationQuaternion,e,this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion)},a._translate=function(e,r){r===void 0&&(r=!0),r?this.position=this._position.add(e):this.worldPosition=this._worldPosition.add(e)},a._rotateXYZ=function(e,r,i,o){o===void 0&&(o=!0);var c=L.degreeToRadFactor,l=s._tempQuat0;he.rotationEuler(e*c,r*c,i*c,l),this._rotateByQuat(l,o)},W(s,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position),this._setDirtyFlagTrue($.LocalMatrix),this._updateWorldPositionFlag()}},{key:"worldPosition",get:function(){return this._isContainDirtyFlag($.WorldPosition)&&(this._getParentTransform()?this.worldMatrix.getTranslation(this._worldPosition):this._position.cloneTo(this._worldPosition),this._setDirtyFlagFalse($.WorldPosition)),this._worldPosition},set:function(e){this._worldPosition!==e&&e.cloneTo(this._worldPosition);var r=this._getParentTransform();r?(j.invert(r.worldMatrix,s._tempMat41),x.transformCoordinate(e,s._tempMat41,this._position)):e.cloneTo(this._position),this.position=this._position,this._setDirtyFlagFalse($.WorldPosition)}},{key:"rotation",get:function(){return this._isContainDirtyFlag($.LocalEuler)&&(this._rotationQuaternion.toEuler(this._rotation),this._rotation.scale(L.radToDegreeFactor),this._setDirtyFlagFalse($.LocalEuler)),this._rotation},set:function(e){this._rotation!==e&&e.cloneTo(this._rotation),this._setDirtyFlagTrue($.LocalMatrix|$.LocalQuat),this._setDirtyFlagFalse($.LocalEuler),this._updateWorldRotationFlag()}},{key:"worldRotation",get:function(){return this._isContainDirtyFlag($.WorldEuler)&&(this.worldRotationQuaternion.toEuler(this._worldRotation),this._worldRotation.scale(L.radToDegreeFactor),this._setDirtyFlagFalse($.WorldEuler)),this._worldRotation},set:function(e){this._worldRotation!==e&&e.cloneTo(this._worldRotation),he.rotationEuler(L.degreeToRadian(e.x),L.degreeToRadian(e.y),L.degreeToRadian(e.z),this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion,this._setDirtyFlagFalse($.WorldEuler)}},{key:"rotationQuaternion",get:function(){return this._isContainDirtyFlag($.LocalQuat)&&(he.rotationEuler(L.degreeToRadian(this._rotation.x),L.degreeToRadian(this._rotation.y),L.degreeToRadian(this._rotation.z),this._rotationQuaternion),this._setDirtyFlagFalse($.LocalQuat)),this._rotationQuaternion},set:function(e){this._rotationQuaternion!==e&&e.cloneTo(this._rotationQuaternion),this._setDirtyFlagTrue($.LocalMatrix|$.LocalEuler),this._setDirtyFlagFalse($.LocalQuat),this._updateWorldRotationFlag()}},{key:"worldRotationQuaternion",get:function(){if(this._isContainDirtyFlag($.WorldQuat)){var e=this._getParentTransform();e!=null?he.multiply(e.worldRotationQuaternion,this.rotationQuaternion,this._worldRotationQuaternion):this.rotationQuaternion.cloneTo(this._worldRotationQuaternion),this._setDirtyFlagFalse($.WorldQuat)}return this._worldRotationQuaternion},set:function(e){this._worldRotationQuaternion!==e&&e.cloneTo(this._worldRotationQuaternion);var r=this._getParentTransform();r?(he.invert(r.worldRotationQuaternion,s._tempQuat0),he.multiply(e,s._tempQuat0,this._rotationQuaternion)):e.cloneTo(this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion,this._setDirtyFlagFalse($.WorldQuat)}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&e.cloneTo(this._scale),this._setDirtyFlagTrue($.LocalMatrix),this._updateWorldScaleFlag()}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag($.WorldScale)){if(this._getParentTransform()){var e=this._getScaleMatrix(),r=e.elements;this._lossyWorldScale.setValue(r[0],r[4],r[8])}else this._scale.cloneTo(this._lossyWorldScale);this._setDirtyFlagFalse($.WorldScale)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag($.LocalMatrix)&&(j.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse($.LocalMatrix)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue($.LocalEuler),this._setDirtyFlagFalse($.LocalMatrix),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag($.WorldMatrix)){var e=this._getParentTransform();e?j.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setDirtyFlagFalse($.WorldMatrix)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&e.cloneTo(this._worldMatrix);var r=this._getParentTransform();r?(j.invert(r.worldMatrix,s._tempMat42),j.multiply(e,s._tempMat42,this._localMatrix)):e.cloneTo(this._localMatrix),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse($.WorldMatrix)}}]),s}(dt),ft._tempQuat0=new he,ft._tempVec3=new x,ft._tempMat30=new Or,ft._tempMat31=new Or,ft._tempMat32=new Or,ft._tempMat40=new j,ft._tempMat41=new j,ft._tempMat42=new j,ft._tempMat43=new j,ft),In=F(We.prototype,"_position",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x}}),Fn=F(We.prototype,"_rotation",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x}}),Nn=F(We.prototype,"_rotationQuaternion",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new he}}),Un=F(We.prototype,"_scale",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x(1,1,1)}}),Vn=F(We.prototype,"_worldPosition",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x}}),Gn=F(We.prototype,"_worldRotation",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x}}),kn=F(We.prototype,"_worldRotationQuaternion",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new he}}),Hn=F(We.prototype,"_lossyWorldScale",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x(1,1,1)}}),Wn=F(We.prototype,"_localMatrix",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),jn=F(We.prototype,"_worldMatrix",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),Xn=F(We.prototype,"_updateFlagManager",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ui}}),Kn=F(We.prototype,"_isParentDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qn=F(We.prototype,"_parentTransformCache",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),We),$;(function(n){n[n.LocalEuler=1]="LocalEuler",n[n.LocalQuat=2]="LocalQuat",n[n.WorldPosition=4]="WorldPosition",n[n.WorldEuler=8]="WorldEuler",n[n.WorldQuat=16]="WorldQuat",n[n.WorldScale=32]="WorldScale",n[n.LocalMatrix=64]="LocalMatrix",n[n.WorldMatrix=128]="WorldMatrix",n[n.WmWp=132]="WmWp",n[n.WmWeWq=152]="WmWeWq",n[n.WmWpWeWq=156]="WmWpWeWq",n[n.WmWs=160]="WmWs",n[n.WmWpWs=164]="WmWpWs",n[n.WmWpWeWqWs=188]="WmWpWeWqWs"})($||($={}));var Ut=function(n){X(s,n),s._findChildByName=function(e,r){for(var i=e._children,o=i.length-1;o>=0;o--){var c=i[o];if(c.name===r)return c}return null},s._traverseSetOwnerScene=function(e,r){e._scene=r;for(var i=e._children,o=e.childCount-1;o>=0;o--)this._traverseSetOwnerScene(i[o],r)};function s(t,e){var r;return r=n.call(this,t)||this,r.name=void 0,r.layer=ot.Layer0,r.transform=void 0,r._isActiveInHierarchy=!1,r._components=[],r._scripts=new It,r._children=[],r._scene=void 0,r._isRoot=!1,r._isActive=!0,r._parent=null,r._activeChangedComponents=void 0,r._invModelMatrix=new j,r._inverseWorldMatFlag=void 0,r.name=e,r.transform=r.addComponent(Rt),r._inverseWorldMatFlag=r.transform.registerWorldChangeFlag(),r}var a=s.prototype;return a.addComponent=function(e){oi._addCheck(this,e);var r=new e(this);return this._components.push(r),this._isActiveInHierarchy&&r._setActive(!0),r},a.getComponent=function(e){for(var r=this._components.length-1;r>=0;r--){var i=this._components[r];if(i instanceof e)return i}},a.getComponents=function(e,r){r.length=0;for(var i=this._components.length-1;i>=0;i--){var o=this._components[i];o instanceof e&&r.push(o)}return r},a.getComponentsIncludeChildren=function(e,r){return r.length=0,this._getComponentsInChildren(e,r),r},a.addChild=function(e){e.parent=this},a.removeChild=function(e){e.parent=null},a.getChild=function(e){return this._children[e]},a.findByName=function(e){var r=this._children,i=s._findChildByName(this,e);if(i)return i;for(var o=r.length-1;o>=0;o--){var c=r[o],l=c.findByName(e);if(l)return l}return null},a.findByPath=function(e){for(var r=e.split("/"),i=this,o=0,c=r.length;o<c;++o){var l=r[o];if(l&&(i=s._findChildByName(i,l),!i))return null}return i},a.createChild=function(e){var r=new s(this.engine,e);return r.layer=this.layer,r.parent=this,r},a.clearChildren=function(){for(var e=this._children,r=e.length-1;r>=0;r--){var i=e[r];i._parent=null,i._isActiveInHierarchy&&i._processInActive(),s._traverseSetOwnerScene(i,null)}e.length=0},a.clone=function(){var e=new s(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var r=this._children,i=0,o=this._children.length;i<o;i++){var c=r[i];e.addChild(c.clone())}for(var l=this._components,u=0,h=l.length;u<h;u++){var d=l[u];if(!(d instanceof Rt)){var f=e.addComponent(d.constructor);Mc.cloneComponent(d,f)}}return e},a.destroy=function(){if(!this._destroyed){n.prototype.destroy.call(this);for(var e=this._components,r=e.length-1;r>=0;r--)e[r].destroy();this._components.length=0;for(var i=this._children,o=i.length-1;o>=0;o--)i[o].destroy();if(this._children.length=0,this._parent!=null){var c=this._parent._children;c.splice(c.indexOf(this),1)}this._parent=null}},a._removeComponent=function(e){oi._removeCheck(this,e.constructor);var r=this._components;r.splice(r.indexOf(e),1)},a._addScript=function(e){e._entityCacheIndex=this._scripts.length,this._scripts.add(e)},a._removeScript=function(e){var r=this._scripts.deleteByIndex(e._entityCacheIndex);r&&(r._entityCacheIndex=e._entityCacheIndex),e._entityCacheIndex=-1},a._removeFromParent=function(){var e=this._parent;if(e!=null){var r=e._children;r.splice(r.indexOf(this),1),this._parent=null}return e},a._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},a._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},a._getComponentsInChildren=function(e,r){for(var i=this._components.length-1;i>=0;i--){var o=this._components[i];o instanceof e&&r.push(o)}for(var c=this._children.length-1;c>=0;c--)this._children[c]._getComponentsInChildren(e,r)},a._setActiveComponents=function(e){for(var r=this._activeChangedComponents,i=0,o=r.length;i<o;++i)r[i]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(r),this._activeChangedComponents=null},a._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var r=this._components,i=r.length-1;i>=0;i--)e.push(r[i]);for(var o=this._children,c=o.length-1;c>=0;c--){var l=o[c];l.isActive&&l._setActiveInHierarchy(e)}},a._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var r=this._components,i=r.length-1;i>=0;i--)e.push(r[i]);for(var o=this._children,c=o.length-1;c>=0;c--){var l=o[c];l.isActive&&l._setInActiveInHierarchy(e)}},a._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,r=this._children.length;e<r;e++)this._children[e]._setTransformDirty()},a.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(j.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},W(s,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var r=this._parent;(r!=null&&r._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){if(e!==this._parent){var r=this._removeFromParent(),i=this._parent=e;if(i){i._children.push(this);var o=i._scene;this._scene!==o&&s._traverseSetOwnerScene(this,o),i._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),r&&s._traverseSetOwnerScene(this,null);this._setTransformDirty()}}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"position",get:function(){return this.transform.position},set:function(e){this.transform.position=e}},{key:"worldPosition",get:function(){return this.transform.worldPosition},set:function(e){this.transform.worldPosition=e}},{key:"rotation",get:function(){return this.transform.rotationQuaternion},set:function(e){this.transform.rotationQuaternion=e}},{key:"scale",get:function(){return this.transform.scale},set:function(e){this.transform.scale=e}}]),s}(sr),As=function(){function n(){this._features=[],this._objects=[]}var s=n.prototype;return s.registerFeature=function(t){for(var e=this._features,r=0,i=e.length;r<i;r++)if(e[r]===t)return;e.push(t);for(var o=this._objects,c=0,l=o.length;c<l;c++)o[c].features.push(new t)},s.addObject=function(t){t.features=[];for(var e=0,r=this._features.length;e<r;e++){var i;t.features.push(new this._features[e]((i=t.engine)!=null?i:t))}this._objects.push(t)},s.callFeatureMethod=function(t,e,r){for(var i=t.features,o=i.length,c=0;c<o;c++){var l=i[c];l[e]&&l[e].apply(l,r)}},s.findFeature=function(t,e){for(var r=t.features,i=r.length,o=0;o<i;o++){var c=r[o];if(c.constructor===e)return c}},n}(),xr;(function(n){n[n.DepthColor=0]="DepthColor",n[n.Depth=1]="Depth",n[n.None=2]="None"})(xr||(xr={}));var Rc=function(){this.entity=null,this.distance=0,this.point=new x,this.normal=new x},Di;(function(n){n[n.Average=0]="Average",n[n.Minimum=1]="Minimum",n[n.Multiply=2]="Multiply",n[n.Maximum=3]="Maximum"})(Di||(Di={}));var gr;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(gr||(gr={}));var Bt=function(){function n(){var a=this;this._nativePhysicsManager=void 0,this._physicalObjectsMap={},this._onContactEnter=function(t,e){},this._onContactExit=function(t,e){},this._onContactStay=function(t,e){},this._onTriggerEnter=function(t,e){for(var r=a._physicalObjectsMap[t],i=a._physicalObjectsMap[e],o=r.collider.entity._scripts,c=0,l=o.length;c<l;c++)o.get(c).onTriggerEnter(i);o=i.collider.entity._scripts;for(var u=0,h=o.length;u<h;u++)o.get(u).onTriggerEnter(r)},this._onTriggerExit=function(t,e){for(var r=a._physicalObjectsMap[t],i=a._physicalObjectsMap[e],o=r.collider.entity._scripts,c=0,l=o.length;c<l;c++)o.get(c).onTriggerExit(i);o=i.collider.entity._scripts;for(var u=0,h=o.length;u<h;u++)o.get(u).onTriggerExit(r)},this._onTriggerStay=function(t,e){for(var r=a._physicalObjectsMap[t],i=a._physicalObjectsMap[e],o=r.collider.entity._scripts,c=0,l=o.length;c<l;c++)o.get(c).onTriggerStay(i);o=i.collider.entity._scripts;for(var u=0,h=o.length;u<h;u++)o.get(u).onTriggerStay(r)},this._nativePhysicsManager=n._nativePhysics.createPhysicsManager(this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay)}var s=n.prototype;return s.raycast=function(t,e,r,i){var o=this,c,l=Number.MAX_VALUE;typeof e=="number"?l=e:e!=null&&(c=e);var u=ot.Everything;if(typeof r=="number"?u=r:r!=null&&(c=r),i&&(c=i),c!=null){var h=this._nativePhysicsManager.raycast(t,l,function(d,f,_,v){c.entity=o._physicalObjectsMap[d]._collider.entity,c.distance=f,v.cloneTo(c.normal),_.cloneTo(c.point)});return h?c.entity.layer&u?!0:(c.entity=null,c.distance=0,c.point.setValue(0,0,0),c.normal.setValue(0,0,0),!1):!1}else return this._nativePhysicsManager.raycast(t,l)},s._update=function(t){this._nativePhysicsManager.update(t)},s._addColliderShape=function(t){this._physicalObjectsMap[t.id]=t,this._nativePhysicsManager.addColliderShape(t._nativeShape)},s._removeColliderShape=function(t){delete this._physicalObjectsMap[t.id],this._nativePhysicsManager.removeColliderShape(t._nativeShape)},s._addCollider=function(t){this._nativePhysicsManager.addCollider(t._nativeCollider)},s._removeCollider=function(t){this._nativePhysicsManager.removeCollider(t._nativeCollider)},n}();Bt._nativePhysics=void 0;var zc=function(){function n(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=Di.Average,this._frictionCombine=Di.Average,this._nativeMaterial=void 0,this._nativeMaterial=Bt._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}return W(n,[{key:"bounciness",get:function(){return this._bounciness},set:function(a){this._bounciness=a,this._nativeMaterial.setBounciness(a)}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(a){this._dynamicFriction=a,this._nativeMaterial.setDynamicFriction(a)}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(a){this._staticFriction=a,this._nativeMaterial.setStaticFriction(a)}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(a){this._bounceCombine=a,this._nativeMaterial.setBounceCombine(a)}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(a){this._frictionCombine=a,this._nativeMaterial.setFrictionCombine(a)}}]),n}(),hi=function(){function n(){this._collider=void 0,this._nativeShape=void 0,this._id=void 0,this._position=new x,this._material=void 0,this._isTrigger=!1,this._isSceneQuery=!0,this._material=new zc,this._id=n._idGenerator++}var s=n.prototype;return s.setPosition=function(t,e,r){this._position.setValue(t,e,r),this._nativeShape.setPosition(this._position)},W(n,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"material",get:function(){return this._material},set:function(t){this._material=t,this._nativeShape.setMaterial(t._nativeMaterial)}},{key:"position",get:function(){return this._position},set:function(t){this._position!==t&&t.cloneTo(this._position),this._nativeShape.setPosition(t)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger=t,this._nativeShape.setIsTrigger(t)}}]),n}();hi._idGenerator=0;var Ec=function(n){X(s,n);function s(){var t;return t=n.call(this)||this,t._size=new x(1,1,1),t._nativeShape=Bt._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t}var a=s.prototype;return a.setSize=function(e,r,i){this._size.x=e,this._size.y=r,this._size.z=i,this._nativeShape.setSize(this._size)},W(s,[{key:"size",get:function(){return this._size},set:function(e){this._size!=e&&e.cloneTo(this._size),this._nativeShape.setSize(e)}}]),s}(hi),Bc=function(n){X(s,n);function s(){var a;return a=n.call(this)||this,a._radius=1,a._nativeShape=Bt._nativePhysics.createSphereColliderShape(a._id,a._radius,a._material._nativeMaterial),a}return W(s,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t,this._nativeShape.setRadius(t)}}]),s}(hi),Dc=function(n){X(s,n);function s(){var t;return t=n.call(this)||this,t._rotation=new x,t._nativeShape=Bt._nativePhysics.createPlaneColliderShape(t._id,t._material._nativeMaterial),t}var a=s.prototype;return a.setRotation=function(e,r,i){this._rotation.setValue(e,r,i),this._nativeShape.setRotation(this._rotation)},W(s,[{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation!=e&&e.cloneTo(this._rotation),this._nativeShape.setRotation(e)}}]),s}(hi),Oc=function(n){X(s,n);function s(){var a;return a=n.call(this)||this,a._radius=1,a._height=2,a._upAxis=gr.Y,a._nativeShape=Bt._nativePhysics.createCapsuleColliderShape(a._id,a._radius,a._height,a._material._nativeMaterial),a._nativeShape.setUpAxis(gr.Y),a}return W(s,[{key:"radius",get:function(){return this._radius},set:function(t){this._nativeShape.setRadius(t)}},{key:"height",get:function(){return this._height},set:function(t){this._nativeShape.setHeight(t)}},{key:"upAxis",get:function(){return this._upAxis},set:function(t){this._upAxis=t,this._nativeShape.setUpAxis(t)}}]),s}(hi),$i,Qn,Ms=($i=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,I(e,"_index",Qn,B(e)),e._nativeCollider=void 0,e._updateFlag=void 0,e._shapes=[],e._updateFlag=e.entity.transform.registerWorldChangeFlag(),e}var a=s.prototype;return a.addShape=function(e){var r=e._collider;r!==this&&(r&&r.removeShape(e),this._shapes.push(e),this.engine.physicsManager._addColliderShape(e),this._nativeCollider.addShape(e._nativeShape),e._collider=this)},a.removeShape=function(e){var r=this._shapes.indexOf(e);r!==-1&&(this._shapes.splice(r,1),this._nativeCollider.removeShape(e._nativeShape),this.engine.physicsManager._removeColliderShape(e),e._collider=null)},a.clearShapes=function(){for(var e=this._shapes,r=0,i=e.length;r<i;r++)this._nativeCollider.removeShape(e[r]._nativeShape),this.engine.physicsManager._removeColliderShape(e[r]);e.length=0},a._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion),this._updateFlag.flag=!1;for(var r=e.lossyWorldScale,i=0,o=this.shapes.length;i<o;i++)this.shapes[i]._nativeShape.setWorldScale(r)}},a._onLateUpdate=function(){},a._onEnable=function(){this.engine.physicsManager._addCollider(this),this.engine._componentsManager.addCollider(this)},a._onDisable=function(){this.engine.physicsManager._removeCollider(this),this.engine._componentsManager.removeCollider(this)},a._onDestroy=function(){this.clearShapes()},W(s,[{key:"shapes",get:function(){return this._shapes}}]),s}(dt),Qn=F($i.prototype,"_index",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$i),Lc=function(n){X(s,n);function s(a){var t;t=n.call(this,a)||this;var e=t.entity.transform;return t._nativeCollider=Bt._nativePhysics.createStaticCollider(e.worldPosition,e.worldRotationQuaternion),t}return s}(Ms),Cs=function(n){X(s,n);function s(t){var e;e=n.call(this,t)||this,e.linearVelocity=void 0,e.angularVelocity=void 0,e.linearDamping=void 0,e.angularDamping=void 0,e.mass=void 0,e.isKinematic=void 0;var r=e.entity.transform;return e._nativeCollider=Bt._nativePhysics.createDynamicCollider(r.worldPosition,r.worldRotationQuaternion),e}var a=s.prototype;return a.applyForce=function(e){this._nativeCollider.addForce(e)},a.applyTorque=function(e){this._nativeCollider.addTorque(e)},a._onLateUpdate=function(){var e=this.entity.transform,r=e.worldPosition,i=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(r,i),e.worldPosition=r,e.worldRotationQuaternion=i,this._updateFlag.flag=!1},s}(Ms),Mt;(function(n){n[n.Down=0]="Down",n[n.Move=1]="Move",n[n.Up=2]="Up",n[n.Leave=3]="Leave"})(Mt||(Mt={}));var Ic=function(s){this.id=void 0,this.phase=Mt.Leave,this.position=new k,this._uniqueID=void 0,this._needUpdate=!0,this.id=s},ki=function(){function n(a){var t=this;this._pointers=[],this._multiPointerEnabled=!0,this._enablePhysics=!1,this._engine=void 0,this._canvas=void 0,this._nativeEvents=[],this._pointerPool=void 0,this._keyEventList=[],this._keyEventCount=0,this._needOverallPointers=!1,this._currentPosition=new k,this._currentPressedEntity=void 0,this._currentEnteredEntity=void 0,this._engine=a,this._canvas=a.canvas;var e=this._canvas._webCanvas;e.style.touchAction="none",e.onpointerdown=e.onpointerup=e.onpointerout=e.onpointermove=function(r){t._nativeEvents.push(r)},this._pointerPool=new Array(11),this._enablePhysics=!!a.physicsManager}var s=n.prototype;return s._update=function(){if(this._needOverallPointers&&this._overallPointers(),this._nativeEvents.length>0&&this._handlePointerEvent(this._nativeEvents),this._enablePhysics){var t=this._pointerRayCast(),e=this._keyEventCount;if(e>0){for(var r=this._keyEventList,i=0;i<e;i++)switch(r[i]){case tr.Down:this._firePointerDown(t);break;case tr.Up:this._firePointerUpAndClick(t);break}this._firePointerExitAndEnter(t),r[e-1]===tr.Leave&&(this._currentPressedEntity=null),this._keyEventCount=0}else this._firePointerDrag(),this._firePointerExitAndEnter(t)}},s._destroy=function(){var t=this._canvas._webCanvas;t.onpointerdown=t.onpointerup=t.onpointerout=t.onpointermove=null,this._nativeEvents.length=0,this._pointerPool.length=0,this._pointers.length=0,this._currentPosition=null,this._currentEnteredEntity=null,this._currentPressedEntity=null,this._engine=null,this._canvas=null},s._overallPointers=function(){for(var t=this._pointers,e=0,r=t.length,i=0;i<r;i++)t[i].phase===Mt.Leave?e++:e>0&&(t[i-e]=t[i]);t.length=r-e,this._needOverallPointers=!1},s._getIndexByPointerID=function(t){for(var e=this._pointers,r=e.length-1;r>=0;r--)if(e[r]._uniqueID===t)return r;return-1},s._addPointer=function(t,e,r,i){var o=this._pointers,c=o.length;if(c===0||this._multiPointerEnabled){for(var l=this._pointerPool,u=0;u<c&&!(o[u].id>u);u++);var h=l[u];h||(h=l[u]=new Ic(u)),h._uniqueID=t,h._needUpdate=!0,h.position.setValue(e,r),h.phase=i,o.splice(u,0,h)}},s._removePointer=function(t){this._pointers[t].phase=Mt.Leave},s._updatePointer=function(t,e,r,i){var o=this._pointers[t];o.position.setValue(e,r),o._needUpdate=!0,o.phase=i},s._handlePointerEvent=function(t){for(var e=this._pointers,r=this._keyEventList,i=e.length,o=t.length,c=0;c<o;c++){var l=t[c],u=this._getIndexByPointerID(l.pointerId);switch(l.type){case"pointerdown":u===-1?(this._addPointer(l.pointerId,l.offsetX,l.offsetY,Mt.Down),i++):this._updatePointer(u,l.offsetX,l.offsetY,Mt.Down),i===1&&(r[this._keyEventCount++]=tr.Down);break;case"pointerup":u>=0&&(this._updatePointer(u,l.offsetX,l.offsetY,Mt.Up),i===1&&(r[this._keyEventCount++]=tr.Up));break;case"pointermove":u===-1?(this._addPointer(l.pointerId,l.offsetX,l.offsetY,Mt.Move),i++):this._updatePointer(u,l.offsetX,l.offsetY,Mt.Move);break;case"pointerout":u>=0&&(this._removePointer(u),--i===0&&(r[this._keyEventCount++]=tr.Leave),this._needOverallPointers=!0);break}}var h=e.length;if(h>0){var d=this._canvas,f=this._currentPosition,_=d.width/d._webCanvas.clientWidth,v=d.height/d._webCanvas.clientHeight;if(i===0){var p=t[o-1];f.setValue(p.offsetX*_,p.offsetY*v)}else{f.setValue(0,0);for(var g=0;g<h;g++){var m=e[g],y=m.position;m._needUpdate&&(y.setValue(y.x*_,y.y*v),m._needUpdate=!1),f.add(y)}f.scale(1/h)}}t.length=0},s._pointerRayCast=function(){if(this._pointers.length>0)for(var t=n._tempPoint,e=n._tempRay,r=n._tempHitResult,i=this._engine.sceneManager.activeScene._activeCameras,o=this._currentPosition.x/this._canvas.width,c=this._currentPosition.y/this._canvas.height,l=i.length-1;l>=0;l--){var u=i[l];if(!(!u.enabled||u.renderTarget)){var h=u.viewport,d=h.x,f=h.y,_=h.z,v=h.w;if(o>=d&&c>=f&&o-d<=_&&c-f<=v){if(t.setValue((o-d)/_,(c-f)/v),this._engine.physicsManager.raycast(u.viewportPointToRay(t,e),r))return r.entity;if(u.clearFlags===xr.DepthColor)return null}}}return null},s._firePointerDrag=function(){if(this._currentPressedEntity)for(var t=this._currentPressedEntity._scripts,e=t.length-1;e>=0;e--)t.get(e).onPointerDrag()},s._firePointerExitAndEnter=function(t){if(this._currentEnteredEntity!==t){if(this._currentEnteredEntity)for(var e=this._currentEnteredEntity._scripts,r=e.length-1;r>=0;r--)e.get(r).onPointerExit();if(t)for(var i=t._scripts,o=i.length-1;o>=0;o--)i.get(o).onPointerEnter();this._currentEnteredEntity=t}},s._firePointerDown=function(t){if(t)for(var e=t._scripts,r=e.length-1;r>=0;r--)e.get(r).onPointerDown();this._currentPressedEntity=t},s._firePointerUpAndClick=function(t){var e=this._currentPressedEntity;if(e){for(var r=e===t,i=e._scripts,o=i.length-1;o>=0;o--){var c=i.get(o);r&&c.onPointerClick(),c.onPointerUp()}this._currentPressedEntity=null}},n}();ki._tempRay=new dc;ki._tempPoint=new k;ki._tempHitResult=new Rc;var tr;(function(n){n[n.Down=0]="Down",n[n.Up=1]="Up",n[n.Leave=2]="Leave"})(tr||(tr={}));var Fc=function(){function n(a){this._pointerManager=void 0,this._pointerManager=new ki(a,a.canvas._webCanvas)}var s=n.prototype;return s._update=function(){this._pointerManager._update()},s._destroy=function(){this._pointerManager._destroy()},W(n,[{key:"pointers",get:function(){return this._pointerManager._pointers}},{key:"multiPointerEnabled",get:function(){return this._pointerManager._multiPointerEnabled},set:function(t){this._pointerManager._multiPointerEnabled=t}}]),n}(),Be;(function(n){n[n.Opaque=1e3]="Opaque",n[n.AlphaTest=2e3]="AlphaTest",n[n.Transparent=3e3]="Transparent"})(Be||(Be={}));var kr=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,e.isGCIgnored=!1,e._refCount=0,t.resourceManager._addRefObject(e.instanceId,B(e)),e}var a=s.prototype;return a.destroy=function(e){if(e===void 0&&(e=!1),this._destroyed)return!0;if(!e&&this._refCount!==0)return!1;var r=this._engine.resourceManager;r&&(n.prototype.destroy.call(this),r._deleteRefObject(this.instanceId));var i=this._getRefCount();return i>0&&this._addRefCount(-i),this._engine=null,this._onDestroy(),!0},a._getRefCount=function(){return this._refCount},a._addRefCount=function(e){this._refCount+=e},a._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},W(s,[{key:"refCount",get:function(){return this._refCount}}]),s}(sr),gt;(function(n){n[n.Scene=0]="Scene",n[n.Camera=1]="Camera",n[n.Renderer=2]="Renderer",n[n.Material=3]="Material"})(gt||(gt={}));var xt=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.name=void 0,t._platformTexture=void 0,t._mipmap=void 0,t._width=void 0,t._height=void 0,t._mipmapCount=void 0,t._wrapModeU=void 0,t._wrapModeV=void 0,t._filterMode=void 0,t._anisoLevel=1,t}var a=s.prototype;return a.generateMipmaps=function(){!this._mipmap||this._platformTexture.generateMipmaps()},a._onDestroy=function(){this._platformTexture.destroy(),this._platformTexture=null},a._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},a._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},W(s,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,this._platformTexture.filterMode=e)}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var r=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>r&&(e=r),e<1&&(e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}}]),s}(kr),Nc=`#define GLSLIFY 1
#define PI 3.14159265359
#define RECIPROCAL_PI 0.31830988618
#define EPSILON 1e-6
#define LOG2 1.442695
#define saturate( a ) clamp( a, 0.0, 1.0 )
#define whiteCompliment(a) ( 1.0 - saturate( a ) )
vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}`,Uc=`#define GLSLIFY 1
attribute vec3 POSITION;
#ifdef O3_HAS_UV
attribute vec2 TEXCOORD_0;
#endif
#ifdef O3_HAS_SKIN
attribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;
#ifdef O3_USE_JOINT_TEXTURE
uniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}
#else
uniform mat4 u_jointMatrix[O3_JOINTS_NUM];
#endif
#endif
#ifdef O3_HAS_VERTEXCOLOR
attribute vec4 COLOR_0;
#endif
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;uniform vec4 u_tilingOffset;
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
attribute vec3 NORMAL;
#endif
#ifdef O3_HAS_TANGENT
attribute vec4 TANGENT;
#endif
#endif
`,Vc=`#define GLSLIFY 1
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;`,Gc=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
varying vec4 v_color;
#endif
`,kc=`#define GLSLIFY 1
#ifdef O3_HAS_NORMAL
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
varying mat3 v_TBN;
#else
varying vec3 v_normal;
#endif
#endif
`,Hc=`#define GLSLIFY 1
varying vec2 v_uv;`,Wc=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
varying vec3 v_pos;
#endif
`,jc=`#define GLSLIFY 1
#ifdef O3_GENERATE_SHADOW_MAP
uniform mat4 u_viewMatFromLight;uniform mat4 u_projMatFromLight;
#endif
#ifdef O3_SHADOW_MAP_COUNT
uniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];uniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];
#endif
`,Xc=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
varying vec3 v_fogDepth;uniform vec3 u_fogColor;
#ifdef O3_FOG_EXP2
uniform float u_fogDensity;
#else
uniform float u_fogNear;uniform float u_fogFar;
#endif
#endif
`,Kc=`#define GLSLIFY 1
#ifdef O3_HAS_NORMAL
vec3 normal=vec3(NORMAL);
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
vec4 tangent=vec4(TANGENT);
#endif
#endif
`,qc=`#define GLSLIFY 1
vec4 position=vec4(POSITION,1.0);`,Qc=`#define GLSLIFY 1
#ifndef O3_GENERATE_SHADOW_MAP
gl_Position=u_MVPMat*position;
#endif
`,Yc=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
v_color=COLOR_0;
#endif
`,$c=`#define GLSLIFY 1
#ifdef O3_HAS_NORMAL
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
vec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);
#else
v_normal=normalize(mat3(u_normalMat)*normal);
#endif
#endif
`,Jc=`#define GLSLIFY 1
#ifdef O3_HAS_SKIN
#ifdef O3_USE_JOINT_TEXTURE
mat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);
#else
mat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];
#endif
position=skinMatrix*position;
#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)
normal=vec4(skinMatrix*vec4(normal,0.0)).xyz;
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
tangent.xyz=vec4(skinMatrix*vec4(tangent.xyz,0.0)).xyz;
#endif
#endif
#endif
`,Zc=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifndef OASIS_BLENDSHAPE_TEXTURE
attribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;
#ifdef OASIS_BLENDSHAPE_NORMAL
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;
#endif
#ifdef OASIS_BLENDSHAPE_TANGENT
attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;
#endif
#endif
uniform float u_blendShapeWeights[4];
#endif
`,el=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifdef OASIS_BLENDSHAPE_TEXTURE
#else
position.xyz+=POSITION_BS0*u_blendShapeWeights[0];position.xyz+=POSITION_BS1*u_blendShapeWeights[1];position.xyz+=POSITION_BS2*u_blendShapeWeights[2];position.xyz+=POSITION_BS3*u_blendShapeWeights[3];
#ifndef OMIT_NORMAL
#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )
normal.xyz+=NORMAL_BS0*u_blendShapeWeights[0];normal.xyz+=NORMAL_BS1*u_blendShapeWeights[1];normal.xyz+=NORMAL_BS2*u_blendShapeWeights[2];normal.xyz+=NORMAL_BS3*u_blendShapeWeights[3];
#endif
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE ) && defined(OASIS_BLENDSHAPE_TANGENT)
tangent.xyz+=TANGENT_BS0*u_blendShapeWeights[0];tangent.xyz+=TANGENT_BS1*u_blendShapeWeights[1];tangent.xyz+=TANGENT_BS2*u_blendShapeWeights[2];tangent.xyz+=TANGENT_BS3*u_blendShapeWeights[3];
#endif
#endif
#endif
#endif
`,tl=`#define GLSLIFY 1
#ifdef O3_HAS_UV
v_uv=TEXCOORD_0;
#else
v_uv=vec2(0.,0.);
#endif
#ifdef O3_NEED_TILINGOFFSET
v_uv=v_uv*u_tilingOffset.xy+u_tilingOffset.zw;
#endif
`,rl=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;
#endif
`,il=`#define GLSLIFY 1
#ifdef O3_GENERATE_SHADOW_MAP
gl_Position=u_projMatFromLight*u_viewMatFromLight*u_modelMat*position;
#endif
#ifdef O3_SHADOW_MAP_COUNT
for(int i=0;i<O3_SHADOW_MAP_COUNT;i++){v_PositionFromLight[i]=u_projMatFromLight[i]*u_viewMatFromLight[i]*u_modelMat*vec4(POSITION,1.0);}
#endif
`,nl=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
v_fogDepth=(u_MVMat*position).xyz;
#endif
`,al=`#define GLSLIFY 1
#ifdef O3_DIRECT_LIGHT_COUNT
struct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];
#endif
#ifdef O3_POINT_LIGHT_COUNT
struct PointLight{vec3 color;vec3 position;float distance;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];
#endif
#ifdef O3_SPOT_LIGHT_COUNT
struct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngleCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];
#endif
struct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight u_envMapLight;
#ifdef O3_USE_SH
uniform vec3 u_env_sh[9];
#endif
#ifdef O3_USE_SPECULAR_ENV
uniform samplerCube u_env_specularSampler;
#endif
`,ol=`#define GLSLIFY 1
uniform vec4 u_emissiveColor;uniform vec4 u_diffuseColor;uniform vec4 u_specularColor;uniform float u_shininess;uniform float u_normalIntensity;uniform float u_alphaCutoff;
#ifdef O3_EMISSIVE_TEXTURE
uniform sampler2D u_emissiveTexture;
#endif
#ifdef O3_DIFFUSE_TEXTURE
uniform sampler2D u_diffuseTexture;
#endif
#ifdef O3_SPECULAR_TEXTURE
uniform sampler2D u_specularTexture;
#endif
#ifdef O3_NORMAL_TEXTURE
uniform sampler2D u_normalTexture;
#endif
`,sl=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
float fogDepth=length(v_fogDepth);
#ifdef O3_FOG_EXP2
float fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));
#else
float fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);
#endif
gl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);
#endif
`,cl=`#define GLSLIFY 1
vec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_diffuseColor;vec4 specular=u_specularColor;
#ifdef O3_EMISSIVE_TEXTURE
vec4 emissiveTextureColor=texture2D(u_emissiveTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveTextureColor=gammaToLinear(emissiveTextureColor);
#endif
emission*=emissiveTextureColor;
#endif
#ifdef O3_DIFFUSE_TEXTURE
vec4 diffuseTextureColor=texture2D(u_diffuseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
diffuseTextureColor=gammaToLinear(diffuseTextureColor);
#endif
diffuse*=diffuseTextureColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
diffuse*=v_color;
#endif
#ifdef O3_SPECULAR_TEXTURE
vec4 specularTextureColor=texture2D(u_specularTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularTextureColor=gammaToLinear(specularTextureColor);
#endif
specular*=specularTextureColor;
#endif
ambient=vec4(u_envMapLight.diffuse*u_envMapLight.diffuseIntensity,1.0)*diffuse;`,ll=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec3 V=normalize(u_cameraPos-v_pos);
#endif
`,ul=`#define GLSLIFY 1
vec3 N=getNormal();vec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);
#ifdef O3_DIRECT_LIGHT_COUNT
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=directionalLight.color*s;}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=pointLight.color*s;}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decayTotal;lightSpecular+=spotLight.color*s;}
#endif
diffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);
#ifdef ALPHA_CUTOFF
if(diffuse.a<u_alphaCutoff){discard;}
#endif
`,hl=`#define GLSLIFY 1
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}
#define K 0.142857142857
#define Ko 0.428571428571
#define K2 0.020408163265306
#define Kd2 0.0714285714285
#define Kz 0.166666666667
#define Kzo 0.416666666667
#define jitter 1.0
#define jitter1 0.8
`,dl=`#define GLSLIFY 1
vec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}`,fl=`#define GLSLIFY 1
vec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}`,_l=`#define GLSLIFY 1
vec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}`,vl=`#define GLSLIFY 1
vec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}`,pl=`#define GLSLIFY 1
#include <noise_cellular_2D>
#include <noise_cellular_3D>
#include <noise_cellular_2x2>
#include <noise_cellular_2x2x2>
`,gl=`#define GLSLIFY 1
float perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}`,ml=`#define GLSLIFY 1
float perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}`,yl=`#define GLSLIFY 1
float perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}`,xl=`#define GLSLIFY 1
#include <noise_perlin_2D>
#include <noise_perlin_3D>
#include <noise_perlin_4D>
`,wl=`#define GLSLIFY 1
vec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}`,bl=`#define GLSLIFY 1
float simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}`,Pl=`#define GLSLIFY 1
float simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}`,Sl=`#define GLSLIFY 1
float simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`,Al=`#define GLSLIFY 1
vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}
#define F4 0.309016994374947451
float simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}`,Ml=`#define GLSLIFY 1
#include <noise_simplex_2D>
#include <noise_simplex_3D>
#include <noise_simplex_3D_grad>
#include <noise_simplex_4D>
`,Cl=`#define GLSLIFY 1
uniform float u_alphaCutoff;uniform vec4 u_baseColor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_specularColor;uniform float u_glossiness;uniform vec3 u_emissiveColor;uniform float u_normalIntensity;uniform float u_occlusionStrength;
#ifdef HAS_BASECOLORMAP
uniform sampler2D u_baseColorSampler;
#endif
#ifdef O3_NORMAL_TEXTURE
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_EMISSIVEMAP
uniform sampler2D u_emissiveSampler;
#endif
#ifdef HAS_METALROUGHNESSMAP
uniform sampler2D u_metallicRoughnessSampler;
#endif
#ifdef HAS_SPECULARGLOSSINESSMAP
uniform sampler2D u_specularGlossinessSampler;
#endif
#ifdef HAS_OCCLUSIONMAP
uniform sampler2D u_occlusionSampler;
#endif
struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct GeometricContext{vec3 position;vec3 normal;vec3 viewDir;};struct PhysicalMaterial{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;};`,Tl=`#define GLSLIFY 1
#include <normal_get>
float pow2(float x){return x*x;}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}float computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}PhysicalMaterial getPhysicalMaterial(vec4 diffuseColor,float metal,float roughness,vec3 specularColor,float glossiness,float alphaCutoff){PhysicalMaterial material;
#ifdef HAS_BASECOLORMAP
vec4 baseColor=texture2D(u_baseColorSampler,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
baseColor=gammaToLinear(baseColor);
#endif
diffuseColor*=baseColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
diffuseColor*=v_color;
#endif
#ifdef ALPHA_CUTOFF
if(diffuseColor.a<alphaCutoff){discard;}
#endif
#ifdef HAS_METALROUGHNESSMAP
vec4 metalRoughMapColor=texture2D(u_metallicRoughnessSampler,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;
#endif
#ifdef HAS_SPECULARGLOSSINESSMAP
vec4 specularGlossinessColor=texture2D(u_specularGlossinessSampler,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularGlossinessColor=gammaToLinear(specularGlossinessColor);
#endif
specularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;
#endif
#ifdef IS_METALLIC_WORKFLOW
material.diffuseColor=diffuseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(0.04),diffuseColor.rgb,metal);material.roughness=clamp(roughness,0.04,1.0);
#else
float specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=diffuseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=clamp(1.0-glossiness,0.04,1.0);
#endif
material.opacity=diffuseColor.a;return material;}
#include <brdf>
#include <direct_irradiance_frag_define>
#include <ibl_frag_define>
`,Rl=`#define GLSLIFY 1
vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(vec3 incidentDirection,GeometricContext geometry,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+geometry.viewDir);float dotNL=saturate(dot(geometry.normal,incidentDirection));float dotNV=saturate(dot(geometry.normal,geometry.viewDir));float dotNH=saturate(dot(geometry.normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}`,zl=`#define GLSLIFY 1
void addDirectRadiance(vec3 incidentDirection,vec3 color,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color;irradiance*=PI;reflectedLight.directSpecular+=irradiance*BRDF_Specular_GGX(incidentDirection,geometry,material.specularColor,material.roughness);reflectedLight.directDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}
#ifdef O3_DIRECT_LIGHT_COUNT
void addDirectionalDirectLightRadiance(DirectLight directionalLight,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
void addPointDirectLightRadiance(PointLight pointLight,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
void addSpotDirectLightRadiance(SpotLight spotLight,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
void addTotalDirectRadiance(GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){
#ifdef O3_DIRECT_LIGHT_COUNT
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}
#endif
}`,El=`#define GLSLIFY 1
vec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getLightProbeRadiance(GeometricContext geometry,float roughness,int maxMIPLevel,float specularIntensity){
#ifndef O3_USE_SPECULAR_ENV
return vec3(0);
#else
vec3 reflectVec=reflect(-geometry.viewDir,geometry.normal);float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);
#ifdef HAS_TEX_LOD
vec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);
#else
vec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);
#endif
#ifdef O3_DECODE_ENV_RGBM
envMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;
#ifdef OASIS_COLORSPACE_GAMMA
envMapColor=linearToGamma(envMapColor);
#endif
#else
#ifndef OASIS_COLORSPACE_GAMMA
envMapColor=gammaToLinear(envMapColor);
#endif
#endif
return envMapColor.rgb*specularIntensity;
#endif
}`,Bl=`#define GLSLIFY 1
GeometricContext geometry=GeometricContext(v_pos,getNormal(),normalize(u_cameraPos-v_pos));PhysicalMaterial material=getPhysicalMaterial(u_baseColor,u_metal,u_roughness,u_specularColor,u_glossiness,u_alphaCutoff);ReflectedLight reflectedLight=ReflectedLight(vec3(0),vec3(0),vec3(0),vec3(0));float dotNV=saturate(dot(geometry.normal,geometry.viewDir));addTotalDirectRadiance(geometry,material,reflectedLight);
#ifdef O3_USE_SH
vec3 irradiance=getLightProbeIrradiance(u_env_sh,geometry.normal);
#ifdef OASIS_COLORSPACE_GAMMA
irradiance=linearToGamma(vec4(irradiance,1.0)).rgb;
#endif
irradiance*=u_envMapLight.diffuseIntensity;
#else
vec3 irradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;irradiance*=PI;
#endif
reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry,material.roughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);reflectedLight.indirectSpecular+=radiance*envBRDFApprox(material.specularColor,material.roughness,dotNV);
#ifdef HAS_OCCLUSIONMAP
float ambientOcclusion=(texture2D(u_occlusionSampler,v_uv).r-1.0)*u_occlusionStrength+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;
#ifdef O3_USE_SPECULAR_ENV
reflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,dotNV);
#endif
#endif
vec3 emissiveRadiance=u_emissiveColor;
#ifdef HAS_EMISSIVEMAP
vec4 emissiveColor=texture2D(u_emissiveSampler,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveColor=gammaToLinear(emissiveColor);
#endif
emissiveRadiance*=emissiveColor.rgb;
#endif
vec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);
#ifndef OASIS_COLORSPACE_GAMMA
targetColor=linearToGamma(targetColor);
#endif
gl_FragColor=targetColor;`,Dl={pbr_frag_define:Cl,pbr_helper:Tl,brdf:Rl,direct_irradiance_frag_define:zl,ibl_frag_define:El,pbr_frag:Bl},Ol=`#define GLSLIFY 1
vec3 getNormal(){
#ifdef O3_NORMAL_TEXTURE
#ifndef O3_HAS_TANGENT
#ifdef HAS_DERIVATIVES
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 tex_dx=dFdx(vec3(v_uv,0.0));vec3 tex_dy=dFdy(vec3(v_uv,0.0));vec3 t=(tex_dy.t*pos_dx-tex_dx.t*pos_dy)/(tex_dx.s*tex_dy.t-tex_dy.s*tex_dx.t);
#ifdef O3_HAS_NORMAL
vec3 ng=normalize(v_normal);
#else
vec3 ng=normalize(cross(pos_dx,pos_dy));
#endif
t=normalize(t-ng*dot(ng,t));vec3 b=normalize(cross(ng,t));mat3 tbn=mat3(t,b,ng);
#else
#ifdef O3_HAS_NORMAL
vec3 ng=normalize(v_normal);
#else
vec3 ng=vec3(0.0,0.0,1.0);
#endif
mat3 tbn=mat3(vec3(0.0),vec3(0.0),ng);
#endif
#else
mat3 tbn=v_TBN;
#endif
vec3 n=texture2D(u_normalTexture,v_uv).rgb;n=normalize(tbn*((2.0*n-1.0)*vec3(u_normalIntensity,u_normalIntensity,1.0)));
#else
#ifdef O3_HAS_NORMAL
vec3 n=normalize(v_normal);
#elif defined(HAS_DERIVATIVES)
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 n=normalize(cross(pos_dx,pos_dy));
#else
vec3 n=vec3(0.0,0.0,1.0);
#endif
#endif
n*=float(gl_FrontFacing)*2.0-1.0;return n;}`,Ll=An(An({common:Nc,common_vert:Uc,common_frag:Vc,color_share:Gc,normal_share:kc,uv_share:Hc,worldpos_share:Wc,shadow_share:jc,fog_share:Xc,begin_normal_vert:Kc,begin_position_vert:qc,position_vert:Qc,color_vert:Yc,normal_vert:$c,skinning_vert:Jc,blendShape_input:Zc,blendShape_vert:el,uv_vert:tl,worldpos_vert:rl,shadow_vert:il,fog_vert:nl,light_frag_define:al,mobile_material_frag:ol,fog_frag:sl,begin_mobile_frag:cl,begin_viewdir_frag:ll,mobile_blinnphong_frag:ul,noise_common:hl,noise_cellular_2D:dl,noise_cellular_2x2:fl,noise_cellular_2x2x2:_l,noise_cellular_3D:vl,noise_cellular:pl,noise_perlin_2D:gl,noise_perlin_3D:ml,noise_perlin_4D:yl,noise_perlin:xl,noise_psrd_2D:wl,noise_simplex_2D:bl,noise_simplex_3D_grad:Pl,noise_simplex_3D:Sl,noise_simplex_4D:Al,noise_simplex:Ml},Dl),{},{normal_get:Ol}),zr=function(){function n(){}return n.parseCustomMacros=function(a){return a.map(function(t){return"#define "+t+`
`}).join("")},n.parseIncludes=function(a){var t=/^[ \t]*#include +<([\w\d.]+)>/gm;function e(r,i){var o=Ll[i];return o===void 0?(ht.error('Shader slice "'+r.trim()+'" not founded.'),""):n.parseIncludes(o)}return a.replace(t,e)},n.parseExtension=function(a){return a.map(function(t){return"#extension "+t+` : enable
`}).join("")},n.convertTo300=function(a,t){if(a=a.replace(/\battribute\b/g,"in"),a=a.replace(/\bvarying\b/g,t?"in":"out"),a=a.replace(/\btexture(2D|Cube)\b/g,"texture"),a=a.replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),t){var e=/\bgl_FragData\[.+?\]/g.test(a);if(e){a=a.replace(/\bgl_FragColor\b/g,"gl_FragData[0]");var r=a.match(/\bgl_FragData\[.+?\]/g);a=this._replaceMRTShader(a,r)}else a=a.replace(/void\s+?main\s*\(/g,`out vec4 glFragColor;
void main(`),a=a.replace(/\bgl_FragColor\b/g,"glFragColor")}return a},n._replaceMRTShader=function(a,t){for(var e="",r=new Set,i=0;i<t.length;i++){var o=t[i].match(/\bgl_FragData\[(.+?)\]/);r.add(o[1])}return r.forEach(function(c){e+="layout(location="+c+") out vec4 fragOutColor"+c+`;
`}),e+="void main(",a=a.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1"),a=a.replace(/void\s+?main\s*\(/g,e),a},n}(),Il=function(s,a,t){this.name=void 0,this._index=void 0,this._value=void 0,this.name=s,this._index=a,this._value=t},mr;(function(n){n[n.Linear=0]="Linear",n[n.Gamma=1]="Gamma"})(mr||(mr={}));var Fl=function(){function n(a){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this.textureIndex=void 0,this.textureDefault=void 0,this._rhi=void 0,this._gl=void 0,this._colorSpace=void 0;var t=a._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=a.settings.colorSpace}var s=n.prototype;return s.upload1f=function(t,e){this.cacheValue!==e&&(this._gl.uniform1f(t.location,e),this.cacheValue=e)},s.upload1fv=function(t,e){this._gl.uniform1fv(t.location,e)},s.upload2f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._colorSpace===mr.Linear?this._gl.uniform2f(t.location,Q.gammaToLinearSpace(e.r),Q.gammaToLinearSpace(e.g)):this._gl.uniform2f(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2f(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2fv=function(t,e){this._gl.uniform2fv(t.location,e)},s.upload3f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._colorSpace===mr.Linear?this._gl.uniform3f(t.location,Q.gammaToLinearSpace(e.r),Q.gammaToLinearSpace(e.g),Q.gammaToLinearSpace(e.b)):this._gl.uniform3f(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3f(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3fv=function(t,e){this._gl.uniform3fv(t.location,e)},s.upload4f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._colorSpace===mr.Linear?this._gl.uniform4f(t.location,Q.gammaToLinearSpace(e.r),Q.gammaToLinearSpace(e.g),Q.gammaToLinearSpace(e.b),e.a):this._gl.uniform4f(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4f(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4fv=function(t,e){this._gl.uniform4fv(t.location,e)},s.upload1i=function(t,e){this.cacheValue!==e&&(this._gl.uniform1i(t.location,e),this.cacheValue=e)},s.upload1iv=function(t,e){this._gl.uniform1iv(t.location,e)},s.upload2i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._gl.uniform2i(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2i(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2iv=function(t,e){this._gl.uniform2iv(t.location,e)},s.upload3i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._gl.uniform3i(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3i(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3iv=function(t,e){this._gl.uniform3iv(t.location,e)},s.upload4i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._gl.uniform4i(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4i(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4iv=function(t,e){this._gl.uniform4iv(t.location,e)},s.uploadMat4=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e.elements)},s.uploadMat4v=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e)},s.uploadTexture=function(t,e){var r=this._rhi;r.activeTexture(t.textureIndex),r.bindTexture(e._platformTexture)},s.uploadTextureArray=function(t,e){for(var r=this._rhi,i=t.textureIndex,o=0;o<e.length;o++){var c=e[o];r.activeTexture(i[o]),r.bindTexture(c._platformTexture)}},n}(),jr=function(){this.constUniforms=[],this.textureUniforms=[]},Ts=function(){n._addLineNum=function(t){var e=t.split(`
`),r=(e.length+1).toString().length+6,i;return e.map(function(o,c){if(i="0:"+(c+1),i.length>=r)return i.substring(0,r)+o;for(var l=0;l<r-i.length;l++)i+=" ";return i+o}).join(`
`)};function n(a,t,e){this.id=void 0,this.sceneUniformBlock=new jr,this.cameraUniformBlock=new jr,this.rendererUniformBlock=new jr,this.materialUniformBlock=new jr,this.otherUniformBlock=new jr,this._uploadRenderCount=-1,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=a,this._gl=a._hardwareRenderer.gl,this._glProgram=this._createProgram(t,e),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=n._counter++}var s=n.prototype;return s.uploadAll=function(t,e){this.uploadUniforms(t,e),this.uploadTextures(t,e)},s.uploadUniforms=function(t,e){for(var r=e._properties,i=t.constUniforms,o=0,c=i.length;o<c;o++){var l=i[o],u=r[l.propertyId];u!=null&&l.applyFunc(l,u)}},s.uploadTextures=function(t,e){var r=e._properties,i=t.textureUniforms;if(i)for(var o=0,c=i.length;o<c;o++){var l=i[o],u=r[l.propertyId];u?l.applyFunc(l,u):l.applyFunc(l,l.textureDefault)}},s.uploadUnGroupTextures=function(){var t=this.otherUniformBlock.textureUniforms;if(t)for(var e=0,r=t.length;e<r;e++){var i=t[e];i.applyFunc(i,i.textureDefault)}},s.groupingOtherUniformBlock=function(){var t=this.otherUniformBlock,e=t.constUniforms,r=t.textureUniforms;e.length>0&&this._groupingSubOtherUniforms(e,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},s.bind=function(){var t=this._engine._hardwareRenderer;return t._currentBind!==this?(this._gl.useProgram(this._glProgram),t._currentBind=this,!0):!1},s.destroy=function(){var t=this._gl;this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._glProgram&&t.deleteProgram(this._glProgram)},s._groupingSubOtherUniforms=function(t,e){for(var r=t.length-1;r>=0;r--){var i=t[r],o=C._getShaderPropertyGroup(i.name);o!==void 0&&(t.splice(t.indexOf(i),1),this._groupingUniform(i,o,e))}},s._groupingUniform=function(t,e,r){switch(e){case gt.Scene:r?this.sceneUniformBlock.textureUniforms.push(t):this.sceneUniformBlock.constUniforms.push(t);break;case gt.Camera:r?this.cameraUniformBlock.textureUniforms.push(t):this.cameraUniformBlock.constUniforms.push(t);break;case gt.Renderer:r?this.rendererUniformBlock.textureUniforms.push(t):this.rendererUniformBlock.constUniforms.push(t);break;case gt.Material:r?this.materialUniformBlock.textureUniforms.push(t):this.materialUniformBlock.constUniforms.push(t);break;default:r?this.otherUniformBlock.textureUniforms.push(t):this.otherUniformBlock.constUniforms.push(t)}},s._createProgram=function(t,e){var r=this._gl,i=this._createShader(r.VERTEX_SHADER,t);if(!i)return null;var o=this._createShader(r.FRAGMENT_SHADER,e);if(!o)return null;var c=r.createProgram();return r.attachShader(c,i),r.attachShader(c,o),r.linkProgram(c),r.validateProgram(c),r.isContextLost()?(r.deleteShader(i),r.deleteShader(o),null):(this._vertexShader=i,this._fragmentShader=o,c)},s._createShader=function(t,e){var r=this._gl,i=r.createShader(t);return i?(r.shaderSource(i,e),r.compileShader(i),r.isContextLost()?(r.deleteShader(i),null):i):null},s._recordLocation=function(){var t=this,e=this._gl,r=this._glProgram,i=this._getUniformInfos(),o=this._getAttributeInfos();i.forEach(function(c){var l=c.name,u=c.size,h=c.type,d=new Fl(t._engine),f=!1,_=!1;l.indexOf("[0]")>0&&(l=l.substr(0,l.length-3),f=!0);var v=C._getShaderPropertyGroup(l),p=e.getUniformLocation(r,l);switch(d.name=l,d.propertyId=C.getPropertyByName(l)._uniqueId,d.location=p,h){case e.FLOAT:f?d.applyFunc=d.upload1fv:(d.applyFunc=d.upload1f,d.cacheValue=0);break;case e.FLOAT_VEC2:f?d.applyFunc=d.upload2fv:(d.applyFunc=d.upload2f,d.cacheValue=new k(0,0));break;case e.FLOAT_VEC3:f?d.applyFunc=d.upload3fv:(d.applyFunc=d.upload3f,d.cacheValue=new x(0,0,0));break;case e.FLOAT_VEC4:f?d.applyFunc=d.upload4fv:(d.applyFunc=d.upload4f,d.cacheValue=new ve(0,0,0,0));break;case e.BOOL:case e.INT:f?d.applyFunc=d.upload1iv:(d.applyFunc=d.upload1i,d.cacheValue=0);break;case e.BOOL_VEC2:case e.INT_VEC2:f?d.applyFunc=d.upload2iv:(d.applyFunc=d.upload2i,d.cacheValue=new k(0,0));break;case e.BOOL_VEC3:case e.INT_VEC3:d.applyFunc=f?d.upload3iv:d.upload3i,d.cacheValue=new x(0,0,0);break;case e.BOOL_VEC4:case e.INT_VEC4:f?d.applyFunc=d.upload4iv:(d.applyFunc=d.upload4i,d.cacheValue=new ve(0,0,0));break;case e.FLOAT_MAT4:d.applyFunc=f?d.uploadMat4v:d.uploadMat4;break;case e.SAMPLER_2D:case e.SAMPLER_CUBE:var g=h===e.SAMPLER_2D?t._engine._whiteTexture2D:t._engine._whiteTextureCube;if(_=!0,f){for(var m=new Array(u),y=new Int32Array(u),w=new Array(u),P=0;P<u;P++)m[P]=g,y[P]=t._activeTextureUint,w[P]=e.TEXTURE0+t._activeTextureUint++;d.textureDefault=m,d.textureIndex=w,d.applyFunc=d.uploadTextureArray,t.bind(),e.uniform1iv(p,y),d.uploadTextureArray(d,m)}else{var A=e.TEXTURE0+t._activeTextureUint;d.textureDefault=g,d.textureIndex=A,d.applyFunc=d.uploadTexture,t.bind(),e.uniform1i(p,t._activeTextureUint++),d.uploadTexture(d,g)}break}t._groupingUniform(d,v,_)}),o.forEach(function(c){var l=c.name;t.attributeLocation[l]=e.getAttribLocation(r,l)})},s._getUniformInfos=function(){for(var t=this._gl,e=this._glProgram,r=[],i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),o=0;o<i;++o){var c=t.getActiveUniform(e,o);r[o]=c}return r},s._getAttributeInfos=function(){for(var t=this._gl,e=this._glProgram,r=[],i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),o=0;o<i;++o){var c=t.getActiveAttrib(e,o);r[o]=c}return r},W(n,[{key:"isValid",get:function(){return this._isValid}}]),n}();Ts._counter=0;var Rs=function n(s){this._uniqueId=void 0,this._group=void 0,this.name=void 0,this.name=s,this._uniqueId=n._propertyNameCounter++};Rs._propertyNameCounter=0;var C=function(){n.create=function(t,e,r){var i=n._shaderMap;if(i[t])throw'Shader named "'+t+'" already exists.';return i[t]=new n(t,e,r)},n.find=function(t){return n._shaderMap[t]},n.getMacroByName=function(t){var e=n._macroMap[t];if(!e){var r=n._macroMaskMap,i=n._macroCounter,o=Math.floor(i/32),c=i%32;e=new Il(t,o,1<<c),n._macroMap[t]=e,o==r.length&&(r.length++,r[o]=new Array(32)),r[o][c]=t,n._macroCounter++}return e},n.getPropertyByName=function(t){var e=n._propertyNameMap;if(e[t]!=null)return e[t];var r=new Rs(t);return e[t]=r,r},n._getShaderPropertyGroup=function(t){var e=n._propertyNameMap[t];return e==null?void 0:e._group},n._getNamesByMacros=function(t,e){var r=n._macroMaskMap,i=t._mask;e.length=0;for(var o=0,c=t._length;o<c;o++)for(var l=r[o],u=i[o],h=u<0?32:Math.floor(Math.log2(u))+1,d=0;d<h;d++)u&1<<d&&e.push(l[d])};function n(a,t,e){this.name=void 0,this._shaderId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderId=n._shaderCounter++,this.name=a,this._vertexSource=t,this._fragmentSource=e}var s=n.prototype;return s.compileVariant=function(t,e){var r=n._compileMacros;r.clear();for(var i=0,o=e.length;i<o;i++)r.enable(n.getMacroByName(e[i]));return this._getShaderProgram(t,r).isValid},s._getShaderProgram=function(t,e){var r=t._getShaderProgramPool(this),i=r.get(e);if(i)return i;var o=t._hardwareRenderer.isWebGL2,c=[];n._getNamesByMacros(e,c);var l=zr.parseCustomMacros(c),u=o?"#version 300 es":"#version 100",h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      precision highp int;
    #else
      precision mediump float;
      precision mediump int;
    #endif
    `;t._hardwareRenderer.canIUse(Ve.shaderTextureLod)&&(h+=`#define HAS_TEX_LOD
`),t._hardwareRenderer.canIUse(Ve.standardDerivatives)&&(h+=`#define HAS_DERIVATIVES
`);var d=zr.parseIncludes(" "+u+`
        `+h+`
        `+l+`
        `+this._vertexSource),f=zr.parseIncludes(" "+u+`
        `+(o?"":zr.parseExtension(n._shaderExtension))+`
        `+h+`
        `+l+`
      `+this._fragmentSource);return o&&(d=zr.convertTo300(d),f=zr.convertTo300(f,!0)),i=new Ts(t,d,f),r.cache(i),i},n}();C._compileMacros=new rt;C._shaderCounter=0;C._shaderMap=Object.create(null);C._propertyNameMap=Object.create(null);C._macroMaskMap=[];C._macroCounter=0;C._macroMap=Object.create(null);C._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];var Hi=function(){function n(a){this._group=void 0,this._properties=Object.create(null),this._macroCollection=new rt,this._variableMacros=Object.create(null),this._refCount=0,this._group=a}var s=n.prototype;return s.getFloat=function(t){return this._getData(t)},s.setFloat=function(t,e){this._setData(t,e)},s.getInt=function(t){return this._getData(t)},s.setInt=function(t,e){this._setData(t,e)},s.getFloatArray=function(t){return this._getData(t)},s.setFloatArray=function(t,e){this._setData(t,e)},s.getIntArray=function(t){return this._getData(t)},s.setIntArray=function(t,e){this._setData(t,e)},s.getVector2=function(t){return this._getData(t)},s.setVector2=function(t,e){this._setData(t,e)},s.getVector3=function(t){return this._getData(t)},s.setVector3=function(t,e){this._setData(t,e)},s.getVector4=function(t){return this._getData(t)},s.setVector4=function(t,e){this._setData(t,e)},s.getMatrix=function(t){return this._getData(t)},s.setMatrix=function(t,e){this._setData(t,e)},s.getColor=function(t){return this._getData(t)},s.setColor=function(t,e){this._setData(t,e)},s.getTexture=function(t){return this._getData(t)},s.setTexture=function(t,e){if(this._getRefCount()>0){var r=this._getData(t);r&&r._addRefCount(-1),e&&e._addRefCount(1)}this._setData(t,e)},s.getTextureArray=function(t){return this._getData(t)},s.setTextureArray=function(t,e){if(this._getRefCount()>0){var r=this._getData(t);if(r)for(var i=0,o=r.length;i<o;i++)r[i]._addRefCount(-1);if(e)for(var c=0,l=e.length;c<l;c++)e[c]._addRefCount(1)}this._setData(t,e)},s.enableMacro=function(t,e){e===void 0&&(e=null),e?this._enableVariableMacro(t,e):(typeof t=="string"&&(t=C.getMacroByName(t)),this._macroCollection.enable(t))},s.disableMacro=function(t){if(typeof t=="string"){var e=this._variableMacros[t];e?this._disableVariableMacro(t,e):(t=C.getMacroByName(t),this._macroCollection.disable(t))}else this._macroCollection.disable(t)},s.clone=function(){var t=new n(this._group);return this.cloneTo(t),t},s.cloneTo=function(t){yt.deepCloneObject(this._macroCollection,t._macroCollection),ii(t._variableMacros,this._variableMacros);for(var e=this._properties,r=t._properties,i=Object.keys(e),o=0,c=i.length;o<c;o++){var l=i[o],u=e[l];if(u!=null)if(typeof u=="number")r[l]=u;else if(u instanceof xt)r[l]=u;else if(u instanceof Array||u instanceof Float32Array||u instanceof Int32Array)r[l]=u.slice();else{var h=r[l];h?u.cloneTo(h):r[l]=u.clone()}else r[l]=u}},s._getData=function(t){return typeof t=="string"&&(t=C.getPropertyByName(t)),this._properties[t._uniqueId]},s._setData=function(t,e){if(typeof t=="string"&&(t=C.getPropertyByName(t)),t._group!==this._group)if(t._group===void 0)t._group=this._group;else throw"Shader property "+t.name+" has been used as "+gt[t._group]+" property.";this._properties[t._uniqueId]=e},s._getRefCount=function(){return this._refCount},s._addRefCount=function(t){this._refCount+=t;var e=this._properties;for(var r in e){var i=e[r];i&&i instanceof xt&&i._addRefCount(t)}},s._enableVariableMacro=function(t,e){var r=this._variableMacros,i=r[t];if(i!==e){i&&this._disableVariableMacro(t,i);var o=C.getMacroByName(t+" "+e);this._macroCollection.enable(o),r[t]=e}},s._disableVariableMacro=function(t,e){var r=C.getMacroByName(t+" "+e);this._macroCollection.disable(r),delete this._variableMacros[t]},n}(),J;(function(n){n[n.Zero=0]="Zero",n[n.One=1]="One",n[n.SourceColor=2]="SourceColor",n[n.OneMinusSourceColor=3]="OneMinusSourceColor",n[n.DestinationColor=4]="DestinationColor",n[n.OneMinusDestinationColor=5]="OneMinusDestinationColor",n[n.SourceAlpha=6]="SourceAlpha",n[n.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",n[n.DestinationAlpha=8]="DestinationAlpha",n[n.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",n[n.SourceAlphaSaturate=10]="SourceAlphaSaturate",n[n.BlendColor=11]="BlendColor",n[n.OneMinusBlendColor=12]="OneMinusBlendColor"})(J||(J={}));var st;(function(n){n[n.Add=0]="Add",n[n.Subtract=1]="Subtract",n[n.ReverseSubtract=2]="ReverseSubtract",n[n.Min=3]="Min",n[n.Max=4]="Max"})(st||(st={}));var rr;(function(n){n[n.None=0]="None",n[n.Red=1]="Red",n[n.Green=2]="Green",n[n.Blue=4]="Blue",n[n.Alpha=8]="Alpha",n[n.All=15]="All"})(rr||(rr={}));var Nl=function(){this.enabled=!1,this.colorBlendOperation=st.Add,this.alphaBlendOperation=st.Add,this.sourceColorBlendFactor=J.One,this.sourceAlphaBlendFactor=J.One,this.destinationColorBlendFactor=J.Zero,this.destinationAlphaBlendFactor=J.Zero,this.colorWriteMask=rr.All},Ul=function(){function n(){this.targetBlendState=new Nl,this.blendColor=new Q(0,0,0,0),this.alphaToCoverage=!1}n._getGLBlendFactor=function(t,e){var r=t.gl;switch(e){case J.Zero:return r.ZERO;case J.One:return r.ONE;case J.SourceColor:return r.SRC_COLOR;case J.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case J.DestinationColor:return r.DST_COLOR;case J.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case J.SourceAlpha:return r.SRC_ALPHA;case J.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case J.DestinationAlpha:return r.DST_ALPHA;case J.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case J.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case J.BlendColor:return r.CONSTANT_COLOR;case J.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}},n._getGLBlendOperation=function(t,e){var r=t.gl;switch(e){case st.Add:return r.FUNC_ADD;case st.Subtract:return r.FUNC_SUBTRACT;case st.ReverseSubtract:return r.FUNC_REVERSE_SUBTRACT;case st.Min:if(!t.canIUse(Ve.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return r.MIN;case st.Max:if(!t.canIUse(Ve.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return r.MAX}};var s=n.prototype;return s._apply=function(t,e){this._platformApply(t,e.blendState)},s._platformApply=function(t,e){var r=t.gl,i=e.targetBlendState,o=this.targetBlendState,c=o.enabled,l=o.colorBlendOperation,u=o.alphaBlendOperation,h=o.sourceColorBlendFactor,d=o.destinationColorBlendFactor,f=o.sourceAlphaBlendFactor,_=o.destinationAlphaBlendFactor,v=o.colorWriteMask;if(c!==i.enabled&&(c?r.enable(r.BLEND):r.disable(r.BLEND),i.enabled=c),c){(h!==i.sourceColorBlendFactor||d!==i.destinationColorBlendFactor||f!==i.sourceAlphaBlendFactor||_!==i.destinationAlphaBlendFactor)&&(r.blendFuncSeparate(n._getGLBlendFactor(t,h),n._getGLBlendFactor(t,d),n._getGLBlendFactor(t,f),n._getGLBlendFactor(t,_)),i.sourceColorBlendFactor=h,i.destinationColorBlendFactor=d,i.sourceAlphaBlendFactor=f,i.destinationAlphaBlendFactor=_),(l!==i.colorBlendOperation||u!==i.alphaBlendOperation)&&(r.blendEquationSeparate(n._getGLBlendOperation(t,l),n._getGLBlendOperation(t,u)),i.colorBlendOperation=l,i.alphaBlendOperation=u);var p=this.blendColor;Q.equals(e.blendColor,p)||(r.blendColor(p.r,p.g,p.b,p.a),p.cloneTo(e.blendColor))}v!==i.colorWriteMask&&(r.colorMask((v&rr.Red)!==0,(v&rr.Green)!==0,(v&rr.Blue)!==0,(v&rr.Alpha)!==0),i.colorWriteMask=v);var g=this.alphaToCoverage;g!==e.alphaToCoverage&&(g?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),e.alphaToCoverage=g)},n}(),fe;(function(n){n[n.Never=0]="Never",n[n.Less=1]="Less",n[n.Equal=2]="Equal",n[n.LessEqual=3]="LessEqual",n[n.Greater=4]="Greater",n[n.NotEqual=5]="NotEqual",n[n.GreaterEqual=6]="GreaterEqual",n[n.Always=7]="Always"})(fe||(fe={}));var Vl=function(){function n(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=fe.Less}n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case fe.Never:return r.NEVER;case fe.Less:return r.LESS;case fe.Equal:return r.EQUAL;case fe.LessEqual:return r.LEQUAL;case fe.Greater:return r.GREATER;case fe.NotEqual:return r.NOTEQUAL;case fe.GreaterEqual:return r.GEQUAL;case fe.Always:return r.ALWAYS}};var s=n.prototype;return s._apply=function(t,e){this._platformApply(t,e.depthState)},s._platformApply=function(t,e){var r=t.gl,i=this.enabled,o=this.compareFunction,c=this.writeEnabled;i!=e.enabled&&(i?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.enabled=i),i&&(o!=e.compareFunction&&(r.depthFunc(n._getGLCompareFunction(t,o)),e.compareFunction=o),c!=e.writeEnabled&&(r.depthMask(c),e.writeEnabled=c))},n}(),ct;(function(n){n[n.Off=0]="Off",n[n.Front=1]="Front",n[n.Back=2]="Back"})(ct||(ct={}));var Gl=function(){function n(){this.cullMode=ct.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var s=n.prototype;return s._apply=function(t,e,r){this._platformApply(t,e.rasterState,r)},s._platformApply=function(t,e,r){var i=t.gl,o=this.cullMode,c=this.depthBias,l=this.slopeScaledDepthBias,u=o!==ct.Off;u!==e._cullFaceEnable&&(u?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),e._cullFaceEnable=u),u&&o!==e.cullMode&&(o==ct.Back?i.cullFace(i.BACK):i.cullFace(i.FRONT),e.cullMode=o),r!==e._frontFaceInvert&&(r?i.frontFace(i.CW):i.frontFace(i.CCW),e._frontFaceInvert=r),(c!==e.depthBias||l!==e.slopeScaledDepthBias)&&(c!==0||l!==0?(i.enable(i.POLYGON_OFFSET_FILL),i.polygonOffset(l,c)):i.disable(i.POLYGON_OFFSET_FILL),e.depthBias=c,e.slopeScaledDepthBias=l)},n}(),Ce;(function(n){n[n.Keep=0]="Keep",n[n.Zero=1]="Zero",n[n.Replace=2]="Replace",n[n.IncrementSaturate=3]="IncrementSaturate",n[n.DecrementSaturate=4]="DecrementSaturate",n[n.Invert=5]="Invert",n[n.IncrementWrap=6]="IncrementWrap",n[n.DecrementWrap=7]="DecrementWrap"})(Ce||(Ce={}));var kl=function(){function n(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=fe.Always,this.compareFunctionBack=fe.Always,this.passOperationFront=Ce.Keep,this.passOperationBack=Ce.Keep,this.failOperationFront=Ce.Keep,this.failOperationBack=Ce.Keep,this.zFailOperationFront=Ce.Keep,this.zFailOperationBack=Ce.Keep}n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case fe.Never:return r.NEVER;case fe.Less:return r.LESS;case fe.Equal:return r.EQUAL;case fe.LessEqual:return r.LEQUAL;case fe.Greater:return r.GREATER;case fe.NotEqual:return r.NOTEQUAL;case fe.GreaterEqual:return r.GEQUAL;case fe.Always:return r.ALWAYS}},n._getGLStencilOperation=function(t,e){var r=t.gl;switch(e){case Ce.Keep:return r.KEEP;case Ce.Zero:return r.ZERO;case Ce.Replace:return r.REPLACE;case Ce.IncrementSaturate:return r.INCR;case Ce.DecrementSaturate:return r.DECR;case Ce.Invert:return r.INVERT;case Ce.IncrementWrap:return r.INCR_WRAP;case Ce.DecrementWrap:return r.DECR_WRAP}};var s=n.prototype;return s._apply=function(t,e){this._platformApply(t,e.stencilState)},s._platformApply=function(t,e){var r=t.gl,i=this.enabled,o=this.referenceValue,c=this.mask,l=this.compareFunctionFront,u=this.compareFunctionBack,h=this.failOperationFront,d=this.zFailOperationFront,f=this.passOperationFront,_=this.failOperationBack,v=this.zFailOperationBack,p=this.passOperationBack,g=this.writeMask;if(i!=e.enabled&&(i?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e.enabled=i),i){var m=o!==e.referenceValue||c!==e.mask;(m||l!==e.compareFunctionFront)&&(r.stencilFuncSeparate(r.FRONT,n._getGLCompareFunction(t,l),o,c),e.compareFunctionFront=l),(m||u!==e.compareFunctionBack)&&(r.stencilFuncSeparate(r.BACK,n._getGLCompareFunction(t,u),o,c),e.compareFunctionBack=this.compareFunctionBack),m&&(e.referenceValue=this.referenceValue,e.mask=this.mask),(h!==e.failOperationFront||d!==e.zFailOperationFront||f!==e.passOperationFront)&&(r.stencilOpSeparate(r.FRONT,n._getGLStencilOperation(t,h),n._getGLStencilOperation(t,d),n._getGLStencilOperation(t,f)),e.failOperationFront=h,e.zFailOperationFront=d,e.passOperationFront=f),(_!==e.failOperationBack||v!==e.zFailOperationBack||p!==e.passOperationBack)&&(r.stencilOpSeparate(r.BACK,n._getGLStencilOperation(t,_),n._getGLStencilOperation(t,v),n._getGLStencilOperation(t,p)),e.failOperationBack=_,e.zFailOperationBack=v,e.passOperationBack=p),g!==e.writeMask&&(r.stencilMask(g),e.writeMask=g)}},n}(),zs=function(){function n(){this.blendState=new Ul,this.depthState=new Vl,this.stencilState=new kl,this.rasterState=new Gl}var s=n.prototype;return s._apply=function(t,e){var r=t._hardwareRenderer,i=t._lastRenderState;this.blendState._apply(r,i),this.depthState._apply(r,i),this.stencilState._apply(r,i),this.rasterState._apply(r,i,e)},n}(),nr=function(n){X(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.name=void 0,r.shader=void 0,r.renderQueueType=Be.Opaque,r.shaderData=new Hi(gt.Material),r.renderState=new zs,r.shader=e,r}var a=s.prototype;return a.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},a.cloneTo=function(e){e.shader=this.shader,e.renderQueueType=this.renderQueueType,this.shaderData.cloneTo(e.shaderData),yt.deepCloneObject(this.renderState,e.renderState)},a._addRefCount=function(e){n.prototype._addRefCount.call(this,e),this.shaderData._addRefCount(e)},a._preRender=function(e){},a._onDestroy=function(){},s}(kr),Ur=function(){function n(a){this._elementPoolIndex=0,this._elementPool=[],this._type=void 0,this._type=a}var s=n.prototype;return s.getFromPool=function(){var t=this._elementPoolIndex,e=this._elementPool;if(this._elementPoolIndex++,e.length===t){var r=new this._type;return e.push(r),r}else return e[t]},s.resetPool=function(){this._elementPoolIndex=0},n}(),Hl=function(){function n(){this._camera=void 0,this._viewProjectMatrix=new j}var s=n.prototype;return s._setContext=function(t){this._camera=t,j.multiply(t.projectionMatrix,t.viewMatrix,this._viewProjectMatrix)},n}(),Wl=function(){function n(){this.component=void 0,this.mesh=void 0,this.subMesh=void 0,this.material=void 0}var s=n.prototype;return s.setValue=function(t,e,r,i){this.component=t,this.mesh=e,this.subMesh=r,this.material=i},n}(),jl=function(){function n(){this.component=void 0,this.positions=void 0,this.uv=void 0,this.triangles=void 0,this.color=void 0,this.material=void 0,this.camera=void 0}var s=n.prototype;return s.setValue=function(t,e,r,i,o,c,l){this.component=t,this.positions=e,this.uv=r,this.triangles=i,this.color=o,this.material=c,this.camera=l},n}(),Xl=function(){function n(){this.component=void 0,this.positions=void 0,this.uv=void 0,this.triangles=void 0,this.material=void 0,this.isAdd=!0,this.camera=void 0}var s=n.prototype;return s.setValue=function(t,e,r,i,o){this.component=t,this.positions=e,this.uv=r,this.triangles=i,this.material=o},n}(),ar;(function(n){n[n.None=0]="None",n[n.VisibleInsideMask=1]="VisibleInsideMask",n[n.VisibleOutsideMask=2]="VisibleOutsideMask"})(ar||(ar={}));var Ae,Yn,$n,Jn,Zn,ea,ta,ra,ia,na,aa,oa,sa,ca,la,ua,ha,Qt,_n=(Ae=(Qt=function(n){X(s,n);function s(t){var e;e=n.call(this,t)||this,I(e,"shaderData",Yn,B(e)),I(e,"isCulled",$n,B(e)),I(e,"_distanceForSort",Jn,B(e)),I(e,"_onUpdateIndex",Zn,B(e)),I(e,"_rendererIndex",ea,B(e)),I(e,"_globalShaderMacro",ta,B(e)),I(e,"_renderSortId",ra,B(e)),I(e,"_overrideUpdate",ia,B(e)),I(e,"_materials",na,B(e)),I(e,"_transformChangeFlag",aa,B(e)),I(e,"_bounds",oa,B(e)),I(e,"_mvMatrix",sa,B(e)),I(e,"_mvpMatrix",ca,B(e)),I(e,"_mvInvMatrix",la,B(e)),I(e,"_normalMatrix",ua,B(e)),I(e,"_materialsInstanced",ha,B(e));var r=s.prototype;return e._overrideUpdate=e.update!==r.update,e._transformChangeFlag=e.entity.transform.registerWorldChangeFlag(),e.shaderData._addRefCount(1),e}var a=s.prototype;return a.getInstanceMaterial=function(e){e===void 0&&(e=0);var r=this._materials;if(r.length>e){var i=r[e];if(i)return this._materialsInstanced[e]?i:this._createInstanceMaterial(i,e)}return null},a.getMaterial=function(e){return e===void 0&&(e=0),this._materials[e]||null},a.setMaterial=function(e,r){r===void 0&&(r=null);var i;typeof e=="number"?i=e:(i=0,r=e);var o=this._materials;i>=o.length&&(o.length=i+1);var c=this._materialsInstanced,l=o[i];l!==r&&(o[i]=r,i<c.length&&(c[i]=!1),l&&l._addRefCount(-1),r&&r._addRefCount(1))},a.getInstanceMaterials=function(){for(var e=this._materials,r=this._materialsInstanced,i=0,o=e.length;i<o;i++)r[i]||this._createInstanceMaterial(this._materials[i],i);return e},a.getMaterials=function(){return this._materials},a.setMaterials=function(e){for(var r=e.length,i=this._materials,o=this._materialsInstanced,c=r,l=i.length;c<l;c++){var u=i[c];u&&u._addRefCount(-1)}i.length!==r&&(i.length=r),o.length!==0&&(o.length=0);for(var h=0;h<r;h++){var d=i[h],f=e[h];d!==f&&(i[h]=f,d&&d._addRefCount(-1),f&&f._addRefCount(1))}},a.update=function(e){},a._updateShaderData=function(e){var r=this.shaderData,i=this.entity.transform.worldMatrix,o=this._mvMatrix,c=this._mvpMatrix,l=this._mvInvMatrix,u=this._normalMatrix;j.multiply(e._camera.viewMatrix,i,o),j.multiply(e._viewProjectMatrix,i,c),j.invert(o,l),j.invert(i,u),u.transpose(),r.setMatrix(s._localMatrixProperty,this.entity.transform.localMatrix),r.setMatrix(s._worldMatrixProperty,i),r.setMatrix(s._mvMatrixProperty,o),r.setMatrix(s._mvpMatrixProperty,c),r.setMatrix(s._mvInvMatrixProperty,l),r.setMatrix(s._normalMatrixProperty,u)},a._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},a._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},a._onDestroy=function(){var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null),this.shaderData._addRefCount(-1);for(var r=0,i=this._materials.length;r<i;r++)this._materials[r]._addRefCount(-1)},a._updateBounds=function(e){},a._createInstanceMaterial=function(e,r){var i=e.clone();return i.name=i.name+"(Instance)",e._addRefCount(-1),i._addRefCount(1),this._materialsInstanced[r]=!0,this._materials[r]=i,i},W(s,[{key:"materialCount",get:function(){return this._materials.length},set:function(e){var r=this._materials,i=this._materialsInstanced;r.length!==e&&(r.length=e),i.length>e&&(i.length=e)}},{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}}]),s}(dt),Qt._localMatrixProperty=C.getPropertyByName("u_localMat"),Qt._worldMatrixProperty=C.getPropertyByName("u_modelMat"),Qt._mvMatrixProperty=C.getPropertyByName("u_MVMat"),Qt._mvpMatrixProperty=C.getPropertyByName("u_MVPMat"),Qt._mvInvMatrixProperty=C.getPropertyByName("u_MVInvMat"),Qt._normalMatrixProperty=C.getPropertyByName("u_normalMat"),Qt),Yn=F(Ae.prototype,"shaderData",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hi(gt.Renderer)}}),$n=F(Ae.prototype,"isCulled",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jn=F(Ae.prototype,"_distanceForSort",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zn=F(Ae.prototype,"_onUpdateIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ea=F(Ae.prototype,"_rendererIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ta=F(Ae.prototype,"_globalShaderMacro",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rt}}),ra=F(Ae.prototype,"_renderSortId",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ia=F(Ae.prototype,"_overrideUpdate",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),na=F(Ae.prototype,"_materials",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aa=F(Ae.prototype,"_transformChangeFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oa=F(Ae.prototype,"_bounds",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new or(new x,new x)}}),sa=F(Ae.prototype,"_mvMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),ca=F(Ae.prototype,"_mvpMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),la=F(Ae.prototype,"_mvInvMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),ua=F(Ae.prototype,"_normalMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),ha=F(Ae.prototype,"_materialsInstanced",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ae),Oi;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything"})(Oi||(Oi={}));var Yt,da,fa,_a,va,pa,ga,Xr,an=(Yt=(Xr=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,e._maskElement=void 0,I(e,"_positions",da,B(e)),I(e,"_worldMatrixDirtyFlag",fa,B(e)),I(e,"_sprite",_a,B(e)),I(e,"_alphaCutoff",va,B(e)),I(e,"_spriteDirty",pa,B(e)),I(e,"influenceLayers",ga,B(e)),e._worldMatrixDirtyFlag=t.transform.registerWorldChangeFlag(),e.setMaterial(e._engine._spriteMaskDefaultMaterial),e.shaderData.setFloat(s._alphaCutoffProperty,e._alphaCutoff),e}var a=s.prototype;return a._onDestroy=function(){this._worldMatrixDirtyFlag.destroy(),this._spriteDirty&&this._spriteDirty.destroy(),n.prototype._onDestroy.call(this)},a._render=function(e){var r=this.sprite;if(!r)return null;var i=r.texture;if(!i)return null;var o=this._positions,c=this.entity.transform;if(r._updateMesh(),this._worldMatrixDirtyFlag.flag||this._spriteDirty.flag){for(var l=r._positions,u=s._tempVec3,h=c.worldMatrix,d=0,f=o.length;d<f;d++){var _=l[d];u.setValue(_.x,_.y,0),x.transformToVec3(u,h,o[d])}this._spriteDirty.flag=!1,this._worldMatrixDirtyFlag.flag=!1}this.shaderData.setTexture(s._textureProperty,i);var v=this._engine._spriteMaskElementPool,p=v.getFromPool();p.setValue(this,o,r._uv,r._triangles,this.getMaterial()),p.camera=e,e._renderPipeline._allSpriteMasks.add(this),this._maskElement=p},a._cloneTo=function(e){e.sprite=this._sprite},W(s,[{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._spriteDirty&&this._spriteDirty.destroy(),this._sprite=e,e&&(this._spriteDirty=e._registerUpdateFlag()))}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(s._alphaCutoffProperty,e))}}]),s}(_n),Xr._textureProperty=C.getPropertyByName("u_maskTexture"),Xr._alphaCutoffProperty=C.getPropertyByName("u_maskAlphaCutoff"),Xr._tempVec3=new x,Xr),da=F(Yt.prototype,"_positions",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new x,new x,new x,new x]}}),fa=F(Yt.prototype,"_worldMatrixDirtyFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_a=F(Yt.prototype,"_sprite",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),va=F(Yt.prototype,"_alphaCutoff",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return .5}}),pa=F(Yt.prototype,"_spriteDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ga=F(Yt.prototype,"influenceLayers",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.Everything}}),Yt),H;(function(n){n[n.Float=0]="Float",n[n.Vector2=1]="Vector2",n[n.Vector3=2]="Vector3",n[n.Vector4=3]="Vector4",n[n.Byte4=4]="Byte4",n[n.UByte4=5]="UByte4",n[n.NormalizedByte4=6]="NormalizedByte4",n[n.NormalizedUByte4=7]="NormalizedUByte4",n[n.Short2=8]="Short2",n[n.UShort2=9]="UShort2",n[n.NormalizedShort2=10]="NormalizedShort2",n[n.NormalizedUShort2=11]="NormalizedUShort2",n[n.Short4=12]="Short4",n[n.UShort4=13]="UShort4",n[n.NormalizedShort4=14]="NormalizedShort4",n[n.NormalizedUShort4=15]="NormalizedUShort4"})(H||(H={}));var lt;(function(n){n[n.Static=0]="Static",n[n.Dynamic=1]="Dynamic",n[n.Stream=2]="Stream"})(lt||(lt={}));var De;(function(n){n[n.UInt8=0]="UInt8",n[n.UInt16=1]="UInt16",n[n.UInt32=2]="UInt32"})(De||(De={}));var Li=function(){function n(){}return n._getGLBufferUsage=function(a,t){switch(t){case lt.Static:return a.STATIC_DRAW;case lt.Dynamic:return a.DYNAMIC_DRAW;case lt.Stream:return a.STREAM_DRAW}},n._getGLIndexType=function(a){switch(a){case De.UInt8:return we.UNSIGNED_BYTE;case De.UInt16:return we.UNSIGNED_SHORT;case De.UInt32:return we.UNSIGNED_INT}},n._getGLIndexByteCount=function(a){switch(a){case De.UInt8:return 1;case De.UInt16:return 2;case De.UInt32:return 4}},n._getElementInfo=function(a){var t,e,r=!1;switch(a){case H.Float:t=1,e=we.FLOAT;break;case H.Vector2:t=2,e=we.FLOAT;break;case H.Vector3:t=3,e=we.FLOAT;break;case H.Vector4:t=4,e=we.FLOAT;break;case H.Byte4:t=4,e=we.BYTE;break;case H.UByte4:t=4,e=we.UNSIGNED_BYTE;break;case H.NormalizedByte4:t=4,e=we.BYTE,r=!0;break;case H.NormalizedUByte4:t=4,e=we.UNSIGNED_BYTE,r=!0;break;case H.Short2:t=2,e=we.SHORT;break;case H.UShort2:t=2,e=we.UNSIGNED_SHORT;break;case H.NormalizedShort2:t=2,e=we.SHORT,r=!0;break;case H.NormalizedUShort2:t=2,e=we.UNSIGNED_SHORT,r=!0;break;case H.Short4:t=4,e=we.SHORT;break;case H.UShort4:t=4,e=we.UNSIGNED_SHORT;break;case H.NormalizedShort4:t=4,e=we.SHORT,r=!0;break;case H.NormalizedUShort4:t=4,e=we.UNSIGNED_SHORT,r=!0;break}return{size:t,type:e,normalized:r}},n}(),ue=function(){function n(s,a,t,e,r){r===void 0&&(r=0),this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=s,this._offset=a,this._format=t,this._bindingIndex=e,this._glElementInfo=Li._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return W(n,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}}]),n}(),kt;(function(n){n[n.VertexBuffer=0]="VertexBuffer",n[n.IndexBuffer=1]="IndexBuffer"})(kt||(kt={}));var Ii;(function(n){n[n.None=0]="None",n[n.Discard=1]="Discard"})(Ii||(Ii={}));var Vr=function(n){X(s,n);function s(t,e,r,i){var o;i===void 0&&(i=lt.Static),o=n.call(this,t)||this,o._glBindTarget=void 0,o._glBufferUsage=void 0,o._nativeBuffer=void 0,o._hardwareRenderer=void 0,o._type=void 0,o._byteLength=void 0,o._bufferUsage=void 0,o._engine=t,o._type=e,o._bufferUsage=i;var c=t._hardwareRenderer,l=c.gl,u=Li._getGLBufferUsage(l,i),h=e===kt.VertexBuffer?l.ARRAY_BUFFER:l.ELEMENT_ARRAY_BUFFER;return o._nativeBuffer=l.createBuffer(),o._hardwareRenderer=c,o._glBufferUsage=u,o._glBindTarget=h,o.bind(),typeof r=="number"?(o._byteLength=r,l.bufferData(h,r,u)):(o._byteLength=r.byteLength,l.bufferData(h,r,u)),l.bindBuffer(h,null),o}var a=s.prototype;return a.bind=function(){var e=this._hardwareRenderer.gl;e.bindBuffer(this._glBindTarget,this._nativeBuffer)},a.setData=function(e,r,i,o,c){r===void 0&&(r=0),i===void 0&&(i=0),c===void 0&&(c=Ii.None);var l=this._hardwareRenderer.gl,u=this._hardwareRenderer.isWebGL2,h=this._glBindTarget;this.bind(),c===Ii.Discard&&l.bufferData(h,this._byteLength,this._glBufferUsage);var d=e.BYTES_PER_ELEMENT||1,f=o?d*o:e.byteLength;if(i!==0||f<e.byteLength){var _=e.byteOffset!==void 0;if(u&&_)l.bufferSubData(h,r,e,i,f/d);else{var v=new Uint8Array(_?e.buffer:e,i*d,f);l.bufferSubData(h,r,v)}}else l.bufferSubData(h,r,e);l.bindBuffer(h,null)},a.getData=function(e,r,i,o){r===void 0&&(r=0),i===void 0&&(i=0);var c=this._hardwareRenderer.isWebGL2;if(c){var l=this._hardwareRenderer.gl;this.bind(),l.getBufferSubData(this._glBindTarget,r,e,i,o)}else throw"Buffer is write-only on WebGL1.0 platforms."},a._onDestroy=function(){var e=this._hardwareRenderer.gl;e.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},a.resize=function(e){this.bind();var r=this._hardwareRenderer.gl;r.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},W(s,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),s}(kr),si;(function(n){n[n.Points=0]="Points",n[n.Lines=1]="Lines",n[n.LineLoop=2]="LineLoop",n[n.LineStrip=3]="LineStrip",n[n.Triangles=4]="Triangles",n[n.TriangleStrip=5]="TriangleStrip",n[n.TriangleFan=6]="TriangleFan"})(si||(si={}));var on=function(){function n(s,a){this._buffer=void 0,this._format=void 0,this._buffer=s,this._format=a}return W(n,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),n}(),Es=function(s,a,t){s===void 0&&(s=0),a===void 0&&(a=0),t===void 0&&(t=si.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=s,this.count=a,this.topology=t},Bs=function(n){X(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.name=void 0,r.bounds=new or,r._vertexElementMap={},r._glIndexType=void 0,r._glIndexByteCount=void 0,r._platformPrimitive=void 0,r._instanceCount=0,r._vertexBufferBindings=[],r._indexBufferBinding=null,r._vertexElements=[],r._subMeshes=[],r._updateFlagManager=new ui,r.name=e,r._platformPrimitive=r._engine._hardwareRenderer.createPlatformPrimitive(B(r)),r}var a=s.prototype;return a.addSubMesh=function(e,r,i){return i===void 0&&(i=si.Triangles),typeof e=="number"&&(e=new Es(e,r,i)),this._subMeshes.push(e),e},a.removeSubMesh=function(e){var r=this._subMeshes,i=r.indexOf(e);i!==-1&&r.splice(i,1)},a.clearSubMesh=function(){this._subMeshes.length=0},a.registerUpdateFlag=function(){return this._updateFlagManager.register()},a._draw=function(e,r){this._platformPrimitive.draw(e,r)},a._addRefCount=function(e){n.prototype._addRefCount.call(this,e);for(var r=this._vertexBufferBindings,i=0,o=r.length;i<o;i++)r[i]._buffer._addRefCount(e)},a._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},a._setVertexElements=function(e){this._clearVertexElements();for(var r=0,i=e.length;r<i;r++)this._addVertexElement(e[r])},a._setVertexBufferBinding=function(e,r){if(this._getRefCount()>0){var i=this._vertexBufferBindings[e];i&&i._buffer._addRefCount(-1),r._buffer._addRefCount(1)}this._vertexBufferBindings[e]=r},a._setIndexBufferBinding=function(e){e?(this._indexBufferBinding=e,this._glIndexType=Li._getGLIndexType(e.format),this._glIndexByteCount=Li._getGLIndexByteCount(e.format)):(this._indexBufferBinding=null,this._glIndexType=void 0)},a._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var r in e)delete e[r]},a._addVertexElement=function(e){var r=e.semantic;this._vertexElementMap[r]=e,this._vertexElements.push(e),this._updateFlagManager.distribute()},W(s,[{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),s}(kr),Ds=function(){function n(s,a){this._buffer=void 0,this._stride=void 0,this._buffer=s,this._stride=a}return W(n,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),n}(),mt;(function(n){n[n.Point=0]="Point",n[n.Bilinear=1]="Bilinear",n[n.Trilinear=2]="Trilinear"})(mt||(mt={}));var Y;(function(n){n[n.R8G8B8=0]="R8G8B8",n[n.R8G8B8A8=1]="R8G8B8A8",n[n.R4G4B4A4=2]="R4G4B4A4",n[n.R5G5B5A1=3]="R5G5B5A1",n[n.R5G6B5=4]="R5G6B5",n[n.Alpha8=5]="Alpha8",n[n.LuminanceAlpha=6]="LuminanceAlpha",n[n.R32G32B32A32=7]="R32G32B32A32",n[n.DXT1=8]="DXT1",n[n.DXT5=9]="DXT5",n[n.ETC1_RGB=10]="ETC1_RGB",n[n.ETC2_RGB=11]="ETC2_RGB",n[n.ETC2_RGBA5=12]="ETC2_RGBA5",n[n.ETC2_RGBA8=13]="ETC2_RGBA8",n[n.PVRTC_RGB2=14]="PVRTC_RGB2",n[n.PVRTC_RGBA2=15]="PVRTC_RGBA2",n[n.PVRTC_RGB4=16]="PVRTC_RGB4",n[n.PVRTC_RGBA4=17]="PVRTC_RGBA4",n[n.ASTC_4x4=18]="ASTC_4x4",n[n.ASTC_5x5=19]="ASTC_5x5",n[n.ASTC_6x6=20]="ASTC_6x6",n[n.ASTC_8x8=21]="ASTC_8x8",n[n.ASTC_10x10=22]="ASTC_10x10",n[n.ASTC_12x12=23]="ASTC_12x12"})(Y||(Y={}));var Ye;(function(n){n[n.Clamp=0]="Clamp",n[n.Repeat=1]="Repeat",n[n.Mirror=2]="Mirror"})(Ye||(Ye={}));var Hr=function(n){X(s,n);function s(t,e,r,i,o){var c;return i===void 0&&(i=Y.R8G8B8A8),o===void 0&&(o=!0),c=n.call(this,t)||this,c._format=void 0,c._mipmap=o,c._width=e,c._height=r,c._format=i,c._mipmapCount=c._getMipmapCount(),c._platformTexture=t._hardwareRenderer.createPlatformTexture2D(B(c)),c.filterMode=mt.Bilinear,c.wrapModeU=c.wrapModeV=Ye.Repeat,c}var a=s.prototype;return a.setPixelBuffer=function(e,r,i,o,c,l){r===void 0&&(r=0),this._platformTexture.setPixelBuffer(e,r,i,o,c,l)},a.setImageSource=function(e,r,i,o,c,l){r===void 0&&(r=0),i===void 0&&(i=!1),o===void 0&&(o=!1),this._platformTexture.setImageSource(e,r,i,o,c,l)},a.getPixelBuffer=function(e,r,i,o,c,l){var u=arguments.length;u===1?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):u===2?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,r):u===5?this._platformTexture.getPixelBuffer(e,r,i,o,0,c):u===6&&this._platformTexture.getPixelBuffer(e,r,i,o,c,l)},W(s,[{key:"format",get:function(){return this._format}}]),s}(xt),et;(function(n){n[n.R8G8B8=0]="R8G8B8",n[n.R8G8B8A8=1]="R8G8B8A8",n[n.R4G4B4A4=2]="R4G4B4A4",n[n.R5G5B5A1=3]="R5G5B5A1",n[n.R5G6B5=4]="R5G6B5",n[n.Alpha8=5]="Alpha8",n[n.R16G16B16A16=6]="R16G16B16A16",n[n.R32G32B32A32=7]="R32G32B32A32"})(et||(et={}));var Ue;(function(n){n[n.Depth=0]="Depth",n[n.DepthStencil=1]="DepthStencil",n[n.Stencil=2]="Stencil",n[n.Depth16=3]="Depth16",n[n.Depth24=4]="Depth24",n[n.Depth32=5]="Depth32",n[n.Depth24Stencil8=6]="Depth24Stencil8",n[n.Depth32Stencil8=7]="Depth32Stencil8"})(Ue||(Ue={}));var pt;(function(n){n[n.PositiveX=0]="PositiveX",n[n.NegativeX=1]="NegativeX",n[n.PositiveY=2]="PositiveY",n[n.NegativeY=3]="NegativeY",n[n.PositiveZ=4]="PositiveZ",n[n.NegativeZ=5]="NegativeZ"})(pt||(pt={}));var Wi=function(n){X(s,n);function s(t,e,r,i){var o;return r===void 0&&(r=Y.R8G8B8A8),i===void 0&&(i=!0),o=n.call(this,t)||this,o._format=void 0,o._mipmap=i,o._width=e,o._height=e,o._format=r,o._mipmapCount=o._getMipmapCount(),o._platformTexture=t._hardwareRenderer.createPlatformTextureCubeMap(B(o)),o.filterMode=mt.Bilinear,o.wrapModeU=o.wrapModeV=Ye.Clamp,o}var a=s.prototype;return a.setPixelBuffer=function(e,r,i,o,c,l,u){i===void 0&&(i=0),this._platformTexture.setPixelBuffer(e,r,i,o,c,l,u)},a.setImageSource=function(e,r,i,o,c,l,u){i===void 0&&(i=0),o===void 0&&(o=!1),c===void 0&&(c=!1),this._platformTexture.setImageSource(e,r,i,o,c,l,u)},a.getPixelBuffer=function(e,r,i,o,c,l,u){var h=arguments.length;h===2?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):h===3?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,i):h===6?this._platformTexture.getPixelBuffer(e,r,i,o,c,0,l):h===7&&this._platformTexture.getPixelBuffer(e,r,i,o,c,l,u)},W(s,[{key:"format",get:function(){return this._format}}]),s}(xt),Kl=function(n){X(s,n);function s(a,t,e,r,i,o){var c;return r===void 0&&(r=Ue.Depth),i===void 0&&(i=!1),o===void 0&&(o=!1),c=n.call(this,a)||this,c._autoMipmap=!1,c._format=void 0,c._isCube=!1,c._isCube=o,c._mipmap=i,c._width=t,c._height=e,c._format=r,c._mipmapCount=c._getMipmapCount(),c._platformTexture=a._hardwareRenderer.createPlatformRenderDepthTexture(B(c)),c.filterMode=mt.Bilinear,c.wrapModeU=c.wrapModeV=Ye.Clamp,c}return W(s,[{key:"format",get:function(){return this._format}},{key:"isCube",get:function(){return this._isCube}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(t){this._autoMipmap=t}}]),s}(xt),ql=function(n){X(s,n);function s(t,e,r,i,o,c){var l;return o===void 0&&(o=Ue.Depth),c===void 0&&(c=1),l=n.call(this,t)||this,l._platformRenderTarget=void 0,l._colorTextures=void 0,l._depth=void 0,l._antiAliasing=void 0,l._width=void 0,l._height=void 0,l._depthTexture=void 0,l._width=e,l._height=r,l._antiAliasing=c,l._depth=o,i?l._colorTextures=i instanceof Array?i.slice():[i]:l._colorTextures=[],o instanceof Kl&&(l._depthTexture=o),l._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(B(l)),l}var a=s.prototype;return a.getColorTexture=function(e){return e===void 0&&(e=0),this._colorTextures[e]},a.generateMipmaps=function(){var e,r=this.colorTextureCount;(e=this._depthTexture)!==null&&e!==void 0&&e.autoGenerateMipmaps&&this._depthTexture.generateMipmaps();for(var i=0;i<r;i++){var o=this._colorTextures[i];o.autoGenerateMipmaps&&o.generateMipmaps()}},a.destroy=function(){this._platformRenderTarget.destroy(),this._colorTextures.length=0,this._depthTexture=null,this._depth=null},a._setRenderTargetInfo=function(e,r){this._platformRenderTarget.setRenderTargetInfo(e,r)},a._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},W(s,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),s}(sr),Ql=function(n){X(s,n);function s(t,e,r,i,o,c){var l;return i===void 0&&(i=et.R8G8B8A8),o===void 0&&(o=!1),c===void 0&&(c=!1),l=n.call(this,t)||this,l._autoMipmap=!1,l._format=void 0,l._isCube=!1,l._isCube=c,l._mipmap=o,l._width=e,l._height=r,l._format=i,l._mipmapCount=l._getMipmapCount(),l._platformTexture=t._hardwareRenderer.createPlatformRenderColorTexture(B(l)),l.filterMode=mt.Bilinear,l.wrapModeU=l.wrapModeV=Ye.Clamp,l}var a=s.prototype;return a.getPixelBuffer=function(e,r,i,o,c,l,u){l===void 0&&(l=0),this._platformTexture.getPixelBuffer(e,r,i,o,c,l,u)},W(s,[{key:"format",get:function(){return this._format}},{key:"isCube",get:function(){return this._isCube}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),s}(xt),Ft=function(n){X(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r._hasBlendShape=!1,r._useBlendShapeNormal=!1,r._useBlendShapeTangent=!1,r._blendShapeTexture=void 0,r._vertexCount=0,r._accessible=!0,r._verticesFloat32=null,r._verticesUint8=null,r._indices=null,r._indicesFormat=null,r._vertexSlotChanged=!0,r._vertexChangeFlag=0,r._indicesChangeFlag=!1,r._elementCount=0,r._vertexElementsCache=[],r._positions=[],r._normals=null,r._colors=null,r._tangents=null,r._uv=null,r._uv1=null,r._uv2=null,r._uv3=null,r._uv4=null,r._uv5=null,r._uv6=null,r._uv7=null,r._boneWeights=null,r._boneIndices=null,r._blendShapes=[],r._blendShapeUpdateFlags=[],r.name=e,r}var a=s.prototype;return a.setPositions=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";var r=e.length;this._positions=e,this._vertexChangeFlag|=ae.Position,this._vertexCount!==r&&(this._vertexCount=r)},a.getPositions=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._positions},a.setNormals=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._normals!=!!e,this._vertexChangeFlag|=ae.Normal,this._normals=e},a.getNormals=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._normals},a.setColors=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._colors!=!!e,this._vertexChangeFlag|=ae.Color,this._colors=e},a.getColors=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._colors},a.setBoneWeights=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=e!=null,this._vertexChangeFlag|=ae.BoneWeight,this._boneWeights=e},a.getBoneWeights=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneWeights},a.setBoneIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._boneIndices!=!!e,this._vertexChangeFlag|=ae.BoneIndex,this._boneIndices=e},a.getBoneIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneIndices},a.setTangents=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._tangents!=!!e,this._vertexChangeFlag|=ae.Tangent,this._tangents=e},a.getTangents=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._tangents},a.setUVs=function(e,r){var i;if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";switch(r=(i=r)!=null?i:0,r){case 0:this._vertexSlotChanged=!!this._uv!=!!e,this._vertexChangeFlag|=ae.UV,this._uv=e;break;case 1:this._vertexSlotChanged=!!this._uv1!=!!e,this._vertexChangeFlag|=ae.UV1,this._uv1=e;break;case 2:this._vertexSlotChanged=!!this._uv2!=!!e,this._vertexChangeFlag|=ae.UV2,this._uv2=e;break;case 3:this._vertexSlotChanged=!!this._uv3!=!!e,this._vertexChangeFlag|=ae.UV3,this._uv3=e;break;case 4:this._vertexSlotChanged=!!this._uv4!=!!e,this._vertexChangeFlag|=ae.UV4,this._uv4=e;break;case 5:this._vertexSlotChanged=!!this._uv5!=!!e,this._vertexChangeFlag|=ae.UV5,this._uv5=e;break;case 6:this._vertexSlotChanged=!!this._uv6!=!!e,this._vertexChangeFlag|=ae.UV6,this._uv6=e;break;case 7:this._vertexSlotChanged=!!this._uv7!=!!e,this._vertexChangeFlag|=ae.UV7,this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},a.getUVs=function(e){var r;if(!this._accessible)throw"Not allowed to access data while accessible is false.";switch(e=(r=e)!=null?r:0,e){case 0:return this._uv;case 1:return this._uv1;case 2:return this._uv2;case 3:return this._uv3;case 4:return this._uv4;case 5:return this._uv5;case 6:return this._uv6;case 7:return this._uv7}throw"The index of channel needs to be in range [0 - 7]."},a.setIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._indices!==e&&(this._indices=e,e instanceof Uint8Array?this._indicesFormat=De.UInt8:e instanceof Uint16Array?this._indicesFormat=De.UInt16:e instanceof Uint32Array&&(this._indicesFormat=De.UInt32)),this._indicesChangeFlag=!0},a.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},a.addBlendShape=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._vertexChangeFlag|=ae.BlendShape,this._useBlendShapeNormal=this._useBlendShapeNormal||e._useBlendShapeNormal,this._useBlendShapeTangent=this._useBlendShapeTangent||e._useBlendShapeTangent,this._blendShapes.push(e),this._blendShapeUpdateFlags.push(e._registerChangeFlag()),this._hasBlendShape=!0},a.clearBlendShapes=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._vertexChangeFlag|=ae.BlendShape,this._useBlendShapeNormal=!1,this._useBlendShapeTangent=!1,this._blendShapes.length=0;for(var e=this._blendShapeUpdateFlags,r=0,i=e.length;r<i;r++)e[r].destroy();e.length=0,this._hasBlendShape=!1},a.uploadData=function(e){var r,i;if(!this._accessible)throw"Not allowed to access data while accessible is false.";var o=this._indices;if(this._vertexSlotChanged){var c=this._updateVertexElements();this._setVertexElements(c),this._vertexChangeFlag=ae.All,this._vertexSlotChanged=!1}var l=this._vertexBufferBindings,u=this._elementCount,h=(r=l[0])===null||r===void 0?void 0:r._buffer,d=u*this._vertexCount;if(!h||this._verticesFloat32.length!==d){h==null||h.destroy();var f=new Float32Array(d);this._verticesFloat32=f,this._verticesUint8=new Uint8Array(f.buffer),this._vertexChangeFlag=ae.All,this._updateVertices(f);var _=new Vr(this._engine,kt.VertexBuffer,f,e?lt.Static:lt.Dynamic);this._setVertexBufferBinding(0,new Ds(_,u*4))}else if(this._vertexChangeFlag&ae.All){var v=this._verticesFloat32;this._updateVertices(v),h.setData(v)}var p=(i=this._indexBufferBinding)===null||i===void 0?void 0:i._buffer;if(o)if(!p||o.byteLength!=p.byteLength){p==null||p.destroy();var g=new Vr(this._engine,kt.IndexBuffer,o);this._setIndexBufferBinding(new on(g,this._indicesFormat))}else this._indicesChangeFlag&&(this._indicesChangeFlag=!1,p.setData(o),this._indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new on(p,this._indicesFormat)));else p&&(p.destroy(),this._setIndexBufferBinding(null));e&&(this._accessible=!1,this._releaseCache())},a._onDestroy=function(){n.prototype._onDestroy.call(this),this._accessible&&this._releaseCache()},a._updateVertexElements=function(){var e=this._vertexElementsCache;e.length=1,e[0]=Yl;var r=12,i=3;this._normals&&(e.push(new ue("NORMAL",r,H.Vector3,0)),r+=12,i+=3),this._colors&&(e.push(new ue("COLOR_0",r,H.Vector4,0)),r+=16,i+=4),this._boneWeights&&(e.push(new ue("WEIGHTS_0",r,H.Vector4,0)),r+=16,i+=4),this._boneIndices&&(e.push(new ue("JOINTS_0",r,H.UByte4,0)),r+=4,i+=1),this._tangents&&(e.push(new ue("TANGENT",r,H.Vector4,0)),r+=16,i+=4),this._uv&&(e.push(new ue("TEXCOORD_0",r,H.Vector2,0)),r+=8,i+=2),this._uv1&&(e.push(new ue("TEXCOORD_1",r,H.Vector2,0)),r+=8,i+=2),this._uv2&&(e.push(new ue("TEXCOORD_2",r,H.Vector2,0)),r+=8,i+=2),this._uv3&&(e.push(new ue("TEXCOORD_3",r,H.Vector2,0)),r+=8,i+=2),this._uv4&&(e.push(new ue("TEXCOORD_4",r,H.Vector2,0)),r+=8,i+=2),this._uv5&&(e.push(new ue("TEXCOORD_5",r,H.Vector2,0)),r+=8,i+=2),this._uv6&&(e.push(new ue("TEXCOORD_6",r,H.Vector2,0)),r+=8,i+=2),this._uv7&&(e.push(new ue("TEXCOORD_7",r,H.Vector2,0)),r+=8,i+=2);for(var o=Math.min(this._blendShapes.length,4),c=0,l=o;c<l;c++)e.push(new ue("POSITION_BS"+c,r,H.Vector3,0)),r+=12,i+=3,this._useBlendShapeNormal&&(e.push(new ue("NORMAL_BS"+c,r,H.Vector3,0)),r+=12,i+=3),this._useBlendShapeTangent&&(e.push(new ue("TANGENT_BS"+c,r,H.Vector3,0)),r+=12,i+=3);return this._elementCount=i,e},a._updateVertices=function(e){var r=this._elementCount,i=this._vertexCount,o=this._positions,c=this._normals,l=this._colors,u=this._vertexChangeFlag,h=this._boneWeights,d=this._boneIndices,f=this._tangents,_=this._uv,v=this._uv1,p=this._uv2,g=this._uv3,m=this._uv4,y=this._uv5,w=this._uv6,P=this._uv7;if(u&ae.Position)for(var A=0;A<i;A++){var b=r*A,M=o[A];e[b]=M.x,e[b+1]=M.y,e[b+2]=M.z}var S=3;if(c){if(u&ae.Normal)for(var T=0;T<i;T++){var z=r*T+S,R=c[T];R&&(e[z]=R.x,e[z+1]=R.y,e[z+2]=R.z)}S+=3}if(l){if(u&ae.Color)for(var E=0;E<i;E++){var N=r*E+S,D=l[E];D&&(e[N]=D.r,e[N+1]=D.g,e[N+2]=D.b,e[N+3]=D.a)}S+=4}if(h){if(u&ae.BoneWeight)for(var V=0;V<i;V++){var U=r*V+S,G=h[V];G&&(e[U]=G.x,e[U+1]=G.y,e[U+2]=G.z,e[U+3]=G.w)}S+=4}if(d){if(u&ae.BoneIndex)for(var O=this._verticesUint8,K=0;K<i;K++){var ee=r*K+S,re=d[K];if(re){var Z=ee*4;O[Z]=re.x,O[Z+1]=re.y,O[Z+2]=re.z,O[Z+3]=re.w}}S+=1}if(f){if(u&ae.Tangent)for(var se=0;se<i;se++){var de=r*se+S,_e=f[se];_e&&(e[de]=_e.x,e[de+1]=_e.y,e[de+2]=_e.z)}S+=4}if(_){if(u&ae.UV)for(var le=0;le<i;le++){var Pe=r*le+S,Oe=_[le];Oe&&(e[Pe]=Oe.x,e[Pe+1]=Oe.y)}S+=2}if(v){if(u&ae.UV1)for(var ze=0;ze<i;ze++){var Ze=r*ze+S,Le=v[ze];Le&&(e[Ze]=Le.x,e[Ze+1]=Le.y)}S+=2}if(p){if(u&ae.UV2)for(var ke=0;ke<i;ke++){var Ee=r*ke+S,Ke=p[ke];Ke&&(e[Ee]=Ke.x,e[Ee+1]=Ke.y)}S+=2}if(g){if(u&ae.UV3)for(var He=0;He<i;He++){var qe=r*He+S,Ie=g[He];Ie&&(e[qe]=Ie.x,e[qe+1]=Ie.y)}S+=2}if(m){if(u&ae.UV4)for(var xe=0;xe<i;xe++){var ge=r*xe+S,Dt=m[xe];Dt&&(e[ge]=Dt.x,e[ge+1]=Dt.y)}S+=2}if(y){if(u&ae.UV5)for(var cr=0;cr<i;cr++){var pi=r*cr+S,lr=y[cr];lr&&(e[pi]=lr.x,e[pi+1]=lr.y)}S+=2}if(w){if(u&ae.UV6)for(var ur=0;ur<i;ur++){var hr=r*ur+S,dr=w[ur];dr&&(e[hr]=dr.x,e[hr+1]=dr.y)}S+=2}if(P){if(u&ae.UV7)for(var fr=0;fr<i;fr++){var Wr=r*fr+S,Kt=P[fr];Kt&&(e[Wr]=Kt.x,e[Wr+1]=Kt.y)}S+=2}if(u&ae.BlendShape){var mn=this._blendShapes,oc=this._blendShapeUpdateFlags,sc=Math.min(mn.length,4);this.engine._hardwareRenderer;for(var gi=0;gi<sc;gi++){var yn=oc[gi];if(yn.flag){var cc=mn[gi],xn=cc.frames,wn=xn.length,mi=xn[wn-1];if(wn>0&&mi.deltaPositions.length!==this._vertexCount)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var lc=mi.deltaPositions,yi=0;yi<i;yi++){var Xi=r*yi+S,xi=lc[yi];xi&&(e[Xi]=xi.x,e[Xi+1]=xi.y,e[Xi+2]=xi.z)}if(S+=3,this._useBlendShapeNormal){var bn=mi.deltaNormals;if(bn)for(var wi=0;wi<i;wi++){var Ki=r*wi+S,bi=bn[wi];bi&&(e[Ki]=bi.x,e[Ki+1]=bi.y,e[Ki+2]=bi.z)}S+=3}if(this._useBlendShapeTangent){var Pn=mi.deltaTangents;if(Pn)for(var Pi=0;Pi<i;Pi++){var qi=r*Pi+S,Si=Pn[Pi];Si&&(e[qi]=Si.x,e[qi+1]=Si.y,e[qi+2]=Si.z)}S+=3}yn.flag=!1}}}this._vertexChangeFlag=0},a._releaseCache=function(){for(var e=this._blendShapeUpdateFlags,r=0,i=e.length;r<i;r++)e[r].destroy();this._verticesUint8=null,this._indices=null,this._verticesFloat32=null,this._positions.length=0,this._tangents=null,this._normals=null,this._colors=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._blendShapes=null,this._blendShapeUpdateFlags=null},W(s,[{key:"accessible",get:function(){return this._accessible}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"blendShapes",get:function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._blendShapes}}]),s}(Bs),Yl=new ue("POSITION",0,H.Vector3,0),ae;(function(n){n[n.Position=1]="Position",n[n.Normal=2]="Normal",n[n.Color=4]="Color",n[n.Tangent=8]="Tangent",n[n.BoneWeight=16]="BoneWeight",n[n.BoneIndex=32]="BoneIndex",n[n.UV=64]="UV",n[n.UV1=128]="UV1",n[n.UV2=256]="UV2",n[n.UV3=512]="UV3",n[n.UV4=1024]="UV4",n[n.UV5=2048]="UV5",n[n.UV6=4096]="UV6",n[n.UV7=8192]="UV7",n[n.BlendShape=16384]="BlendShape",n[n.All=65535]="All"})(ae||(ae={}));var $l=function(n){X(s,n);function s(a){var t;return t=n.call(this,null)||this,t.name=a,t.inverseBindMatrices=void 0,t.joints=void 0,t.skeleton=void 0,t.inverseBindMatrices=[],t.joints=[],t.skeleton="none",t}return s}(sr),Mi,ma,ya,Er,di=(Mi=(Er=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,I(e,"_mesh",ma,B(e)),I(e,"_meshUpdateFlag",ya,B(e)),e}var a=s.prototype;return a._render=function(e){var r=this._mesh;if(r){if(this._meshUpdateFlag.flag){var i=this.shaderData,o=r._vertexElements;i.disableMacro(s._uvMacro),i.disableMacro(s._normalMacro),i.disableMacro(s._tangentMacro),i.disableMacro(s._vertexColorMacro);for(var c=0,l=o.length;c<l;c++){var u=o[c].semantic;switch(u){case"TEXCOORD_0":i.enableMacro(s._uvMacro);break;case"NORMAL":i.enableMacro(s._normalMacro);break;case"TANGENT":i.enableMacro(s._tangentMacro);break;case"COLOR_0":i.enableMacro(s._vertexColorMacro);break}}this._meshUpdateFlag.flag=!1}for(var h=r.subMeshes,d=e._renderPipeline,f=this._engine._renderElementPool,_=0,v=h.length;_<v;_++){var p=this._materials[_];if(p){var g=f.getFromPool();g.setValue(this,r,h[_],p),d.pushPrimitive(g)}}}},a._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._mesh;e&&!e.destroyed&&(e._addRefCount(-1),this._mesh=null)},a._cloneTo=function(e){e.mesh=this._mesh},a._updateBounds=function(e){var r=this._mesh;if(r){var i=r.bounds,o=this._entity.transform.worldMatrix;or.transform(i,o,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},W(s,[{key:"mesh",get:function(){return this._mesh},set:function(e){var r=this._mesh;r!==e&&(r&&(r._addRefCount(-1),this._meshUpdateFlag.destroy()),e&&(e._addRefCount(1),this._meshUpdateFlag=e.registerUpdateFlag()),this._mesh=e)}}]),s}(_n),Er._uvMacro=C.getMacroByName("O3_HAS_UV"),Er._normalMacro=C.getMacroByName("O3_HAS_NORMAL"),Er._tangentMacro=C.getMacroByName("O3_HAS_TANGENT"),Er._vertexColorMacro=C.getMacroByName("O3_HAS_VERTEXCOLOR"),Er),ma=F(Mi.prototype,"_mesh",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ya=F(Mi.prototype,"_meshUpdateFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Mi),$t,xa,wa,ba,Pa,Sa,Aa,St,ci=($t=(St=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,I(e,"matrixPalette",xa,B(e)),I(e,"jointNodes",wa,B(e)),I(e,"jointTexture",ba,B(e)),I(e,"_hasInitJoints",Pa,B(e)),I(e,"_mat",Sa,B(e)),I(e,"_useJointTexture",Aa,B(e)),e._skin=void 0,e._blendShapeWeights=void 0,e._mat=new j,e._skin=null,e}var a=s.prototype;return a._updateShaderData=function(e){n.prototype._updateShaderData.call(this,e);var r=this.shaderData;!this._useJointTexture&&this.matrixPalette&&r.setFloatArray(s._jointMatrixProperty,this.matrixPalette);var i=this.mesh;i._hasBlendShape?(r.setFloatArray(s._blendShapeWeightsProperty,this._blendShapeWeights),r.enableMacro(s._blendShapeMacro),i._useBlendShapeNormal?r.enableMacro(s._blendShapeNormalMacro):r.disableMacro(s._blendShapeNormalMacro),i._useBlendShapeTangent?r.enableMacro(s._blendShapeTangentMacro):r.disableMacro(s._blendShapeTangentMacro)):r.disableMacro(s._blendShapeMacro)},a._initJoints=function(){if(!!this._skin){for(var e=this._skin,r=e.joints,i=[],o=r.length-1;o>=0;o--)i[o]=this.findByNodeName(this.entity,r[o]);this.matrixPalette=new Float32Array(i.length*16),this.jointNodes=i;var c=this.entity.engine._hardwareRenderer;if(!!c){var l=c.renderStates.getParameter(c.gl.MAX_VERTEX_UNIFORM_VECTORS),u=Math.floor((l-30)/4),h=this.shaderData,d=i.length;if(d)if(h.enableMacro("O3_HAS_SKIN"),h.setInt(s._jointCountProperty,d),d>u)c.canIUseMoreJoints&&(this._useJointTexture=!0);else{var f=Math.max(s._maxJoints,d);s._maxJoints=f,h.disableMacro("O3_USE_JOINT_TEXTURE"),h.enableMacro("O3_JOINTS_NUM",f.toString())}else h.disableMacro("O3_HAS_SKIN")}}},a.findByNodeName=function(e,r){if(!e)return null;var i=e.findByName(r);return i||this.findByNodeName(e.parent,r)},a.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,r=this._skin.inverseBindMatrices,i=this.matrixPalette,o=this.entity.getInvModelMatrix(),c=this._mat,l=e.length-1;l>=0;l--)c.identity(),e[l]?j.multiply(e[l].transform.worldMatrix,r[l],c):r[l].cloneTo(c),j.multiply(o,c,c),i.set(c.elements,l*16);this._useJointTexture&&this.createJointTexture()}},a.createJointTexture=function(){if(!this.jointTexture){var e=this.engine,r=e._hardwareRenderer;if(!r)return;this.jointTexture=new Hr(e,4,this.jointNodes.length,Y.R32G32B32A32,!1),this.jointTexture.filterMode=mt.Point,this.shaderData.enableMacro("O3_USE_JOINT_TEXTURE"),this.shaderData.setTexture(s._jointSamplerProperty,this.jointTexture)}this.jointTexture.setPixelBuffer(this.matrixPalette)},W(s,[{key:"blendShapeWeights",get:function(){return this._blendShapeWeights},set:function(e){this._blendShapeWeights=e}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}}]),s}(di),St._blendShapeMacro=C.getMacroByName("OASIS_BLENDSHAPE"),St._blendShapeNormalMacro=C.getMacroByName("OASIS_BLENDSHAPE_NORMAL"),St._blendShapeTangentMacro=C.getMacroByName("OASIS_BLENDSHAPE_TANGENT"),St._jointCountProperty=C.getPropertyByName("u_jointCount"),St._jointSamplerProperty=C.getPropertyByName("u_jointSampler"),St._jointMatrixProperty=C.getPropertyByName("u_jointMatrix"),St._blendShapeWeightsProperty=C.getPropertyByName("u_blendShapeWeights"),St._maxJoints=0,St),xa=F($t.prototype,"matrixPalette",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wa=F($t.prototype,"jointNodes",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ba=F($t.prototype,"jointTexture",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pa=F($t.prototype,"_hasInitJoints",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sa=F($t.prototype,"_mat",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Aa=F($t.prototype,"_useJointTexture",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$t),$r=function(){function n(){}return n.createSphere=function(a,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=18),r===void 0&&(r=!0);var i=new Ft(a);e=Math.max(2,Math.floor(e));for(var o=e+1,c=o*o,l=e*e,u=n._generateIndices(a,c,l*6),h=Math.PI,d=h*2,f=1/o,_=1/e,v=new Array(c),p=new Array(c),g=new Array(c),m=0;m<c;++m){var y=m%o,w=m*f|0,P=y*_,A=w*_,b=P*d,M=A*h,S=Math.sin(M),T=-t*Math.cos(b)*S,z=t*Math.cos(M),R=t*Math.sin(b)*S;v[m]=new x(T,z,R),p[m]=new x(T,z,R),g[m]=new k(P,A)}for(var E=0,N=0;N<l;++N){var D=N%e,V=N*_|0,U=V*o+D,G=U+1,O=U+o,K=O+1;u[E++]=G,u[E++]=U,u[E++]=K,u[E++]=U,u[E++]=O,u[E++]=K}var ee=i.bounds;return ee.min.setValue(-t,-t,-t),ee.max.setValue(t,t,t),n._initialize(i,v,p,g,u,r),i},n.createCuboid=function(a,t,e,r,i){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),i===void 0&&(i=!0);var o=new Ft(a),c=t/2,l=e/2,u=r/2,h=new Array(24),d=new Array(24),f=new Array(24);h[0]=new x(-c,l,-u),h[1]=new x(c,l,-u),h[2]=new x(c,l,u),h[3]=new x(-c,l,u),d[0]=new x(0,1,0),d[1]=new x(0,1,0),d[2]=new x(0,1,0),d[3]=new x(0,1,0),f[0]=new k(0,0),f[1]=new k(1,0),f[2]=new k(1,1),f[3]=new k(0,1),h[4]=new x(-c,-l,-u),h[5]=new x(c,-l,-u),h[6]=new x(c,-l,u),h[7]=new x(-c,-l,u),d[4]=new x(0,-1,0),d[5]=new x(0,-1,0),d[6]=new x(0,-1,0),d[7]=new x(0,-1,0),f[4]=new k(0,1),f[5]=new k(1,1),f[6]=new k(1,0),f[7]=new k(0,0),h[8]=new x(-c,l,-u),h[9]=new x(-c,l,u),h[10]=new x(-c,-l,u),h[11]=new x(-c,-l,-u),d[8]=new x(-1,0,0),d[9]=new x(-1,0,0),d[10]=new x(-1,0,0),d[11]=new x(-1,0,0),f[8]=new k(0,0),f[9]=new k(1,0),f[10]=new k(1,1),f[11]=new k(0,1),h[12]=new x(c,l,-u),h[13]=new x(c,l,u),h[14]=new x(c,-l,u),h[15]=new x(c,-l,-u),d[12]=new x(1,0,0),d[13]=new x(1,0,0),d[14]=new x(1,0,0),d[15]=new x(1,0,0),f[12]=new k(1,0),f[13]=new k(0,0),f[14]=new k(0,1),f[15]=new k(1,1),h[16]=new x(-c,l,u),h[17]=new x(c,l,u),h[18]=new x(c,-l,u),h[19]=new x(-c,-l,u),d[16]=new x(0,0,1),d[17]=new x(0,0,1),d[18]=new x(0,0,1),d[19]=new x(0,0,1),f[16]=new k(0,0),f[17]=new k(1,0),f[18]=new k(1,1),f[19]=new k(0,1),h[20]=new x(-c,l,-u),h[21]=new x(c,l,-u),h[22]=new x(c,-l,-u),h[23]=new x(-c,-l,-u),d[20]=new x(0,0,-1),d[21]=new x(0,0,-1),d[22]=new x(0,0,-1),d[23]=new x(0,0,-1),f[20]=new k(1,0),f[21]=new k(0,0),f[22]=new k(0,1),f[23]=new k(1,1);var _=new Uint16Array(36);_[0]=0,_[1]=2,_[2]=1,_[3]=2,_[4]=0,_[5]=3,_[6]=4,_[7]=6,_[8]=7,_[9]=6,_[10]=4,_[11]=5,_[12]=8,_[13]=10,_[14]=9,_[15]=10,_[16]=8,_[17]=11,_[18]=12,_[19]=14,_[20]=15,_[21]=14,_[22]=12,_[23]=13,_[24]=16,_[25]=18,_[26]=17,_[27]=18,_[28]=16,_[29]=19,_[30]=20,_[31]=22,_[32]=23,_[33]=22,_[34]=20,_[35]=21;var v=o.bounds;return v.min.setValue(-c,-l,-u),v.max.setValue(c,l,u),n._initialize(o,h,d,f,_,i),o},n.createPlane=function(a,t,e,r,i,o){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),i===void 0&&(i=1),o===void 0&&(o=!0);var c=new Ft(a);r=Math.max(1,Math.floor(r)),i=Math.max(1,Math.floor(i));for(var l=r+1,u=i+1,h=t/2,d=e/2,f=t/r,_=e/i,v=l*u,p=i*r,g=n._generateIndices(a,v,p*6),m=1/l,y=1/r,w=1/i,P=new Array(v),A=new Array(v),b=new Array(v),M=0;M<v;++M){var S=M%l,T=M*m|0;P[M]=new x(S*f-h,0,T*_-d),A[M]=new x(0,1,0),b[M]=new k(S*y,T*w)}for(var z=0,R=0;R<p;++R){var E=R%r,N=R*y|0,D=N*l+E,V=D+1,U=D+l,G=U+1;g[z++]=D,g[z++]=U,g[z++]=V,g[z++]=U,g[z++]=G,g[z++]=V}var O=c.bounds;return O.min.setValue(-h,0,-d),O.max.setValue(h,0,d),n._initialize(c,P,A,b,g,o),c},n.createCylinder=function(a,t,e,r,i,o,c){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),i===void 0&&(i=20),o===void 0&&(o=1),c===void 0&&(c=!0);var l=new Ft(a);i=Math.floor(i),o=Math.floor(o);for(var u=i+1,h=o+1,d=r*.5,f=r/o,_=u*h,v=i*o,p=i*2,g=_+2+p,m=n._generateIndices(a,g,v*6+p*3),y=1/u,w=1/i,P=1/o,A=new Array(g),b=new Array(g),M=new Array(g),S=0,T=Math.PI,z=Math.PI*2,R=e-t,E=R/r,N=R/o,D=0;D<_;++D){var V=D%u,U=D*y|0,G=V*w,O=U*P,K=T+G*z,ee=Math.sin(K),re=Math.cos(K),Z=e-U*N,se=Z*ee,de=U*f-d,_e=Z*re;A[D]=new x(se,de,_e),b[D]=new x(ee,E,re),M[D]=new k(G,1-O)}for(var le=0;le<v;++le){var Pe=le%i,Oe=le*w|0,ze=Oe*u+Pe,Ze=ze+1,Le=ze+u,ke=Le+1;m[S++]=Ze,m[S++]=Le,m[S++]=ze,m[S++]=Ze,m[S++]=ke,m[S++]=Le}A[_]=new x(0,-d,0),b[_]=new x(0,-1,0),M[_]=new k(.5,.5),A[_+1]=new x(0,d,0),b[_+1]=new x(0,1,0),M[_+1]=new k(.5,.5);for(var Ee=_+2,Ke=1/(t*2),He=1/(e*2),qe=u*o,Ie=0;Ie<i;++Ie){var xe=A[Ie],ge=xe.x,Dt=xe.z;A[Ee]=new x(ge,-d,Dt),b[Ee]=new x(0,-1,0),M[Ee++]=new k(ge*He+.5,.5-Dt*He);var cr=A[Ie+qe];ge=cr.x,Dt=cr.z,A[Ee]=new x(ge,d,Dt),b[Ee]=new x(0,1,0),M[Ee++]=new k(ge*Ke+.5,Dt*Ke+.5)}for(var pi=_+1,lr=_+2,ur=lr+1,hr=0;hr<i;++hr){var dr=hr*2,fr=hr===i-1?0:dr+2;m[S++]=_,m[S++]=lr+fr,m[S++]=lr+dr,m[S++]=pi,m[S++]=ur+dr,m[S++]=ur+fr}var Wr=l.bounds,Kt=Math.max(t,e);return Wr.min.setValue(-Kt,-d,-Kt),Wr.max.setValue(Kt,d,Kt),n._initialize(l,A,b,M,m,c),l},n.createTorus=function(a,t,e,r,i,o,c){t===void 0&&(t=.5),e===void 0&&(e=.1),r===void 0&&(r=30),i===void 0&&(i=30),o===void 0&&(o=360),c===void 0&&(c=!0);var l=new Ft(a);r=Math.floor(r),i=Math.floor(i);var u=(r+1)*(i+1),h=r*i,d=n._generateIndices(a,u,h*6),f=new Array(u),_=new Array(u),v=new Array(u);o=o/180*Math.PI;for(var p=0,g=0;g<=r;g++)for(var m=0;m<=i;m++){var y=m/i*o,w=g/r*Math.PI*2,P=Math.cos(w),A=Math.sin(w),b=Math.cos(y),M=Math.sin(y),S=new x((t+e*P)*b,(t+e*P)*M,e*A);f[p]=S;var T=t*b,z=t*M;_[p]=new x(S.x-T,S.y-z,S.z).normalize(),v[p++]=new k(m/i,g/r)}p=0;for(var R=1;R<=r;R++)for(var E=1;E<=i;E++){var N=(i+1)*R+E-1,D=(i+1)*(R-1)+E-1,V=(i+1)*(R-1)+E,U=(i+1)*R+E;d[p++]=N,d[p++]=D,d[p++]=U,d[p++]=D,d[p++]=V,d[p++]=U}var G=l.bounds,O=t+e;return G.min.setValue(-O,-O,-e),G.max.setValue(O,O,e),n._initialize(l,f,_,v,d,c),l},n.createCone=function(a,t,e,r,i,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=20),i===void 0&&(i=1),o===void 0&&(o=!0);var c=new Ft(a);r=Math.floor(r),i=Math.floor(i);for(var l=r+1,u=i+1,h=e*.5,d=e/i,f=l*u,_=r*i,v=f+1+r,p=n._generateIndices(a,v,_*6+r*3),g=1/l,m=1/r,y=1/i,w=new Array(v),P=new Array(v),A=new Array(v),b=0,M=Math.PI,S=Math.PI*2,T=t/e,z=0;z<f;++z){var R=z%l,E=z*g|0,N=R*m,D=E*y,V=M+N*S,U=Math.sin(V),G=Math.cos(V),O=t-E*t,K=O*U,ee=E*d-h,re=O*G;w[z]=new x(K,ee,re),P[z]=new x(U,T,G),A[z]=new k(N,1-D)}for(var Z=0;Z<_;++Z){var se=Z%r,de=Z*m|0,_e=de*l+se,le=_e+1,Pe=_e+l,Oe=Pe+1;p[b++]=le,p[b++]=Pe,p[b++]=_e,p[b++]=le,p[b++]=Oe,p[b++]=Pe}w[f]=new x(0,-h,0),P[f]=new x(0,-1,0),A[f]=new k(.5,.5);for(var ze=f+1,Ze=1/(t*2),Le=0;Le<r;++Le){var ke=w[Le],Ee=ke.x,Ke=ke.z;w[ze]=new x(Ee,-h,Ke),P[ze]=new x(0,-1,0),A[ze++]=new k(Ee*Ze+.5,.5-Ke*Ze)}for(var He=f+1,qe=0;qe<r;++qe){var Ie=qe,xe=qe===r-1?0:Ie+1;p[b++]=f,p[b++]=He+xe,p[b++]=He+Ie}var ge=c.bounds;return ge.min.setValue(-t,-h,-t),ge.max.setValue(t,h,t),n._initialize(c,w,P,A,p,o),c},n.createCapsule=function(a,t,e,r,i,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=6),i===void 0&&(i=1),o===void 0&&(o=!0);var c=new Ft(a);r=Math.max(2,Math.floor(r)),i=Math.floor(i);for(var l=r+1,u=i+1,h=e*.5,d=e/i,f=l*u,_=r*i,v=l*l,p=r*r,g=f+2*v,m=n._generateIndices(a,g,(_+2*p)*6),y=1/l,w=1/r,P=1/i,A=Math.PI/2,b=Math.PI*2,M=new Array(g),S=new Array(g),T=new Array(g),z=0,R=0;R<f;++R){var E=R%l,N=R*y|0,D=E*w,V=N*P,U=-A+D*b,G=Math.sin(U),O=Math.cos(U);M[R]=new x(t*G,N*d-h,t*O),S[R]=new x(G,0,O),T[R]=new k(D,1-V)}for(var K=0;K<_;++K){var ee=K%r,re=K*w|0,Z=re*l+ee,se=Z+1,de=Z+l,_e=de+1;m[z++]=se,m[z++]=de,m[z++]=Z,m[z++]=se,m[z++]=_e,m[z++]=de}n._createCapsuleCap(t,e,r,b,f,1,M,S,T,m,z),n._createCapsuleCap(t,e,r,-b,f+v,-1,M,S,T,m,z+6*p);var le=c.bounds;return le.min.setValue(-t,-t-h,-t),le.max.setValue(t,t+h,t),n._initialize(c,M,S,T,m,o),c},n._initialize=function(a,t,e,r,i,o){a.setPositions(t),a.setNormals(e),a.setUVs(r),a.setIndices(i),a.uploadData(o),a.addSubMesh(0,i.length)},n._generateIndices=function(a,t,e){var r=null;if(t>65535)if(a._hardwareRenderer.canIUse(Ve.elementIndexUint))r=new Uint32Array(e);else throw Error("The vertex count is over limit.");else r=new Uint16Array(e);return r},n._createCapsuleCap=function(a,t,e,r,i,o,c,l,u,h,d){for(var f=e+1,_=t*.5,v=f*f,p=e*e,g=1/f,m=1/e,y=0;y<v;++y){var w=y%f,P=y*g|0,A=w*m,b=P*m,M=A*r,S=b*Math.PI/2,T=Math.sin(S),z=-a*Math.cos(M)*T,R=(a*Math.cos(S)+_)*o,E=a*Math.sin(M)*T,N=y+i;c[N]=new x(z,R,E),l[N]=new x(z,R,E),u[N]=new k(A,b)}for(var D=0;D<p;++D){var V=D%e,U=D*m|0,G=U*f+V+i,O=G+1,K=G+f,ee=K+1;h[d++]=O,h[d++]=G,h[d++]=ee,h[d++]=G,h[d++]=K,h[d++]=ee}},n}(),Os=function(n){X(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.setVertexElements=function(e){this._setVertexElements(e)},a.setVertexBufferBinding=function(e,r,i){r===void 0&&(r=0),i===void 0&&(i=0);var o=e,c=o.buffer!==void 0;c||(o=new Ds(e,r));var l=this._vertexBufferBindings;l.length<=i&&(l.length=i+1),this._setVertexBufferBinding(c?r:i,o)},a.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var i=this._vertexBufferBindings,o=e.length,c=r+o;i.length<c&&(i.length=c);for(var l=0;l<o;l++)this._setVertexBufferBinding(r+l,e[l])},a.setIndexBufferBinding=function(e,r){var i=e;if(i){var o=i.buffer!==void 0;o||(i=new on(e,r))}this._setIndexBufferBinding(i)},W(s,[{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}},{key:"vertexElements",get:function(){return this._vertexElements}}]),s}(Bs),Jl=function(s,a,t,e){if(t===void 0&&(t=null),e===void 0&&(e=null),this.weight=void 0,this.deltaPositions=void 0,this.deltaNormals=void 0,this.deltaTangents=void 0,t&&t.length!==a.length)throw"deltaNormals length must same with deltaPositions length.";if(e&&e.length!==a.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=s,this.deltaPositions=a,this.deltaNormals=t,this.deltaTangents=e},Zl=function(){function n(a){this.name=void 0,this._useBlendShapeNormal=!1,this._useBlendShapeTangent=!1,this._frames=[],this._updateFlagManager=new ui,this.name=a}var s=n.prototype;return s.addFrame=function(t,e,r,i){if(typeof t=="number"){var o=new Jl(t,e,r,i);return this._addFrame(o),o}else this._addFrame(t);this._updateFlagManager.distribute()},s.clearFrames=function(){this._frames.length=0,this._updateFlagManager.distribute(),this._useBlendShapeNormal=!1,this._useBlendShapeTangent=!1},s._registerChangeFlag=function(){return this._updateFlagManager.register()},s._addFrame=function(t){var e=this._frames,r=e.length;if(r>0&&t.deltaPositions.length!==e[r-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._useBlendShapeNormal=this._useBlendShapeNormal||t.deltaNormals!==null,this._useBlendShapeTangent=this._useBlendShapeTangent||t.deltaTangents!==null,this._frames.push(t)},W(n,[{key:"frames",get:function(){return this._frames}}]),n}(),ji=function(){function n(a){this._subMeshPool=new Ur(Es),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._vertices=void 0,this._indices=void 0,this._flushId=0,this._vertexCount=0,this._elementCount=0;var t=n.MAX_VERTEX_COUNT;this._vertices=new Float32Array(t*9),this._indices=new Uint16Array(t*3);for(var e=this._meshes,r=this._meshCount,i=0;i<r;i++)e[i]=this._createMesh(a,i)}var s=n.prototype;return s.drawElement=function(t){var e=t.positions.length;this._vertexCount+e>n.MAX_VERTEX_COUNT&&this.flush(t.camera.engine),this._vertexCount+=e,this._batchedQueue[this._elementCount++]=t},s.flush=function(t){var e=this._batchedQueue;e.length!==0&&(this._updateData(t),this.drawBatches(t),n._canUploadSameBuffer||this._flushId++,e.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},s.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},s.destroy=function(){this._batchedQueue=null;for(var t=this._meshes,e=this._vertexBuffers,r=this._indiceBuffers,i=0,o=t.length;i<o;++i)t[i].destroy();this._meshes=null;for(var c=0,l=e.length;c<l;++c)e[c].destroy();this._vertexBuffers=null;for(var u=0,h=r.length;u<h;++u)r[u].destroy();this._indiceBuffers=null},s._createMesh=function(t,e){var r=n.MAX_VERTEX_COUNT,i=new Os(t,"BufferMesh"+e),o=[],c=this.createVertexElements(o);return this._vertexBuffers[e]=new Vr(t,kt.VertexBuffer,r*4*c,lt.Dynamic),this._indiceBuffers[e]=new Vr(t,kt.IndexBuffer,r*3,lt.Dynamic),i.setVertexBufferBinding(this._vertexBuffers[e],c),i.setIndexBufferBinding(this._indiceBuffers[e],De.UInt16),i.setVertexElements(o),i},s._updateData=function(t){var e=this._meshes,r=this._flushId;!n._canUploadSameBuffer&&this._meshCount<=r&&(this._meshCount++,e[r]=this._createMesh(t,r));var i=this._batchedQueue,o=this._vertices,c=this._indices,l=e[r];l.clearSubMesh();for(var u=0,h=0,d=0,f=0,_=0,v=0,p=null,g=0,m=i.length;g<m;g++){var y=i[g];u=this.updateVertices(y,o,u);for(var w=y.triangles,P=w.length,A=0;A<P;A++)c[h++]=w[A]+_;_+=y.positions.length,p===null||this.canBatch(p,y)?f+=P:(l.addSubMesh(this._getSubMeshFromPool(d,f)),d+=f,f=P,i[v++]=p),p=y}l.addSubMesh(this._getSubMeshFromPool(d,f)),i[v]=p,this._vertexBuffers[r].setData(o,0,0,u),this._indiceBuffers[r].setData(c,0,0,h)},s._getSubMeshFromPool=function(t,e){var r=this._subMeshPool.getFromPool();return r.start=t,r.count=e,r.topology=si.Triangles,r},n}();ji.MAX_VERTEX_COUNT=4096;ji._canUploadSameBuffer=!0;var eu=function(n){X(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.createVertexElements=function(e){return e[0]=new ue("POSITION",0,H.Vector3,0),e[1]=new ue("TEXCOORD_0",12,H.Vector2,0),20},a.canBatch=function(e,r){if(e.isAdd!==r.isAdd)return!1;var i=e.component.shaderData,o=r.component.shaderData,c=an._textureProperty,l=an._alphaCutoffProperty;return i.getTexture(c)===o.getTexture(c)&&i.getTexture(l)===o.getTexture(l)},a.updateVertices=function(e,r,i){for(var o=e.positions,c=e.uv,l=o.length,u=0;u<l;u++){var h=o[u],d=c[u];r[i++]=h.x,r[i++]=h.y,r[i++]=h.z,r[i++]=d.x,r[i++]=d.y}return i},a.drawBatches=function(e){for(var r=this._meshes[this._flushId],i=r.subMeshes,o=this._batchedQueue,c=0,l=i.length;c<l;c++){var u=i[c],h=o[c];if(!u||!h)return;var d=h.component,f=h.material,_=C._compileMacros;rt.unionCollection(d._globalShaderMacro,f.shaderData._macroCollection,_);var v=f.renderState.stencilState,p=h.isAdd?Ce.IncrementSaturate:Ce.DecrementSaturate;v.passOperationFront=p,v.passOperationBack=p;var g=f.shader._getShaderProgram(e,_);if(!g.isValid)return;var m=h.camera;g.bind(),g.groupingOtherUniformBlock(),g.uploadAll(g.sceneUniformBlock,m.scene.shaderData),g.uploadAll(g.cameraUniformBlock,m.shaderData),g.uploadAll(g.rendererUniformBlock,d.shaderData),g.uploadAll(g.materialUniformBlock,f.shaderData),f.renderState._apply(e,!1),e._hardwareRenderer.drawPrimitive(r,u,g)}},s}(ji),tu=function(){function n(a){this._batcher=void 0,this._preMaskLayer=0,this._batcher=new eu(a)}var s=n.prototype;return s.clear=function(){this._preMaskLayer=0,this._batcher.clear()},s.preRender=function(t,e){e.maskInteraction!==ar.None&&(this._batcher.clear(),this._processMasksDiff(t,e),this._batcher.flush(t.engine))},s.postRender=function(t){t.maskInteraction!==ar.None&&(this._preMaskLayer=t.maskLayer)},s.destroy=function(){this._batcher.destroy(),this._batcher=null},s._processMasksDiff=function(t,e){var r=this._preMaskLayer,i=e.maskLayer;if(r!==i)for(var o=t._renderPipeline._allSpriteMasks,c=r&i,l=i&~r,u=r&~i,h=o._elements,d=0,f=o.length;d<f;d++){var _=h[d],v=_.influenceLayers;if(!(v&c)){if(v&l){var p=_._maskElement;p.isAdd=!0,this._batcher.drawElement(p);continue}if(v&u){var g=_._maskElement;g.isAdd=!1,this._batcher.drawElement(g)}}}},n}(),li;(function(n){n[n.SolidColor=0]="SolidColor",n[n.Sky=1]="Sky",n[n.Texture=2]="Texture"})(li||(li={}));var _r;(function(n){n[n.AspectFitWidth=0]="AspectFitWidth",n[n.AspectFitHeight=1]="AspectFitHeight",n[n.Fill=2]="Fill"})(_r||(_r={}));var ru=function(){this.material=void 0,this.mesh=void 0,this._matrix=new j},iu=function(){function n(a){this._engine=a,this.mode=li.SolidColor,this.solidColor=new Q(.25,.25,.25,1),this.sky=new ru,this._textureFillMode=_r.AspectFitHeight,this._mesh=void 0,this._texture=null,this._mesh=this._createPlane(a)}var s=n.prototype;return s._resizeBackgroundTexture=function(){if(!!this._texture){var t=this._engine.canvas,e=t.width,r=t.height,i=this._mesh,o=i.getPositions();switch(this._textureFillMode){case _r.Fill:o[0].setValue(-1,-1,1),o[1].setValue(1,-1,1),o[2].setValue(-1,1,1),o[3].setValue(1,1,1);break;case _r.AspectFitWidth:var c=this._texture.height*e/this.texture.width/r;o[0].setValue(-1,-c,1),o[1].setValue(1,-c,1),o[2].setValue(-1,c,1),o[3].setValue(1,c,1);break;case _r.AspectFitHeight:var l=this._texture.width*r/this.texture.height/e;o[0].setValue(-l,-1,1),o[1].setValue(l,-1,1),o[2].setValue(-l,1,1),o[3].setValue(l,1,1);break}i.setPositions(o),i.uploadData(!1)}},s._createPlane=function(t){var e=new Ft(t);e.isGCIgnored=!0;for(var r=new Uint8Array([1,2,0,1,3,2]),i=new Array(4),o=new Array(4),c=0;c<4;++c)i[c]=new x,o[c]=new k(c%2,1-(c*.5|0));return e.setPositions(i),e.setUVs(o),e.setIndices(r),e.uploadData(!1),e.addSubMesh(0,r.length),e},W(n,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t,this._engine._backgroundTextureMaterial.shaderData.setTexture("u_baseTexture",t))}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(t){t!==this._textureFillMode&&(this._textureFillMode=t,this._resizeBackgroundTexture())}}]),n}(),wr;(function(n){n[n.SolidColor=0]="SolidColor",n[n.SphericalHarmonics=1]="SphericalHarmonics"})(wr||(wr={}));var it=function(){function n(){this._diffuseSphericalHarmonics=void 0,this._diffuseSolidColor=new Q(.212,.227,.259),this._diffuseIntensity=1,this._specularReflection=void 0,this._specularIntensity=1,this._diffuseMode=wr.SolidColor,this._shArray=new Float32Array(27),this._scene=void 0,this._specularTextureDecodeRGBM=!1}var s=n.prototype;return s._setScene=function(t){if(this._scene=t,!!t){var e=t.shaderData;e.setColor(n._diffuseColorProperty,this._diffuseSolidColor),this.diffuseMode=this._diffuseMode,this.diffuseSphericalHarmonics=this._diffuseSphericalHarmonics,this.diffuseIntensity=this._diffuseIntensity,this.specularTexture=this._specularReflection,this.specularIntensity=this._specularIntensity,this.specularTextureDecodeRGBM=this._specularTextureDecodeRGBM}},s._preComputeSH=function(t,e){var r=t.coefficients;return e[0]=r[0]*.886227,e[1]=r[1]*.886227,e[2]=r[2]*.886227,e[3]=r[3]*-1.023327,e[4]=r[4]*-1.023327,e[5]=r[5]*-1.023327,e[6]=r[6]*1.023327,e[7]=r[7]*1.023327,e[8]=r[8]*1.023327,e[9]=r[9]*-1.023327,e[10]=r[10]*-1.023327,e[11]=r[11]*-1.023327,e[12]=r[12]*.858086,e[13]=r[13]*.858086,e[14]=r[14]*.858086,e[15]=r[15]*-.858086,e[16]=r[16]*-.858086,e[17]=r[17]*-.858086,e[18]=r[18]*.247708,e[19]=r[19]*.247708,e[20]=r[20]*.247708,e[21]=r[21]*-.858086,e[22]=r[22]*-.858086,e[23]=r[23]*-.858086,e[24]=r[24]*.429042,e[25]=r[25]*.429042,e[26]=r[26]*.429042,e},W(n,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(t){this._specularTextureDecodeRGBM=t,this._scene&&(t?this._scene.shaderData.enableMacro(n._decodeRGBMMacro):this._scene.shaderData.disableMacro(n._decodeRGBMMacro))}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(t){this._diffuseMode=t,this._scene&&(t===wr.SphericalHarmonics?this._scene.shaderData.enableMacro(n._shMacro):this._scene.shaderData.disableMacro(n._shMacro))}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(t){t!==this._diffuseSolidColor&&t.cloneTo(this._diffuseSolidColor)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(t){this._diffuseSphericalHarmonics=t,!!this._scene&&t&&this._scene.shaderData.setFloatArray(n._diffuseSHProperty,this._preComputeSH(t,this._shArray))}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(t){this._diffuseIntensity=t,this._scene&&this._scene.shaderData.setFloat(n._diffuseIntensityProperty,t)}},{key:"specularTexture",get:function(){return this._specularReflection},set:function(t){if(this._specularReflection=t,!!this._scene){var e=this._scene.shaderData;t?(e.setTexture(n._specularTextureProperty,t),e.setFloat(n._mipLevelProperty,this._specularReflection.mipmapCount-1),e.enableMacro(n._specularMacro)):e.disableMacro(n._specularMacro)}}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(t){this._specularIntensity=t,this._scene&&this._scene.shaderData.setFloat(n._specularIntensityProperty,t)}}]),n}();it._shMacro=C.getMacroByName("O3_USE_SH");it._specularMacro=C.getMacroByName("O3_USE_SPECULAR_ENV");it._decodeRGBMMacro=C.getMacroByName("O3_DECODE_ENV_RGBM");it._diffuseColorProperty=C.getPropertyByName("u_envMapLight.diffuse");it._diffuseSHProperty=C.getPropertyByName("u_env_sh");it._diffuseIntensityProperty=C.getPropertyByName("u_envMapLight.diffuseIntensity");it._specularTextureProperty=C.getPropertyByName("u_env_specularSampler");it._specularIntensityProperty=C.getPropertyByName("u_envMapLight.specularIntensity");it._mipLevelProperty=C.getPropertyByName("u_envMapLight.mipMapLevel");var Ls=function(){function n(){}var s=n.prototype;return s.preUpdate=function(t){},s.postUpdate=function(t){},s.preRender=function(t,e){},s.postRender=function(t,e){},s.destroy=function(t){},n}(),Ge=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t._viewMat=void 0,t._inverseViewMat=void 0,t}var a=s.prototype;return a._onEnable=function(){this.scene.findFeature(br).attachRenderLight(this)},a._onDisable=function(){this.scene.findFeature(br).detachRenderLight(this)},W(s,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new j),j.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new j),j.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),s}(dt);Ge._maxLight=10;var Ht=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.color=new Q(1,1,1,1),t.intensity=1,t._forward=new x,t._lightColor=new Q(1,1,1,1),t._reverseDirection=new x,t}s._updateShaderData=function(e){var r=s._combinedData;e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._directionProperty,r.direction)};var a=s.prototype;return a._appendData=function(e){var r=e*3,i=e*3,o=this.lightColor,c=this.direction,l=s._combinedData;l.color[r]=o.r,l.color[r+1]=o.g,l.color[r+2]=o.b,l.direction[i]=c.x,l.direction[i+1]=c.y,l.direction[i+2]=c.z},W(s,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}},{key:"reverseDirection",get:function(){return x.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),s}(Ge);Ht._colorProperty=C.getPropertyByName("u_directLightColor");Ht._directionProperty=C.getPropertyByName("u_directLightDirection");Ht._combinedData={color:new Float32Array(3*Ge._maxLight),direction:new Float32Array(3*Ge._maxLight)};var Wt=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.color=new Q(1,1,1,1),t.intensity=1,t.distance=100,t._lightColor=new Q(1,1,1,1),t}s._updateShaderData=function(e){var r=s._combinedData;e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._distanceProperty,r.distance)};var a=s.prototype;return a._appendData=function(e){var r=e*3,i=e*3,o=e,c=this.lightColor,l=this.position,u=s._combinedData;u.color[r]=c.r,u.color[r+1]=c.g,u.color[r+2]=c.b,u.position[i]=l.x,u.position[i+1]=l.y,u.position[i+2]=l.z,u.distance[o]=this.distance},W(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),s}(Ge);Wt._colorProperty=C.getPropertyByName("u_pointLightColor");Wt._positionProperty=C.getPropertyByName("u_pointLightPosition");Wt._distanceProperty=C.getPropertyByName("u_pointLightDistance");Wt._combinedData={color:new Float32Array(3*Ge._maxLight),position:new Float32Array(3*Ge._maxLight),distance:new Float32Array(Ge._maxLight)};var ut=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.color=new Q(1,1,1,1),t.intensity=1,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._forward=new x,t._lightColor=new Q(1,1,1,1),t._inverseDirection=new x,t}s._updateShaderData=function(e){var r=s._combinedData;e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._directionProperty,r.direction),e.setFloatArray(s._distanceProperty,r.distance),e.setFloatArray(s._angleCosProperty,r.angleCos),e.setFloatArray(s._penumbraCosProperty,r.penumbraCos)};var a=s.prototype;return a._appendData=function(e){var r=e*3,i=e*3,o=e*3,c=e,l=e,u=e,h=this.lightColor,d=this.position,f=this.direction,_=s._combinedData;_.color[r]=h.r,_.color[r+1]=h.g,_.color[r+2]=h.b,_.position[i]=d.x,_.position[i+1]=d.y,_.position[i+2]=d.z,_.direction[o]=f.x,_.direction[o+1]=f.y,_.direction[o+2]=f.z,_.distance[c]=this.distance,_.angleCos[u]=Math.cos(this.angle),_.penumbraCos[l]=Math.cos(this.angle+this.penumbra)},W(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return x.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),s}(Ge);ut._colorProperty=C.getPropertyByName("u_spotLightColor");ut._positionProperty=C.getPropertyByName("u_spotLightPosition");ut._directionProperty=C.getPropertyByName("u_spotLightDirection");ut._distanceProperty=C.getPropertyByName("u_spotLightDistance");ut._angleCosProperty=C.getPropertyByName("u_spotLightAngleCos");ut._penumbraCosProperty=C.getPropertyByName("u_spotLightPenumbraCos");ut._combinedData={color:new Float32Array(3*Ge._maxLight),position:new Float32Array(3*Ge._maxLight),direction:new Float32Array(3*Ge._maxLight),distance:new Float32Array(Ge._maxLight),angleCos:new Float32Array(Ge._maxLight),penumbraCos:new Float32Array(Ge._maxLight)};function nu(){return this.findFeature(br).visibleLights.length>0}var br=function(n){X(s,n);function s(){var t;return t=n.call(this)||this,t.visibleLights=void 0,t.visibleLights=[],t}var a=s.prototype;return a.attachRenderLight=function(e){var r=this.visibleLights.indexOf(e);r==-1&&this.visibleLights.push(e)},a.detachRenderLight=function(e){var r=this.visibleLights.indexOf(e);r!=-1&&this.visibleLights.splice(r,1)},a._updateShaderData=function(e){for(var r=0,i=0,o=0,c=this.visibleLights,l=0,u=c.length;l<u;l++){var h=c[l];h instanceof Ht?h._appendData(r++):h instanceof Wt?h._appendData(i++):h instanceof ut&&h._appendData(o++)}r?(Ht._updateShaderData(e),e.enableMacro("O3_DIRECT_LIGHT_COUNT",r.toString())):e.disableMacro("O3_DIRECT_LIGHT_COUNT"),i?(Wt._updateShaderData(e),e.enableMacro("O3_POINT_LIGHT_COUNT",i.toString())):e.disableMacro("O3_POINT_LIGHT_COUNT"),o?(ut._updateShaderData(e),e.enableMacro("O3_SPOT_LIGHT_COUNT",o.toString())):e.disableMacro("O3_SPOT_LIGHT_COUNT")},s}(Ls),yr=function(n){X(s,n);function s(t,e){var r;r=n.call(this,t)||this,r.name=void 0,r.background=new iu(r._engine),r.shaderData=new Hi(gt.Scene),r._activeCameras=[],r._isActiveInEngine=!1,r._globalShaderMacro=new rt,r._rootEntities=[],r._ambientLight=void 0,r.features=[],r.name=e||"";var i=r.shaderData;return s.sceneFeatureManager.addObject(B(r)),i._addRefCount(1),r.ambientLight=new it,r}var a=s.prototype;return a.createRootEntity=function(e){var r=new Ut(this._engine,e);return this.addRootEntity(r),r},a.addRootEntity=function(e){var r=e._isRoot;r||(e._isRoot=!0,e._removeFromParent());var i=e._scene;i!==this?(i&&r&&i._removeEntity(e),this._rootEntities.push(e),Ut._traverseSetOwnerScene(e,this)):r||this._rootEntities.push(e),this._isActiveInEngine?!e._isActiveInHierarchy&&e._isActive&&e._processActive():e._isActiveInHierarchy&&e._processInActive()},a.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeEntity(e),this._isActiveInEngine&&e._processInActive(),Ut._traverseSetOwnerScene(e,null))},a.getRootEntity=function(e){return e===void 0&&(e=0),this._rootEntities[e]},a.findEntityByName=function(e){for(var r=this._rootEntities,i=r.length-1;i>=0;i--){var o=r[i];if(o.name===e)return o}for(var c=r.length-1;c>=0;c--){var l=r[c],u=l.findByName(e);if(u)return u}return null},a.findEntityByPath=function(e){for(var r=e.split("/").filter(Boolean),i=0,o=this.rootEntitiesCount;i<o;i++){var c=this.getRootEntity(i);if(c.name==r[0]){for(var l=1,u=r.length;l<u&&(c=Ut._findChildByName(c,r[l]),!!c);++l);return c}}return null},a.destroy=function(){if(!this._destroyed){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),s.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,r=this.rootEntitiesCount;e<r;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,s.sceneFeatureManager._objects=[],this.shaderData._addRefCount(-1)}},a._attachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r===-1&&this._activeCameras.push(e)},a._detachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r!==-1&&this._activeCameras.splice(r,1)},a._processActive=function(e){this._isActiveInEngine=e;for(var r=this._rootEntities,i=r.length-1;i>=0;i--){var o=r[i];o._isActive&&(e?o._processActive():o._processInActive())}},a._updateShaderData=function(){rt.unionCollection(this.engine._macroCollection,this.shaderData._macroCollection,this._globalShaderMacro);var e=this.findFeature(br);e._updateShaderData(this.shaderData)},a._removeEntity=function(e){var r=this._rootEntities;r.splice(r.indexOf(e),1)},s.registerFeature=function(e){s.sceneFeatureManager.registerFeature(e)},a.findFeature=function(e){return s.sceneFeatureManager.findFeature(this,e)},W(s,[{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(!!e){var r=this._ambientLight;r!==e&&(r&&r._setScene(null),e._setScene(this),this._ambientLight=e)}}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}}]),s}(sr);yr.sceneFeatureManager=new As;var au=function(){function n(a){this.engine=a,this._activeScene=void 0}var s=n.prototype;return s.loadScene=function(t,e){var r=this;e===void 0&&(e=!0);var i=this.engine.resourceManager.load(t);return i.then(function(o){var c=r._activeScene;r.activeScene=o,c&&e&&c.destroy()}),i},s.mergeScenes=function(t,e){for(var r=t.rootEntities,i=0,o=r.length;i<o;i++)e.addRootEntity(r[i])},W(n,[{key:"activeScene",get:function(){return this._activeScene},set:function(t){var e=this._activeScene;e!==t&&(e&&e._processActive(!1),t&&t._processActive(!0),this._activeScene=t)}}]),n}(),ou=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <mobile_material_frag>
#include <fog_share>
#include <normal_get>
void main(){
#include <begin_mobile_frag>
#include <begin_viewdir_frag>
#include <mobile_blinnphong_frag>
gl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;
#ifndef OASIS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
#include <fog_frag>
}`,su=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <shadow_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <shadow_vert>
#include <position_vert>
#include <fog_vert>
}`,cu=`#define GLSLIFY 1
varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){if(v_lifeLeft==1.0){discard;}float alphaFactor=1.0;
#ifdef fadeIn
float fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);
#endif
#ifdef fadeOut
float fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;
#endif
#ifdef particleTexture
vec4 tex=texture2D(u_texture,v_uv);
#ifdef useOriginColor
gl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);
#else
gl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);
#endif
#else
gl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);
#endif
}`,lu=`#define GLSLIFY 1
attribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;
#ifdef is2d
uniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;
#endif
mat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y;float startTime=a_lifeAndSize.x;float deltaTime=max(mod(u_time-startTime,life),0.0);if((u_once&&u_time>life+startTime)){deltaTime=0.0;}v_lifeLeft=1.0-deltaTime/life;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;
#ifdef isScaleByLifetime
scale*=v_lifeLeft;
#else
scale*=pow(a_lifeAndSize.w,deltaTime);
#endif
#ifdef rotateToVelocity
vec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;
#else
float deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;
#endif
#ifdef is2d
vec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);
#else
#ifdef rotateToVelocity
float s=sin(angle);float c=cos(angle);
#else
float s=sin(angle);float c=cos(angle);
#endif
vec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;
#endif
}`,uu=`#define GLSLIFY 1
#define IS_METALLIC_WORKFLOW
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,hu=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,Ma=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <shadow_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <shadow_vert>
#include <position_vert>
#include <fog_vert>
}`,du=`#define GLSLIFY 1
vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}void main(){gl_FragColor=pack(gl_FragCoord.z);}`,Ca=`#define GLSLIFY 1
#include <common_vert>
#include <blendShape_input>
#include <normal_share>
#include <shadow_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <shadow_vert>
#include <position_vert>
}`,fu=`#define GLSLIFY 1
#ifdef O3_SHADOW_MAP_COUNT
uniform float u_shadowBias[O3_SHADOW_MAP_COUNT];uniform float u_shadowIntensity[O3_SHADOW_MAP_COUNT];uniform float u_shadowRadius[O3_SHADOW_MAP_COUNT];uniform vec2 u_shadowMapSize[O3_SHADOW_MAP_COUNT];uniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}float getVisibility(vec4 positionFromLight,const in sampler2D shadowMap,vec2 mapSize,float intensity,float bias,float radius){vec3 shadowCoord=(positionFromLight.xyz/positionFromLight.w)/2.0+0.5;float filterX=step(0.0,shadowCoord.x)*(1.0-step(1.0,shadowCoord.x));float filterY=step(0.0,shadowCoord.y)*(1.0-step(1.0,shadowCoord.y));shadowCoord.z-=bias;vec2 texelSize=vec2(1.0)/mapSize;float visibility=0.0;for(float y=-1.0;y<=1.0;y+=1.0){for(float x=-1.0;x<=1.0;x+=1.0){vec2 uv=shadowCoord.xy+texelSize*vec2(x,y)*radius;vec4 rgbaDepth=texture2D(shadowMap,uv);float depth=unpack(rgbaDepth);visibility+=step(depth,shadowCoord.z)*intensity;}}visibility*=(1.0/9.0);return visibility*filterX*filterY;}
#endif
void main(){vec4 shadowColor=vec4(1.0,1.0,1.0,1.0);
#ifdef O3_SHADOW_MAP_COUNT
float visibility=1.0;
#if (O3_SHADOW_MAP_COUNT == 1)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);
#elif (O3_SHADOW_MAP_COUNT == 2)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);
#elif (O3_SHADOW_MAP_COUNT == 3)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);visibility-=getVisibility(v_PositionFromLight[2],u_shadowMaps[2],u_shadowMapSize[2],u_shadowIntensity[2],u_shadowBias[2],u_shadowRadius[2]);
#endif
visibility=clamp(visibility,0.0,1.0);shadowColor=vec4(visibility,visibility,visibility,1.0);
#endif
gl_FragColor=shadowColor;}`,_u=`#define GLSLIFY 1
#include <common>
uniform samplerCube u_cube;varying vec3 v_cubeUV;uniform vec4 u_cubeDecodeParam;void main(){vec4 textureColor=textureCube(u_cube,v_cubeUV);if(u_cubeDecodeParam.x>0.0){textureColor=RGBMToLinear(textureColor,u_cubeDecodeParam.y);textureColor=linearToGamma(textureColor);}gl_FragColor=textureColor;}`,vu=`#define GLSLIFY 1
#include <common_vert>
uniform mat4 u_mvpNoscale;varying vec3 v_cubeUV;void main(){v_cubeUV=POSITION.xyz;gl_Position=u_mvpNoscale*vec4(POSITION,1.0);gl_Position.z=gl_Position.w;}`,pu=`#define GLSLIFY 1
uniform sampler2D u_maskTexture;uniform float u_maskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(u_maskTexture,v_uv);if(color.a<u_maskAlphaCutoff){discard;}gl_FragColor=color;}`,gu=`#define GLSLIFY 1
uniform mat4 u_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=u_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,mu=`#define GLSLIFY 1
#ifdef USE_CUSTOM_TEXTURE
uniform sampler2D u_cusTomTexture;
#else
uniform sampler2D u_spriteTexture;
#endif
varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_CUSTOM_TEXTURE
vec4 baseColor=texture2D(u_cusTomTexture,v_uv);
#else
vec4 baseColor=texture2D(u_spriteTexture,v_uv);
#endif
gl_FragColor=baseColor*v_color;}`,yu=`#define GLSLIFY 1
#ifdef USE_MODEL_MATRIX
uniform mat4 u_MVPMat;
#else
uniform mat4 u_VPMat;
#endif
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_MODEL_MATRIX
gl_Position=u_MVPMat*vec4(POSITION,1.0);
#else
gl_Position=u_VPMat*vec4(POSITION,1.0);
#endif
v_uv=TEXCOORD_0;v_color=COLOR_0;}`,xu=`#define GLSLIFY 1
#include <common>
#include <uv_share>
#include <fog_share>
uniform vec4 u_baseColor;uniform float u_alphaCutoff;
#ifdef O3_BASE_TEXTURE
uniform sampler2D u_baseTexture;
#endif
void main(){vec4 baseColor=u_baseColor;
#ifdef O3_BASE_TEXTURE
vec4 textureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
baseColor*=textureColor;
#endif
#ifdef ALPHA_CUTOFF
if(baseColor.a<u_alphaCutoff){discard;}
#endif
#ifndef OASIS_COLORSPACE_GAMMA
baseColor=linearToGamma(baseColor);
#endif
gl_FragColor=baseColor;
#include <fog_frag>
}`,wu=`#define GLSLIFY 1
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <position_vert>
#include <fog_vert>
}`,bu=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,Pu=`#define GLSLIFY 1
uniform sampler2D u_baseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(u_baseTexture,v_uv);}`,Su=function(){function n(){}return n.init=function(){C.create("blinn-phong",su,ou),C.create("pbr",Ma,uu),C.create("pbr-specular",Ma,hu),C.create("unlit",wu,xu),C.create("shadow-map",Ca,du),C.create("shadow",Ca,fu),C.create("skybox",vu,_u),C.create("particle-shader",lu,cu),C.create("SpriteMask",gu,pu),C.create("Sprite",yu,mu),C.create("background-texture",bu,Pu)},n}(),Au=function(){function n(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var s=n.prototype;return s.get=function(t){var e=this._cacheMap,r=t._length;r>this._cacheHierarchy&&this._resizeCacheMapHierarchy(e,0,r);for(var i=t._mask,o=t._length-1,c=this._cacheHierarchy-1,l=0;l<c;l++){var u=o<l?0:i[l],h=e[u];h||(e[u]=h=Object.create(null)),e=h}var d=o<c?0:i[c],f=e[d];return f||(this._lastQueryKey=d,this._lastQueryMap=e),f},s.cache=function(t){this._lastQueryMap[this._lastQueryKey]=t},s._resizeCacheMapHierarchy=function(t,e,r){var i=this._cacheHierarchy-1;if(e==i){for(var o in t)for(var c=t[o],l=0,u=r-i;l<u;l++)l==u-1?t[0]=c:t=t[l==0?o:0]=Object.create(null);this._cacheHierarchy=r}else for(var h in t)this._resizeCacheMapHierarchy(t[h],++e,r)},n}(),Jt=new As;Su.init();var Mu=function(n){X(s,n);function s(t,e,r,i){var o;o=n.call(this)||this,o.physicsManager=void 0,o.inputManager=void 0,o._componentsManager=new fn,o._hardwareRenderer=void 0,o._lastRenderState=new zs,o._renderElementPool=new Ur(Wl),o._spriteElementPool=new Ur(jl),o._spriteMaskElementPool=new Ur(Xl),o._spriteDefaultMaterial=void 0,o._spriteMaskDefaultMaterial=void 0,o._renderContext=new Hl,o._whiteTexture2D=void 0,o._whiteTextureCube=void 0,o._backgroundTextureMaterial=void 0,o._renderCount=0,o._shaderProgramPools=[],o._spriteMaskManager=void 0,o._macroCollection=new rt,o._canvas=void 0,o._settings={},o._resourceManager=new Gi(B(o)),o._sceneManager=new au(B(o)),o._vSyncCount=1,o._targetFrameRate=60,o._time=new Ac,o._isPaused=!0,o._requestId=void 0,o._timeoutId=void 0,o._vSyncCounter=1,o._targetFrameInterval=1e3/60,o._animate=function(){o._vSyncCount?(o._requestId=requestAnimationFrame(o._animate),o._vSyncCounter++%o._vSyncCount===0&&(o.update(),o._vSyncCounter=1)):(o._timeoutId=window.setTimeout(o._animate,o._targetFrameInterval),o.update())},o.features=[],o._hardwareRenderer=e,o._hardwareRenderer.init(t),r&&(Bt._nativePhysics=r,o.physicsManager=new Bt),o._canvas=t,Jt.addObject(B(o)),o._sceneManager.activeScene=new yr(B(o),"DefaultScene"),o._spriteMaskManager=new tu(B(o)),o._spriteDefaultMaterial=o._createSpriteMaterial(),o._spriteMaskDefaultMaterial=o._createSpriteMaskMaterial(),o.inputManager=new Fc(B(o));var c=new Uint8Array([255,255,255,255]),l=new Hr(B(o),1,1,Y.R8G8B8A8,!1);l.setPixelBuffer(c),l.isGCIgnored=!0;var u=new Wi(B(o),1,Y.R8G8B8A8,!1);u.setPixelBuffer(pt.PositiveX,c),u.setPixelBuffer(pt.NegativeX,c),u.setPixelBuffer(pt.PositiveY,c),u.setPixelBuffer(pt.NegativeY,c),u.setPixelBuffer(pt.PositiveZ,c),u.setPixelBuffer(pt.NegativeZ,c),u.isGCIgnored=!0,o._whiteTexture2D=l,o._whiteTextureCube=u,o._backgroundTextureMaterial=new nr(B(o),C.find("background-texture")),o._backgroundTextureMaterial.isGCIgnored=!0,o._backgroundTextureMaterial.renderState.depthState.compareFunction=fe.LessEqual;var h=(i==null?void 0:i.colorSpace)||mr.Linear;return h===mr.Gamma&&o._macroCollection.enable(s._gammaMacro),o._settings.colorSpace=h,o}var a=s.prototype;return a.createEntity=function(e){return new Ut(this,e)},a.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},a.resume=function(){!this._isPaused||(this._isPaused=!1,this.time.reset(),requestAnimationFrame(this._animate))},a.update=function(){var e=this._time,r=e.deltaTime;e.tick(),this._renderElementPool.resetPool(),this._spriteElementPool.resetPool(),this._spriteMaskElementPool.resetPool(),Jt.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]);var i=this._sceneManager._activeScene,o=this._componentsManager;i&&(i._activeCameras.sort(function(c,l){return c.priority-l.priority}),o.callScriptOnStart(),this.physicsManager&&(o.callColliderOnUpdate(),this.physicsManager._update(r/1e3),o.callColliderOnLateUpdate()),this.inputManager._update(),o.callScriptOnUpdate(r),o.callAnimationUpdate(r),o.callScriptOnLateUpdate(r),this._render(i)),this._componentsManager.callComponentDestroy(),Jt.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])},a.run=function(){Jt.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new Tn("run",this))},a.destroy=function(){this._sceneManager&&(this._whiteTexture2D.destroy(!0),this._whiteTextureCube.destroy(!0),this.inputManager._destroy(),this.trigger(new Tn("shutdown",this)),Jt.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._activeScene.destroy(),this._resourceManager._destroy(),this._componentsManager.callComponentDestroy(),this._sceneManager=null,this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,this._spriteMaskManager.destroy(),Jt._objects=[],this.removeAllEventListeners())},a._getShaderProgramPool=function(e){var r=e._shaderId,i=this._shaderProgramPools,o=i[r];if(!o){var c=r+1;c<i.length&&(i.length=c),i[r]=o=new Au}return o},a._render=function(e){var r=e._activeCameras,i=this._componentsManager,o=this.time.deltaTime;if(i.callRendererOnUpdate(o),e._updateShaderData(),r.length>0)for(var c=0,l=r.length;c<l;c++){var u=r[c],h=u.entity;u.enabled&&h.isActiveInHierarchy&&(i.callCameraOnBeginRender(u),yr.sceneFeatureManager.callFeatureMethod(e,"preRender",[e,u]),u.render(),yr.sceneFeatureManager.callFeatureMethod(e,"postRender",[e,u]),i.callCameraOnEndRender(u))}},a._createSpriteMaterial=function(){var e=new nr(this,C.find("Sprite")),r=e.renderState,i=r.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=J.SourceAlpha,i.destinationColorBlendFactor=J.OneMinusSourceAlpha,i.sourceAlphaBlendFactor=J.One,i.destinationAlphaBlendFactor=J.OneMinusSourceAlpha,i.colorBlendOperation=i.alphaBlendOperation=st.Add,r.depthState.writeEnabled=!1,r.rasterState.cullMode=ct.Off,e.renderQueueType=Be.Transparent,e.isGCIgnored=!0,e},a._createSpriteMaskMaterial=function(){var e=new nr(this,C.find("SpriteMask")),r=e.renderState;return r.blendState.targetBlendState.colorWriteMask=rr.None,r.rasterState.cullMode=ct.Off,r.stencilState.enabled=!0,r.depthState.enabled=!1,e.isGCIgnored=!0,e},a.findFeature=function(e){return Jt.findFeature(this,e)},s.registerFeature=function(e){Jt.registerFeature(e)},W(s,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}}]),s}(Ss);Mu._gammaMacro=C.getMacroByName("OASIS_COLORSPACE_GAMMA");var Ot,Ta,Ra,za,Ea,Ba,Da,Oa;Ot=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,I(t,"_started",Ta,B(t)),I(t,"_onStartIndex",Ra,B(t)),I(t,"_onUpdateIndex",za,B(t)),I(t,"_onLateUpdateIndex",Ea,B(t)),I(t,"_onPreRenderIndex",Ba,B(t)),I(t,"_onPostRenderIndex",Da,B(t)),I(t,"_entityCacheIndex",Oa,B(t)),t}var a=s.prototype;return a.onAwake=function(){},a.onEnable=function(){},a.onStart=function(){},a.onUpdate=function(e){},a.onLateUpdate=function(e){},a.onBeginRender=function(e){},a.onEndRender=function(e){},a.onTriggerEnter=function(e){},a.onTriggerExit=function(e){},a.onTriggerStay=function(e){},a.onPointerDown=function(){},a.onPointerUp=function(){},a.onPointerClick=function(){},a.onPointerEnter=function(){},a.onPointerExit=function(){},a.onPointerDrag=function(){},a.onDisable=function(){},a.onDestroy=function(){},a._onAwake=function(){this.onAwake()},a._onEnable=function(){var e=this.engine._componentsManager,r=s.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==r.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.addOnLateUpdateScript(this),this._entity._addScript(this),this.onEnable()},a._onDisable=function(){var e=this.engine._componentsManager;this._onStartIndex!==-1&&e.removeOnStartScript(this),this._onUpdateIndex!==-1&&e.removeOnUpdateScript(this),this._onLateUpdateIndex!==-1&&e.removeOnLateUpdateScript(this),this._entityCacheIndex!==-1&&this._entity._removeScript(this),this.onDisable()},a._onDestroy=function(){this.engine._componentsManager.addDestroyComponent(this)},s}(dt),Ta=F(Ot.prototype,"_started",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ra=F(Ot.prototype,"_onStartIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),za=F(Ot.prototype,"_onUpdateIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ea=F(Ot.prototype,"_onLateUpdateIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ba=F(Ot.prototype,"_onPreRenderIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Da=F(Ot.prototype,"_onPostRenderIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Oa=F(Ot.prototype,"_entityCacheIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}});var Cu=0,Ir=function(){function n(a,t,e,r,i){a===void 0&&(a="RENDER_PASS"+Cu++),t===void 0&&(t=0),e===void 0&&(e=null),r===void 0&&(r=null),i===void 0&&(i=null),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.name=a,this.enabled=!0,this.priority=t,this.renderTarget=e,this.replaceMaterial=r,this.mask=i||ot.Everything,this.renderOverride=!1}var s=n.prototype;return s.render=function(t,e,r,i){},s.preRender=function(t,e,r,i){},s.postRender=function(t,e,r,i){},n}(),Is=function(n){X(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.createVertexElements=function(e){return e[0]=new ue("POSITION",0,H.Vector3,0),e[1]=new ue("TEXCOORD_0",12,H.Vector2,0),e[2]=new ue("COLOR_0",20,H.Vector4,0),36},a.canBatch=function(e,r){var i=e.component,o=r.component;if(!this.checkBatchWithMask(i,o))return!1;var c=s._textureProperty;return i.shaderData.getTexture(c)!==o.shaderData.getTexture(c)?!1:e.material===r.material},a.checkBatchWithMask=function(e,r){var i=e.maskInteraction;return i!==r.maskInteraction?!1:i===ar.None?!0:e.maskLayer===r.maskLayer},a.updateVertices=function(e,r,i){for(var o=e.positions,c=e.uv,l=e.color,u=o.length,h=0;h<u;h++){var d=o[h],f=c[h];r[i++]=d.x,r[i++]=d.y,r[i++]=d.z,r[i++]=f.x,r[i++]=f.y,r[i++]=l.r,r[i++]=l.g,r[i++]=l.b,r[i++]=l.a}return i},a.drawBatches=function(e){for(var r=this._meshes[this._flushId],i=r.subMeshes,o=this._batchedQueue,c=e._spriteMaskManager,l=0,u=i.length;l<u;l++){var h=i[l],d=o[l];if(!h||!d)return;var f=d.component,_=d.camera,v=d.material;c.preRender(_,f);var p=C._compileMacros;rt.unionCollection(f._globalShaderMacro,v.shaderData._macroCollection,p);var g=v.shader._getShaderProgram(e,p);if(!g.isValid)return;g.bind(),g.groupingOtherUniformBlock(),g.uploadAll(g.sceneUniformBlock,_.scene.shaderData),g.uploadAll(g.cameraUniformBlock,_.shaderData),g.uploadAll(g.rendererUniformBlock,f.shaderData),g.uploadAll(g.materialUniformBlock,v.shaderData),v.renderState._apply(e,!1),e._hardwareRenderer.drawPrimitive(r,h,g),c.postRender(f)}},a.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,r=this._vertexBuffers,i=this._indiceBuffers,o=0,c=e.length;o<c;++o)e[o].destroy();this._meshes=null;for(var l=0,u=r.length;l<u;++l)r[l].destroy();this._vertexBuffers=null;for(var h=0,d=i.length;h<d;++h)i[h].destroy();this._indiceBuffers=null},s}(ji);Is._textureProperty=C.getPropertyByName("u_spriteTexture");var Br=function(){n._compareFromNearToFar=function(t,e){return t.material.renderQueueType-e.material.renderQueueType||t.component._distanceForSort-e.component._distanceForSort||e.component._renderSortId-t.component._renderSortId},n._compareFromFarToNear=function(t,e){return t.material.renderQueueType-e.material.renderQueueType||e.component._distanceForSort-t.component._distanceForSort||e.component._renderSortId-t.component._renderSortId};function n(a){this.items=[],this._spriteBatcher=void 0,this._spriteBatcher=new Is(a)}var s=n.prototype;return s.pushPrimitive=function(t){this.items.push(t)},s.render=function(t,e,r){var i=this.items;if(i.length!==0){for(var o=t.engine,c=t.scene,l=o._renderCount,u=o._hardwareRenderer,h=c.shaderData,d=t.shaderData,f=0,_=i.length;f<_;f++){var v=i[f],p=v.component.entity.layer;if(!!(p&r))if(v.mesh){this._spriteBatcher.flush(o);var g=C._compileMacros,m=v,y=m.component,w=e||m.material,P=y.shaderData,A=w.shaderData;w._preRender(m),rt.unionCollection(y._globalShaderMacro,A._macroCollection,g);var b=w.shader._getShaderProgram(o,g);if(!b.isValid)continue;var M=b.bind(),S=l!==b._uploadRenderCount;S?(b.groupingOtherUniformBlock(),b.uploadAll(b.sceneUniformBlock,h),b.uploadAll(b.cameraUniformBlock,d),b.uploadAll(b.rendererUniformBlock,P),b.uploadAll(b.materialUniformBlock,A),b.uploadUnGroupTextures(),b._uploadCamera=t,b._uploadRenderer=y,b._uploadMaterial=w,b._uploadRenderCount=l):(b._uploadCamera!==t?(b.uploadAll(b.cameraUniformBlock,d),b._uploadCamera=t):M&&b.uploadTextures(b.cameraUniformBlock,d),b._uploadRenderer!==y?(b.uploadAll(b.rendererUniformBlock,P),b._uploadRenderer=y):M&&b.uploadTextures(b.rendererUniformBlock,P),b._uploadMaterial!==w?(b.uploadAll(b.materialUniformBlock,A),b._uploadMaterial=w):M&&b.uploadTextures(b.materialUniformBlock,A),M&&b.uploadUnGroupTextures()),w.renderState._apply(t.engine,y.entity.transform._isFrontFaceInvert()),u.drawPrimitive(m.mesh,m.subMesh,b)}else{var T=v;this._spriteBatcher.drawElement(T)}}this._spriteBatcher.flush(o)}},s.clear=function(){this.items.length=0,this._spriteBatcher.clear()},s.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},s.sort=function(t){this._quickSort(this.items,0,this.items.length,t)},s._quickSort=function(t,e,r,i){for(;;){if(r-e<=10){this._insertionSort(t,e,r,i);return}var o=e+r>>1,c=t[e],l=t[r-1],u=t[o],h=i(c,l);if(h>0){var d=c;c=l,l=d}var f=i(c,u);if(f>=0){var _=c;c=u,u=l,l=_}else{var v=i(l,u);if(v>0){var p=l;l=u,u=p}}t[e]=c,t[r-1]=u;var g=l,m=e+1,y=r-1;t[o]=t[m],t[m]=g;e:for(var w=m+1;w<y;w++){var P=t[w],A=i(P,g);if(A<0)t[w]=t[m],t[m]=P,m++;else if(A>0){do{if(y--,y==w)break e;var b=t[y];A=i(b,g)}while(A>0);t[w]=t[y],t[y]=P,A<0&&(P=t[w],t[w]=t[m],t[m]=P,m++)}}r-y<m-e?(this._quickSort(t,y,r,i),r=m):(this._quickSort(t,e,m,i),e=y)}},s._insertionSort=function(t,e,r,i){for(var o=e+1;o<r;o++){var c=void 0,l=t[o];for(c=o-1;c>=e;c--){var u=t[c],h=i(u,l);if(h>0)t[c+1]=u;else break}t[c+1]=l}},n}(),Tu=function(){function n(a){this._opaqueQueue=void 0,this._transparentQueue=void 0,this._alphaTestQueue=void 0,this._allSpriteMasks=new It,this._camera=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._lastCanvasSize=new k,this._camera=a;var t=a.engine;this._opaqueQueue=new Br(t),this._alphaTestQueue=new Br(t),this._transparentQueue=new Br(t),this._renderPassArray=[],this._defaultPass=new Ir("default",0,null,null,0),this.addRenderPass(this._defaultPass)}var s=n.prototype;return s.addRenderPass=function(t,e,r,i,o){if(e===void 0&&(e=null),r===void 0&&(r=null),i===void 0&&(i=null),o===void 0&&(o=null),typeof t=="string"){var c=new Ir(t,e,r,i,o);this._renderPassArray.push(c)}else t instanceof Ir&&this._renderPassArray.push(t);this._renderPassArray.sort(function(l,u){return l.priority-u.priority})},s.removeRenderPass=function(t){var e;if(typeof t=="string"?e=this.getRenderPass(t):t instanceof Ir&&(e=t),e){var r=this._renderPassArray.indexOf(e);this._renderPassArray.splice(r,1)}},s.getRenderPass=function(t){for(var e=0,r=this._renderPassArray.length;e<r;e++){var i=this._renderPassArray[e];if(i.name===t)return i}return null},s.destroy=function(){this._opaqueQueue.destroy(),this._alphaTestQueue.destroy(),this._transparentQueue.destroy(),this._allSpriteMasks=null,this._renderPassArray=null,this._defaultPass=null,this._camera=null},s.render=function(t,e,r){var i=this._camera,o=this._opaqueQueue,c=this._alphaTestQueue,l=this._transparentQueue;i.engine._spriteMaskManager.clear(),o.clear(),c.clear(),l.clear(),this._allSpriteMasks.length=0,i.engine._componentsManager.callRender(t),o.sort(Br._compareFromNearToFar),c.sort(Br._compareFromNearToFar),l.sort(Br._compareFromFarToNear);for(var u=0,h=this._renderPassArray.length;u<h;u++)this._drawRenderPass(this._renderPassArray[u],i,e,r)},s._drawRenderPass=function(t,e,r,i){if(t.preRender(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue),t.enabled){var o,c,l=e.engine,u=e.scene,h=u.background,d=l._hardwareRenderer,f=e.renderTarget||t.renderTarget;d.activeRenderTarget(f,e,i),f==null||f._setRenderTargetInfo(r,i);var _=(o=t.clearFlags)!=null?o:e.clearFlags,v=(c=t.clearColor)!=null?c:h.solidColor;_!==xr.None&&d.clearRenderTarget(e.engine,_,v),t.renderOverride?t.render(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue):(this._opaqueQueue.render(e,t.replaceMaterial,t.mask),this._alphaTestQueue.render(e,t.replaceMaterial,t.mask),e.clearFlags===xr.DepthColor&&(h.mode===li.Sky?this._drawSky(l,e,h.sky):h.mode===li.Texture&&h.texture&&this._drawBackgroundTexture(l,h)),this._transparentQueue.render(e,t.replaceMaterial,t.mask)),f==null||f._blitRenderTarget(),f==null||f.generateMipmaps()}t.postRender(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue)},s.pushPrimitive=function(t){var e=t.material.renderQueueType;e>Be.Transparent+Be.AlphaTest>>1?this._transparentQueue.pushPrimitive(t):e>Be.AlphaTest+Be.Opaque>>1?this._alphaTestQueue.pushPrimitive(t):this._opaqueQueue.pushPrimitive(t)},s._drawBackgroundTexture=function(t,e){var r=t._hardwareRenderer,i=t._backgroundTextureMaterial,o=t.canvas,c=e._mesh;(this._lastCanvasSize.x!==o.width||this._lastCanvasSize.y!==o.height)&&e._textureFillMode!==_r.Fill&&(this._lastCanvasSize.setValue(o.width,o.height),e._resizeBackgroundTexture());var l=i.shader._getShaderProgram(t,C._compileMacros);l.bind(),l.uploadAll(l.materialUniformBlock,i.shaderData),l.uploadUnGroupTextures(),i.renderState._apply(t,!1),r.drawPrimitive(c,c.subMesh,l)},s._drawSky=function(t,e,r){var i=r.material,o=r.mesh,c=r._matrix;if(!!i&&!!o){var l=t._hardwareRenderer,u=i.shaderData,h=i.shader,d=i.renderState,f=C._compileMacros;rt.unionCollection(e._globalShaderMacro,u._macroCollection,f);var _=e.viewMatrix,v=e.projectionMatrix;_.cloneTo(c);var p=c.elements;p[12]=p[13]=p[14]=0,j.multiply(v,c,c),u.setMatrix("u_mvpNoscale",c);var g=h._getShaderProgram(t,f);g.bind(),g.groupingOtherUniformBlock(),g.uploadAll(g.materialUniformBlock,u),g.uploadUnGroupTextures(),d._apply(t,!1),l.drawPrimitive(o,o.subMesh,g)}},W(n,[{key:"defaultRenderPass",get:function(){return this._defaultPass}}]),n}(),La,Ia,Qe,Fa,Na,Ua,Va,Ga,ka,Ha,Wa,ja,Xa,Ka,qa,Zt,vr=function(){};vr.tempVec4=new ve;vr.tempVec3=new x;vr.tempVec2=new k;var Fs=(La=Cc(Rt),La(Ia=(Qe=(Zt=function(n){X(s,n);function s(t){var e;e=n.call(this,t)||this,e.shaderData=new Hi(gt.Camera),e.priority=0,e.enableFrustumCulling=!0,e.clearFlags=xr.DepthColor,e.cullingMask=ot.Everything,e._globalShaderMacro=new rt,I(e,"_frustum",Fa,B(e)),I(e,"_renderPipeline",Na,B(e)),e._isOrthographic=!1,e._isProjMatSetting=!1,e._nearClipPlane=.1,e._farClipPlane=100,e._fieldOfView=45,e._orthographicSize=10,e._isProjectionDirty=!0,e._isInvProjMatDirty=!0,e._isFrustumProjectDirty=!0,e._customAspectRatio=void 0,e._renderTarget=null,I(e,"_frustumViewChangeFlag",Ua,B(e)),I(e,"_transform",Va,B(e)),I(e,"_isViewMatrixDirty",Ga,B(e)),I(e,"_isInvViewProjDirty",ka,B(e)),I(e,"_projectionMatrix",Ha,B(e)),I(e,"_viewMatrix",Wa,B(e)),I(e,"_viewport",ja,B(e)),I(e,"_inverseProjectionMatrix",Xa,B(e)),I(e,"_lastAspectSize",Ka,B(e)),I(e,"_invViewProjMat",qa,B(e));var r=e.entity.transform;return e._transform=r,e._isViewMatrixDirty=r.registerWorldChangeFlag(),e._isInvViewProjDirty=r.registerWorldChangeFlag(),e._frustumViewChangeFlag=r.registerWorldChangeFlag(),e._renderPipeline=new Tu(B(e)),e.shaderData._addRefCount(1),e}var a=s.prototype;return a.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},a.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},a.worldToViewportPoint=function(e,r){var i=vr.tempVec3,o=vr.tempVec4;x.transformCoordinate(e,this.viewMatrix,i),x.transformToVec4(i,this.projectionMatrix,o);var c=o.w;return r.setValue((o.x/c+1)*.5,(1-o.y/c)*.5,-i.z),r},a.viewportToWorldPoint=function(e,r){var i=this.nearClipPlane,o=this.farClipPlane,c=1/(i-o),l;if(this.isOrthographic)l=-e.z*2*c,l+=(o+i)*c;else{var u=e.z;l=-u*(i+o)*c,l+=2*i*o*c,l=l/u}return this._innerViewportToWorldPoint(e.x,e.y,(l+1)/2,this._getInvViewProjMat(),r),r},a.viewportPointToRay=function(e,r){var i=this._getInvViewProjMat(),o=this._innerViewportToWorldPoint(e.x,e.y,0,i,r.origin),c=this._innerViewportToWorldPoint(e.x,e.y,1,i,r.direction);return x.subtract(c,o,c),c.normalize(),r},a.screenToViewportPoint=function(e,r){var i=this.engine.canvas,o=this.viewport;return r.x=(e.x/i.width-o.x)/o.z,r.y=(e.y/i.height-o.y)/o.w,e.z!==void 0&&(r.z=e.z),r},a.viewportToScreenPoint=function(e,r){var i=this.engine.canvas,o=this.viewport;return r.x=(o.x+e.x*o.z)*i.width,r.y=(o.y+e.y*o.w)*i.height,e.z!==void 0&&(r.z=e.z),r},a.worldToScreenPoint=function(e,r){return this.worldToViewportPoint(e,r),this.viewportToScreenPoint(r,r)},a.screenToWorldPoint=function(e,r){return this.screenToViewportPoint(e,r),this.viewportToWorldPoint(r,r)},a.screenPointToRay=function(e,r){var i=vr.tempVec2;return this.screenToViewportPoint(e,i),this.viewportPointToRay(i,r)},a.render=function(e,r){r===void 0&&(r=0);var i=this.engine._renderContext;i._setContext(this),this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(i._viewProjectMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(i),rt.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),r>0&&!this.engine._hardwareRenderer.isWebGL2&&(r=0),this._renderPipeline.render(i,e,r),this._engine._renderCount++},a._onActive=function(){this.entity.scene._attachRenderCamera(this)},a._onInActive=function(){this.entity.scene._detachRenderCamera(this)},a._onDestroy=function(){var e;(e=this._renderPipeline)===null||e===void 0||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},a._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},a._innerViewportToWorldPoint=function(e,r,i,o,c){var l=vr.tempVec3;return l.setValue(e*2-1,1-r*2,i*2-1),x.transformCoordinate(l,o,c),c},a._updateShaderData=function(e){var r=this.shaderData;r.setMatrix(s._viewMatrixProperty,this.viewMatrix),r.setMatrix(s._projectionMatrixProperty,this.projectionMatrix),r.setMatrix(s._vpMatrixProperty,e._viewProjectMatrix),r.setMatrix(s._inverseViewMatrixProperty,this._transform.worldMatrix),r.setMatrix(s._inverseProjectionMatrixProperty,this._getInverseProjectionMatrix()),r.setVector3(s._cameraPositionProperty,this._transform.worldPosition)},a._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,j.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},a._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,j.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},W(s,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,r=this._entity.engine.canvas;return(e=this._customAspectRatio)!=null?e:r.width*this._viewport.z/(r.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&e.cloneTo(this._viewport),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,j.invert(this._transform.worldMatrix,this._viewMatrix)),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var r=this.aspectRatio;if(!this._isOrthographic)j.perspective(L.degreeToRadian(this._fieldOfView),r,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);else{var i=this._orthographicSize*r,o=this._orthographicSize;j.ortho(-i,i,-o,o,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}}]),s}(dt),Zt._viewMatrixProperty=C.getPropertyByName("u_viewMat"),Zt._projectionMatrixProperty=C.getPropertyByName("u_projMat"),Zt._vpMatrixProperty=C.getPropertyByName("u_VPMat"),Zt._inverseViewMatrixProperty=C.getPropertyByName("u_viewInvMat"),Zt._inverseProjectionMatrixProperty=C.getPropertyByName("u_projInvMat"),Zt._cameraPositionProperty=C.getPropertyByName("u_cameraPos"),Zt),Fa=F(Qe.prototype,"_frustum",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hc}}),Na=F(Qe.prototype,"_renderPipeline",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ua=F(Qe.prototype,"_frustumViewChangeFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Va=F(Qe.prototype,"_transform",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ga=F(Qe.prototype,"_isViewMatrixDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ka=F(Qe.prototype,"_isInvViewProjDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ha=F(Qe.prototype,"_projectionMatrix",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),Wa=F(Qe.prototype,"_viewMatrix",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),ja=F(Qe.prototype,"_viewport",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ve(0,0,1,1)}}),Xa=F(Qe.prototype,"_inverseProjectionMatrix",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),Ka=F(Qe.prototype,"_lastAspectSize",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new k(0,0)}}),qa=F(Qe.prototype,"_invViewProjMat",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new j}}),Qe))||Ia),Ru={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"},zu=4,Eu=15e3,Bu=500;function Ri(n,s){return s===void 0&&(s={}),new tt(function(a,t,e){var r,i,o,c,l=(r=s.retryCount)!=null?r:zu,u=(i=s.retryInterval)!=null?i:Bu;s.timeout=(o=s.timeout)!=null?o:Eu,s.type=(c=s.type)!=null?c:Lu(n);var h=s.type==="image"?Du:Ou,d,f=new Iu(function(){return h(n,s).onProgress(e).then(function(_){a(_),f.stop()}).catch(function(_){return d=_})},l,u);f.start(function(){t(d)})})}function Du(n,s){return new tt(function(a,t){var e=s.timeout,r=new Image,i=function(){t(new Error("request "+n+" fail"))};r.onerror=i,r.onabort=i;var o=setTimeout(function(){t(new Error("request "+n+" timeout"))},e);r.onload=function(c){return function(){requestAnimationFrame(function(){a(r),r.onload=null,r.onerror=null,r.onabort=null}),clearTimeout(c)}}(o),r.crossOrigin="anonymous",r.src=n})}function Ou(n,s){return new tt(function(a,t,e){var r,i=new XMLHttpRequest;i.timeout=s.timeout,s.method=(r=s.method)!=null?r:"get",i.onload=function(){var c;if(i.status<200||i.status>=300){t(new Error("request failed from: "+n));return}var l=(c=i.response)!=null?c:i.responseText;a(l)},i.onerror=function(){t(new Error("request failed from: "+n))},i.ontimeout=function(){t(new Error("request timeout from: "+n))},i.onprogress=function(c){e(c.loaded/c.total)},i.open(s.method,n,!0),i.withCredentials=s.credentials==="include",i.responseType=s.type;var o=s.headers;o&&Object.keys(o).forEach(function(c){i.setRequestHeader(c,o[c])}),i.send(s.body)})}function Lu(n){var s=n.substring(n.lastIndexOf(".")+1);return Ru[s]}var Iu=function(){function n(a,t,e){this.execFunc=a,this.totalCount=t,this.interval=e,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var s=n.prototype;return s.start=function(t){this.done=t,this.exec()},s.stop=function(){clearTimeout(this._timeoutId)},s.exec=function(){var t=this;if(this._currentCount>=this.totalCount){this.done&&this.done();return}this._currentCount++,this.execFunc(this._currentCount).then(function(){t._timeoutId=setTimeout(t.exec,t.interval)})},n}(),Xt=function(s){this.useCache=s,this.request=Ri},pe;(function(n){n.Text="text",n.JSON="json",n.Buffer="buffer",n.Texture2D="texture2d",n.TextureCube="texture-cube",n.Material="material",n.Mesh="mesh",n.AnimationClip="animation-clip",n.Prefab="prefab",n.KTX="ktx",n.KTXCube="ktx-cube",n.SpriteAtlas="sprite-atlas",n.Env="environment"})(pe||(pe={}));var ir;(function(n){n[n.Front=0]="Front",n[n.Back=1]="Back",n[n.Double=2]="Double"})(ir||(ir={}));var Jr;(function(n){n[n.Normal=0]="Normal",n[n.Additive=1]="Additive"})(Jr||(Jr={}));var fi=function(n){X(s,n);function s(t,e){var r;return r=n.call(this,t,e)||this,r._renderFace=ir.Front,r._isTransparent=!1,r._blendMode=void 0,r.blendMode=Jr.Normal,r.shaderData.setFloat(s._alphaCutoffProp,0),r}var a=s.prototype;return a.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},a.cloneTo=function(e){n.prototype.cloneTo.call(this,e),e._renderFace=this._renderFace,e._isTransparent=this._isTransparent,e._blendMode=this._blendMode},W(s,[{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){if(e!==this._isTransparent){this._isTransparent=e;var r=this.renderState,i=r.depthState,o=r.blendState.targetBlendState;e?(o.enabled=!0,i.writeEnabled=!1,this.renderQueueType=Be.Transparent):(o.enabled=!1,i.writeEnabled=!0,this.renderQueueType=this.shaderData.getFloat(s._alphaCutoffProp)?Be.AlphaTest:Be.Opaque)}}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(s._alphaCutoffProp)},set:function(e){this.shaderData.setFloat(s._alphaCutoffProp,e),e>0?(this.shaderData.enableMacro(s._alphaCutoffMacro),this.renderQueueType=this._isTransparent?Be.Transparent:Be.AlphaTest):(this.shaderData.disableMacro(s._alphaCutoffMacro),this.renderQueueType=this._isTransparent?Be.Transparent:Be.Opaque)}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){if(e!==this._renderFace)switch(this._renderFace=e,e){case ir.Front:this.renderState.rasterState.cullMode=ct.Back;break;case ir.Back:this.renderState.rasterState.cullMode=ct.Front;break;case ir.Double:this.renderState.rasterState.cullMode=ct.Off;break}}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){if(e!==this._blendMode){this._blendMode=e;var r=this.renderState.blendState.targetBlendState;switch(e){case Jr.Normal:r.sourceColorBlendFactor=J.SourceAlpha,r.destinationColorBlendFactor=J.OneMinusSourceAlpha,r.sourceAlphaBlendFactor=J.One,r.destinationAlphaBlendFactor=J.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=st.Add;break;case Jr.Additive:r.sourceColorBlendFactor=J.SourceAlpha,r.destinationColorBlendFactor=J.One,r.sourceAlphaBlendFactor=J.One,r.destinationAlphaBlendFactor=J.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=st.Add;break}}}}]),s}(nr);fi._alphaCutoffMacro=C.getMacroByName("ALPHA_CUTOFF");fi._alphaCutoffProp=C.getPropertyByName("u_alphaCutoff");var $e=function(n){X(s,n);function s(t){var e;e=n.call(this,t,C.find("blinn-phong"))||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(s._diffuseColorProp,new Q(1,1,1,1)),r.setColor(s._specularColorProp,new Q(1,1,1,1)),r.setColor(s._emissiveColorProp,new Q(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ve(1,1,0,0)),r.setFloat(s._shininessProp,16),r.setFloat(s._normalIntensityProp,1),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},W(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._diffuseColorProp)},set:function(e){var r=this.shaderData.getColor(s._diffuseColorProp);e!==r&&e.cloneTo(r)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro("O3_DIFFUSE_TEXTURE"):this.shaderData.disableMacro("O3_DIFFUSE_TEXTURE")}},{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&e.cloneTo(r)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(s._specularTextureProp)},set:function(e){this.shaderData.setTexture(s._specularTextureProp,e),e?this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(e){var r=this.shaderData.getColor(s._emissiveColorProp);e!==r&&e.cloneTo(r)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(s._emissiveTextureProp,e),e?this.shaderData.enableMacro("O3_EMISSIVE_TEXTURE"):this.shaderData.disableMacro("O3_EMISSIVE_TEXTURE")}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(e){this.shaderData.setTexture(s._normalTextureProp,e),e?this.shaderData.enableMacro("O3_NORMAL_TEXTURE"):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(s._normalIntensityProp)},set:function(e){this.shaderData.setFloat(s._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(s._shininessProp)},set:function(e){this.shaderData.setFloat(s._shininessProp,e)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&e.cloneTo(r)}}]),s}(fi);$e._diffuseColorProp=C.getPropertyByName("u_diffuseColor");$e._specularColorProp=C.getPropertyByName("u_specularColor");$e._emissiveColorProp=C.getPropertyByName("u_emissiveColor");$e._tilingOffsetProp=C.getPropertyByName("u_tilingOffset");$e._shininessProp=C.getPropertyByName("u_shininess");$e._normalIntensityProp=C.getPropertyByName("u_normalIntensity");$e._baseTextureProp=C.getPropertyByName("u_diffuseTexture");$e._specularTextureProp=C.getPropertyByName("u_specularTexture");$e._emissiveTextureProp=C.getPropertyByName("u_emissiveTexture");$e._normalTextureProp=C.getPropertyByName("u_normalTexture");var Pt=function(n){X(s,n);function s(a,t){var e;e=n.call(this,a,t)||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(s._baseColorProp,new Q(1,1,1,1)),r.setColor(s._emissiveColorProp,new Q(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ve(1,1,0,0)),r.setFloat(s._normalTextureIntensityProp,1),r.setFloat(s._occlusionTextureIntensityProp,1),e}return W(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(t){var e=this.shaderData.getColor(s._baseColorProp);t!==e&&t.cloneTo(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(t){this.shaderData.setTexture(s._baseTextureProp,t),t?this.shaderData.enableMacro("HAS_BASECOLORMAP"):this.shaderData.disableMacro("HAS_BASECOLORMAP")}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(t){this.shaderData.setTexture(s._normalTextureProp,t),t?this.shaderData.enableMacro("O3_NORMAL_TEXTURE"):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(s._normalTextureIntensityProp)},set:function(t){this.shaderData.setFloat(s._normalTextureIntensityProp,t),this.shaderData.setFloat("u_normalIntensity",t)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(t){var e=this.shaderData.getColor(s._emissiveColorProp);t!==e&&t.cloneTo(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(t){this.shaderData.setTexture(s._emissiveTextureProp,t),t?this.shaderData.enableMacro("HAS_EMISSIVEMAP"):this.shaderData.disableMacro("HAS_EMISSIVEMAP")}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(s._occlusionTextureProp)},set:function(t){this.shaderData.setTexture(s._occlusionTextureProp,t),t?this.shaderData.enableMacro("HAS_OCCLUSIONMAP"):this.shaderData.disableMacro("HAS_OCCLUSIONMAP")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(s._occlusionTextureIntensityProp)},set:function(t){this.shaderData.setFloat(s._occlusionTextureIntensityProp,t)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(t){var e=this.shaderData.getVector4(s._tilingOffsetProp);t!==e&&t.cloneTo(e)}}]),s}(fi);Pt._baseColorProp=C.getPropertyByName("u_baseColor");Pt._emissiveColorProp=C.getPropertyByName("u_emissiveColor");Pt._tilingOffsetProp=C.getPropertyByName("u_tilingOffset");Pt._baseTextureProp=C.getPropertyByName("u_baseColorSampler");Pt._normalTextureProp=C.getPropertyByName("u_normalTexture");Pt._normalTextureIntensityProp=C.getPropertyByName("u_normalIntensity");Pt._occlusionTextureIntensityProp=C.getPropertyByName("u_occlusionStrength");Pt._emissiveTextureProp=C.getPropertyByName("u_emissiveSampler");Pt._occlusionTextureProp=C.getPropertyByName("u_occlusionSampler");var Pr=function(n){X(s,n);function s(t){var e;return e=n.call(this,t,C.find("pbr"))||this,e.shaderData.setFloat(s._metallicProp,1),e.shaderData.setFloat(s._roughnessProp,1),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},W(s,[{key:"metallic",get:function(){return this.shaderData.getFloat(s._metallicProp)},set:function(e){this.shaderData.setFloat(s._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(s._roughnessProp)},set:function(e){this.shaderData.setFloat(s._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(s._metallicRoughnessTextureProp)},set:function(e){this.shaderData.setTexture(s._metallicRoughnessTextureProp,e),e?this.shaderData.enableMacro("HAS_METALROUGHNESSMAP"):this.shaderData.disableMacro("HAS_METALROUGHNESSMAP")}}]),s}(Pt);Pr._metallicProp=C.getPropertyByName("u_metal");Pr._roughnessProp=C.getPropertyByName("u_roughness");Pr._metallicRoughnessTextureProp=C.getPropertyByName("u_metallicRoughnessSampler");var Sr=function(n){X(s,n);function s(t){var e;return e=n.call(this,t,C.find("pbr-specular"))||this,e.shaderData.setColor(s._specularColorProp,new Q(1,1,1,1)),e.shaderData.setFloat(s._glossinessProp,1),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},W(s,[{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&e.cloneTo(r)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(s._glossinessProp)},set:function(e){this.shaderData.setFloat(s._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(s._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(s._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro("HAS_SPECULARGLOSSINESSMAP"):this.shaderData.disableMacro("HAS_SPECULARGLOSSINESSMAP")}}]),s}(Pt);Sr._specularColorProp=C.getPropertyByName("u_specularColor");Sr._glossinessProp=C.getPropertyByName("u_glossiness");Sr._specularGlossinessTextureProp=C.getPropertyByName("u_specularGlossinessSampler");var Ar=function(n){X(s,n);function s(t){var e;e=n.call(this,t,C.find("unlit"))||this;var r=e.shaderData;return r.enableMacro("OMIT_NORMAL"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(s._baseColorProp,new Q(1,1,1,1)),r.setVector4(s._tilingOffsetProp,new ve(1,1,0,0)),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},W(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(e){var r=this.shaderData.getColor(s._baseColorProp);e!==r&&e.cloneTo(r)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro("O3_BASE_TEXTURE"):this.shaderData.disableMacro("O3_BASE_TEXTURE")}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&e.cloneTo(r)}}]),s}(fi);Ar._baseColorProp=C.getPropertyByName("u_baseColor");Ar._baseTextureProp=C.getPropertyByName("u_baseTexture");Ar._tilingOffsetProp=C.getPropertyByName("u_tilingOffset");var Ns=function(n){X(a,n);var s=a.prototype;s.getSprite=function(e){var r=this._sprites[this._spriteNamesToIndex[e]];return r||console.warn("There is no sprite named "+e+" in the atlas."),r},s.getSprites=function(e,r){r.length=0;var i=this._spriteNamesToIndex[e];if(i!==void 0)for(var o=this._sprites;i>=0;i--){var c=o[i];c.name===e&&r.push(c)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return r};function a(t){var e;return e=n.call(this,t)||this,e._sprites=new Array,e._spriteNamesToIndex={},e}return s._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1},s._onDestroy=function(){this._sprites=null,this._spriteNamesToIndex=null},W(a,[{key:"sprites",get:function(){return this._sprites}}]),a}(kr),vn=function(n){X(s,n);function s(t,e,r,i,o,c){var l;return e===void 0&&(e=null),r===void 0&&(r=null),i===void 0&&(i=null),o===void 0&&(o=128),c===void 0&&(c=null),l=n.call(this,t)||this,l.name=void 0,l._uv=[new k,new k,new k,new k],l._positions=[new k,new k,new k,new k],l._bounds=new or,l._triangles=void 0,l._assetID=void 0,l._pixelsPerUnit=void 0,l._texture=null,l._atlasRotated=!1,l._region=new tn(0,0,1,1),l._pivot=new k(.5,.5),l._atlasRegion=new tn(0,0,1,1),l._atlasRegionOffset=new ve(0,0,0,0),l._dirtyFlag=Se.all,l._updateFlagManager=new ui,l.name=c,l._texture=e,l._pixelsPerUnit=o,r&&r.cloneTo(l._region),i&&i.cloneTo(l._pivot),l._triangles=s._rectangleTriangles,l}var a=s.prototype;return a.clone=function(){var e=new s(this._engine,this._texture,this._region,this._pivot,this._pixelsPerUnit,this.name);return e._assetID=this._assetID,e._atlasRotated=this._atlasRotated,this._atlasRegion.cloneTo(e._atlasRegion),this._atlasRegionOffset.cloneTo(e._atlasRegionOffset),e},a._registerUpdateFlag=function(){return this._updateFlagManager.register()},a._onDestroy=function(){this._texture&&(this._texture=null)},a._updatePositionsAndBounds=function(){var e=this._texture,r=this._bounds;if(e){var i=this._atlasRegion,o=this._pivot,c=this._atlasRegionOffset,l=this._region,u=l.x,h=l.y,d=l.width,f=l.height,_=1/this._pixelsPerUnit,v,p,g,m,y,w;if(this._atlasRotated?(y=e.height*i.height*_,w=e.width*i.width*_):(y=e.width*i.width*_,w=e.height*i.height*_),c.x==0&&c.y==0&&c.z==0&&c.w==0){var P=y*d,A=w*f;v=-o.x*P,m=-o.y*A,g=P+v,p=A+m}else{var b=c.x,M=c.y,S=c.z,T=c.w,z=y/(1-S-b),R=w/(1-T-M);v=(-o.x*d+Math.max(b,u)-u)*z,p=(o.y*f-Math.max(M,h)+h)*R,g=(-o.x*d+Math.min(1-S,u+d)-u)*z,m=(o.y*f-Math.min(1-T,h+f)+h)*R}var E=this._positions;E[0].setValue(v,p),E[1].setValue(g,p),E[2].setValue(g,m),E[3].setValue(v,m),r.min.setValue(v,m,0),r.max.setValue(g,p,0)}else r.min.setValue(0,0,0),r.max.setValue(0,0,0)},a._updateMesh=function(){if(this._isContainDirtyFlag(Se.positions)&&this._updatePositionsAndBounds(),this._isContainDirtyFlag(Se.uv)){var e=this._atlasRegion,r=this._uv,i=this._region,o=this._atlasRotated,c=this._atlasRegionOffset,l,u,h,d;if(c.x==0&&c.y==0&&c.z==0&&c.w==0){var f=e.width,_=e.height;o?(l=f*(1-i.y-i.height)+e.x,u=_*i.x+e.y,h=f*i.height+l,d=_*i.width+u):(l=f*i.x+e.x,u=_*i.y+e.y,h=f*i.width+l,d=_*i.height+u)}else{var v=i.x,p=i.y,g=e.x,m=e.y,y=c.x,w=c.y,P=c.z,A=c.w;if(o){var b=e.width/(1-A-w),M=e.height/(1-P-y);l=(Math.max(A,1-p-i.height)-A)*b+g,u=(Math.max(y,v)-y)*M+m,h=(Math.min(1-w,1-p)-A)*b+g,d=(Math.min(1-P,v+i.width)-y)*M+m}else{var S=e.width/(1-P-y),T=e.height/(1-A-w);l=(Math.max(y,v)-y)*S+g,u=(Math.max(w,p)-w)*T+m,h=(Math.min(1-P,v+i.width)-y)*S+g,d=(Math.min(1-A,p+i.height)-w)*T+m}}o?(r[0].setValue(h,u),r[1].setValue(h,d),r[2].setValue(l,d),r[3].setValue(l,u)):(r[0].setValue(l,u),r[1].setValue(h,u),r[2].setValue(h,d),r[3].setValue(l,d))}this._setDirtyFlagFalse(Se.all)},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e,this._updateFlagManager.distribute()},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},W(s,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._setDirtyFlagTrue(Se.positions))}},{key:"bounds",get:function(){return this._isContainDirtyFlag(Se.positions)&&this._texture&&(this._updatePositionsAndBounds(),this._setDirtyFlagFalse(Se.positions)),this._bounds}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e,this._setDirtyFlagTrue(Se.positions|Se.uv))}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var r=L.clamp(e.x,0,1),i=L.clamp(e.y,0,1);this._atlasRegion.setValue(r,i,L.clamp(e.width,0,1-r),L.clamp(e.height,0,1-i)),this._setDirtyFlagTrue(Se.positions|Se.uv)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var r=L.clamp(e.x,0,1),i=L.clamp(e.y,0,1);this._atlasRegionOffset.setValue(r,i,L.clamp(e.z,0,1-r),L.clamp(e.w,0,1-i)),this._setDirtyFlagTrue(Se.positions|Se.uv)}},{key:"pivot",get:function(){return this._pivot},set:function(e){var r=this._pivot,i=L.clamp(e.x,0,1),o=L.clamp(e.y,0,1);(r===e||r.x!==i||r.y!==o)&&(r.setValue(i,o),this._setDirtyFlagTrue(Se.positions))}},{key:"region",get:function(){return this._region},set:function(e){var r=this._region,i=L.clamp(e.x,0,1),o=L.clamp(e.y,0,1);r.setValue(i,o,L.clamp(e.width,0,1-i),L.clamp(e.height,0,1-o)),this._setDirtyFlagTrue(Se.positions|Se.uv)}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._setDirtyFlagTrue(Se.positions))}}]),s}(kr);vn._rectangleTriangles=[0,2,1,2,0,3];var Se;(function(n){n[n.positions=1]="positions",n[n.uv=2]="uv",n[n.all=3]="all"})(Se||(Se={}));var Fe,Qa,Ya,$a,Ja,Za,eo,to,ro,io,no,ao,oo,so,co,Ci,Fu=(Fe=(Ci=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,I(e,"_customLocalBounds",Qa,B(e)),I(e,"_customRootEntity",Ya,B(e)),I(e,"_positions",$a,B(e)),I(e,"_sprite",Ja,B(e)),I(e,"_color",Za,B(e)),I(e,"_flipX",eo,B(e)),I(e,"_flipY",to,B(e)),I(e,"_cacheFlipX",ro,B(e)),I(e,"_cacheFlipY",io,B(e)),I(e,"_dirtyFlag",no,B(e)),I(e,"_isWorldMatrixDirty",ao,B(e)),I(e,"_spriteDirty",oo,B(e)),I(e,"_maskInteraction",so,B(e)),I(e,"_maskLayer",co,B(e)),e._isWorldMatrixDirty=t.transform.registerWorldChangeFlag(),e.setMaterial(e._engine._spriteDefaultMaterial),e}var a=s.prototype;return a._render=function(e){var r=this.sprite;if(!!r){var i=r.texture;if(!!i){var o=this._positions,c=this.entity.transform;if(r._updateMesh(),this._isWorldMatrixDirty.flag||this._spriteDirty.flag){for(var l=r._positions,u=s._tempVec3,h=c.worldMatrix,d=this.flipX,f=this.flipY,_=0,v=o.length;_<v;_++){var p=l[_];u.setValue(d?-p.x:p.x,f?-p.y:p.y,0),x.transformToVec3(u,h,o[_])}this._setDirtyFlagFalse(At.Flip),this._isWorldMatrixDirty.flag=!1,this._spriteDirty.flag=!1,this._cacheFlipX=d,this._cacheFlipY=f}else if(this._isContainDirtyFlag(At.Flip)){var g=this.flipX,m=this.flipY,y=this._cacheFlipX!==g,w=this._cacheFlipY!==m;if(y||w)for(var P=c.worldPosition,A=P.x,b=P.y,M=0,S=o.length;M<S;M++){var T=o[M];y&&(T.x=A*2-T.x),w&&(T.y=b*2-T.y)}this._setDirtyFlagFalse(At.Flip),this._cacheFlipX=g,this._cacheFlipY=m}this._isContainDirtyFlag(At.MaskInteraction)&&(this._updateStencilState(),this._setDirtyFlagFalse(At.MaskInteraction)),this.shaderData.setTexture(s._textureProperty,i);var z=this.getMaterial(),R=this._engine._spriteElementPool,E=R.getFromPool();E.setValue(this,o,r._uv,r._triangles,this.color,z,e),e._renderPipeline.pushPrimitive(E)}}},a._onDestroy=function(){this._isWorldMatrixDirty.destroy(),this._spriteDirty&&this._spriteDirty.destroy(),n.prototype._onDestroy.call(this)},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},a._cloneTo=function(e){e.sprite=this._sprite},a._updateBounds=function(e){var r=this._sprite;if(r)if(this._customLocalBounds&&this._customRootEntity){var i=this._customRootEntity.transform.worldMatrix;or.transform(this._customLocalBounds,i,e)}else{var o=r.bounds,c=this._entity.transform.worldMatrix;or.transform(o,c,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},a._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,i=this._maskInteraction;if(i===ar.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=fe.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var o=i===ar.VisibleInsideMask?fe.LessEqual:fe.Greater;r.compareFunctionFront=o,r.compareFunctionBack=o}},W(s,[{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._spriteDirty&&this._spriteDirty.destroy(),this._sprite=e,e&&(this._spriteDirty=e._registerUpdateFlag()))}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&e.cloneTo(this._color)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._setDirtyFlagTrue(At.Flip))}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._setDirtyFlagTrue(At.Flip))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(At.MaskInteraction))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}}]),s}(_n),Ci._textureProperty=C.getPropertyByName("u_spriteTexture"),Ci._tempVec3=new x,Ci),Qa=F(Fe.prototype,"_customLocalBounds",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ya=F(Fe.prototype,"_customRootEntity",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$a=F(Fe.prototype,"_positions",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new x,new x,new x,new x]}}),Ja=F(Fe.prototype,"_sprite",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Za=F(Fe.prototype,"_color",[ye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q(1,1,1,1)}}),eo=F(Fe.prototype,"_flipX",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),to=F(Fe.prototype,"_flipY",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ro=F(Fe.prototype,"_cacheFlipX",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),io=F(Fe.prototype,"_cacheFlipY",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),no=F(Fe.prototype,"_dirtyFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ao=F(Fe.prototype,"_isWorldMatrixDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oo=F(Fe.prototype,"_spriteDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),so=F(Fe.prototype,"_maskInteraction",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.None}}),co=F(Fe.prototype,"_maskLayer",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.Layer0}}),Fe),At;(function(n){n[n.Flip=1]="Flip",n[n.MaskInteraction=2]="MaskInteraction"})(At||(At={}));var Nu=function(){this.relativePath=void 0,this.type=void 0,this.property=void 0,this.curve=void 0},Uu=function(){this.time=void 0,this.functionName=void 0,this.parameter=void 0},ie;(function(n){n[n.Position=0]="Position",n[n.Rotation=1]="Rotation",n[n.Scale=2]="Scale",n[n.BlendShapeWeights=3]="BlendShapeWeights"})(ie||(ie={}));var Vu=function(){},Gu=function(n){X(s,n);function s(t){var e;return e=n.call(this)||this,e.name=t,e._curveBindings=[],e._length=0,e._events=[],e}var a=s.prototype;return a.addEvent=function(e,r,i){if(typeof e=="string"){var o=new Uu;o.functionName=e,o.time=r,o.parameter=i,this._events.push(o)}else this._events.push(e);this._events.sort(function(c,l){return c.time-l.time})},a.clearEvents=function(){this._events.length=0},a.addCurveBinding=function(e,r,i,o){var c;switch(i){case"position":c=ie.Position;break;case"rotation":c=ie.Rotation;break;case"scale":c=ie.Scale;break;case"blendShapeWeights":c=ie.BlendShapeWeights;break}var l=new Nu;l.relativePath=e,l.type=r,l.property=c,l.curve=o,o.length>this._length&&(this._length=o.length),this._curveBindings.push(l)},a.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},a._sampleAnimation=function(e,r){for(var i=this._curveBindings.length,o=i-1;o>=0;o--){var c=this._curveBindings[o],l=c.curve,u=c.property,h=c.relativePath,d=c.type,f=l.evaluate(r),_=e.findByName(h),v=_.transform;if(d===Rt)switch(u){case ie.Position:v.position=f;break;case ie.Rotation:v.rotationQuaternion=f;break;case ie.Scale:v.scale=f;break}}},W(s,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),s}(Vu),Fi=function(){function n(){}return n.scaleWeight=function(a,t,e){var r=a.x,i=a.y,o=a.z;e.x=r>0?Math.pow(Math.abs(r),t):-Math.pow(Math.abs(r),t),e.y=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),e.z=o>0?Math.pow(Math.abs(o),t):-Math.pow(Math.abs(o),t)},n.scaleBlend=function(a,t,e,r){var i=n._tempVector30,o=n._tempVector31;n.scaleWeight(a,1-e,i),n.scaleWeight(t,e,o);var c=e>.5?t:a;r.x=c.x>0?Math.abs(i.x*o.x):-Math.abs(i.x*o.x),r.y=c.y>0?Math.abs(i.y*o.y):-Math.abs(i.y*o.y),r.z=c.z>0?Math.abs(i.z*o.z):-Math.abs(i.z*o.z)},n.quaternionWeight=function(a,t,e){e.x=a.x*t,e.y=a.y*t,e.z=a.z*t,e.w=a.w},n}();Fi._tempVector30=new x;Fi._tempVector31=new x;var Ni;(function(n){n[n.Override=0]="Override",n[n.Additive=1]="Additive"})(Ni||(Ni={}));var Xe;(function(n){n[n.UnStarted=0]="UnStarted",n[n.Playing=1]="Playing",n[n.Finished=2]="Finished"})(Xe||(Xe={}));var Me;(function(n){n[n.Standby=0]="Standby",n[n.Playing=1]="Playing",n[n.CrossFading=2]="CrossFading",n[n.FixedCrossFading=3]="FixedCrossFading"})(Me||(Me={}));var ku=function(){function n(a,t,e){switch(this.crossCurveMark=0,this.crossCurveIndex=void 0,this.target=void 0,this.type=void 0,this.property=void 0,this.component=void 0,this.defaultValue=void 0,this.fixedPoseValue=void 0,this._hasSavedDefaultValue=!1,this.target=a,this.type=t,this.property=e,e){case ie.Position:this.defaultValue=new x,this.fixedPoseValue=new x,this.component=a.transform;break;case ie.Rotation:this.defaultValue=new he,this.fixedPoseValue=new he,this.component=a.transform;break;case ie.Scale:this.defaultValue=new x,this.fixedPoseValue=new x,this.component=a.transform;break;case ie.BlendShapeWeights:this.defaultValue=new Float32Array(4),this.fixedPoseValue=new Float32Array(4),this.component=a.getComponent(ci);break}}var s=n.prototype;return s.saveDefaultValue=function(){switch(this.property){case ie.Position:this.target.transform.position.cloneTo(this.defaultValue);break;case ie.Rotation:this.target.transform.rotationQuaternion.cloneTo(this.defaultValue);break;case ie.Scale:this.target.transform.scale.cloneTo(this.defaultValue);break;case ie.BlendShapeWeights:for(var t=this.component,e=t.blendShapeWeights,r=0,i=e.length;r<i;++r)this.defaultValue[r]=this.component.blendShapeWeights[r];break}this._hasSavedDefaultValue=!0},s.saveFixedPoseValue=function(){switch(this.property){case ie.Position:this.target.transform.position.cloneTo(this.fixedPoseValue);break;case ie.Rotation:this.target.transform.rotationQuaternion.cloneTo(this.fixedPoseValue);break;case ie.Scale:this.target.transform.scale.cloneTo(this.fixedPoseValue);break;case ie.BlendShapeWeights:for(var t=this.component,e=t.blendShapeWeights,r=0,i=e.length;r<i;++r)this.fixedPoseValue[r]=this.component.blendShapeWeights[r];break}},n}(),Hu=function(){this.event=void 0,this.handlers=[]},Us=function(){this.duration=0,this.offset=0,this.exitTime=1,this.destinationState=void 0},Ui;(function(n){n[n.Once=0]="Once",n[n.Loop=1]="Loop"})(Ui||(Ui={}));var lo=function(){function n(){this.state=void 0,this.stateData=void 0,this.frameTime=void 0,this.playState=void 0,this.clipTime=void 0,this.currentEventIndex=void 0}var s=n.prototype;return s.reset=function(t,e,r){this.state=t,this.frameTime=r,this.stateData=e,this.playState=Xe.UnStarted,this.clipTime=t.clipStartTime*t.clip.length,this.currentEventIndex=0},s.update=function(){var t=this.state,e=this.frameTime,r=t._getDuration();this.playState=Xe.Playing,e>r&&(t.wrapMode===Ui.Loop?e=e%r:(e=r,this.playState=Xe.Finished)),this.clipTime=e+t.clipStartTime*t.clip.length},n}(),Wu=function(){function n(){this.animatorStateDataMap={},this.srcPlayData=new lo,this.destPlayData=new lo,this.layerState=Me.Standby,this.crossCurveMark=0,this.manuallyTransition=new Us,this.crossFadeTransition=void 0}var s=n.prototype;return s.switchPlayData=function(){var t=this.destPlayData,e=this.srcPlayData;this.srcPlayData=t,this.destPlayData=e},n}(),ju=function(){this.curveOwners=[],this.eventHandlers=[]},Xu=function(){this.layerIndex=void 0,this.state=void 0},Ku=function(){this.curveOwner=void 0,this.srcCurveIndex=void 0,this.destCurveIndex=void 0},Lt,uo,ho,fo,_o,vo,po,go,Kr,pn=(Lt=(Kr=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,e._animatorController=void 0,I(e,"_speed",uo,B(e)),I(e,"_controllerUpdateFlag",ho,B(e)),I(e,"_animatorLayersData",fo,B(e)),I(e,"_crossCurveDataCollection",_o,B(e)),I(e,"_animationCurveOwners",vo,B(e)),I(e,"_crossCurveDataPool",po,B(e)),I(e,"_animationEventHandlerPool",go,B(e)),e}var a=s.prototype;return a.play=function(e,r,i){var o;r===void 0&&(r=-1),i===void 0&&(i=0),(o=this._controllerUpdateFlag)!==null&&o!==void 0&&o.flag&&this._clearPlayData();var c=this._getAnimatorStateInfo(e,r,s._animatorInfo),l=c.state;if(!!l){if(!l.clip){console.warn("The state named "+e+" has no AnimationClip data.");return}var u=this._getAnimatorLayerData(c.layerIndex),h=u.srcPlayData,d=h.state;d&&d!==l&&this._revertDefaultValue(h.state,h.stateData);var f=this._getAnimatorStateData(e,l,u);u.layerState=Me.Playing,h.reset(l,f,l._getDuration()*i),this._saveDefaultValues(f)}},a._reset=function(){var e=this._animatorController;if(e)for(var r=e.layers,i=0,o=r.length;i<o;++i)for(var c=r[i].stateMachine.states,l=this._getAnimatorLayerData(i),u=0,h=c.length;u<h;++u){var d=c[u],f=this._getAnimatorStateData(d.name,d,l);this._revertDefaultValue(d,f)}this._clearPlayData()},a.crossFade=function(e,r,i,o){var c;i===void 0&&(i=-1),o===void 0&&(o=0),(c=this._controllerUpdateFlag)!==null&&c!==void 0&&c.flag&&this._clearPlayData();var l=this._getAnimatorStateInfo(e,i,s._animatorInfo),u=l.state,h=this._getAnimatorLayerData(i),d=h.manuallyTransition;d.duration=r,d.offset=o,d.destinationState=u,this._crossFadeByTransition(d,i)},a.update=function(e){var r;if(this.speed!==0){var i=this._animatorController;if(!!i&&!((r=this._controllerUpdateFlag)!==null&&r!==void 0&&r.flag)){e*=this.speed;for(var o=0,c=i.layers.length;o<c;o++){var l=this._getAnimatorLayerData(o);l.layerState!==Me.Standby&&this._updateLayer(o,o===0,e/1e3)}}}},a.getCurrentAnimatorState=function(e){var r,i;return(r=this._animatorLayersData[e])===null||r===void 0||(i=r.srcPlayData)===null||i===void 0?void 0:i.state},a._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},a._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},a._getAnimatorStateInfo=function(e,r,i){var o=null,c=this._animatorController;if(c){var l=c.layers;if(r===-1){for(var u=0,h=l.length;u<h;u++)if(o=l[u].stateMachine.findStateByName(e),o){r=u;break}}else o=l[r].stateMachine.findStateByName(e)}return i.layerIndex=r,i.state=o,i},a._saveDefaultValues=function(e){for(var r=e.curveOwners,i=r.length-1;i>=0;i--)r[i].saveDefaultValue()},a._getAnimatorStateData=function(e,r,i){var o=i.animatorStateDataMap,c=o[e];return c||(c=new ju,o[e]=c,this._saveAnimatorStateData(r,c),this._saveAnimatorEventHandlers(r,c)),c},a._saveAnimatorStateData=function(e,r){for(var i=this.entity,o=this._animationCurveOwners,c=r.curveOwners,l=e.clip._curveBindings,u=l.length-1;u>=0;u--){var h=l[u],d=h.relativePath===""?i:i.findByPath(h.relativePath),f=h.property,_=d.instanceId,v=o[_]||(o[_]=[]);c[u]=v[f]||(v[f]=new ku(d,h.type,f))}},a._saveAnimatorEventHandlers=function(e,r){var i=this._animationEventHandlerPool,o=this._entity._scripts,c=o.length,l=r.eventHandlers,u=e.clip.events;i.resetPool(),l.length=0;for(var h=0,d=u.length;h<d;h++){var f=u[h],_=i.getFromPool(),v=f.functionName,p=_.handlers;_.event=f,p.length=0;for(var g=c-1;g>=0;g--){var m=o.get(g)[v];m&&p.push(m)}l.push(_)}},a._clearCrossData=function(e){e.crossCurveMark++,this._crossCurveDataCollection.length=0,this._crossCurveDataPool.resetPool()},a._addCrossCurveData=function(e,r,i,o){var c=this._crossCurveDataPool.getFromPool();c.curveOwner=r,c.srcCurveIndex=i,c.destCurveIndex=o,e.push(c)},a._prepareCrossFading=function(e){var r=this._crossCurveDataCollection,i=e.crossCurveMark;this._prepareSrcCrossData(r,e.srcPlayData,i,!1),this._prepareDestCrossData(r,e.destPlayData,i,!1)},a._prepareStandbyCrossFading=function(e){var r=this._crossCurveDataCollection,i=e.srcPlayData,o=e.crossCurveMark;i&&this._prepareSrcCrossData(r,i,o,!0),this._prepareDestCrossData(r,e.destPlayData,o,!0)},a._prepareFixedPoseCrossFading=function(e){for(var r=this._crossCurveDataCollection,i=r.length-1;i>=0;i--){var o=r[i];o.curveOwner.saveFixedPoseValue(),o.destCurveIndex=-1}this._prepareDestCrossData(r,e.destPlayData,e.crossCurveMark,!0)},a._prepareSrcCrossData=function(e,r,i,o){for(var c=r.stateData.curveOwners,l=c.length-1;l>=0;l--){var u=c[l];u.crossCurveMark=i,u.crossCurveIndex=e.length,o&&u.saveFixedPoseValue(),this._addCrossCurveData(e,u,l,-1)}},a._prepareDestCrossData=function(e,r,i,o){for(var c=r.stateData.curveOwners,l=c.length-1;l>=0;l--){var u=c[l];u.crossCurveMark===i?e[u.crossCurveIndex].destCurveIndex=l:(u.saveDefaultValue(),o&&u.saveFixedPoseValue(),u.crossCurveMark=i,u.crossCurveIndex=e.length,this._addCrossCurveData(e,u,-1,l))}},a._evaluateCurve=function(e,r,i,o){var c=r.evaluate(i);if(o){var l=r.keys[0].value;switch(e){case ie.Position:var u=s._tempVector3;return x.subtract(c,l,u),u;case ie.Rotation:var h=s._tempQuaternion;return he.conjugate(l,h),he.multiply(h,c,h),h;case ie.Scale:var d=s._tempVector3;return x.divide(c,l,d),d}}return c},a._getAnimatorLayerData=function(e){var r=this._animatorLayersData[e];return r||(this._animatorLayersData[e]=r=new Wu),r},a._updateLayer=function(e,r,i){var o=this._animatorController.layers[e],c=o.blendingMode,l=o.weight,u=this._animatorLayersData[e],h=u.srcPlayData,d=u.destPlayData,f=u.crossFadeTransition,_=c===Ni.Additive,v=r?1:l;switch(this._checkTransition(h,f,e),u.layerState){case Me.Playing:this._updatePlayingState(h,u,e,v,i,_);break;case Me.FixedCrossFading:this._updateCrossFadeFromPose(d,u,e,v,i,_);break;case Me.CrossFading:this._updateCrossFade(h,d,u,e,v,i,_);break}},a._updatePlayingState=function(e,r,i,o,c,l){var u=e.stateData,h=u.curveOwners,d=u.eventHandlers,f=e.state,_=e.playState,v=e.clipTime,p=f.clip._curveBindings;e.update();var g=e.clipTime,m=e.playState;d.length&&this._fireAnimationEvents(e,d,v,g),_===Xe.UnStarted&&this._callAnimatorScriptOnEnter(f,i),m===Xe.Finished?this._callAnimatorScriptOnExit(f,i):this._callAnimatorScriptOnUpdate(f,i);for(var y=p.length-1;y>=0;y--){var w=h[y],P=this._evaluateCurve(w.property,p[y].curve,g,l);l?this._applyClipValueAdditive(w,P,o):this._applyClipValue(w,P,o)}e.frameTime+=f.speed*c,m===Xe.Finished&&(r.layerState=Me.Standby)},a._updateCrossFade=function(e,r,i,o,c,l,u){var h=this._crossCurveDataCollection,d=e.state.clip._curveBindings,f=e.state,_=e.stateData,v=e.playState,p=_.eventHandlers,g=r.state,m=r.stateData,y=r.playState,w=m.eventHandlers,P=g.clip._curveBindings,A=e.clipTime,b=r.clipTime,M=r.frameTime/(g._getDuration()*i.crossFadeTransition.duration);M>=1&&(M=1),e.update(),r.update();var S=e.playState,T=r.playState;this._updateCrossFadeData(i,M,l,!1);var z=e.clipTime,R=r.clipTime;p.length&&this._fireAnimationEvents(e,p,A,z),w.length&&this._fireAnimationEvents(r,w,b,R),v===Xe.UnStarted&&this._callAnimatorScriptOnEnter(f,o),M===1||S===Xe.Finished?this._callAnimatorScriptOnExit(f,o):this._callAnimatorScriptOnUpdate(f,o),y===Xe.UnStarted&&this._callAnimatorScriptOnEnter(g,o),T===Xe.Finished?this._callAnimatorScriptOnExit(g,o):this._callAnimatorScriptOnUpdate(g,o);for(var E=h.length-1;E>=0;E--){var N=h[E],D=N.curveOwner,V=N.srcCurveIndex,U=N.destCurveIndex,G=D.property,O=D.defaultValue,K=V>=0?this._evaluateCurve(G,d[V].curve,z,u):O,ee=U>=0?this._evaluateCurve(G,P[U].curve,R,u):O;this._applyCrossClipValue(D,K,ee,M,c,u)}},a._updateCrossFadeFromPose=function(e,r,i,o,c,l){var u=this._crossCurveDataCollection,h=e.state,d=e.stateData,f=e.playState,_=d.eventHandlers,v=h.clip._curveBindings,p=e.clipTime,g=e.frameTime/(h._getDuration()*r.crossFadeTransition.duration);g>=1&&(g=1),e.update();var m=e.playState;this._updateCrossFadeData(r,g,c,!0);var y=e.clipTime;_.length&&this._fireAnimationEvents(e,_,p,y),f===Xe.UnStarted&&this._callAnimatorScriptOnEnter(h,i),m===Xe.Finished?this._callAnimatorScriptOnExit(h,i):this._callAnimatorScriptOnUpdate(h,i);for(var w=u.length-1;w>=0;w--){var P=u[w],A=P.curveOwner,b=P.destCurveIndex,M=b>=0?this._evaluateCurve(A.property,v[b].curve,y,l):A.defaultValue;this._applyCrossClipValue(A,A.fixedPoseValue,M,g,o,l)}},a._updateCrossFadeData=function(e,r,i,o){var c=e.destPlayData;c.frameTime+=c.state.speed*i,r===1?(c.playState===Xe.Finished?e.layerState=Me.Standby:e.layerState=Me.Playing,e.switchPlayData()):o||(e.srcPlayData.frameTime+=e.srcPlayData.state.speed*i)},a._applyCrossClipValue=function(e,r,i,o,c,l){var u;if(e.type===Rt){var h=e.target.transform;switch(e.property){case ie.Position:x.lerp(r,i,o,s._tempVector3),u=s._tempVector3;break;case ie.Rotation:he.slerp(r,i,o,s._tempQuaternion),u=s._tempQuaternion;break;case ie.Scale:{var d=h.scale;x.lerp(r,i,o,s._tempVector3),h.scale=d,u=s._tempVector3;break}}}else if(e.type===ci)switch(e.property){case ie.BlendShapeWeights:e.component.blendShapeWeights=u;break}l?this._applyClipValueAdditive(e,u,c):this._applyClipValue(e,u,c)},a._applyClipValue=function(e,r,i){if(e.type===Rt){var o=e.target.transform;switch(e.property){case ie.Position:if(i===1)o.position=r;else{var c=o.position;x.lerp(c,r,i,c),o.position=c}break;case ie.Rotation:if(i===1)o.rotationQuaternion=r;else{var l=o.rotationQuaternion;he.slerp(l,r,i,l),o.rotationQuaternion=l}break;case ie.Scale:if(i===1)o.scale=r;else{var u=o.scale;x.lerp(u,r,i,u),o.scale=u}break}}else if(e.type===ci)switch(e.property){case ie.BlendShapeWeights:e.component.blendShapeWeights=r;break}},a._applyClipValueAdditive=function(e,r,i){if(e.type===Rt){var o=e.target.transform;switch(e.property){case ie.Position:var c=o.position;c.x+=r.x*i,c.y+=r.y*i,c.z+=r.z*i,o.position=c;break;case ie.Rotation:var l=o.rotationQuaternion;Fi.quaternionWeight(r,i,r),r.normalize(),l.multiply(r),o.rotationQuaternion=l;break;case ie.Scale:var u=o.scale;Fi.scaleWeight(u,i,u),x.multiply(u,r,u),o.scale=u;break}}},a._revertDefaultValue=function(e,r){var i=e.clip;if(i)for(var o=i._curveBindings,c=r.curveOwners,l=o.length-1;l>=0;l--){var u=c[l],h=u.target.transform;if(!!u._hasSavedDefaultValue)switch(u.property){case ie.Position:h.position=u.defaultValue;break;case ie.Rotation:h.rotationQuaternion=u.defaultValue;break;case ie.Scale:h.scale=u.defaultValue;break;case ie.BlendShapeWeights:for(var d=u.component,f=d.blendShapeWeights,_=0,v=f.length;_<v;++_)u.component.blendShapeWeights[_]=u.defaultValue[_];break}}},a._checkTransition=function(e,r,i){for(var o=e.state,c=e.clipTime,l=o._getDuration(),u=o.transitions,h=0,d=u.length;h<d;++h){var f=u[h];l*f.exitTime<=c&&r!==f&&this._crossFadeByTransition(f,i)}},a._crossFadeByTransition=function(e,r){var i=e.destinationState.name,o=this._getAnimatorStateInfo(i,r,s._animatorInfo),c=o.state;if(!!c){if(!c.clip){console.warn("The state named "+i+" has no AnimationClip data.");return}var l=this._getAnimatorLayerData(o.layerIndex),u=l.layerState,h=l.destPlayData,d=this._getAnimatorStateData(i,c,l),f=c._getDuration(),_=f*e.offset;switch(h.reset(c,d,_),u){case Me.Standby:l.layerState=Me.FixedCrossFading,this._clearCrossData(l),this._prepareStandbyCrossFading(l);break;case Me.Playing:l.layerState=Me.CrossFading,this._clearCrossData(l),this._prepareCrossFading(l);break;case Me.CrossFading:l.layerState=Me.FixedCrossFading,this._prepareFixedPoseCrossFading(l);break;case Me.FixedCrossFading:this._prepareFixedPoseCrossFading(l);break}l.crossFadeTransition=e}},a._fireAnimationEvents=function(e,r,i,o){var c=e.state,l=c.clip.length;o<i?(this._fireSubAnimationEvents(e,r,i,c.clipEndTime*l),e.currentEventIndex=0,this._fireSubAnimationEvents(e,r,c.clipStartTime*l,o)):this._fireSubAnimationEvents(e,r,i,o)},a._fireSubAnimationEvents=function(e,r,i,o){for(var c=e.currentEventIndex,l=r.length;c<l;c++){var u=r[c],h=u.event,d=h.time,f=h.parameter;if(d>o)break;var _=u.handlers;if(d>=i){for(var v=_.length-1;v>=0;v--)_[v](f);e.currentEventIndex=c+1}}},a._callAnimatorScriptOnEnter=function(e,r){for(var i=e._onStateEnterScripts,o=0,c=i.length;o<c;o++)i[o].onStateEnter(this,e,r)},a._callAnimatorScriptOnUpdate=function(e,r){for(var i=e._onStateUpdateScripts,o=0,c=i.length;o<c;o++)i[o].onStateUpdate(this,e,r)},a._callAnimatorScriptOnExit=function(e,r){for(var i=e._onStateExitScripts,o=0,c=i.length;o<c;o++)i[o].onStateExit(this,e,r)},a._clearPlayData=function(){this._animatorLayersData.length=0,this._crossCurveDataCollection.length=0,this._animationCurveOwners.length=0,this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},W(s,[{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),s}(dt),Kr._tempVector3=new x,Kr._tempQuaternion=new he,Kr._animatorInfo=new Xu,Kr),uo=F(Lt.prototype,"_speed",[Tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ho=F(Lt.prototype,"_controllerUpdateFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fo=F(Lt.prototype,"_animatorLayersData",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_o=F(Lt.prototype,"_crossCurveDataCollection",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vo=F(Lt.prototype,"_animationCurveOwners",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),po=F(Lt.prototype,"_crossCurveDataPool",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ur(Ku)}}),go=F(Lt.prototype,"_animationEventHandlerPool",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ur(Hu)}}),Lt),Vs=function(){function n(){this._updateFlagManager=new ui,this._layers=[],this._layersMap={}}var s=n.prototype;return s.findLayerByName=function(t){return this._layersMap[t]},s.addLayer=function(t){this._layers.push(t),this._layersMap[t.name]=t,this._distributeUpdateFlag()},s.removeLayer=function(t){var e=this.layers[t];this._layers.splice(t,1),delete this._layersMap[e.name],this._distributeUpdateFlag()},s.clearLayers=function(){this._layers.length=0;for(var t in this._layersMap)delete this._layersMap[t];this._distributeUpdateFlag()},s._registerChangeFlag=function(){return this._updateFlagManager.register()},s._distributeUpdateFlag=function(){this._updateFlagManager.distribute()},W(n,[{key:"layers",get:function(){return this._layers}}]),n}(),sn=function(s){this.name=s,this.weight=1,this.blendingMode=Ni.Override,this.stateMachine=void 0},mo=function(){function n(){this._destroyed=!1,this._state=void 0}var s=n.prototype;return s.onStateEnter=function(t,e,r){},s.onStateUpdate=function(t,e,r){},s.onStateExit=function(t,e,r){},s.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},n}(),qu=function(){function n(a){this.name=a,this.speed=1,this.wrapMode=Ui.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._clipStartTime=0,this._clipEndTime=1,this._clip=void 0,this._transitions=[]}var s=n.prototype;return s.addTransition=function(t){this._transitions.push(t)},s.removeTransition=function(t){var e=this._transitions.indexOf(t);e!==-1&&this._transitions.splice(e,1)},s.addStateMachineScript=function(t){var e=new t;e._state=this;var r=mo.prototype;return e.onStateEnter!==r.onStateEnter&&this._onStateEnterScripts.push(e),e.onStateUpdate!==r.onStateUpdate&&this._onStateUpdateScripts.push(e),e.onStateExit!==r.onStateExit&&this._onStateExitScripts.push(e),e},s.clearTransitions=function(){this._transitions.length=0},s._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},s._removeStateMachineScript=function(t){var e=mo.prototype;if(t.onStateEnter!==e.onStateEnter){var r=this._onStateEnterScripts.indexOf(t);r!==-1&&this._onStateEnterScripts.splice(r,1)}if(t.onStateUpdate!==e.onStateUpdate){var i=this._onStateUpdateScripts.indexOf(t);i!==-1&&this._onStateUpdateScripts.splice(i,1)}if(t.onStateExit!==e.onStateExit){var o=this._onStateExitScripts.indexOf(t);o!==-1&&this._onStateExitScripts.splice(o,1)}},W(n,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(t){this._clip=t,this._clipEndTime=Math.min(this._clipEndTime,1)}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(t){this._clipStartTime=Math.max(t,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(t){this._clipEndTime=Math.min(t,1)}}]),n}(),cn=function(){function n(){this.states=[],this._statesMap={}}var s=n.prototype;return s.addState=function(t){var e=this.findStateByName(t);return e?console.warn("The state named "+t+" has existed."):(e=new qu(t),this.states.push(e),this._statesMap[t]=e),e},s.removeState=function(t){var e=t.name,r=this.states.indexOf(t);r>-1&&this.states.splice(r,1),delete this._statesMap[e]},s.findStateByName=function(t){return this._statesMap[t]},s.makeUniqueStateName=function(t){for(var e=this._statesMap,r=t,i=0;e[t];)t=r+" "+i,i++;return t},n}(),me;(function(n){n[n.Float=0]="Float",n[n.FloatArray=1]="FloatArray",n[n.Vector2=2]="Vector2",n[n.Vector3=3]="Vector3",n[n.Vector4=4]="Vector4",n[n.Quaternion=5]="Quaternion"})(me||(me={}));var Vt;(function(n){n[n.Linear=0]="Linear",n[n.CubicSpine=1]="CubicSpine",n[n.Step=2]="Step",n[n.Hermite=3]="Hermite"})(Vt||(Vt={}));var Qu=function(){function n(){this.keys=[],this.interpolation=void 0,this._valueSize=void 0,this._valueType=void 0,this._currentValue=void 0,this._length=0,this._currentIndex=0}var s=n.prototype;return s.addKey=function(t){var e=t.time;if(this.keys.push(t),e>this._length&&(this._length=e),!this._valueSize&&(typeof t.value=="number"&&(this._valueSize=1,this._valueType=me.Float,this._currentValue=0),t.value instanceof k&&(this._valueSize=2,this._valueType=me.Vector2,this._currentValue=new k),t.value instanceof x&&(this._valueSize=3,this._valueType=me.Vector3,this._currentValue=new x),t.value instanceof ve&&(this._valueSize=4,this._valueType=me.Vector4,this._currentValue=new ve),t.value instanceof he&&(this._valueSize=4,this._valueType=me.Quaternion,this._currentValue=new he),t.value instanceof Float32Array)){var r=t.value.length;this._valueSize=r,this._valueType=me.FloatArray,this._currentValue=new Float32Array(r)}this.keys.sort(function(i,o){return i.time-o.time})},s.evaluate=function(t){var e=this.keys,r=this.interpolation,i=this.keys.length,o=this._currentIndex;o!==-1&&t<e[o].time&&(o=-1);for(var c=o+1;c<i&&!(t<e[c].time);)o++,c++;this._currentIndex=o;var l;if(o===-1)l=e[0].value;else if(c===i)l=e[o].value;else{var u=e[o].time,h=e[c].time-u,d=(t-u)/h,f=h;switch(r){case Vt.Linear:l=this._evaluateLinear(o,c,d);break;case Vt.Step:l=this._evaluateStep(c);break;case Vt.CubicSpine:case Vt.Hermite:l=this._evaluateHermite(o,c,d,f)}}return l},s.moveKey=function(t,e){this.keys[t]=e},s.removeKey=function(t){this.keys.splice(t,1);for(var e=this.keys,r=this.keys.length,i=0,o=r-1;o>=0;o--)e[o].time>length&&(i=e[o].time);this._length=i},s._evaluateLinear=function(t,e,r){var i=this._valueType,o=this.keys;switch(i){case me.Float:return o[t].value*(1-r)+o[e].value*r;case me.FloatArray:for(var c=this._currentValue,l=o[t].value,u=o[e].value,h=0,d=l.length;h<d;h++)c[h]=l[h]*(1-r)+u[h]*r;return c;case me.Vector2:return k.lerp(o[t].value,o[e].value,r,this._currentValue),this._currentValue;case me.Vector3:return x.lerp(o[t].value,o[e].value,r,this._currentValue),this._currentValue;case me.Quaternion:return he.slerp(o[t].value,o[e].value,r,this._currentValue),this._currentValue}},s._evaluateStep=function(t){var e=this._valueSize,r=this.keys;return r[t].value},s._evaluateHermite=function(t,e,r,i){var o=this._valueSize,c=this.keys,l=c[t],u=c[e];switch(o){case 1:{var h=l.outTangent,d=u.inTangent,f=l.value,_=u.value;if(Number.isFinite(h)&&Number.isFinite(d)){var v=r*r,p=v*r,g=2*p-3*v+1,m=p-2*v+r,y=p-v,w=-2*p+3*v;return g*f+m*h*i+y*d*i+w*_}else return l.value}case 2:{var P=l.value,A=l.outTangent,b=u.value,M=u.inTangent,S=r*r,T=S*r,z=2*T-3*S+1,R=T-2*S+r,E=T-S,N=-2*T+3*S,D=A.x,V=M.x;return Number.isFinite(D)&&Number.isFinite(V)?this._currentValue.x=z*P.x+R*D*i+E*V*i+N*b.x:this._currentValue.x=P.x,D=A.y,V=M.y,Number.isFinite(D)&&Number.isFinite(V)?this._currentValue.y=z*P.y+R*D*i+E*V*i+N*b.y:this._currentValue.y=P.y,this._currentValue}case 3:{var U=l.value,G=l.outTangent,O=u.value,K=u.inTangent,ee=r*r,re=ee*r,Z=2*re-3*ee+1,se=re-2*ee+r,de=re-ee,_e=-2*re+3*ee,le=G.x,Pe=K.x;return Number.isFinite(le)&&Number.isFinite(Pe)?this._currentValue.x=Z*U.x+se*le*i+de*Pe*i+_e*O.x:this._currentValue.x=U.x,le=G.y,Pe=K.y,Number.isFinite(le)&&Number.isFinite(Pe)?this._currentValue.y=Z*U.y+se*le*i+de*Pe*i+_e*O.y:this._currentValue.y=U.y,le=G.z,Pe=K.z,Number.isFinite(le)&&Number.isFinite(Pe)?this._currentValue.z=Z*U.z+se*le*i+de*Pe*i+_e*O.z:this._currentValue.z=U.z,this._currentValue}case 4:{var Oe=l.value,ze=l.outTangent,Ze=u.value,Le=u.inTangent,ke=r*r,Ee=ke*r,Ke=2*Ee-3*ke+1,He=Ee-2*ke+r,qe=Ee-ke,Ie=-2*Ee+3*ke,xe=ze.x,ge=Le.x;return Number.isFinite(xe)&&Number.isFinite(ge)?this._currentValue.x=Ke*Oe.x+He*xe*i+qe*ge*i+Ie*Ze.x:this._currentValue.x=Oe.x,xe=ze.y,ge=Le.y,Number.isFinite(xe)&&Number.isFinite(ge)?this._currentValue.y=Ke*Oe.y+He*xe*i+qe*ge*i+Ie*Ze.y:this._currentValue.y=Oe.y,xe=ze.z,ge=Le.z,Number.isFinite(xe)&&Number.isFinite(ge)?this._currentValue.z=Ke*Oe.z+He*xe*i+qe*ge*i+Ie*Ze.z:this._currentValue.z=Oe.z,xe=ze.w,ge=Le.w,Number.isFinite(xe)&&Number.isFinite(ge)?this._currentValue.w=Ke*Oe.w+He*xe*i+qe*ge*i+Ie*Ze.w:this._currentValue.w=Oe.w,this._currentValue}}},W(n,[{key:"length",get:function(){return this._length}}]),n}(),Yu=function(){this.time=void 0,this.value=void 0},Dr=function(n){X(s,n);function s(){for(var a,t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return a=n.call.apply(n,[this].concat(e))||this,a.inTangent=void 0,a.outTangent=void 0,a}return s}(Yu),yo;(function(n){n[n.If=0]="If",n[n.IfNot=1]="IfNot",n[n.Greater=2]="Greater",n[n.Less=3]="Less",n[n.Equals=4]="Equals",n[n.NotEquals=5]="NotEquals"})(yo||(yo={}));var $u=function(n){X(s,n);function s(a){var t;return t=n.call(this,a,C.find("skybox"))||this,t._decodeParam=new ve(0,5,0,0),t.renderState.rasterState.cullMode=ct.Off,t.renderState.depthState.compareFunction=fe.LessEqual,t.shaderData.setVector4("u_cubeDecodeParam",t._decodeParam),t}return W(s,[{key:"textureDecodeRGBM",get:function(){return Boolean(this._decodeParam.x)},set:function(t){this._decodeParam.x=Number(t)}},{key:"RGBMDecodeFactor",get:function(){return this._decodeParam.y},set:function(t){this._decodeParam.y=t}},{key:"textureCubeMap",get:function(){return this.shaderData.getTexture("u_cube")},set:function(t){this.shaderData.setTexture("u_cube",t)}}]),s}(nr),ne;(function(n){n[n.Position=1]="Position",n[n.Velocity=2]="Velocity",n[n.Acceleration=4]="Acceleration",n[n.Color=8]="Color",n[n.Alpha=16]="Alpha",n[n.Size=32]="Size",n[n.StartAngle=64]="StartAngle",n[n.StartTime=128]="StartTime",n[n.LifeTime=256]="LifeTime",n[n.RotateVelocity=512]="RotateVelocity",n[n.Scale=1024]="Scale",n[n.Everything=4294967295]="Everything"})(ne||(ne={}));var Zr;(function(n){n[n.Transparent=0]="Transparent",n[n.Additive=1]="Additive"})(Zr||(Zr={}));var Gs=function(n){X(s,n),s._getRandom=function(){return Math.random()-.5};function s(t){var e;return e=n.call(this,t)||this,e._vertexStride=void 0,e._vertices=void 0,e._vertexBuffer=void 0,e._maxCount=1e3,e._position=new x,e._positionRandomness=new x,e._positionArray=void 0,e._velocity=new x,e._velocityRandomness=new x,e._acceleration=new x,e._accelerationRandomness=new x,e._color=new Q(1,1,1,1),e._colorRandomness=0,e._size=1,e._sizeRandomness=0,e._alpha=1,e._alphaRandomness=0,e._startAngle=0,e._startAngleRandomness=0,e._rotateVelocity=0,e._rotateVelocityRandomness=0,e._lifetime=5,e._startTimeRandomness=0,e._scale=1,e._isOnce=!1,e._onceTime=0,e._time=0,e._isInit=!1,e._isStart=!1,e._updateDirtyFlag=ne.Everything,e._isRotateToVelocity=!1,e._isUseOriginColor=!1,e._isScaleByLifetime=!1,e._is2d=!0,e._isFadeIn=!1,e._isFadeOut=!1,e._playOnEnable=!0,e._blendMode=Zr.Transparent,e.spriteSheet=void 0,e.setMaterial(e._createMaterial()),e}var a=s.prototype;return a.update=function(e){if(!(!this._isInit||!this._isStart)){if(this._isOnce&&this._time>this._onceTime)return this.stop();this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time)}},a._onEnable=function(){n.prototype._onEnable.call(this),this._playOnEnable&&this.start()},a.start=function(){this._isStart=!0,this._time=0},a.stop=function(){this._isStart=!1},a._createMaterial=function(){var e=new nr(this.engine,C.find("particle-shader")),r=e.renderState,i=r.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=J.SourceAlpha,i.destinationColorBlendFactor=J.OneMinusSourceAlpha,i.sourceAlphaBlendFactor=J.One,i.destinationAlphaBlendFactor=J.OneMinusSourceAlpha,r.depthState.writeEnabled=!1,e.renderQueueType=Be.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,e},a._createMesh=function(){var e=new Os(this._entity.engine,"particleMesh"),r=96,i=this._maxCount*4,o=i*r,c=new Float32Array(o),l=null,u=!1;if(i>s._uint16VertexLimit)if(this.engine._hardwareRenderer.canIUse(Ve.elementIndexUint))u=!0,l=new Uint32Array(6*this._maxCount);else throw Error("The vertex count is over limit.");else l=new Uint16Array(6*this._maxCount);for(var h=0,d=0;h<this._maxCount;++h){var f=h*4;l[d++]=f,l[d++]=f+1,l[d++]=f+2,l[d++]=f,l[d++]=f+2,l[d++]=f+3}var _=[new ue("a_position",0,H.Vector3,0),new ue("a_velocity",12,H.Vector3,0),new ue("a_acceleration",24,H.Vector3,0),new ue("a_color",36,H.Vector4,0),new ue("a_lifeAndSize",52,H.Vector4,0),new ue("a_rotation",68,H.Vector2,0),new ue("a_uv",76,H.Vector3,0),new ue("a_normalizedUv",88,H.Vector2,0)],v=new Vr(this.engine,kt.VertexBuffer,o*4,lt.Dynamic),p=new Vr(this.engine,kt.IndexBuffer,l,lt.Dynamic);return e.setVertexBufferBinding(v,r),e.setIndexBufferBinding(p,u?De.UInt32:De.UInt16),e.setVertexElements(_),e.addSubMesh(0,l.length),this._vertexBuffer=v,this._vertexStride=r/4,this._vertices=c,e},a._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},a._updateSingleBuffer=function(e){var r=this._updateDirtyFlag,i=this._vertices,o=this._vertexStride,c=s._getRandom,l=e*4,u=l*o,h=(l+1)*o,d=(l+2)*o,f=(l+3)*o;if(r&ne.Position){var _=this._position,v=_.x,p=_.y,g=_.z,m=this._positionArray,y=this._positionRandomness;if(m){if(m.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var w=m[e];v+=w.x,p+=w.y,g+=w.z}else v+=c()*y.x,p+=c()*y.y,g+=c()*y.z;i[u]=i[h]=i[d]=i[f]=v,i[u+1]=i[h+1]=i[d+1]=i[f+1]=p,i[u+2]=i[h+2]=i[d+2]=i[f+2]=g}if(r&ne.Velocity){var P=this._velocity,A=this._velocityRandomness;i[u+3]=i[h+3]=i[d+3]=i[f+3]=P.x+c()*A.x,i[u+4]=i[h+4]=i[d+4]=i[f+4]=P.y+c()*A.y,i[u+5]=i[h+5]=i[d+5]=i[f+5]=P.z+c()*A.z}if(r&ne.Acceleration){var b=this._acceleration,M=this._accelerationRandomness;i[u+6]=i[h+6]=i[d+6]=i[f+6]=b.x+c()*M.x,i[u+7]=i[h+7]=i[d+7]=i[f+7]=b.y+c()*M.y,i[u+8]=i[h+8]=i[d+8]=i[f+8]=b.z+c()*M.z}if(r&ne.Color){var S=this._color,T=this._colorRandomness;i[u+9]=i[h+9]=i[d+9]=i[f+9]=L.clamp(S.r+c()*T,0,1),i[u+10]=i[h+10]=i[d+10]=i[f+10]=L.clamp(S.g+c()*T,0,1),i[u+11]=i[h+11]=i[d+11]=i[f+11]=L.clamp(S.b+c()*T,0,1)}if(r&ne.Alpha&&(i[u+12]=i[h+12]=i[d+12]=i[f+12]=L.clamp(this._alpha+c()*this._alphaRandomness,0,1)),r&ne.StartTime&&(i[u+13]=i[h+13]=i[d+13]=i[f+13]=Math.random()*this._startTimeRandomness),r&ne.LifeTime){var z=this._lifetime;i[u+14]=i[h+14]=i[d+14]=i[f+14]=z+c()*z}if((r&ne.StartTime||r&ne.LifeTime)&&(this._onceTime=Math.max(this._onceTime,i[u+13]+i[u+14])),r&ne.Size){var R=this._size;i[u+15]=i[h+15]=i[d+15]=i[f+15]=Math.max(R+c()*this._sizeRandomness*R*2,0)}r&ne.Scale&&(i[u+16]=i[h+16]=i[d+16]=i[f+16]=this._scale),r&ne.StartAngle&&(i[u+17]=i[h+17]=i[d+17]=i[f+17]=this._startAngle+c()*Math.PI*this._startAngleRandomness*2),r&ne.RotateVelocity&&(i[u+18]=i[h+18]=i[d+18]=i[f+18]=this._rotateVelocity+c()*this._rotateVelocityRandomness),this._updateSingleUv(e,u,h,d,f)},a._updateSingleUv=function(e,r,i,o,c){var l=this.spriteSheet,u=this.getMaterial().shaderData.getTexture("u_texture"),h=this._vertices;if(u){var d=u.width,f=u.height;if(l){var _=l[e%l.length],v=_.x,p=_.y,g=_.w,m=_.h,y=v/d,w=p/f,P=y+g/d,A=w+m/f,b=m/g;h[r+19]=y,h[r+20]=A,h[r+21]=b,h[i+19]=P,h[i+20]=A,h[i+21]=b,h[o+19]=P,h[o+20]=w,h[o+21]=b,h[c+19]=y,h[c+20]=w,h[c+21]=b}else{var M=f/d;h[r+19]=0,h[r+20]=1,h[r+21]=M,h[i+19]=1,h[i+20]=1,h[i+21]=M,h[o+19]=1,h[o+20]=0,h[o+21]=M,h[c+19]=0,h[c+20]=0,h[c+21]=M}}else h[r+19]=0,h[r+20]=0,h[r+21]=1,h[i+19]=1,h[i+20]=0,h[i+21]=1,h[o+19]=1,h[o+20]=1,h[o+21]=1,h[c+19]=0,h[c+20]=1,h[c+21]=1;h[r+22]=-.5,h[r+23]=-.5,h[i+22]=.5,h[i+23]=-.5,h[o+22]=.5,h[o+23]=.5,h[c+22]=-.5,h[c+23]=.5},W(s,[{key:"texture",get:function(){return this.getMaterial().shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.getMaterial().shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=ne.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=ne.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=ne.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=ne.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=ne.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=ne.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=ne.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._updateDirtyFlag|=ne.Color,this._color=e}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=ne.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=ne.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=ne.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=ne.Alpha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=ne.Alpha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=ne.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=ne.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=ne.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=ne.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=ne.LifeTime,this._lifetime=e,this._onceTime=0}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=ne.StartTime,this._startTimeRandomness=e,this._onceTime=0}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=ne.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=ne.Everything,this.mesh=this._createMesh(),this._updateBuffer(),this._isInit=!0,this.shaderData.setFloat("u_time",0)}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(e){e?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.getMaterial().renderState.rasterState.cullMode=ct.Off),this._is2d=e}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){var r=this.getMaterial().renderState.blendState,i=r.targetBlendState;e===Zr.Transparent?(i.enabled=!0,i.sourceColorBlendFactor=J.SourceAlpha,i.destinationColorBlendFactor=J.OneMinusSourceAlpha,i.sourceAlphaBlendFactor=J.One,i.destinationAlphaBlendFactor=J.OneMinusSourceAlpha):e===Zr.Additive&&(i.enabled=!0,i.sourceColorBlendFactor=J.SourceAlpha,i.destinationColorBlendFactor=J.One,i.sourceAlphaBlendFactor=J.One,i.destinationAlphaBlendFactor=J.OneMinusSourceAlpha),this._blendMode=e}}]),s}(di);Gs._uint16VertexLimit=65535;var Ju=`#define GLSLIFY 1
varying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}`,Zu=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`;C.create("trail",Zu,Ju);new x;var eh=function(n){X(s,n);function s(t){var e;return e=n.call(this,t)||this,e._color=new Q(1,0,0,1),e.color=e._color,e}var a=s.prototype;return a._onEnable=function(){this.scene.shaderData.enableMacro("O3_HAS_FOG")},a._onDisable=function(){this.scene.shaderData.disableMacro("O3_HAS_FOG")},W(s,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(s._colorProperty,e)}}]),s}(dt);eh._colorProperty=C.getPropertyByName("u_fogColor");C.getPropertyByName("u_fogDensity");C.getPropertyByName("u_fogNear");C.getPropertyByName("u_fogFar");new x;new x;new x;var Te=function(){n._updateShaderData=function(t){var e=n._combinedData;t.setFloatArray(n._viewMatFromLightProperty,e.viewMatrix),t.setFloatArray(n._projMatFromLightProperty,e.projectionMatrix),t.setFloatArray(n._shadowBiasProperty,e.bias),t.setFloatArray(n._shadowIntensityProperty,e.intensity),t.setFloatArray(n._shadowRadiusProperty,e.radius),t.setFloatArray(n._shadowMapSizeProperty,e.mapSize),t.setTextureArray(n._shadowMapsProperty,e.map)},n.clearMap=function(){n._combinedData.map.length=0};function n(a,t){t===void 0&&(t={engine:null,width:512,height:512}),this._mapSize=void 0,this._renderTarget=void 0,this.light=void 0,this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new j,this.light=a;var e=t,r=e.engine,i=e.width,o=e.height;this._mapSize=new k(i,o),this._renderTarget=new ql(r,i,o,new Ql(r,i,o))}var s=n.prototype;return s.initShadowProjectionMatrix=function(t){if(t instanceof Ht&&j.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),t instanceof Wt&&j.perspective(L.degreeToRadian(50),1,.5,50,this.projectionMatrix),t instanceof ut){var e=Math.min(Math.PI/2,t.angle*2*Math.sqrt(2));j.perspective(e,1,.1,t.distance+5,this.projectionMatrix)}},s.appendData=function(t){var e=t*16,r=t*16,i=t,o=t,c=t,l=t*2,u=t,h=n._combinedData;h.viewMatrix.set(this.light.viewMatrix.elements,e),h.projectionMatrix.set(this.projectionMatrix.elements,r),h.bias[i]=this.bias,h.intensity[o]=this.intensity,h.radius[c]=this.radius,h.mapSize[l]=this.mapSize.x,h.mapSize[l+1]=this.mapSize.y,h.map[u]=this.map},W(n,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),n}();Te._viewMatFromLightProperty=C.getPropertyByName("u_viewMatFromLight");Te._projMatFromLightProperty=C.getPropertyByName("u_projMatFromLight");Te._shadowBiasProperty=C.getPropertyByName("u_shadowBias");Te._shadowIntensityProperty=C.getPropertyByName("u_shadowIntensity");Te._shadowRadiusProperty=C.getPropertyByName("u_shadowRadius");Te._shadowMapSizeProperty=C.getPropertyByName("u_shadowMapSize");Te._shadowMapsProperty=C.getPropertyByName("u_shadowMaps");Te._maxLight=3;Te._combinedData={viewMatrix:new Float32Array(16*Te._maxLight),projectionMatrix:new Float32Array(16*Te._maxLight),bias:new Float32Array(Te._maxLight),intensity:new Float32Array(Te._maxLight),radius:new Float32Array(Te._maxLight),mapSize:new Float32Array(2*Te._maxLight),map:[]};Object.defineProperty(Ge.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(s){if(this._enableShadow=s,this._enableShadow){if(this instanceof it){this._enableShadow=!1;return}this.shadow=this.shadow||new Te(this,{engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}});Object.defineProperty(dt.prototype,"receiveShadow",{get:function(){return this._recieveShadow},set:function(s){this._recieveShadow=s}});Object.defineProperty(dt.prototype,"castShadow",{get:function(){return this._castShadow},set:function(s){this._castShadow=s}});var th=function(n){X(s,n);function s(a){var t;return t=n.call(this,a,C.find("shadow-map"))||this,t.shaderData.enableMacro("O3_GENERATE_SHADOW_MAP"),t}return s}(nr),gn=function(n){X(s,n);function s(t,e,r,i,o,c){var l;return l=n.call(this,t,e,r,i,o)||this,l.light=void 0,l.light=c,l.clearColor=new Q(1,1,1,1),l}var a=s.prototype;return a.preRender=function(e,r){var i=this.replaceMaterial.shaderData;i.setMatrix(s._viewMatFromLightProperty,this.light.viewMatrix),i.setMatrix(s._projMatFromLightProperty,this.light.shadow.projectionMatrix)},s}(Ir);gn._viewMatFromLightProperty=C.getPropertyByName("u_viewMatFromLight");gn._projMatFromLightProperty=C.getPropertyByName("u_projMatFromLight");var rh=function(n){X(s,n);function s(a){var t;t=n.call(this,a,C.find("shadow"))||this;var e=t.renderState.blendState.targetBlendState;return e.enabled=!0,e.sourceColorBlendFactor=e.sourceAlphaBlendFactor=J.DestinationColor,e.destinationColorBlendFactor=e.destinationAlphaBlendFactor=J.Zero,t.renderState.depthState.compareFunction=fe.LessEqual,t.renderQueueType=Be.Transparent,t}return s}(nr),ih=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.clearFlags=xr.None,t}var a=s.prototype;return a.preRender=function(e,r){this.enabled=!1;var i=e.scene.findFeature(br),o=i.visibleLights,c=this.replaceMaterial.shaderData,l=e._renderPipeline.defaultRenderPass;this.renderTarget=l.renderTarget;var u=0;Te.clearMap();for(var h=0,d=o.length;h<d;h++){var f=o[h];f.enableShadow&&f.shadow.appendData(u++)}u?(this.enabled=!0,Te._updateShaderData(c),c.enableMacro("O3_SHADOW_MAP_COUNT",u.toString())):c.disableMacro("O3_SHADOW_MAP_COUNT")},s}(Ir),nh=function(n){X(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t._shadowPass=void 0,t._shadowMapMaterial=void 0,t}var a=s.prototype;return a.preRender=function(e,r){var i=e.findFeature(br).visibleLights;if(i.length>0){this._shadowPass||this.addShadowPass(r);for(var o=r._renderPipeline,c=0,l=i.length;c<l;c++){var u=i[c];u.enableShadow&&!u.shadowMapPass?u.shadowMapPass=this.addShadowMapPass(r,u):!u.enableShadow&&u.shadowMapPass&&(o.removeRenderPass(u.shadowMapPass),u.shadowMapPass=null)}this.updatePassRenderFlag(o._opaqueQueue),this.updatePassRenderFlag(o._alphaTestQueue),this.updatePassRenderFlag(o._transparentQueue)}},a.addShadowPass=function(e){var r=new rh(e.engine);this._shadowPass=new ih("ShadowPass",1,null,r,ot.Layer30);var i=e._renderPipeline;i.addRenderPass(this._shadowPass)},a.addShadowMapPass=function(e,r){this._shadowMapMaterial=this._shadowMapMaterial||new th(e.engine);var i=new gn("ShadowMapPass",-1,r.shadow.renderTarget,this._shadowMapMaterial,ot.Layer31,r),o=e._renderPipeline;return o.addRenderPass(i),i},a.updatePassRenderFlag=function(e){for(var r=e.items,i=0,o=r.length;i<o;i++){var c=r[i],l=c.component,u=l.recieveShadow,h=l.castShadow;u===!0?l.entity.layer|=ot.Layer30:u===!1&&(l.entity.layer&=~ot.Layer30),h===!0?l.entity.layer|=ot.Layer31:h===!1&&(l.entity.layer&=~ot.Layer31)}},s}(Ls);yr.registerFeature(nh);yr.registerFeature(br);yr.prototype.hasLight=nu;var oe;(function(n){n[n.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",n[n.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",n[n.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",n[n.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",n[n.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",n[n.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",n[n.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",n[n.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",n[n.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",n[n.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",n[n.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",n[n.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",n[n.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",n[n.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",n[n.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",n[n.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",n[n.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",n[n.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",n[n.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",n[n.R11_EAC=37488]="R11_EAC",n[n.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",n[n.RG11_EAC=37490]="RG11_EAC",n[n.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",n[n.RGB8_ETC2=37492]="RGB8_ETC2",n[n.SRGB8_ETC2=37493]="SRGB8_ETC2",n[n.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",n[n.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",n[n.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",n[n.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",n[n.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",n[n.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",n[n.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",n[n.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT"})(oe||(oe={}));function xo(n,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function ah(n,s,a){return s&&xo(n.prototype,s),a&&xo(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}var oh=function(){n._isPowerOf2=function(t){return(t&t-1)===0},n._getFormatDetail=function(t,e,r){switch(t){case Y.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case Y.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case Y.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case Y.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case Y.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case Y.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case Y.LuminanceAlpha:return{internalFormat:e.LUMINANCE_ALPHA,baseFormat:e.LUMINANCE_ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case Y.R32G32B32A32:return{internalFormat:e.RGBA32F,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};case Y.DXT1:return{internalFormat:oe.RGB_S3TC_DXT1_EXT,isCompressed:!0};case Y.DXT5:return{internalFormat:oe.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case Y.ETC1_RGB:return{internalFormat:oe.RGB_ETC1_WEBGL,isCompressed:!0};case Y.ETC2_RGB:return{internalFormat:oe.RGB8_ETC2,isCompressed:!0};case Y.ETC2_RGBA5:return{internalFormat:oe.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case Y.ETC2_RGBA8:return{internalFormat:oe.RGBA8_ETC2_EAC,isCompressed:!0};case Y.PVRTC_RGB2:return{internalFormat:oe.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case Y.PVRTC_RGBA2:return{internalFormat:oe.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case Y.PVRTC_RGB4:return{internalFormat:oe.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case Y.PVRTC_RGBA4:return{internalFormat:oe.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case Y.ASTC_4x4:return{internalFormat:oe.RGBA_ASTC_4X4_KHR,isCompressed:!0};case Y.ASTC_5x5:return{internalFormat:oe.RGBA_ASTC_5X5_KHR,isCompressed:!0};case Y.ASTC_6x6:return{internalFormat:oe.RGBA_ASTC_6X6_KHR,isCompressed:!0};case Y.ASTC_8x8:return{internalFormat:oe.RGBA_ASTC_8X8_KHR,isCompressed:!0};case Y.ASTC_10x10:return{internalFormat:oe.RGBA_ASTC_10X10_KHR,isCompressed:!0};case Y.ASTC_12x12:return{internalFormat:oe.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},n._getRenderBufferColorFormatDetail=function(t,e,r){switch(t){case et.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case et.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case et.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case et.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case et.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case et.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case et.R16G16B16A16:return{internalFormat:e.RGBA16F,baseFormat:e.RGBA,dataType:e.HALF_FLOAT,isCompressed:!1};case et.R32G32B32A32:return{internalFormat:e.RGBA32F,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};default:throw new Error("this RenderBufferColorFormat is not supported in Oasis Engine: "+t)}},n._getRenderBufferDepthFormatDetail=function(t,e,r){switch(t){case Ue.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case Ue.DepthStencil:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case Ue.Stencil:return{internalFormat:e.STENCIL_INDEX8,baseFormat:e.STENCIL_ATTACHMENT,dataType:e.UNSIGNED_BYTE,isCompressed:!1,attachment:e.STENCIL_ATTACHMENT};case Ue.Depth16:return{internalFormat:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case Ue.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case Ue.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case Ue.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case Ue.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this RenderBufferDepthFormat is not supported in Oasis Engine: "+t)}},n._supportTextureFormat=function(t,e){var r=!0;switch(t){case Y.R32G32B32A32:e.canIUse(Ve.textureFloat)||(r=!1);break}return r},n._supportRenderBufferColorFormat=function(t,e){var r=!0;switch(t){case et.R32G32B32A32:(!e.canIUse(Ve.colorBufferFloat)||!e.canIUse(Ve.textureFloat))&&(r=!1);break;case et.R16G16B16A16:(!e.canIUse(Ve.colorBufferHalfFloat)||!e.canIUse(Ve.textureHalfFloat))&&(r=!1);break}return r},n._supportRenderBufferDepthFormat=function(t,e,r){var i=e.isWebGL2,o=!0;if(r&&!e.canIUse(Ve.depthTexture))return!1;switch(t){case Ue.Stencil:o=!1;break;case Ue.Depth24:case Ue.Depth32:case Ue.Depth32Stencil8:i||(o=!1);break}return o};function n(a,t,e){this._texture=void 0,this._glTexture=void 0,this._rhi=void 0,this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._formatDetail=void 0,this._texture=t,this._rhi=a,this._gl=a.gl,this._isWebGL2=a.isWebGL2,this._target=e,this._glTexture=this._gl.createTexture()}var s=n.prototype;return s.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},s.generateMipmaps=function(){this._bind(),this._gl.generateMipmap(this._target)},s._bind=function(){this._rhi.bindTexture(this)},s._initMipmap=function(t){var e=this._gl,r=this._isWebGL2,i=this._formatDetail,o=i.internalFormat,c=i.baseFormat,l=i.dataType,u=this._texture,h=u.mipmapCount,d=u.width,f=u.height;if(this._bind(),r&&!(c===e.LUMINANCE_ALPHA||c===e.ALPHA))e.texStorage2D(this._target,h,o,d,f);else if(c!==o&&(o=c),t)for(var g=0;g<h;g++)for(var m=Math.max(1,d>>g),y=0;y<6;y++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+y,g,o,m,m,0,c,l,null);else for(var _=0;_<h;_++){var v=Math.max(1,d>>_),p=Math.max(1,f>>_);e.texImage2D(this._target,_,o,v,p,0,c,l,null)}},s._getPixelBuffer=function(t,e,r,i,o,c,l){var u=this._gl,h=this._formatDetail,d=h.baseFormat,f=h.dataType;n._readFrameBuffer||(n._readFrameBuffer=u.createFramebuffer()),u.bindFramebuffer(u.FRAMEBUFFER,n._readFrameBuffer),c>0&&!this._isWebGL2&&(c=0),t!=null?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+t,this._glTexture,c):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,this._glTexture,c),u.readPixels(e,r,i,o,d,f,l),u.bindFramebuffer(u.FRAMEBUFFER,null)},s._setWrapMode=function(t,e){var r=this._gl,i=this._isWebGL2,o=this._target,c=this._texture,l=c.width,u=c.height;switch(!i&&t!==Ye.Clamp&&(!n._isPowerOf2(l)||!n._isPowerOf2(u))&&(t=Ye.Clamp),t){case Ye.Clamp:r.texParameteri(o,e,r.CLAMP_TO_EDGE);break;case Ye.Repeat:r.texParameteri(o,e,r.REPEAT);break;case Ye.Mirror:r.texParameteri(o,e,r.MIRRORED_REPEAT);break}},ah(n,[{key:"wrapModeU",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(t){var e=this._gl,r=this._target,i=this._texture._mipmap;switch(this._bind(),t){case mt.Point:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(r,e.TEXTURE_MIN_FILTER,i?e.NEAREST_MIPMAP_NEAREST:e.NEAREST);break;case mt.Bilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,i?e.LINEAR_MIPMAP_NEAREST:e.LINEAR);break;case mt.Trilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,i?e.LINEAR_MIPMAP_LINEAR:e.LINEAR);break}}},{key:"anisoLevel",set:function(t){var e=this._gl;this._bind(),e.texParameterf(this._target,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}}]),n}();oh._readFrameBuffer=null;var wo;(function(n){n[n.Auto=0]="Auto",n[n.WebGL2=1]="WebGL2",n[n.WebGL1=2]="WebGL1"})(wo||(wo={}));function bo(n,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function sh(n,s,a){return s&&bo(n.prototype,s),a&&bo(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}var ch=function(){function n(a,t){var e=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(a),this._worker.onmessage=function(r){var i=r.data;switch(i.type){case"decode":e._callbacks[i.id].resolve(i.geometry);break;case"error":e._callbacks[i.id].reject(i);break;default:ht.error('DRACOWorker: Unexpected message, "'+i.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var s=n.prototype;return s.setCosts=function(t,e){this._costs[t]=e},s.addCurrentLoad=function(t){this._currentLoad+=t},s.setCallback=function(t,e,r){this._callbacks[t]={resolve:e,reject:r}},s.decode=function(t,e,r){this._worker.postMessage({type:"decode",id:t,taskConfig:e,buffer:r},[r])},s.releaseTask=function(t){this._currentLoad-=this._costs[t],delete this._callbacks[t],delete this._costs[t]},sh(n,[{key:"currentLoad",get:function(){return this._currentLoad}}]),n}(),Po=`let decoderPending;
let decoderConfig;

onmessage = function(e) {
  const message = e.data;

  switch (message.type) {
    case "init":
      decoderConfig = message.decoderConfig;
      decoderPending = new Promise(function(resolve /*, reject*/) {
        decoderConfig.onModuleLoaded = function(draco) {
          // Module is Promise-like. Wrap before resolving to avoid loop.
          resolve({ draco: draco });
        };
        DracoDecoderModule(decoderConfig);
      });
      break;

    case "decode":
      const buffer = message.buffer;
      const taskConfig = message.taskConfig;
      decoderPending.then(module => {
        const draco = module.draco;
        const decoder = new draco.Decoder();
        const decoderBuffer = new draco.DecoderBuffer();
        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);
        try {
          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);
          const buffers = geometry.attributes.map(attr => attr.array.buffer);
          if (geometry.index) buffers.push(geometry.index.array.buffer);
          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);
        } catch (error) {
          console.error(error);
          self.postMessage({ type: "error", id: message.id, error: error.message });
        } finally {
          draco.destroy(decoderBuffer);
          draco.destroy(decoder);
        }
      });
      break;
  }
};

function decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {
  const attributeIDs = taskConfig.attributeIDs;
  const attributeTypes = taskConfig.attributeTypes;

  let dracoGeometry;
  let decodingStatus;

  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);
  if (geometryType === draco.TRIANGULAR_MESH) {
    dracoGeometry = new draco.Mesh();
    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);
  } else {
    throw new Error("DRACODecoder worker: Unexpected geometry type.");
  }

  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {
    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());
  }

  const geometry = { index: null, attributes: [] };

  // Gather all vertex attributes.
  for (let attributeName in attributeIDs) {
    const attributeType = self[attributeTypes[attributeName]];

    let attribute;
    let attributeID;

    // A Draco file may be created with default vertex attributes, whose attribute IDs
    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,
    // a Draco file may contain a custom set of attributes, identified by known unique
    // IDs. glTF files always do the latter, and .drc files typically do the former.
    if (taskConfig.useUniqueIDs) {
      attributeID = attributeIDs[attributeName];
      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);
    } else {
      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);
      if (attributeID === -1) continue;
      attribute = decoder.GetAttribute(dracoGeometry, attributeID);
    }
    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));
  }
  // Add index.
  if (geometryType === draco.TRIANGULAR_MESH) {
    // Generate mesh faces.
    const numFaces = dracoGeometry.num_faces();
    const numIndices = numFaces * 3;
    let dataSize;
    let ptr;
    let index;
    const indexType = self[taskConfig.indexType];

    switch (indexType) {
      case Uint16Array:
        dataSize = numIndices * 2;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);
        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      case Uint32Array:
        dataSize = numIndices * 4;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);
        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      default:
        throw new Error("DRACODecoder: Unexpected index type.");
    }
    geometry.index = { array: index, itemSize: 1 };
  }
  draco.destroy(dracoGeometry);
  return geometry;
}

function decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {
  const numComponents = attribute.num_components();
  const numPoints = dracoGeometry.num_points();
  const numValues = numPoints * numComponents;
  let ptr;
  let array;
  let dataSize;
  switch (attributeType) {
    case Float32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);
      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);
      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);
      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);
      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);
      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);
      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);
      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    default:
      throw new Error("DRACODecoder: Unexpected attribute type.");
  }

  return {
    name: attributeName,
    array: array,
    itemSize: numComponents
  };
}
`,Ji="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",lh="draco_decoder_gltf.js",uh="draco_decoder_gltf.r3bin",hh="draco_wasm_wrapper_gltf.js",dh=function(){function n(a){if(a===void 0&&(a={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,a.workerLimit>this.workerLimit)ht.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+a.workerLimit);else{var t;this.workerLimit=(t=a.workerLimit)!=null?t:4}this.useJS=typeof WebAssembly!="object"||a.type==="js",this.loadLibPromise=this.preloadLib()}var s=n.prototype;return s.preloadLib=function(){var t=this;return this.loadLibPromise?this.loadLibPromise:new Promise(function(e,r){t.useJS?Ri(""+Ji+lh,{type:"text"}).then(function(i){var o=[i,Po].join(`
`),c=URL.createObjectURL(new Blob([o]));e({workerSourceURL:c,decoderWASMBinary:null})}).catch(function(i){r(i)}):Promise.all([Ri(""+Ji+hh,{type:"text"}),Ri(""+Ji+uh,{type:"arraybuffer"})]).then(function(i){var o=i[0],c=i[1],l=[o,Po].join(`
`),u=URL.createObjectURL(new Blob([l]));e({workerSourceURL:u,decoderWASMBinary:c})}).catch(function(i){r(i)})})},s.getWorker=function(){var t=this;return this.preloadLib().then(function(e){if(t.pool.length<t.workerLimit){var r=new ch(e.workerSourceURL,e.decoderWASMBinary);t.pool.push(r)}else t.pool.sort(function(i,o){return i.currentLoad>o.currentLoad?-1:1});return t.pool[t.pool.length-1]})},s.decode=function(t,e){var r=this,i=JSON.stringify(e);if(this.taskCache.has(t)){var o=this.taskCache.get(t);if(o.key===i)return o.promise;if(t.byteLength===0)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var c=this.currentTaskId++,l=t.byteLength,u,h=new Promise(function(d,f){r.getWorker().then(function(_){u=_,_.setCosts(c,l),_.addCurrentLoad(l),_.setCallback(c,d,f),_.decode(c,e,t)}).catch(function(_){f(_)})});return h.finally(function(){u&&c&&u.releaseTask(c)}),this.taskCache.set(t,{key:i,promise:h}),h},n}();function So(n,s){var a=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);s&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),a.push.apply(a,t)}return a}function Re(n){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?So(Object(a),!0).forEach(function(t){fh(n,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):So(Object(a)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(a,t))})}return n}function Ao(n,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function _i(n,s,a){return s&&Ao(n.prototype,s),a&&Ao(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}function fh(n,s,a){return s in n?Object.defineProperty(n,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[s]=a,n}function ln(){return ln=Object.assign||function(n){for(var s=1;s<arguments.length;s++){var a=arguments[s];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(n[t]=a[t])}return n},ln.apply(this,arguments)}function te(n,s){n.prototype=Object.create(s.prototype),n.prototype.constructor=n,un(n,s)}function un(n,s){return un=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},un(n,s)}function qr(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function _h(n,s){if(!!n){if(typeof n=="string")return Mo(n,s);var a=Object.prototype.toString.call(n).slice(8,-1);if(a==="Object"&&n.constructor&&(a=n.constructor.name),a==="Map"||a==="Set")return Array.from(n);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Mo(n,s)}}function Mo(n,s){(s==null||s>n.length)&&(s=n.length);for(var a=0,t=new Array(s);a<s;a++)t[a]=n[a];return t}function vh(n,s){var a=typeof Symbol!="undefined"&&n[Symbol.iterator]||n["@@iterator"];if(a)return(a=a.call(n)).next.bind(a);if(Array.isArray(n)||(a=_h(n))||s&&n&&typeof n.length=="number"){a&&(n=a);var t=0;return function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function zt(n,s,a,t,e){var r={};return Object.keys(t).forEach(function(i){r[i]=t[i]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=a.slice().reverse().reduce(function(i,o){return o(n,s,i)||i},r),e&&r.initializer!==void 0&&(r.value=r.initializer?r.initializer.call(e):void 0,r.initializer=void 0),r.initializer===void 0&&(Object.defineProperty(n,s,r),r=null),r}var Co,To;function ph(n){return/^data:(.+?);base64,/.test(n)}Co=jt(pe.Buffer,["bin","r3bin"],!1),Co(To=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e){var r=e.url;return ph(r)?new tt(function(i){var o=r.slice(13+RegExp.$1.length),c=Uint8Array.from(atob(o),function(l){return l.charCodeAt(0)});i(c.buffer)}):this.request(r,Re(Re({},e),{},{type:"arraybuffer"}))},s}(Xt));var Ne;(function(n){n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT",n[n.FLOAT=5126]="FLOAT"})(Ne||(Ne={}));var Ct;(function(n){n.SCALAR="SCALAR",n.VEC2="VEC2",n.VEC3="VEC3",n.VEC4="VEC4",n.MAT2="MAT2",n.MAT3="MAT3",n.MAT4="MAT4"})(Ct||(Ct={}));var Fr;(function(n){n.TRANSLATION="translation",n.ROTATION="rotation",n.SCALE="scale",n.WEIGHTS="weights"})(Fr||(Fr={}));var Nr;(function(n){n.Linear="LINEAR",n.Step="STEP",n.CubicSpine="CUBICSPLINE"})(Nr||(Nr={}));var Vi;(function(n){n.PERSPECTIVE="perspective",n.ORTHOGRAPHIC="orthographic"})(Vi||(Vi={}));var Ro;(function(n){n.JPEG="image/jpeg",n.PNG="image/png"})(Ro||(Ro={}));var ei;(function(n){n.OPAQUE="OPAQUE",n.MASK="MASK",n.BLEND="BLEND"})(ei||(ei={}));var zo;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR"})(zo||(zo={}));var Eo;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR",n[n.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",n[n.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",n[n.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",n[n.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Eo||(Eo={}));var Bo;(function(n){n[n.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",n[n.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",n[n.REPEAT=10497]="REPEAT"})(Bo||(Bo={}));var ce=function(){function n(){}return n.floatBufferToVector2Array=function(a){for(var t=a.length,e=new Array(t/2),r=0;r<t;r+=2)e[r/2]=new k(a[r],a[r+1]);return e},n.floatBufferToVector3Array=function(a){for(var t=a.length,e=new Array(t/3),r=0;r<t;r+=3)e[r/3]=new x(a[r],a[r+1],a[r+2]);return e},n.floatBufferToVector4Array=function(a){for(var t=a.length,e=new Array(t/4),r=0;r<t;r+=4)e[r/4]=new ve(a[r],a[r+1],a[r+2],a[r+3]);return e},n.floatBufferToColorArray=function(a,t){var e=a.length,r=new Array(e/(t?3:4));if(t)for(var i=0;i<e;i+=3)r[i/3]=new Q(a[i],a[i+1],a[i+2],1);else for(var o=0;o<e;o+=4)r[o/4]=new Q(a[o],a[o+1],a[o+2],a[o+3]);return r},n.decodeText=function(a){if(typeof TextDecoder!="undefined")return new TextDecoder().decode(a);for(var t="",e=0,r=a.length;e<r;e++)t+=String.fromCharCode(a[e]);return decodeURIComponent(encodeURIComponent(t))},n.getAccessorTypeSize=function(a){switch(a){case Ct.SCALAR:return 1;case Ct.VEC2:return 2;case Ct.VEC3:return 3;case Ct.VEC4:return 4;case Ct.MAT2:return 4;case Ct.MAT3:return 9;case Ct.MAT4:return 16}},n.getComponentType=function(a){switch(a){case Ne.BYTE:return Int8Array;case Ne.UNSIGNED_BYTE:return Uint8Array;case Ne.SHORT:return Int16Array;case Ne.UNSIGNED_SHORT:return Uint16Array;case Ne.UNSIGNED_INT:return Uint32Array;case Ne.FLOAT:return Float32Array}},n.getAccessorData=function(a,t,e){var r,i=a.bufferViews,o=i[t.bufferView],c=e[o.buffer],l=t.hasOwnProperty("byteOffset")?t.byteOffset:0,u=o.hasOwnProperty("byteOffset")?o.byteOffset:0,h=l+u,d=n.getAccessorTypeSize(t.type),f=d*t.count,_=(r=o.byteStride)!=null?r:0,v=n.getComponentType(t.componentType),p;if(_){var g=d*v.BYTES_PER_ELEMENT;p=new Uint8Array(t.count*g);for(var m=new Uint8Array(c,u,o.byteLength),y=0;y<t.count;y++)for(var w=0;w<g;w++)p[y*g+w]=m[y*_+l+w]}else p=new Uint8Array(c.slice(h,h+f*v.BYTES_PER_ELEMENT));var P=new v(p.buffer);if(t.sparse)for(var A,b,M,S,T=t.sparse,z=T.count,R=T.indices,E=T.values,N=i[R.bufferView],D=i[E.bufferView],V=e[N.buffer],U=e[D.buffer],G=((A=R.byteOffset)!=null?A:0)+((b=N.byteOffset)!=null?b:0),O=N.byteLength,K=((M=E.byteOffset)!=null?M:0)+((S=D.byteOffset)!=null?S:0),ee=D.byteLength,re=n.getComponentType(R.componentType),Z=new re(V,G,O/re.BYTES_PER_ELEMENT),se=new v(U,K,ee/v.BYTES_PER_ELEMENT),de=0;de<z;de++)for(var _e=Z[de],le=0;le<d;le++)P[_e*d+le]=se[de*d+le];return P},n.getBufferViewData=function(a,t){var e=a.buffer,r=a.byteOffset,i=r===void 0?0:r,o=a.byteLength,c=t[e];return c.slice(i,i+o)},n.getVertexStride=function(a,t){var e,r=a.bufferViews[(e=t.bufferView)!=null?e:0].byteStride;if(r)return r;var i=n.getAccessorTypeSize(t.type),o=n.getComponentType(t.componentType);return i*o.BYTES_PER_ELEMENT},n.createVertexElement=function(a,t,e){var r=n.getAccessorTypeSize(t.type);return new ue(a,0,n.getElementFormat(t.componentType,r,t.normalized),e)},n.getIndexFormat=function(a){switch(a){case Ne.UNSIGNED_BYTE:return De.UInt8;case Ne.UNSIGNED_SHORT:return De.UInt16;case Ne.UNSIGNED_INT:return De.UInt32}},n.getElementFormat=function(a,t,e){if(e===void 0&&(e=!1),a==Ne.FLOAT)switch(t){case 1:return H.Float;case 2:return H.Vector2;case 3:return H.Vector3;case 4:return H.Vector4}if(a==Ne.SHORT)switch(t){case 2:return e?H.NormalizedShort2:H.Short2;case 3:case 4:return e?H.NormalizedShort4:H.Short4}if(a==Ne.UNSIGNED_SHORT)switch(t){case 2:return e?H.NormalizedUShort2:H.UShort2;case 3:case 4:return e?H.NormalizedUShort4:H.UShort4}if(a==Ne.BYTE)switch(t){case 2:case 3:case 4:return e?H.NormalizedByte4:H.Byte4}if(a==Ne.UNSIGNED_BYTE)switch(t){case 2:case 3:case 4:return e?H.NormalizedUByte4:H.UByte4}},n.loadImageBuffer=function(a,t){return new Promise(function(e,r){var i=new window.Blob([a],{type:t}),o=new Image;o.src=URL.createObjectURL(i),o.crossOrigin="anonymous",o.onerror=function(){r(new Error("Failed to load image buffer"))},o.onload=function(){requestAnimationFrame(function(){e(o),o.onload=null,o.onerror=null,o.onabort=null})}})},n.isAbsoluteUrl=function(a){return/^(?:http|blob|data:|\/)/.test(a)},n.parseRelativeUrl=function(a,t){if(n.isAbsoluteUrl(t))return t;var e=t.charAt(0);return e==="."?n._formatRelativePath(t+t):a.substring(0,a.lastIndexOf("/")+1)+t},n.parseGLB=function(a){var t=4,e=1179937895,r=12,i={JSON:1313821514,BIN:5130562},o=new DataView(a),c={magic:o.getUint32(0,!0),version:o.getUint32(t,!0),length:o.getUint32(2*t,!0)};if(c.magic!==e)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+c.magic.toString(16)),null;var l=o.getUint32(r,!0),u=o.getUint32(r+t,!0);if(u!==i.JSON)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+u.toString(16)),null;for(var h=new Uint8Array(a,r+2*t,l),d=JSON.parse(n.decodeText(h)),f=[],_=r+2*t+l;_<c.length;){if(l=o.getUint32(_,!0),u=o.getUint32(_+t,!0),u!==i.BIN)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+u.toString(16)),null;var v=_+2*t,p=a.slice(v,v+l);f.push(p),_+=l+2*t}return{gltf:d,buffers:f}},n._formatRelativePath=function(a){for(var t=a.split("/"),e=0,r=t.length;e<r;e++)t[e]==".."&&(t.splice(e-1,2),e-=2);return t.join("/")},n}(),be=function(){function n(){}return n.parseEngineResource=function(a,t,e,r){var i=n._extensionParsers[a];if(i!=null&&i.length){for(var o=arguments.length,c=new Array(o>4?o-4:0),l=4;l<o;l++)c[l-4]=arguments[l];for(var u=0;u<i.length;u++){var h;(h=i[u]).parseEngineResource.apply(h,[t,e,r].concat(c))}}},n.createEngineResource=function(a,t,e){var r=n._extensionParsers[a];if(r!=null&&r.length){for(var i,o=arguments.length,c=new Array(o>3?o-3:0),l=3;l<o;l++)c[l-3]=arguments[l];return(i=r[0]).createEngineResource.apply(i,[t,e].concat(c))}},n.hasExtensionParser=function(a){var t=n._extensionParsers[a];return!!(t!=null&&t.length)},n.initialize=function(a){var t=n._extensionParsers[a];if(t!=null&&t.length)for(var e=0;e<t.length;e++)t[e].initialize()},n._addExtensionParser=function(a,t){n._extensionParsers[a]||(n._extensionParsers[a]=[]),n._extensionParsers[a].push(t)},n}();be._extensionParsers={};function Mr(n){return function(s){var a=new s;be._addExtensionParser(n,a)}}var gh=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.gltf,i=e.buffers,o=e.entities,c=r.animations,l=r.accessors;if(!!c){for(var u=c.length,h=new Array(u),d=new Array(u),f=0;f<u;f++){for(var _=c[f],v=_.channels,p=_.samplers,g=_.name,m=g===void 0?"AnimationClip"+f:g,y=new Gu(m),w=new Array,P=0;P<p.length;P++){var A,b=p[P],M=l[b.input],S=l[b.output],T=ce.getAccessorData(r,M,i),z=ce.getAccessorData(r,S,i),R=z.length/T.length,E=(A=b.interpolation)!=null?A:Nr.Linear,N=void 0;switch(E){case Nr.CubicSpine:N=Vt.CubicSpine;break;case Nr.Step:N=Vt.Step;break;case Nr.Linear:N=Vt.Linear;break}T[T.length-1],w.push({type:S.type,interpolation:N,input:T,output:z,outputSize:R})}for(var D=0;D<v.length;D++){for(var V=v[D],U=V.target,G=o[U.node],O="",K=G;K.parent;)O=O===""?""+K.name:K.name+"/"+O,K=K.parent;var ee=void 0,re=void 0,Z=void 0;switch(U.path){case Fr.TRANSLATION:ee=Rt,re="position",Z=me.Vector3;break;case Fr.ROTATION:ee=Rt,re="rotation",Z=me.Quaternion;break;case Fr.SCALE:ee=Rt,re="scale",Z=me.Vector3;break;case Fr.WEIGHTS:ee=ci,re="blendShapeWeights",Z=me.FloatArray;break}var se=this._addCurve(Z,V,w);y.addCurveBinding(O,ee,re,se)}h[f]=y,d[f]={name:m,index:f}}e.animations=h,e._animationsIndices=d}},a._addCurve=function(e,r,i){var o=new Qu,c=i[r.sampler],l=c.input,u=c.output,h=c.outputSize;o.interpolation=c.interpolation;for(var d=0,f=l.length;d<f;d++){var _=d*h;if(e===me.Float){var v=new Dr;v.time=l[d],v.inTangent=0,v.outTangent=0,v.value=u[_],o.addKey(v)}else if(e===me.FloatArray){var p=new Dr;p.time=l[d],p.inTangent=new Float32Array(h),p.outTangent=new Float32Array(h),p.value=u.subarray(_,_+h),o.addKey(p)}else if(e===me.Vector2){var g=new Dr;g.time=l[d],g.value=new k(u[_],u[_+1]),g.inTangent=new k,g.outTangent=new k,o.addKey(g)}else if(e===me.Vector3){var m=new Dr;m.time=l[d],m.value=new x(u[_],u[_+1],u[_+2]),m.inTangent=new x,m.outTangent=new x,o.addKey(m)}else if(e===me.Vector4){var y=new Dr;y.time=l[d],y.value=new ve(u[_],u[_+1],u[_+2],u[_+3]),y.inTangent=new ve,y.outTangent=new ve,o.addKey(y)}else if(e===me.Quaternion){var w=new Dr;w.time=l[d],w.value=new he(u[_],u[_+1],u[_+2],u[_+3]),w.inTangent=new ve,w.outTangent=new ve,o.addKey(w)}}return o},s}(be),mh=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.url,i=e.engine;return this._isGLB(r)?i.resourceManager.load({url:r,type:pe.Buffer}).then(ce.parseGLB).then(function(o){var c=o.gltf,l=o.buffers;e.gltf=c,e.buffers=l}):i.resourceManager.load({url:r,type:pe.JSON}).then(function(o){return e.gltf=o,Promise.all(o.buffers.map(function(c){return i.resourceManager.load({type:pe.Buffer,url:ce.parseRelativeUrl(r,c.uri)})})).then(function(c){e.buffers=c})})},a._isGLB=function(e){return e.substring(e.lastIndexOf(".")+1)==="glb"},s}(be),ks=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.engine,i=e.gltf.nodes;if(!!i){for(var o=[],c=0;c<i.length;c++){var l=i[c],u=l.matrix,h=l.translation,d=l.rotation,f=l.scale,_=new Ut(r,l.name||""+s._defaultName+c),v=_.transform;if(u){var p=v.localMatrix;p.setValueByArray(u),v.localMatrix=p}else h&&v.setPosition(h[0],h[1],h[2]),d&&v.setRotationQuaternion(d[0],d[1],d[2],d[3]),f&&v.setScale(f[0],f[1],f[2]);o[c]=_}e.entities=o,this._buildEntityTree(e),this._createSceneRoots(e)}},a._buildEntityTree=function(e){for(var r=e.gltf.nodes,i=e.entities,o=0;o<r.length;o++){var c=r[o].children,l=i[o];if(c)for(var u=0;u<c.length;u++){var h=i[c[u]];l.addChild(h)}}},a._createSceneRoots=function(e){var r=e.engine,i=e.gltf,o=i.scene,c=o===void 0?0:o,l=i.scenes,u=e.entities;if(!!l){for(var h=[],d=0;d<l.length;d++){var f=l[d].nodes;if(!!f)if(f.length===1)h[d]=u[f[0]];else{for(var _=new Ut(r,"GLTF_ROOT"),v=0;v<f.length;v++)_.addChild(u[f[v]]);h[d]=_}}e.sceneRoots=h,e.defaultSceneRoot=h[c]}},s}(be);ks._defaultName="_GLTF_ENTITY_";var hn=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}s._parseTextureTransform=function(e,r,i){r===void 0&&(r={});var o=r.KHR_texture_transform;o&&be.parseEngineResource("KHR_texture_transform",o,e,i)};var a=s.prototype;return a.parse=function(e){var r=e.gltf,i=e.engine,o=e.textures;if(!!r.materials){for(var c=[],l=0;l<r.materials.length;l++){var u=r.materials[l],h=u.extensions,d=h===void 0?{}:h,f=u.pbrMetallicRoughness,_=u.normalTexture,v=u.occlusionTexture,p=u.emissiveTexture,g=u.emissiveFactor,m=u.alphaMode,y=u.alphaCutoff,w=u.doubleSided,P=u.name,A=P===void 0?"":P,b=d.KHR_materials_unlit,M=d.KHR_materials_pbrSpecularGlossiness,S=null;if(b?S=be.createEngineResource("KHR_materials_unlit",b,e):M?S=be.createEngineResource("KHR_materials_pbrSpecularGlossiness",M,e):S=new Pr(i),S.name=A,f){var T=f.baseColorFactor,z=f.baseColorTexture,R=f.metallicFactor,E=f.roughnessFactor,N=f.metallicRoughnessTexture;if(T&&(S.baseColor=new Q(Q.linearToGammaSpace(T[0]),Q.linearToGammaSpace(T[1]),Q.linearToGammaSpace(T[2]),T[3])),z&&(S.baseTexture=o[z.index],s._parseTextureTransform(S,z.extensions,e)),!b&&!M){var D=S;D.metallic=R!=null?R:1,D.roughness=E!=null?E:1,N&&(D.roughnessMetallicTexture=o[N.index],s._parseTextureTransform(S,N.extensions,e))}}if(!b){var V=S;if(p&&(V.emissiveTexture=o[p.index],s._parseTextureTransform(S,p.extensions,e)),g&&(V.emissiveColor=new Q(Q.linearToGammaSpace(g[0]),Q.linearToGammaSpace(g[1]),Q.linearToGammaSpace(g[2]))),_){var U=_.index,G=_.scale;V.normalTexture=o[U],s._parseTextureTransform(S,_.extensions,e),G!==void 0&&(V.normalTextureIntensity=G)}if(v){var O=v.index,K=v.strength;V.occlusionTexture=o[O],s._parseTextureTransform(S,v.extensions,e),K!==void 0&&(V.occlusionTextureIntensity=K)}}switch(w?S.renderFace=ir.Double:S.renderFace=ir.Front,m){case ei.OPAQUE:S.isTransparent=!1;break;case ei.BLEND:S.isTransparent=!0;break;case ei.MASK:S.alphaCutoff=y!=null?y:.5;break}c[l]=S}e.materials=c}},s}(be),Hs=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=this,i=e.engine,o=e.gltf,c=e.buffers;if(!!o.meshes){for(var l=[],u=function(f){for(var _=o.meshes[f],v=[],p=function(y){var w=_.primitives[y],P=w.extensions,A=P===void 0?{}:P,b=A.KHR_draco_mesh_compression;v.push(new Promise(function(M){var S=new Ft(i,_.name||y+"");b?be.createEngineResource("KHR_draco_mesh_compression",b,e,w).then(function(T){return r._parseMeshFromGLTFPrimitive(S,_,w,o,function(z){for(var R=0;R<T.attributes.length;R++)if(T.attributes[R].name===z)return T.attributes[R].array;return null},function(z,R){throw"BlendShape animation is not supported when using draco."},function(){return T.index.array},i)}).then(M):r._parseMeshFromGLTFPrimitive(S,_,w,o,function(T){var z=w.attributes[T],R=o.accessors[z];return ce.getAccessorData(o,R,c)},function(T,z){var R=w.targets[z],E=R[T];if(E){var N=o.accessors[E];return ce.getAccessorData(o,N,c)}else return null},function(){var T=o.accessors[w.indices];return ce.getAccessorData(o,T,c)},i).then(M)}))},g=0;g<_.primitives.length;g++)p(g);l.push(Promise.all(v))},h=0;h<o.meshes.length;h++)u(h);return Promise.all(l).then(function(d){e.meshes=d})}},a._parseMeshFromGLTFPrimitive=function(e,r,i,o,c,l,u,h){var d=i.attributes,f=i.targets,_=i.indices,v=i.mode,p,g=o.accessors,m=g[d.POSITION],y=c("POSITION"),w=ce.floatBufferToVector3Array(y);e.setPositions(w);var P=e.bounds;if(p=m.count,m.min&&m.max)P.min.setValueByArray(m.min),P.max.setValueByArray(m.max);else{var A=s._tempVector3,b=P.min,M=P.max;b.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),M.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var S=y.length/p,T=0;T<p;T++){var z=T*S;A.setValueByArray(y,z),x.min(b,A,b),x.max(M,A,M)}}for(var R in d)if(R!=="POSITION"){var E=c(R);switch(R){case"NORMAL":var N=ce.floatBufferToVector3Array(E);e.setNormals(N);break;case"TEXCOORD_0":var D=ce.floatBufferToVector2Array(E);e.setUVs(D,0);break;case"TEXCOORD_1":var V=ce.floatBufferToVector2Array(E);e.setUVs(V,1);break;case"TEXCOORD_2":var U=ce.floatBufferToVector2Array(E);e.setUVs(U,2);break;case"TEXCOORD_3":var G=ce.floatBufferToVector2Array(E);e.setUVs(G,3);break;case"TEXCOORD_4":var O=ce.floatBufferToVector2Array(E);e.setUVs(O,4);break;case"TEXCOORD_5":var K=ce.floatBufferToVector2Array(E);e.setUVs(K,5);break;case"TEXCOORD_6":var ee=ce.floatBufferToVector2Array(E);e.setUVs(ee,6);break;case"TEXCOORD_7":var re=ce.floatBufferToVector2Array(E);e.setUVs(re,7);break;case"COLOR_0":var Z=ce.floatBufferToColorArray(E,g[d.COLOR_0].type===Ct.VEC3);e.setColors(Z);break;case"TANGENT":var se=ce.floatBufferToVector4Array(E);e.setTangents(se);break;case"JOINTS_0":var de=ce.floatBufferToVector4Array(E);e.setBoneIndices(de);break;case"WEIGHTS_0":var _e=ce.floatBufferToVector4Array(E);e.setBoneWeights(_e);break}}if(_!==void 0){var le=o.accessors[_],Pe=u();e.setIndices(Pe),e.addSubMesh(0,le.count,v)}else e.addSubMesh(0,p,v);return f&&this._createBlendShape(e,r,f,l),e.uploadData(!0),Promise.resolve(e)},a._createBlendShape=function(e,r,i,o){for(var c=r.extras?r.extras.targetNames:null,l=0,u=i.length;l<u;l++){var h=c?c[l]:"blendShape"+l,d=o("POSITION",l),f=o("NORMAL",l),_=o("TANGENT",l),v=d?ce.floatBufferToVector3Array(d):null,p=f?ce.floatBufferToVector3Array(f):null,g=_?ce.floatBufferToVector3Array(_):null,m=new Zl(h);m.addFrame(1,v,p,g),e.addBlendShape(m)}},s}(be);Hs._tempVector3=new x;var Ws=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}s._getDefaultMaterial=function(e){return s._defaultMaterial||(s._defaultMaterial=new $e(e)),s._defaultMaterial};var a=s.prototype;return a.parse=function(e){var r=e.gltf,i=r.nodes,o=r.cameras,c=e.entities;if(!!i){for(var l=0;l<i.length;l++){var u=i[l],h=u.camera,d=u.mesh,f=u.extensions,_=f===void 0?{}:f,v=_.KHR_lights_punctual,p=c[l];if(h!==void 0&&this._createCamera(e,o[h],p),d!==void 0&&this._createRenderer(e,u,p),v){var g=v.light,m=e.gltf.extensions.KHR_lights_punctual.lights;be.parseEngineResource("KHR_lights_punctual",m[g],p,e)}}e.defaultSceneRoot&&this._createAnimator(e)}},a._createCamera=function(e,r,i){var o=r.orthographic,c=r.perspective,l=r.type,u=i.addComponent(Fs);if(l===Vi.ORTHOGRAPHIC){var h=o.xmag,d=o.ymag,f=o.zfar,_=o.znear;u.isOrthographic=!0,_!==void 0&&(u.nearClipPlane=_),f!==void 0&&(u.farClipPlane=f),u.orthographicSize=Math.max(d!=null?d:0,h!=null?h:0)/2}else if(l===Vi.PERSPECTIVE){var v=c.aspectRatio,p=c.yfov,g=c.zfar,m=c.znear;v!==void 0&&(u.aspectRatio=v),p!==void 0&&(u.fieldOfView=p*180/Math.PI),g!==void 0&&(u.farClipPlane=g),m!==void 0&&(u.nearClipPlane=m)}e.cameras||(e.cameras=[]),e.cameras.push(u),u.enabled=!1},a._createRenderer=function(e,r,i){for(var o=e.engine,c=e.gltf.meshes,l=e.meshes,u=e.materials,h=e.skins,d=r.mesh,f=r.skin,_=c[d],v=_.primitives,p=r.weights||_.weights,g=0;g<v.length;g++){var m=l[d][g],y=void 0;if(f!==void 0||p){var w=i.addComponent(ci);w.mesh=m,f!==void 0&&(w.skin=h[f]),p&&(w.blendShapeWeights=new Float32Array(p)),y=w}else y=i.addComponent(di),y.mesh=m;var P=v[g].material,A=(u==null?void 0:u[P])||s._getDefaultMaterial(o);y.setMaterial(A);var b=v[g].extensions,M=b===void 0?{}:b,S=M.KHR_materials_variants;S&&be.parseEngineResource("KHR_materials_variants",S,y,e)}},a._createAnimator=function(e){var r=e.defaultSceneRoot,i=e.animations;if(!!i){var o=r.addComponent(pn),c=new Vs,l=new sn("layer"),u=new cn;if(c.addLayer(l),o.animatorController=c,l.stateMachine=u,i)for(var h=0;h<i.length;h++){var d=i[h],f=d.name,_=u.makeUniqueStateName(f);_!==f&&console.warn("AnimatorState name is existed, name: "+f+" reset to "+_);var v=u.addState(_);v.clip=d}}},s}(be);Ws._defaultMaterial=void 0;var yh=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.gltf,i=e.buffers,o=e.entities,c=e.defaultSceneRoot,l=r.skins;if(!!l){for(var u=[],h=0;h<l.length;h++){var d=l[h],f=d.inverseBindMatrices,_=d.skeleton,v=d.joints,p=d.name,g=p===void 0?"SKIN_"+h:p,m=v.length,y=new $l(g);y.inverseBindMatrices.length=m;for(var w=r.accessors[f],P=ce.getAccessorData(r,w,i),A=0;A<m;A++){var b=new j;b.setValueByArray(P,A*16),y.inverseBindMatrices[A]=b}for(var M=0;M<m;M++)y.joints[M]=o[v[M]].name;_!==void 0?y.skeleton=o[_].name:y.skeleton=c.name,u[h]=y}e.skins=u}},s}(be),js=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=this,i=e.gltf,o=e.buffers,c=e.engine,l=e.url;if(i.textures)return Promise.all(i.textures.map(function(u,h){var d=u.sampler,f=u.source,_=f===void 0?0:f,v=u.name,p=i.images[_],g=p.uri,m=p.bufferView,y=p.mimeType,w=p.name;if(g)return c.resourceManager.load({url:ce.parseRelativeUrl(l,g),type:pe.Texture2D}).then(function(b){return b.name||(b.name=v||w||"texture_"+h),d!==void 0&&r._parseSampler(b,i.samplers[d]),b});var P=i.bufferViews[m],A=ce.getBufferViewData(P,o);return ce.loadImageBuffer(A,y).then(function(b){var M=new Hr(c,b.width,b.height);return M.setImageSource(b),M.generateMipmaps(),M.name=v||w||"texture_"+h,d!==void 0&&r._parseSampler(M,i.samplers[d]),M})})).then(function(u){e.textures=u})},a._parseSampler=function(e,r){r.magFilter,r.minFilter;var i=r.wrapS,o=r.wrapT;i&&(e.wrapModeU=s._wrapMap[i]),o&&(e.wrapModeV=s._wrapMap[o])},s}(be);js._wrapMap={33071:Ye.Clamp,33648:Ye.Mirror,10497:Ye.Repeat};var xh=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.gltf,i=r.asset.version,o=r.extensionsUsed,c=r.extensionsRequired,l=Number(i);if(!(l>=2&&l<3))throw"Only support gltf 2.x.";if(o)for(var u=0;u<o.length;u++)be.hasExtensionParser(o[u])||ht.warn("Extension "+o[u]+" is not implemented, you can customize this extension in gltf.");if(c)for(var h=0;h<c.length;h++){var d=c[h];be.hasExtensionParser(d)&&be.initialize(d)}},s}(be),dn=function(){function n(a){var t=this;this._pipes=[],a.forEach(function(e,r){t._pipes[r]=new e})}var s=n.prototype;return s.parse=function(t){var e=this,r;return new Promise(function(i,o){e._pipes.forEach(function(c){r?r=r.then(function(){return c.parse(t)}):r=c.parse(t)}),r?r.then(function(){i(t)}).catch(o):i(t)})},n}();dn.instance=new dn([mh,xh,js,hn,Hs,ks,yh,gh,Ws]);var wh=function(n){te(s,n);function s(){for(var a,t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return a=n.call.apply(n,[this].concat(e))||this,a.url=void 0,a.gltf=void 0,a.buffers=void 0,a.textures=void 0,a.materials=void 0,a.meshes=void 0,a.skins=void 0,a.animations=void 0,a.entities=void 0,a.cameras=void 0,a.lights=void 0,a.sceneRoots=void 0,a.defaultSceneRoot=void 0,a.variants=void 0,a}return s}(sr),Do,Oo;Do=jt(pe.Prefab,["gltf","glb"]),Do(Oo=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=e.url;return new tt(function(o,c){var l=new wh(r.engine);l.url=i,dn.instance.parse(l).then(o).catch(function(u){console.error(u),c("Error loading glTF model from "+i+" .")})})},s}(Xt));var Lo,Io;Lo=jt(pe.JSON,["json"],!1),Lo(Io=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e){return this.request(e.url,Re(Re({},e),{},{type:"json"}))},s}(Xt));var bh=12+13*4,Ph=0;function Sh(n,s){for(var a=[],t=bh+n.bytesOfKeyValueData,e=n.pixelWidth,r=n.pixelHeight,i=s?n.numberOfMipmapLevels:1,o=0;o<i;o++){var c=new Int32Array(n.buffer,t,1)[0];t+=4;for(var l=0;l<n.numberOfFaces;l++){var u=new Uint8Array(n.buffer,t,c);a.push({data:u,width:e,height:r}),t+=c,t+=3-(c+3)%4}e=Math.max(1,e*.5),r=Math.max(1,r*.5)}return a}function Ah(n){if(n.byteLength>=12){var s=new Uint8Array(n,0,12);if(s[0]===171&&s[1]===75&&s[2]===84&&s[3]===88&&s[4]===32&&s[5]===49&&s[6]===49&&s[7]===187&&s[8]===13&&s[9]===10&&s[10]===26&&s[11]===10)return!0}return!1}function Mh(n){switch(n){case oe.RGB_S3TC_DXT1_EXT:return Y.DXT1;case oe.RGBA_S3TC_DXT5_EXT:return Y.DXT5;case oe.RGB_ETC1_WEBGL:return Y.ETC1_RGB;case oe.RGB8_ETC2:return Y.ETC2_RGB;case oe.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return Y.ETC2_RGBA5;case oe.RGBA8_ETC2_EAC:return Y.ETC2_RGBA8;case oe.RGB_PVRTC_2BPPV1_IMG:return Y.PVRTC_RGB2;case oe.RGBA_PVRTC_2BPPV1_IMG:return Y.PVRTC_RGBA2;case oe.RGB_PVRTC_4BPPV1_IMG:return Y.PVRTC_RGB4;case oe.RGBA_PVRTC_4BPPV1_IMG:return Y.PVRTC_RGBA4;case oe.RGBA_ASTC_4X4_KHR:return Y.ASTC_4x4;case oe.RGBA_ASTC_5X5_KHR:return Y.ASTC_5x5;case oe.RGBA_ASTC_6X6_KHR:return Y.ASTC_6x6;case oe.RGBA_ASTC_8X8_KHR:return Y.ASTC_8x8;case oe.RGBA_ASTC_10X10_KHR:return Y.ASTC_10x10;case oe.RGBA_ASTC_12X12_KHR:return Y.ASTC_12x12;default:var s=oe[n];throw new Error("this format is not supported in Oasis Engine: "+s)}}var Xs={parse:function(s,a,t,e){if(e===void 0&&(e=!1),!Ah(s))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,i=new DataView(s,12,13*r),o=i.getUint32(0,!0),c=o===67305985,l={buffer:s,glType:i.getUint32(1*r,c),glTypeSize:i.getUint32(2*r,c),glFormat:i.getUint32(3*r,c),glInternalFormat:i.getUint32(4*r,c),glBaseInternalFormat:i.getUint32(5*r,c),pixelWidth:i.getUint32(6*r,c),pixelHeight:i.getUint32(7*r,c),pixelDepth:i.getUint32(8*r,c),numberOfArrayElements:i.getUint32(9*r,c),numberOfFaces:i.getUint32(10*r,c),numberOfMipmapLevels:i.getUint32(11*r,c),bytesOfKeyValueData:i.getUint32(12*r,c),loadType:Ph};if(l.glType!==0)throw new Error("only compressed formats currently supported");if(l.numberOfMipmapLevels=Math.max(1,l.numberOfMipmapLevels),l.pixelHeight===0||l.pixelDepth!==0)throw new Error("only 2D textures currently supported");if(l.numberOfArrayElements!==0)throw new Error("texture arrays not currently supported");if(l.numberOfFaces!==a)throw new Error("number of faces expected"+a+", but found "+l.numberOfFaces);return t&&(l.mipmaps=Sh(l,!0)),e&&(l.engineFormat=Mh(l.glInternalFormat)),l}};function Ch(n){var s=Xs.parse(n,1,!0,!0);return{mipmaps:s.mipmaps,engineFormat:s.engineFormat,internalFormat:s.glInternalFormat,width:s.pixelWidth,height:s.pixelHeight}}function Th(n){for(var s=[],a,t,e,r,i=0;i<n.length;i++){var o=Xs.parse(n[i],1,!0,!0);s.push(o.mipmaps),i===0&&(e=o.pixelWidth,r=o.pixelHeight,a=o.glInternalFormat,t=o.engineFormat)}return{mipmapsFaces:s,engineFormat:t,internalFormat:a,width:e,height:r}}var Fo,No;Fo=jt(pe.KTXCube,[]),Fo(No=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new tt(function(o,c){Promise.all(e.urls.map(function(l){return i.request(l,Re(Re({},e),{},{type:"arraybuffer"}))})).then(function(l){for(var u=Th(l),h=u.width,d=u.mipmapsFaces,f=u.engineFormat,_=d[0].length>1,v=new Wi(r.engine,h,f,_),p=0;p<6;p++)for(var g=d[p].length,m=0;m<g;m++){var y=d[p][m],w=y.data,P=y.width,A=y.height;v.setPixelBuffer(pt.PositiveX+p,w,m,0,0,P,A)}o(v)}).catch(function(l){c(l)})})},s}(Xt));var Uo,Vo;Uo=jt(pe.KTX,["ktx"]),Uo(Vo=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new tt(function(o,c){i.request(e.url,Re(Re({},e),{},{type:"arraybuffer"})).then(function(l){for(var u=Ch(l),h=u.width,d=u.height,f=u.mipmaps,_=u.engineFormat,v=f.length>1,p=new Hr(r.engine,h,d,_,v),g=0;g<f.length;g++){var m=f[g],y=m.width,w=m.height,P=m.data;p.setPixelBuffer(P,g,0,0,y,w)}o(p)}).catch(function(l){c(l)})})},s}(Xt));var Go,ko;Go=jt(pe.Texture2D,["png","jpg","webp","jpeg"]),Go(ko=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new tt(function(o,c){i.request(e.url,Re(Re({},e),{},{type:"image"})).then(function(l){var u=new Hr(r.engine,l.width,l.height);if(!!u._platformTexture){if(u.setImageSource(l),u.generateMipmaps(),e.url.indexOf("data:")!==0){var h=e.url.split("/");u.name=h[h.length-1]}o(u)}}).catch(function(l){c(l)})})},s}(Xt));var Ho,Wo;Ho=jt(pe.TextureCube,[""]),Ho(Wo=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new tt(function(o,c){Promise.all(e.urls.map(function(l){return i.request(l,Re(Re({},e),{},{type:"image"}))})).then(function(l){var u=l[0],h=u.width,d=u.height;if(h!==d){console.error("The cube texture must have the same width and height");return}var f=new Wi(r.engine,h);if(!!f._platformTexture){for(var _=0;_<6;_++)f.setImageSource(pt.PositiveX+_,l[_],0);f.generateMipmaps(),o(f)}}).catch(function(l){c(l)})})},s}(Xt));var jo,Xo;jo=jt(pe.SpriteAtlas,["atlas"],!1),jo(Xo=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new tt(function(o,c){i.request(e.url,Re(Re({},e),{},{type:"json"})).then(function(l){var u=l.atlasItems,h=l.format,d=u.length;Promise.all(u.map(function(f){var _=f.img;return i.request(ce.parseRelativeUrl(e.url,_),Re(Re({},e),{},{type:"image"}))})).then(function(f){for(var _=r.engine,v=new tn,p=new k,g=new Ns(_),m=0;m<d;m++){var y=f[m],w=y.width,P=y.height,A=new Hr(_,w,P,h);A.setImageSource(y),A.generateMipmaps();for(var b=u[m],M=b.sprites,S=1/w,T=1/P,z=M.length-1;z>=0;z--){var R=M[z],E=R.region,N=R.pivot,D=R.atlasRegionOffset,V=R.atlasRegion,U=R.id,G=new vn(_,A,E?v.setValue(E.x,E.y,E.w,E.h):void 0,N?p.setValue(N.x,N.y):void 0,R.pixelsPerUnit||void 0,R.name);if(G.atlasRegion.setValue(V.x*S,V.y*T,V.w*S,V.h*T),R.atlasRotated&&(G.atlasRotated=!0),D){var O=D.x,K=D.y,ee=D.z,re=D.w,Z=void 0,se=void 0;R.atlasRotated?(Z=1/(O+V.h+ee),se=1/(K+V.w+re)):(Z=1/(O+V.w+ee),se=1/(K+V.h+re)),G.atlasRegionOffset.setValue(O*Z,K*se,ee*Z,re*se)}U!==void 0&&(G._assetID=U),g._addSprite(G)}}o(g)})}).catch(function(l){c(l)})})},s}(Xt));var Ko,qo;Ko=jt(pe.Env,["env"]),Ko(qo=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){return new tt(function(i,o){r.load({type:pe.Buffer,url:e.url}).then(function(c){var l,u=new Float32Array(c,0,27),h=27*4,d=(l=new Uint16Array(c,h,1))===null||l===void 0?void 0:l[0],f=new Wi(r.engine,d);f.filterMode=mt.Trilinear;for(var _=f.mipmapCount,v=h+2,p=0;p<_;p++)for(var g=d>>p,m=0;m<6;m++){var y=g*g*4,w=new Uint8Array(c,v,y);v+=y,f.setPixelBuffer(pt.PositiveX+m,w,p)}var P=new it,A=new fc;P.diffuseMode=wr.SphericalHarmonics,A.setValueByArray(u),P.diffuseSphericalHarmonics=A,P.specularTexture=f,P.specularTextureDecodeRGBM=!0,i(P)}).catch(function(c){o(c)})})},s}(Xt));var Cr=function(){function n(){}var s=n.prototype;return s.initialize=function(){},s.parseEngineResource=function(t,e,r){},s.createEngineResource=function(t,e){return null},n}(),Qo,Yo,Zi;Qo=Mr("KHR_draco_mesh_compression"),Qo(Yo=(Zi=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.initialize=function(){s._decoder||(s._decoder=new dh)},a.createEngineResource=function(e,r,i){var o=r.gltf,c=r.buffers,l=o.bufferViews,u=o.accessors,h=e.bufferView,d=e.attributes,f={},_={};for(var v in d)f[v]=d[v];for(var p in i.attributes)if(d[p]!==void 0){var g=u[i.attributes[p]];_[p]=ce.getComponentType(g.componentType).name}var m=u[i.indices],y=ce.getComponentType(m.componentType).name,w={attributeIDs:f,attributeTypes:_,useUniqueIDs:!0,indexType:y},P=ce.getBufferViewData(l[h],c);return s._decoder.decode(P,w).then(function(A){return A})},s}(Cr),Zi._decoder=void 0,Zi));var $o,Jo;$o=Mr("KHR_lights_punctual"),$o(Jo=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parseEngineResource=function(e,r,i){var o=e.color,c=e.intensity,l=c===void 0?1:c,u=e.type,h=e.range,d=e.spot,f;if(u==="directional"?f=r.addComponent(Ht):u==="point"?f=r.addComponent(Wt):u==="spot"&&(f=r.addComponent(ut)),o&&f.color.setValue(o[0],o[1],o[2],1),f.intensity=l,h&&!(f instanceof Ht)&&(f.distance=h),d&&f instanceof ut){var _=d.innerConeAngle,v=_===void 0?0:_,p=d.outerConeAngle,g=p===void 0?Math.PI/4:p;f.angle=v,f.penumbra=g-v}i.lights||(i.lights=[]),i.lights.push(f)},s}(Cr));var Zo,es;Zo=Mr("KHR_materials_pbrSpecularGlossiness"),Zo(es=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.createEngineResource=function(e,r){var i=r.engine,o=r.textures,c=new Sr(i),l=e.diffuseFactor,u=e.diffuseTexture,h=e.specularFactor,d=e.glossinessFactor,f=e.specularGlossinessTexture;return l&&(c.baseColor=new Q(Q.linearToGammaSpace(l[0]),Q.linearToGammaSpace(l[1]),Q.linearToGammaSpace(l[2]),l[3])),u&&(c.baseTexture=o[u.index],hn._parseTextureTransform(c,u.extensions,r)),h&&(c.specularColor=new Q(Q.linearToGammaSpace(h[0]),Q.linearToGammaSpace(h[1]),Q.linearToGammaSpace(h[2]))),d!==void 0&&(c.glossiness=d),f&&(c.specularGlossinessTexture=o[f.index],hn._parseTextureTransform(c,f.extensions,r)),c},s}(Cr));var ts,rs;ts=Mr("KHR_materials_unlit"),ts(rs=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.createEngineResource=function(e,r){var i=r.engine,o=new Ar(i);return o},s}(Cr));var is,ns;is=Mr("KHR_materials_variants"),is(ns=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parseEngineResource=function(e,r,i){for(var o=i.gltf.extensions.KHR_materials_variants.variants,c=i.materials,l=e.mappings,u=0;u<l.length;u++){var h=l[u],d=h.material,f=h.variants;i.variants||(i.variants=[]),i.variants.push({renderer:r,material:c[d],variants:f.map(function(_){return o[_].name})})}},s}(Cr));var as,os;as=Mr("KHR_mesh_quantization"),as(os=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}return s}(Cr));var ss,cs;ss=Mr("KHR_texture_transform"),ss(cs=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.parseEngineResource=function(e,r,i){var o=e.offset;e.rotation;var c=e.scale;e.texCoord,o&&(r.tilingOffset.z=o[0],r.tilingOffset.w=o[1]),c&&(r.tilingOffset.x=c[0],r.tilingOffset.y=c[1])},s}(Cr));var Rh=function(n){te(s,n);function s(t){var e;return e=n.call(this,t)||this,e._animatorController=void 0,e._speed=1,e._animator=void 0,e._asset=void 0,e._glTFEntity=void 0,e._clipPreview=void 0,e._hasBuiltNode=!1,e._controllerUpdateFlag=void 0,e}var a=s.prototype;return a.init=function(e){var r=e.asset,i=r===void 0?null:r,o=e.speed,c=e.animatorController,l=e.clipPreview,u=e.isClone;if(u){var h=e.gltfRootName;h&&(this._glTFEntity=this.entity.findByName(h))}if(this._glTFEntity)this._hasBuiltNode=!0;else{var d="GLTF-"+Date.now();e.gltfRootName=d,this._glTFEntity=this.entity.createChild(d),this._hasBuiltNode=!1}this.asset=i,this.animatorController=c,this.speed=o,this.clipPreview=l},a.update=function(){if(this._animator){var e;(e=this._controllerUpdateFlag)!==null&&e!==void 0&&e.flag&&this._playState()}},a._onEnable=function(){this._glTFEntity&&(this._glTFEntity.isActive=!0),this.engine._componentsManager.addOnUpdateAnimations(this)},a._onDisable=function(){this._glTFEntity&&(this._glTFEntity.isActive=!1),this.engine._componentsManager.removeOnUpdateAnimations(this)},a._playState=function(){var e,r=this._clipPreview;r?r==="_default"?this._playDefaultState():this._animator.play(r,0):this._animator._reset(),(e=this._controllerUpdateFlag)!==null&&e!==void 0&&e.flag&&(this._controllerUpdateFlag.flag=!1)},a._playDefaultState=function(){var e=this._animatorController,r=this._animator;if(!!r&&e)for(var i=e.layers,o=0,c=i.length;o<c;++o){var l,u,h,d=(l=i[o])===null||l===void 0||(u=l.stateMachine)===null||u===void 0?void 0:u._defaultState,f=d==null?void 0:d.name;f?r.play(f,o):r._reset(),(h=this._controllerUpdateFlag)!==null&&h!==void 0&&h.flag&&(this._controllerUpdateFlag.flag=!1)}},_i(s,[{key:"asset",get:function(){return this._asset},set:function(e){var r=this._animatorController,i=this._speed,o=this._glTFEntity;if(!(e&&e.defaultSceneRoot===this._glTFEntity)){if(!this._hasBuiltNode&&(o.clearChildren(),e!==null)){o==null||o.destroy();var c=e.defaultSceneRoot.clone();this._animator=c.getComponent(pn),this.entity.addChild(c),c.isActive=this.enabled,this._glTFEntity=c}r&&(this._animator.animatorController=r,this._animator.speed=i,this._playState()),this._asset=e}}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){var r=this._animator;e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e,r&&(r.animatorController=e,this._playState()))}},{key:"speed",get:function(){return this._speed},set:function(e){var r=this._animator;this._speed=e,r&&(r.speed=e,this._playState())}},{key:"animator",get:function(){return this._animator}},{key:"clipPreview",get:function(){return this._clipPreview},set:function(e){this._animator&&(e?e==="_default"?this._playDefaultState():this._animator.play(e,0):this._animator._reset()),this._clipPreview=e}}]),s}(dt),Ks=function(n){te(s,n);function s(t){var e;return e=n.call(this,t)||this,e._props=null,e.setMaterial(new $e(e.engine)),e}var a=s.prototype;return a.setProps=function(e){switch(e===void 0&&(e={}),this._props!==e&&(this._props=e),e.geometryType){case"Sphere":this.mesh=$r.createSphere(this._engine,e.sphereRadius,e.sphereSegments);break;case"Cylinder":this.mesh=$r.createCylinder(this._engine,e.cylinderRadiusTop,e.cylinderRadiusBottom,e.cylinderHeight,e.cylinderRadialSegments,e.cylinderHeightSegments);break;case"Plane":this.mesh=$r.createPlane(this._engine,e.planeWidth,e.planeHeight,e.planeHorizontalSegments,e.planeVerticalSegments);break;case"Box":this.mesh=$r.createCuboid(this._engine,e.boxWidth,e.boxHeight,e.boxDepth);break}},a.updateProp=function(e,r){var i=this._props;i[e]=r,this.setProps(i)},_i(s,[{key:"material",get:function(){return this.getMaterial()},set:function(e){this.setMaterial(e)}}]),s}(di),zh=function(){function n(){this.registeredPlugins=new Set,this.plugins=[]}var s=n.prototype;return s.register=function(t){this.registeredPlugins.add(t)},s.boot=function(t){for(var e=vh(this.registeredPlugins.values()),r;!(r=e()).done;){var i=r.value;typeof i=="function"&&(i=i(t)),this.plugins.push(i)}},s.reset=function(){this.registeredPlugins.clear(),this.plugins=[]},s.nodeAdded=function(t){this.delegateMethod("nodeAdded",t)},s.delegateMethod=function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];this.plugins.forEach(function(o){return o[t]&&o[t].apply(o,r)})},n}();function Et(n){return function(s,a,t){var e=t.value;t.value=function(){for(var r,i=this,o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return n.before&&(r=this.oasis.pluginManager).delegateMethod.apply(r,[n.before].concat(c)),Promise.resolve(e.apply(this,arguments)).then(function(u){return n.after&&i.oasis.pluginManager.delegateMethod(n.after,u),u})}}}function Eh(n){for(var s=n.abilities,a=s===void 0?{}:s,t=n.assets,e=t===void 0?{}:t,r=n.scene,i=r===void 0?{}:r,o=Object.keys(a),c=Object.keys(e),l=Object.keys(i||{}),u=0,h=o.length;u<h;++u)Bh(a[o[u]].props);for(var d=0,f=c.length;d<f;++d)Oh(e[c[d]].props);for(var _=0,v=l.length;_<v;++_)Dh(i[l[_]].props);return n}function Bh(n){for(var s=Object.keys(n),a=0,t=s.length;a<t;++a){var e=s[a],r=n[e];Array.isArray(r)&&typeof r[0]!="object"&&(["color","diffuseColor","specularColor"].indexOf(e)!==-1?n[e]=new Q(r[0],r[1],r[2],r[3]):r.length===4?n[e]=new ve(r[0],r[1],r[2],r[3]):r.length===3?n[e]=new x(r[0],r[1],r[2]):r.length===2&&(n[e]=new k(r[0],r[1])))}}function Dh(n){for(var s=Object.keys(n),a=0,t=s.length;a<t;++a){var e=s[a],r=n[e];Array.isArray(r)&&typeof r[0]!="object"&&(/color/i.test(e)?n[e]=new Q(r[0],r[1],r[2],r[3]):r.length===4?n[e]=new ve(r[0],r[1],r[2],r[3]):r.length===3?n[e]=new x(r[0],r[1],r[2]):r.length===2&&(n[e]=new k(r[0],r[1])))}}function Oh(n){if(n===void 0&&(n={}),!!n)for(var s=Object.keys(n),a=0,t=s.length;a<t;a++){var e=s[a],r=n[e];e==="newMaterial"||e==="scripts"||Array.isArray(r)&&typeof r[0]!="object"&&(["emissiveColor","diffuseColor","specularColor","baseColor"].indexOf(e)!==-1?n[e]=new Q(r[0],r[1],r[2],r[3]):r.length===4?n[e]=new ve(r[0],r[1],r[2],r[3]):r.length===3?n[e]=new x(r[0],r[1],r[2]):r.length===2&&(n[e]=new k(r[0],r[1])))}}var ls=3,vi=function(){var n=s.prototype;n.parse=function(t){var e;if((t==null||(e=t.config)===null||e===void 0?void 0:e.version)!==ls){var r;console.warn('schema-parser: schema version "'+(t==null||(r=t.config)===null||r===void 0?void 0:r.version)+'" is out of date, please re-pull the latest version (version '+ls+") of the schema")}return Eh(t.config),Kh.create(t,this.pluginManager)},n.register=function(t){this.pluginManager.register(t)},n.resetPlugins=function(){this.pluginManager.reset()};function s(){this.pluginManager=new zh}return s.create=function(){var t=new s;return t},s.registerComponents=function(t,e){this._components[t]||(this._components[t]={}),ln(this._components[t],e)},s}();vi._components={};vi.create();function qs(n,s,a){if(!(s===a||a===null||a===void 0)){var t=[n[a],n[s]];n[s]=t[0],n[a]=t[1]}}function wt(n){return n&&n.type==="asset"}function Gr(n){for(var s=[],a=Object.getPrototypeOf(n),t=Object.getOwnPropertyDescriptors(a),e=0,r=Object.entries(t);e<r.length;e++){var i=r[e],o=i[0],c=i[1];typeof c.get=="function"&&s.push(o)}return s}var Je=function(){var n=s.prototype;n.setMeta=function(){};function s(a,t){this.resourceManager=a,this._resource=t,this._meta={},this._attachedResources=[],this.setMeta()}return n.loadWithAttachedResources=function(t,e,r){var i=this;return new Promise(function(o,c){i.load(t,e,r).then(function(){o({resources:[i],structure:{index:0,props:{}}})}).catch(function(l){c(l)})})},n.getProps=function(){return{}},n.bind=function(){},n.attach=function(){},n.update=function(t,e){if(wt(e)){var r=this.resourceManager.get(e.id);r?this._resource[t]=r.resource:ht.warn("SchemaResource: "+this.meta.name+" can't find asset, which id is: "+e.id)}else this._resource[t]=e},n.updateMeta=function(t,e){this._meta[t]=e},n.onDestroy=function(){},_i(s,[{key:"resource",get:function(){return this._resource}},{key:"meta",get:function(){return this._meta}},{key:"attachedResources",get:function(){return this._attachedResources}}]),s}(),Qs=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){i._resource=r.props||{},i.setMeta(),o(i)})},a.loadWithAttachedResources=function(e,r){var i=this;return new Promise(function(o,c){var l;r.props?l=i.load(e,r):c("Load AnimationClip Error"),l&&l.then(function(){var u={resources:[i],structure:{index:0,props:{}}};o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){return this._resource},s}(Je),Ys=function(n){te(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.gltf=void 0,t.animatorControllerData=void 0,t.animationClipAssets=void 0,t.animationsIndices=void 0,t}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){var c=r.props||{},l=c.animatorController,u=c.animationClips,h=c.animationsIndices,d=c.gltf;i._resource=new Vs,i.animatorControllerData=l,i.animationsIndices=h||[],i.animationClipAssets=u||[],i.gltf=d,!l&&i._setDefaultDataByAnimationClip(),i.setMetaData("name",r.name),o(i)})},a.loadWithAttachedResources=function(e,r){var i=this;return new Promise(function(o,c){var l=[];i.load(e,r).then(function(){for(var u={resources:[i],structure:{index:0,props:{animationClips:[]}}},h=i.animationsIndices,d=0,f=h.length;d<f;++d){var _=h[d],v=new Qs(i.resourceManager);i.attachedResources.push(v),l.push(v.loadWithAttachedResources(e,{type:"animationClip",name:_.name,props:_}))}Promise.all(l).then(function(p){var g=u.structure.props.animationClips;p.forEach(function(m){var y=m.structure,w=m.resources[y.index];u.resources.push(w),y.index=u.resources.length-1,g.push(y)}),o(u)})})})},a.setMetaData=function(e,r){this._meta[e]=r},a.update=function(e,r){this._initAnimatorController(r)},a.bind=function(){var e=this.animatorControllerData,r=this.animationClipAssets;this._bindClips(r),e?this._initAnimatorController(e):this._setDefaultDataByAnimationClipAsset()},a._initAnimatorController=function(e){var r=this.gltf||{},i=r.animations,o=e.layers;if(!(!i||!o)){this._resource.clearLayers();for(var c=0,l=o.length;c<l;++c){var u=o[c],h=u.name,d=u.blending,f=u.weight,_=u.stateMachine;if(!!_){var v=new sn(h);v.blendingMode=d,v.weight=f;for(var p=_.states,g=new cn,m=[],y=0,w=p.length;y<w;++y){var P=p[y],A=P.name,b=P.transitions,M=P.clip,S=P.speed,T=P.wrapMode,z=P.clipStartNormalizedTime,R=P.clipEndNormalizedTime,E=P.isDefaultState,N=M||{},D=N.id;if(!!D){var V=g.makeUniqueStateName(A);V!==A&&console.warn("AnimatorState name is existed, name: "+A+" reset to "+V);var U=g.addState(V);U.speed=S,U.wrapMode=T;var G=this.resourceManager.get(D).resource,O=i[G.index];if(!!O){U.clip=O,U.clipStartTime=z,U.clipEndTime=R;for(var K=0,ee=b.length;K<ee;++K){var re=b[K];b[K].srcState=U,m.push(re)}E&&(g._defaultState=U)}}}for(var Z=0,se=m.length;Z<se;++Z){var de=m[Z],_e=new Us;_e.duration=de.duration,_e.offset=de.offset,_e.exitTime=de.exitTime,_e.destinationState=g.findStateByName(de.targetStateName),de.srcState.addTransition(_e),delete de.srcState}v.stateMachine=g,this._resource.addLayer(v)}}}},a._bindClips=function(e){for(var r=0,i=e.length;r<i;r++){var o=e[r],c=this.resourceManager.get(o.id);c?this._attachedResources.push(c):""+this.meta.name+o.id}},a._setDefaultDataByAnimationClipAsset=function(){var e=this.animationClipAssets;if(!!e.length){for(var r=[],i=0,o=e.length;i<o;i++){var c=this.resourceManager.get(e[i].id);r.push(c.resource)}this.animationsIndices=r,this._setDefaultDataByAnimationClip()}},a._setDefaultDataByAnimationClip=function(){var e=this.animationsIndices,r=this._resource,i=this.gltf;if(!(!e.length||!i)){var o=i.animations,c=new sn("layer"),l=new cn;r.addLayer(c),c.stateMachine=l;for(var u=0,h=e.length;u<h;u++){var d=e[u],f=d.name,_=d.index,v=l.makeUniqueStateName(f);v!==f&&console.warn("AnimatorState name is existed, name: "+f+" reset to "+v);var p=l.addState(v);p.clip=o[_]}}},s}(Je),bt=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,i){var o=this;return new Promise(function(c,l){var u,h,d,f,_=pe.Texture2D;if(o.resourceManager.useCompressedTexture&&r!==null&&r!==void 0&&(u=r.props)!==null&&u!==void 0&&(h=u.compression)!==null&&h!==void 0&&h.compressions.length)for(var v=i.engine._hardwareRenderer,p=r.props.compression.compressions,g=0;g<p.length;g++){var m=p[g];if(m.container==="ktx"&&v.canIUse(Ve[m.type])){f=m.url,_=pe.KTX;break}}f=(d=f)!=null?d:r.url,e.load({url:f,type:_}).then(function(y){o._resource=y,c(o)}).catch(function(y){l(y)})})},a.setMeta=function(){this.resource&&(this._meta.name=this.resource.name)},s}(Je),$s=function(n){te(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){var c=new $e(e.engine);i.configProps=r.props,i._resource=c;for(var l in i.configProps)wt(i.configProps[l])||(c[l]=i.configProps[l]);i.setMeta(),o(i)})},a.loadWithAttachedResources=function(e,r){var i=this;return new Promise(function(o,c){var l;r.resource instanceof $e?l=new Promise(function(u){i._resource=r.resource,i.setMeta(),u(i)}):r.props?l=i.load(e,r):c("Load BlinnPhongMaterial Error"),l&&l.then(function(){var u={resources:[i],structure:{index:0,props:{}}},h=i._resource;Gr(i._resource).forEach(function(d){if(h[d]instanceof xt){var f=new bt(i.resourceManager,h[d]);i.attachedResources.push(f),u.resources.push(f),u.structure.props[d]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(i){var o=e.configProps[i];if(wt(o)){var c=e.resourceManager.get(o.id);c&&c instanceof bt?(r[i]=c.resource,e._attachedResources.push(c)):(r[i]=null,ht.warn("BlinnPhongMaterialResource: "+e.meta.name+` can't find asset "`+i+'", which id is: '+o.id))}else r[i]=o})},s}(Je),us=["metallic","roughness","roughnessMetallicTexture","tilingOffset","baseColor","normalTextureIntensity","emissiveColor","occlusionTextureIntensity","baseTexture","normalTexture","emissiveTexture","occlusionTexture","isTransparent","alphaCutoff","renderFace","blendMode"],Js=function(n){te(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){var c=new Pr(e.engine);i.configProps=r.props;for(var l in i.configProps)wt(i.configProps[l])||(c[l]=i.configProps[l]);i._resource=c,i.setMeta(),o(i)})},a.loadWithAttachedResources=function(e,r){var i=this;return new Promise(function(o,c){var l;r.resource instanceof Pr?l=new Promise(function(u){i._resource=r.resource,i.setMeta(),u(i)}):r.props?l=i.load(e,r):c("Load PBRMaterial Error"),l&&l.then(function(){var u={resources:[i],structure:{index:0,props:{}}},h=i._resource;us.forEach(function(d){if(h[d]instanceof xt){var f=new bt(i.resourceManager,h[d]);i.attachedResources.push(f),u.resources.push(f),u.structure.props[d]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={};return us.forEach(function(i){return r[i]=e.resource[i]}),r},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(i){var o=e.configProps[i];if(wt(o)){var c=e.resourceManager.get(o.id);c&&c instanceof bt?(r[i]=c.resource,e._attachedResources.push(c)):(r[i]=null,ht.warn("PBRMaterialResource: "+e.meta.name+` can't find asset "`+i+'", which id is: '+o.id))}else r[i]=o})},s}(Je),Lh=["specularColor","glossiness","specularGlossinessTexture","tilingOffset","baseColor","normalTextureIntensity","emissiveColor","occlusionTextureIntensity","baseTexture","normalTexture","emissiveTexture","occlusionTexture","isTransparent","alphaCutoff","renderFace","blendMode"],Zs=function(n){te(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){var c=new Sr(e.engine);i.configProps=r.props,i._resource=c;for(var l in i.configProps)wt(i.configProps[l])||(c[l]=i.configProps[l]);i.setMeta(),o(i)})},a.loadWithAttachedResources=function(e,r){var i=this;return new Promise(function(o,c){var l;r.resource instanceof Sr?l=new Promise(function(u){i._resource=r.resource,i.setMeta(),u(i)}):r.props?l=i.load(e,r):c("Load PBRSpecularMaterial Error"),l&&l.then(function(){var u={resources:[i],structure:{index:0,props:{}}},h=i._resource;Object.keys(i._resource).forEach(function(d){if(h[d]instanceof xt){var f=new bt(i.resourceManager,h[d]);i.attachedResources.push(f),u.resources.push(f),u.structure.props[d]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={};return Lh.forEach(function(i){return r[i]=e.resource[i]}),r},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(i){var o=e.configProps[i];if(wt(o)){var c=e.resourceManager.get(o.id);c&&c instanceof bt?(r[i]=c.resource,e._attachedResources.push(c)):(r[i]=null,ht.warn("PBRSpecularMaterialResource: "+e.meta.name+` can't find asset "`+i+'", which id is: '+o.id))}else r[i]=o})},s}(Je),ec=function(n){te(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){var c=new Ar(e.engine);i.configProps=r.props;for(var l in i.configProps)wt(i.configProps[l])||(c[l]=i.configProps[l]);i._resource=c,i.setMeta(),o(i)})},a.loadWithAttachedResources=function(e,r){var i=this;return new Promise(function(o,c){var l;r.resource instanceof Ar?l=new Promise(function(u){i._resource=r.resource,i.setMeta(),u(i)}):r.props?l=i.load(e,r):c("Load PBRMaterial Error"),l&&l.then(function(){var u={resources:[i],structure:{index:0,props:{}}},h=i._resource;Gr(i._resource).forEach(function(d){if(h[d]instanceof xt){var f=new bt(i.resourceManager,h[d]);i.attachedResources.push(f),u.resources.push(f),u.structure.props[d]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={},i=Gr(this.resource);return i.forEach(function(o){return r[o]=e.resource[o]}),r},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(i){var o=e.configProps[i];if(wt(o)){var c=e.resourceManager.get(o.id);c&&c instanceof bt?(r[i]=c.resource,e._attachedResources.push(c)):(r[i]=null,ht.warn("PBRMaterialResource: "+e.meta.name+` can't find asset "`+i+'", which id is: '+o.id))}else r[i]=o})},s}(Je),Ih=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,i){var o=this;return e.load({url:r.url,type:pe.Prefab}).then(function(c){var l=c;r.props&&(l.newMaterial=r.props.newMaterial,l.animatorControllers=r.props.animatorControllers),o._resource=l})},a.loadWithAttachedResources=function(e,r,i){var o=this;return new Promise(function(c){o.load(e,r,i).then(function(){var l=o.resource,u=l.materials,h=u===void 0?[]:u,d=l._animationsIndices,f=d===void 0?[]:d,_=[],v,p={resources:[o],structure:{index:0,props:{newMaterial:[],animatorControllers:[]}}};if(h!=null&&h.length)for(var g=0;g<h.length;g++){var m=h[g],y=null,w="";m instanceof Pr?(y=new Js(o.resourceManager),w="PBRMaterial"):m instanceof Ar?(y=new ec(o.resourceManager),w="UnlitMaterial"):m instanceof Sr?(y=new Zs(o.resourceManager),w="PBRSpecularMaterial"):(y=new $s(o.resourceManager),w="BlinnPhongMaterial"),o._attachedResources.push(y),_.push(y.loadWithAttachedResources(e,{type:w,name:m.name,resource:m}))}if(f.length){var P=new Ys(o.resourceManager);o._attachedResources.push(P),v=P.loadWithAttachedResources(e,{type:"animatorController",name:"AnimatorController",props:{animationsIndices:f,gltf:o._resource}})}var A=Promise.all(_).then(function(M){var S=p.structure.props.newMaterial;M.forEach(function(T){var z=T.structure,R=T.resources[z.index];p.resources.push(R),z.index=p.resources.length-1;for(var E in z.props)if(z.props.hasOwnProperty(E)){var N=z.props[E],D=T.resources[N.index];p.resources.push(D),N.index=p.resources.length-1}S.push(z)})}),b=v?v.then(function(M){var S=p.structure.props.animatorControllers,T=M.structure,z=M.resources[T.index];p.resources.push(z),T.index=p.resources.length-1;var R=T.props.animationClips;if(R)for(var E=0,N=R.length;E<N;++E){var D=R[E],V=M.resources[D.index];p.resources.push(V),D.index=p.resources.length-1}S.push(T)}):Promise.resolve();Promise.all([A,b]).then(function(){c(p)})})})},a.setMeta=function(e){e&&(this.meta.name=e.name)},a.bind=function(){var e=this._resource;this.bindMaterials(e.newMaterial),this.bindAnimatorControllers(e.animatorControllers)},a.update=function(e,r){e==="newMaterial"?this.bindMaterials(r):this._resource[e]=r},a.bindMaterials=function(e){var r=e.length;if(!(!e||!e.length)){var i=this._resource,o=new Array(r);i.newMaterial=o;for(var c=0;c<e.length;c++){var l=this.resourceManager.get(e[c].id);l?(this._attachedResources.push(l),o[c]=l.resource):ht.warn("GLTFResource: "+this.meta.name+` can't find asset "material", which id is: `+e[c].id)}for(var u=i.defaultSceneRoot,h=i.materials,d=u.getComponentsIncludeChildren(di,[]),f=0;f<r;f++)for(var _=o[f],v=h[f],p=0;p<d.length;p++)for(var g=d[p],m=g.getMaterials(),y=0;y<m.length;y++)v===m[y]&&g.setMaterial(y,_)}},a.bindAnimatorControllers=function(e){for(var r=0,i=e.length;r<i;r++){var o=e[r],c=this.resourceManager.get(o.id);c.gltf=this._resource,c?this._attachedResources.push(c):""+this.meta.name+o.id}},s}(Je),zi={},Fh=function(n){te(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.isInit=!1,t}var a=s.prototype;return a.initScriptContext=function(){this.isInit||(this.isInit=!0,window.__o3_script_context__={o3:vi._components.o3,script:function(r){return function(i){zi[r]=i}}})},a.load=function(e,r,i){var o=this;return this.initScriptContext(),new Promise(function(c){var l=r,u=l.props.scripts;if(o.resourceManager.isLocal){for(var d=0;d<u.length;d++){var f,_=u[d].name;zi[_]=(f=i.options)===null||f===void 0?void 0:f.scripts[_]}c(o)}else{var h=document.createElement("script");h.crossOrigin="anonymous",o.setMeta(r),h.onload=function(){for(var v=window.o3Scripts,p=0;p<u.length;p++){var g=u[p].name;o._resource=v&&v[g],zi[g]=o._resource}c(o)},h.src=r.url,document.body.appendChild(h)}})},a.setMeta=function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)},s}(Je),tc=function(n){te(s,n);function s(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){var c=new vn(e.engine);i.configProps=r.props;var l=i.configProps,u=l.pivotType,h=l.pivot;if(typeof h!="undefined"&&typeof u!="undefined"&&u!==nt.Custom)switch(u){case nt.Center:h.x=.5,h.y=.5;break;case nt.TopLeft:h.x=0,h.y=1;break;case nt.Top:h.x=.5,h.y=1;break;case nt.TopRight:h.x=1,h.y=1;break;case nt.Left:h.x=0,h.y=.5;break;case nt.Right:h.x=1,h.y=.5;break;case nt.BottomLeft:h.x=0,h.y=0;break;case nt.Bottom:h.x=.5,h.y=0;break;case nt.BottomRight:h.x=1,h.y=0;break}for(var d in l)!wt(l[d])&&typeof l[d]!="undefined"&&(c[d]=l[d]);i._resource=c,i.setMeta(),o(i)})},a.loadWithAttachedResources=function(e,r){var i=this;return new Promise(function(o,c){var l;r.resource instanceof s?l=new Promise(function(u){i._resource=r.resource,i.setMeta(),u(i)}):r.props?l=i.load(e,r):c("Load Sprite Error"),l&&l.then(function(){var u={resources:[i],structure:{index:0,props:{}}},h=i._resource;Gr(i._resource).forEach(function(d){if(h[d]instanceof xt){var f=new bt(i.resourceManager,h[d]);i.attachedResources.push(f),u.resources.push(f),u.structure.props[d]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={},i=Gr(this.resource);return i.forEach(function(o){return r[o]=e.resource[o]}),r},a.bind=function(){var e=this,r=this._resource;this.configProps&&Object.keys(this.configProps).forEach(function(i){var o=e.configProps[i];if(wt(o)){var c=e.resourceManager.get(o.id);c&&c instanceof bt?(r[i]=c.resource,e._attachedResources.push(c)):(r[i]=null,ht.warn("SpriteResource: "+e.meta.name+` can't find asset "`+i+'", which id is: '+o.id))}else r[i]=o})},s}(Je),nt;(function(n){n[n.Center=0]="Center",n[n.TopLeft=1]="TopLeft",n[n.Top=2]="Top",n[n.TopRight=3]="TopRight",n[n.Left=4]="Left",n[n.Right=5]="Right",n[n.BottomLeft=6]="BottomLeft",n[n.Bottom=7]="Bottom",n[n.BottomRight=8]="BottomRight",n[n.Custom=9]="Custom"})(nt||(nt={}));var hs={px:0,nx:1,py:2,ny:3,pz:4,nz:5},Nh=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,i){var o=this;return new Promise(function(c,l){var u,h,d=[],f=pe.TextureCube;if(o.resourceManager.useCompressedTexture&&r!==null&&r!==void 0&&(u=r.props)!==null&&u!==void 0&&(h=u.compression)!==null&&h!==void 0&&h.compressions.length)for(var _=i.engine._hardwareRenderer,v=r.props.compression.compressions,p=0;p<v.length;p++){var g=v[p];if(g.container==="ktx"&&_.canIUse(Ve[g.type])){for(var m in g.files)if(g.files.hasOwnProperty(m)){var y=g.files[m];d[hs[m]]=y.url}console.warn(g.type),f=pe.KTXCube;break}}if(f===pe.TextureCube){for(var w in r.props.images)if(r.props.images.hasOwnProperty(w)){var P=r.props.images[w];d[hs[w]]=P.url}}e.load({urls:d,type:f}).then(function(A){o._resource=A,c(o)}).catch(function(A){l(A)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},s}(Je),Uh=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){i._resource=r,i.setMetaData("name",i.resource.name),i.setMetaData("url",i.resource.url),o(i)})},a.setMetaData=function(e,r){this._meta[e]=r},s}(Je),Vh=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,i){var o=this;return new Promise(function(c,l){var u=r.url;e.load({url:u,type:pe.Env}).then(function(h){o._resource=h,c(o)}).catch(function(h){l(h)})})},a.setMeta=function(){this.resource&&(this._meta.name=this.resource.name)},s}(Je);function Gh(n,s){n.isShowCollider=s.isShowCollider;for(var a=s.colliderShapes,t=0;t<a.length;t++){var e=a[t];switch(e._shapes){case"BoxColliderShape":{var r=new Ec;e.size&&r.setSize(e.size[0],e.size[1],e.size[2]),e.position&&r.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(r.isTrigger=e.isTrigger),n.addShape(r);break}case"CapsuleColliderShape":{var i=new Oc;if(e.radius&&(i.radius=e.radius),e.height&&(i.height=e.height),e.upAxis)switch(e.upAxis){case"X":i.upAxis=gr.X;break;case"Y":i.upAxis=gr.Y;break;case"Z":i.upAxis=gr.Z;break}e.position&&i.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(i.isTrigger=e.isTrigger),n.addShape(i);break}case"PlaneColliderShape":{var o=new Dc;e.rotation&&o.setRotation(e.rotation[0],e.rotation[1],e.rotation[2]),e.position&&o.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(o.isTrigger=e.isTrigger),n.addShape(o);break}case"SphereColliderShape":{var c=new Bc;e.radius&&(c.radius=e.radius),e.position&&c.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(c.isTrigger=e.isTrigger),n.addShape(c);break}}}if(n instanceof Cs){var l=s.force;l&&n.applyForce(new x(l[0],l[1],l[2]));var u=s.torque;u&&n.applyTorque(new x(u[0],u[1],u[2]))}}var ds,fs,_s,_t,kh=(ds=Et({after:"abilityAdded",before:"beforeAbilityAdded"}),fs=Et({before:"beforeAbilityUpdated",after:"abilityUpdated"}),_s=Et({after:"abilityDeleted",before:"beforeAbilityDeleted"}),_t=function(){function n(a){this.oasis=a,this.abilityMap={}}var s=n.prototype;return s.add=function(t){var e=t.type,r=t.node,i=t.props,o=t.id,c=t.index,l=this.oasis.nodeManager.get(r),u=this.getCompConstructor(e);if(!!u){var h=this.mixPropsToExplicitProps(i),d=l.addComponent(u),f=h.enabled;if(f!==void 0&&(d.enabled=f),e==="GLTFModel")d.init(h);else if(e==="Model")d.setProps(h),h.material&&(d.material=h.material);else if(e==="StaticCollider"||e==="DynamicCollider")Gh(d,h);else for(var _ in h)h[_]!==null&&(d[_]=h[_]);var v=l._components,p=v.length-1;return qs(v,p,c),d.id=o,this.abilityMap[o]=d,d}},s.update=function(t,e,r){return r&&this.checkIsAsset(r)?this.get(t)[e]=this.oasis.resourceManager.get(r.id).resource:this.get(t).constructor===Ks?this.get(t).updateProp(e,r):this.get(t)[e]=r,{id:t,key:e,value:r}},s.addRuntimeComponent=function(t,e){return e.id=t,this.abilityMap[t]=e,e},s.get=function(t){return this.abilityMap[t]},s.delete=function(t){var e=this.abilityMap[t];return e.destroy(),delete this.abilityMap[t],t},s.getCompConstructor=function(t){var e=t.split(".");if(e[0]==="script")return zi[e[1]];var r=vi._components.o3[t];return r||console.warn(t+" is not defined"),r},s.mixPropsToExplicitProps=function(t){var e=Re({},t);for(var r in t){var i=t[r];if(i&&this.checkIsAsset(i)){var o=this.oasis.resourceManager.get(i.id);o?e[r]=o.resource:(e[r]=null,ht.warn(`AbilityManager: can't get asset "`+r+'", which id is '+i.id))}}return e},s.checkIsAsset=function(t){return t.type==="asset"},n}(),zt(_t.prototype,"add",[ds],Object.getOwnPropertyDescriptor(_t.prototype,"add"),_t.prototype),zt(_t.prototype,"update",[fs],Object.getOwnPropertyDescriptor(_t.prototype,"update"),_t.prototype),zt(_t.prototype,"delete",[_s],Object.getOwnPropertyDescriptor(_t.prototype,"delete"),_t.prototype),_t),vs,ps,gs,vt,Hh=(vs=Et({after:"nodeAdded"}),ps=Et({before:"beforeNodeUpdated",after:"nodeUpdated"}),gs=Et({before:"beforeNodeDeleted"}),vt=function(){function n(a){this.oasis=a,this.nodeMap={},this.root=void 0,this.root=new Ut(this.oasis.engine,"root")}var s=n.prototype;return s.addRootEntity=function(){this.oasis.engine.sceneManager.activeScene.addRootEntity(this.root)},s.add=function(t){return this.create(t),this.append(t.id,t.parent,t.index),this.get(t.id)},s.update=function(t,e,r){return this.get(t)[e]=r,{id:t,key:e,value:r}},s.get=function(t){return this.nodeMap[t]},s.reset=function(){this.nodeMap={}},s.delete=function(t){this.nodeMap[t].destroy(),delete this.nodeMap[t]},s.create=function(t){var e=t.isActive,r=t.position,i=t.rotation,o=t.scale,c=t.id,l=t.name,u=new Ut(this.oasis.engine,l);return u.isActive=e,u.transform.position=new x(r[0],r[1],r[2]),u.transform.rotation=new x(i[0],i[1],i[2]),u.transform.scale=new x(o[0],o[1],o[2]),u.id=c,this.nodeMap[c]=u,u},s.append=function(t,e,r){var i=this.nodeMap[t],o=this.nodeMap[e]||this.root;o.addChild(i);var c=o._children,l=c.length-1;qs(c,l,r)},n}(),zt(vt.prototype,"add",[vs],Object.getOwnPropertyDescriptor(vt.prototype,"add"),vt.prototype),zt(vt.prototype,"update",[ps],Object.getOwnPropertyDescriptor(vt.prototype,"update"),vt.prototype),zt(vt.prototype,"delete",[gs],Object.getOwnPropertyDescriptor(vt.prototype,"delete"),vt.prototype),vt),ms,Qr,Wh=(ms=Et({before:"beforeSceneUpdated",after:"sceneUpdated"}),Qr=function(){function n(a){this.oasis=a}var s=n.prototype;return s.init=function(){var t=this,e=this.oasis.options.config.scene;e&&Object.keys(e).forEach(function(r){var i=e[r];Object.keys(i.props).forEach(function(o){var c=i.props[o];t.setProp(r,o,c)})})},s.update=function(t,e,r){return this.setProp(t,e,r),{field:t,key:e,value:r}},s.setProp=function(t,e,r){var i=this.oasis.engine.sceneManager.activeScene;if(t==="background"&&e==="skyboxTexture"){var o=i.background.sky;if(r){o.mesh=$r.createCuboid(i.engine,2,2,2);var c=new $u(i.engine);c.textureCubeMap=this.oasis.resourceManager.get(r.id).resource,o.material=c}else o.mesh=null,o.material=null}else if(i[t]&&t==="ambientLight"&&e==="specularTexture")if(r&&r.type==="asset"){var l=this.oasis.resourceManager.get(r.id).resource;i.ambientLight.specularTexture=l.specularTexture,i.ambientLight.diffuseSphericalHarmonics=l.diffuseSphericalHarmonics,i.ambientLight.diffuseMode=wr.SphericalHarmonics,i.ambientLight.specularTextureDecodeRGBM=!0}else i.ambientLight.specularTexture=null,i.ambientLight.diffuseMode=wr.SolidColor;else i[t]&&(r&&r.type==="asset"?i[t][e]=this.oasis.resourceManager.get(r.id).resource:i[t][e]=r)},n}(),zt(Qr.prototype,"update",[ms],Object.getOwnPropertyDescriptor(Qr.prototype,"update"),Qr.prototype),Qr),rc=function(n){te(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var i=this;return new Promise(function(o){i.setMeta(),r.source?e.load({url:r.source,type:pe.SpriteAtlas}).then(function(c){i._resource=c;for(var l=c.sprites,u=i.resourceManager,h=l.length-1;h>=0;h--){var d=l[h],f=new tc(u,d),_=d._assetID;u.maxId=Math.max(_,u.maxId),u.resourceMap[_]=f,u.resourceIdMap.set(f,""+_)}o(i)}):(s.defaultAtlas||(s.defaultAtlas=new Ns(e.engine)),i._resource=s.defaultAtlas,o(i))})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={},i=Gr(this.resource);return i.forEach(function(o){return r[o]=e.resource[o]}),r},a.update=function(){},s}(Je);rc.defaultAtlas=void 0;var ys,xs,er,ti={script:Fh,gltf:Ih,texture:bt,cubeTexture:Nh,PBRMaterial:Js,PBRSpecularMaterial:Zs,UnlitMaterial:ec,BlinnPhongMaterial:$s,base:Uh,sprite:tc,SpriteAtlas:rc,animatorController:Ys,animationClip:Qs,environment:Vh},ic=new Map;for(var en in ti)if(ti.hasOwnProperty(en)){var jh=ti[en];ic.set(jh,en)}var ws={createResource:function(s,a){return new ti[a](s)}},Xh=(ys=Et({before:"beforeResourceRemove"}),xs=Et({after:"resourceUpdated",before:"beforeResourceUpdate"}),er=function(){function n(a){this.oasis=a,this.resourceMap={},this.resourceIdMap=new WeakMap,this.maxId=0,this.engineResourceManager=void 0,this.engineResourceManager=this.oasis.engine.resourceManager}var s=n.prototype;return s.load=function(t){var e=this,r=ws.createResource(this,t.type),i=r.load(this.oasis.engine.resourceManager,t,this.oasis);return this.maxId=Math.max(+t.id,this.maxId),i.then(function(){e.resourceMap[t.id]=r,e.resourceIdMap.set(r,t.id)}),i},s.add=function(t){var e=this,r=ws.createResource(this,t.type);return new Promise(function(i){r.loadWithAttachedResources(e.oasis.engine.resourceManager,t,e.oasis).then(function(o){i(e.getAddResourceResult(o.resources,o.structure))})})},s.remove=function(t){var e=this;return new Promise(function(r){var i=e.resourceMap[t],o=[t],c=!1;if(delete e.resourceMap[t],i)for(var l=i.attachedResources,u=0;u<l.length;u++){var h=l[u],d=e.resourceIdMap.get(h);d&&(c=!0,e.remove(d).then(function(f){o.push.apply(o,f),r(o)}))}c||r(o)})},s.update=function(t,e,r){var i=this.get(t);return i&&i.update(e,r),{resource:i,id:t,key:e,value:r}},s.updateMeta=function(t,e,r){var i=this.get(t);i&&i.updateMeta(e,r)},s.get=function(t){return this.resourceMap[t]},s.getAll=function(){return ai(this.resourceMap)},s.getAddResourceResult=function(t,e){var r=this,i={},o=t[e.index],c=""+ ++this.maxId;this.resourceMap[c]=o,this.resourceIdMap.set(o,c),i.id=this.maxId,i.type=ic.get(o.constructor),i.meta=o.meta,i.props={};for(var l in e.props)if(e.props.hasOwnProperty(l)){var u=e.props[l];u&&(Array.isArray(u)?i.props[l]=u.map(function(h){return r.getAddResourceResult(t,h)}):i.props[l]=this.getAddResourceResult(t,u))}return i},_i(n,[{key:"isLocal",get:function(){return this.oasis.options.local}},{key:"useCompressedTexture",get:function(){var t;return(t=this.oasis.options.useCompressedTexture)!=null?t:!0}}]),n}(),zt(er.prototype,"remove",[ys],Object.getOwnPropertyDescriptor(er.prototype,"remove"),er.prototype),zt(er.prototype,"update",[xs],Object.getOwnPropertyDescriptor(er.prototype,"update"),er.prototype),er),bs,Yr,Kh=(bs=Et({after:"schemaParsed"}),Yr=function(n){te(s,n);function s(t,e){var r,i;return i=n.call(this)||this,i._options=t,i.pluginManager=e,i.nodeManager=void 0,i.abilityManager=void 0,i.sceneManager=void 0,i.resourceManager=void 0,i._canvas=void 0,i.schema=void 0,i.timeout=void 0,i.oasis=qr(i),i.engine=void 0,i.engine=t.engine,i.schema=t.config,i.timeout=t.timeout,t.scripts=(r=t.scripts)!=null?r:{},i.nodeManager=new Hh(qr(i)),i.abilityManager=new kh(qr(i)),i.nodeManager.add=i.nodeManager.add.bind(i.nodeManager),i.abilityManager.add=i.abilityManager.add.bind(i.abilityManager),i.resourceManager=new Xh(qr(i)),i.sceneManager=new Wh(qr(i)),t.fps&&(i.engine.targetFrameRate=t.fps,i.engine.vSyncCount=0),i}var a=s.prototype;return a.updateConfig=function(e){this.schema=e,this.init()},a.init=function(){var e=this;return this.loadResources().then(function(){e.bindResources(),e.parseEntities(),e.attach(),e.nodeManager.addRootEntity(),e.sceneManager.init(),e.parseNodeAbilities(),e.pluginManager.boot(e)})},a.loadResources=function(){var e=this,r=this.schema.assets,i=r===void 0?{}:r,o=ai(i).filter(function(c){return ti[c.type]?!0:(console.warn(c.type+" loader is not defined. the "+c.type+" type will be ignored."),!1)}).map(function(c){return e.resourceManager.load(c)});return Promise.all(o)},a.bindResources=function(){this.resourceManager.getAll().forEach(function(e){e.bind()})},a.parseEntities=function(){var e=this.schema.nodes,r=this.bfsNodes();r.map(function(i){return e[i]}).forEach(this.nodeManager.add)},a.parseNodeAbilities=function(){var e=this.schema.abilities;Object.keys(e).map(function(r){return Re({id:r},e[r])}).forEach(this.abilityManager.add)},a.bfsNodes=function(){var e=this.schema.nodes,r=ai(e).filter(function(c){return!e[c.parent]}).map(function(c){return c.id}),i=[],o=function c(l){i=i.concat(l),l.forEach(function(u){var h=e[u].children;h&&c(h)})};return o(r),i},a.attach=function(){this.resourceManager.getAll().forEach(function(e){e.attach()})},s.create=function(e,r){var i=new s(e,r);return i.init().then(function(){return e.autoPlay&&i.engine.run(),i})},_i(s,[{key:"canvas",get:function(){return this._options.canvas}},{key:"options",get:function(){return this._options}}]),s}(Ss),zt(Yr.prototype,"init",[bs],Object.getOwnPropertyDescriptor(Yr.prototype,"init"),Yr.prototype),Yr);vi.registerComponents("o3",{GLTFModel:Rh,SpriteRenderer:Fu,SpriteMask:an,PointLight:Wt,AmbientLight:it,DirectLight:Ht,ParticleRenderer:Gs,Camera:Fs,Model:Ks,Component:dt,StaticCollider:Lc,DynamicCollider:Cs,Animator:pn});var qh="0.6.9";console.log("oasis engine version: "+qh);var ri;(n=>{class s{constructor(){this.Position=new x,this.Target=new x}}n.Camera=s;class a{constructor(r,i){this.name=r,this.Vertices=new Array(i),this.Rotation=new x,this.Position=new x}}n.Mesh=a;class t{constructor(r){this.workingCanvas=r,this.workingWidth=r.width,this.workingHeight=r.height,this.workingContext=this.workingCanvas.getContext("2d")}clear(){this.workingContext.clearRect(0,0,this.workingWidth,this.workingHeight),this.backbuffer=this.workingContext.getImageData(0,0,this.workingWidth,this.workingHeight)}present(){this.workingContext.putImageData(this.backbuffer,0,0)}putPixel(r,i,o){this.backbufferdata=this.backbuffer.data;var c=((r>>0)+(i>>0)*this.workingWidth)*4;this.backbufferdata[c]=o.r*255,this.backbufferdata[c+1]=o.g*255,this.backbufferdata[c+2]=o.b*255,this.backbufferdata[c+3]=o.a*255}project(r,i){var o=r.transformCoordinate(i),c=o.x*this.workingWidth+this.workingWidth/2>>0,l=-o.y*this.workingHeight+this.workingHeight/2>>0;return new k(c,l)}drawPoint(r){r.x>=0&&r.y>=0&&r.x<this.workingWidth&&r.y<this.workingHeight&&this.putPixel(r.x,r.y,new Q(1,1,0,1))}render(r,i){let o=new j;const c=new x(0,1,0);j.lookAt(r.Position,r.Target,c,o);let l=new j;j.perspective(.78,this.workingWidth/this.workingHeight,.01,1,l);for(let u=0;u<i.length;u++){const h=i[u];let d=new he;he.rotationYawPitchRoll(h.Rotation.y,h.Rotation.x,h.Rotation.z,d);let f=new j;j.rotationTranslation(d,new x(h.Position.x,h.Position.y,h.Position.z),f);const _=f.multiply(o).multiply(l);for(let v=0;v<h.Vertices.length;v++){const p=this.project(h.Vertices[v],_);this.drawPoint(p)}}}}n.Device=t})(ri||(ri={}));let Ps,Ei,at,nc=[],Bi;document.addEventListener("DOMContentLoaded",Qh,!1);function Qh(){Ps=document.getElementById("canvas"),at=new ri.Mesh("Cube",8),nc.push(at),Bi=new ri.Camera,Ei=new ri.Device(Ps),at.Vertices[0]=new x(-1,1,1),at.Vertices[1]=new x(1,1,1),at.Vertices[2]=new x(-1,-1,1),at.Vertices[3]=new x(-1,-1,-1),at.Vertices[4]=new x(-1,1,-1),at.Vertices[5]=new x(1,1,-1),at.Vertices[6]=new x(1,-1,1),at.Vertices[7]=new x(1,-1,-1),Bi.Position=new x(0,0,10),Bi.Target=new x(0,0,0),requestAnimationFrame(ac)}function ac(){Ei.clear(),at.Rotation.x+=.01,at.Rotation.y+=.01,Ei.render(Bi,nc),Ei.present(),requestAnimationFrame(ac)}
